<?xml version='1.0' encoding='UTF-8' ?>
<!-- Created by Uniface - (C) Uniface B.V. All rights reserved -->
<!DOCTYPE UNIFACE PUBLIC "UNIFACE.DTD" "UNIFACE.DTD">
<UNIFACE release="9.7" xmlengine="2.0">
<TABLE>
<DSC name="UFORM" model="DICT" system="S" pseudo ="73" level="1" noupdate="0"
 rbk="0" ffsql="0" transnr="0" segsize="0" ufocc="1000" charset=".U">
<FLD name="UTIMESTAMP" seqno="1" type="E" level="2" pack="0" scale="0" length="15"
 pointer="0" inum="0" ufocc="0" />
<FLD name="UCOMPSTAMP" seqno="2" type="E" level="2" pack="0" scale="0" length="15"
 pointer="0" inum="0" ufocc="0" />
<FLD name="ULABEL" seqno="3" type="S" level="2" pack="0" scale="0" length="16"
 pointer="0" inum="1" ufocc="0" mandatory="yes" idxnum="1" idxsnr="101" />
<FLD name="FTYP" seqno="4" type="S" level="2" pack="0" scale="0" length="4"
 pointer="0" inum="0" ufocc="0" />
<FLD name="UVERS" seqno="5" type="S" level="2" pack="0" scale="0" length="12"
 pointer="0" inum="0" ufocc="0" />
<FLD name="UDESCR" seqno="6" type="S" level="2" pack="0" scale="0" length="25"
 pointer="0" inum="0" ufocc="0" />
<FLD name="FHEAD" seqno="7" type="S" level="2" pack="0" scale="0" length="6"
 pointer="0" inum="0" ufocc="0" />
<FLD name="VMAAT" seqno="8" type="S" level="2" pack="0" scale="0" length="6"
 pointer="0" inum="0" ufocc="0" />
<FLD name="HMAAT" seqno="9" type="S" level="2" pack="0" scale="0" length="6"
 pointer="0" inum="0" ufocc="0" />
<FLD name="UCOLOR" seqno="10" type="S" level="2" pack="0" scale="0" length="6"
 pointer="0" inum="0" ufocc="0" />
<FLD name="WVPOS" seqno="11" type="S" level="2" pack="0" scale="0" length="6"
 pointer="0" inum="0" ufocc="0" />
<FLD name="WHPOS" seqno="12" type="S" level="2" pack="0" scale="0" length="6"
 pointer="0" inum="0" ufocc="0" />
<FLD name="WVSIZ" seqno="13" type="S" level="2" pack="0" scale="0" length="6"
 pointer="0" inum="0" ufocc="0" />
<FLD name="WHSIZ" seqno="14" type="S" level="2" pack="0" scale="0" length="6"
 pointer="0" inum="0" ufocc="0" />
<FLD name="CLRSCRN" seqno="15" type="S" level="2" pack="0" scale="0" length="1"
 pointer="0" inum="0" ufocc="0" />
<FLD name="UBORDER" seqno="16" type="S" level="2" pack="0" scale="0" length="1"
 pointer="0" inum="0" ufocc="0" />
<FLD name="RIBIN" seqno="17" type="S" level="2" pack="0" scale="0" length="16"
 pointer="0" inum="0" ufocc="0" />
<FLD name="RIBOT" seqno="18" type="S" level="2" pack="0" scale="0" length="16"
 pointer="0" inum="0" ufocc="0" />
<FLD name="MOVABLE" seqno="19" type="S" level="2" pack="0" scale="0" length="1"
 pointer="0" inum="0" ufocc="0" />
<FLD name="VIDEOINVERSE" seqno="20" type="S" level="2" pack="0" scale="0" length="1"
 pointer="0" inum="0" ufocc="0" />
<FLD name="VIDEOBRIGHT" seqno="21" type="S" level="2" pack="0" scale="0" length="1"
 pointer="0" inum="0" ufocc="0" />
<FLD name="VIDEOUNLINE" seqno="22" type="S" level="2" pack="0" scale="0" length="1"
 pointer="0" inum="0" ufocc="0" />
<FLD name="VIDEOBLINK" seqno="23" type="S" level="2" pack="0" scale="0" length="1"
 pointer="0" inum="0" ufocc="0" />
<FLD name="UPANEL" seqno="24" type="S" level="2" pack="0" scale="0" length="16"
 pointer="0" inum="0" ufocc="0" />
<FLD name="POSPANEL" seqno="25" type="S" level="2" pack="0" scale="0" length="1"
 pointer="0" inum="0" ufocc="0" />
<FLD name="UPULL" seqno="26" type="S" level="2" pack="0" scale="0" length="16"
 pointer="0" inum="0" ufocc="0" />
<FLD name="HIDESTACK" seqno="27" type="S" level="2" pack="0" scale="0" length="1"
 pointer="0" inum="0" ufocc="0" />
<FLD name="TEMPLATENAME" seqno="28" type="S" level="2" pack="0" scale="0" length="16"
 pointer="0" inum="1" ufocc="0" idxnum="2" idxsnr="1" />
<FLD name="UINHERIT" seqno="29" type="B" level="2" pack="0" scale="0" length="1"
 pointer="0" inum="0" ufocc="0" />
<FLD name="LIBRAR" seqno="30" type="S" level="2" pack="0" scale="0" length="16"
 pointer="0" inum="0" ufocc="0" />
<FLD name="UTRANSACT" seqno="31" type="S" level="2" pack="0" scale="0" length="8"
 pointer="0" inum="0" ufocc="0" />
<FLD name="TPLACTUAL" seqno="32" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\D3,0,0,0,,0,0,0,," />
<FLD name="CONSTRAINTS" seqno="33" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\D4,0,0,0,,0,0,0,," />
<FLD name="INIT" seqno="34" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\C1,0,0,0,,0,0,0,," />
<FLD name="CLEAR" seqno="35" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\C2,0,0,0,,0,0,0,," />
<FLD name="RETRIEVE" seqno="36" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\C3,0,0,0,,0,0,0,," />
<FLD name="RECORD" seqno="37" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\C4,0,0,0,,0,0,0,," />
<FLD name="STORE" seqno="38" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\C5,0,0,0,,0,0,0,," />
<FLD name="DELET" seqno="39" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\C6,0,0,0,,0,0,0,," />
<FLD name="ACCEPT" seqno="40" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\C7,0,0,0,,0,0,0,," />
<FLD name="QUIT" seqno="41" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\C8,0,0,0,,0,0,0,," />
<FLD name="MENU" seqno="42" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\C9,0,0,0,,0,0,0,," />
<FLD name="INTKEY" seqno="43" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\CA,0,0,0,,0,0,0,," />
<FLD name="SPRINT" seqno="44" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\CB,0,0,0,,0,0,0,," />
<FLD name="EPRINT" seqno="45" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\CC,0,0,0,,0,0,0,," />
<FLD name="ASYNC" seqno="46" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\CD,0,0,0,,0,0,0,," />
<FLD name="GENERAL" seqno="47" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\CE,0,0,0,,0,0,0,," />
<FLD name="FORMPIC" seqno="48" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\E0,0,0,0,,0,0,0,," />
<FLD name="HEADER" seqno="49" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\E3,0,0,0,,0,0,0,," />
<FLD name="LISTING" seqno="50" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\E5,0,0,0,,0,0,0,," />
<FLD name="PERF" seqno="51" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\E1,0,0,0,,0,0,0,," />
<FLD name="PROTO" seqno="52" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\E2,0,0,0,,0,0,0,," />
<FLD name="TITLE" seqno="53" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\E7,0,0,0,,0,0,0,," />
<FLD name="WINPROP" seqno="54" type="S" level="2" pack="128" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\D2,0,0,0,,0,0,0,," />
<FLD name="FRLF" seqno="55" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\E4,0,0,0,,0,0,0,," />
<FLD name="FRGF" seqno="56" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\E6,0,0,0,,0,0,0,," />
<FLD name="SFUNC" seqno="57" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\DC,0,0,0,,0,0,0,," />
<FLD name="HTMLPROP" seqno="58" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\DD,0,0,0,,0,0,0,," />
<FLD name="USCONTAINED" seqno="59" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\CF,0,0,0,,0,0,0,," />
<FLD name="UEXECDEF" seqno="60" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\D0,0,0,0,,0,0,0,," />
<FLD name="UPOPUP" seqno="61" type="S" level="2" pack="128" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\D5,0,0,0,,0,0,0,," />
<FLD name="UML_DATA" seqno="62" type="S" level="2" pack="128" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\D6,0,0,0,,0,0,0,," />
<FLD name="HTML_CMPPROP" seqno="63" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\D1,0,0,0,,0,0,0,," />
<FLD name="HTML_FORMAT" seqno="64" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\D7,0,0,0,,0,0,0,," />
<FLD name="HTML_STYLES" seqno="65" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\D8,0,0,0,,0,0,0,," />
<FLD name="HTML_HOOK_H" seqno="66" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\D9,0,0,0,,0,0,0,," />
<FLD name="HTML_HOOK_B" seqno="67" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\DA,0,0,0,,0,0,0,," />
<FLD name="HTML_HOOK_E" seqno="68" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\DB,0,0,0,,0,0,0,," />
<FLD name="HTML_BODYHOOK" seqno="69" type="S" level="2" pack="128" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\DE,0,0,0,,0,0,0,," />
<FLD name="HTML_CMPCLASS" seqno="70" type="S" level="2" pack="128" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\DF,0,0,0,,0,0,0,," />
<FLD name="GETSTATE" seqno="71" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\E8,0,0,0,,0,0,0,," />
<FLD name="SETSTATE" seqno="72" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\E9,0,0,0,,0,0,0,," />
<FLD name="UNOSTATE" seqno="73" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\EA,0,0,0,,0,0,0,," />
<FLD name="CMP_EXT" seqno="74" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\EB,0,0,0,,0,0,0,," />
<FLD name="UCTRIGGERS" seqno="75" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\EC,0,0,0,,0,0,0,," />
<FLD name="UACCESSPATH" seqno="76" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\ED,0,0,0,,0,0,0,," />
<FLD name="USPLITPROP" seqno="77" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\EE,0,0,0,,0,0,0,," />
<FLD name="TPLACTUAL2" seqno="78" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\EF,0,0,0,,0,0,0,," />
<FLD name="USTATEMANAGEDBY" seqno="79" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\F0,0,0,0,,0,0,0,," />
<FLD name="HTMLSKELETON" seqno="80" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\F1,0,0,0,,0,0,0,," />
</DSC>
<OCC>
<DAT name="UTIMESTAMP">2019-03-11T15:02:26.00</DAT>
<DAT name="UCOMPSTAMP">2019-03-20T08:30:20.00</DAT>
<DAT name="ULABEL">CDFSVCO038</DAT>
<DAT name="UDESCR" xml:space='preserve'>Alocação Industrial</DAT>
<DAT name="WVSIZ">10</DAT>
<DAT name="WHSIZ">40</DAT>
<DAT name="TEMPLATENAME">SVC001</DAT>
<DAT name="UINHERIT">F</DAT>
<DAT name="UTRANSACT">1</DAT>
<DAT name="TPLACTUAL" xml:space='preserve'>
#Comment ----------------------------------------------
#Comment start_of_references
#ifdefined TEMPLATENAME
#info symbol TEMPLATENAME is already or also defined as a global or local constant
#endif
#define TEMPLATENAME=SVC001
#Comment

#Comment end_of_references


#Comment ----------------------------------------------
#Comment start_of_mappings
#ifdefined GENERICA
#info symbol GENERICA is already or also defined as a global or local constant
#endif
#define GENERICA=CDF_PARTIDASVC.CDF
#Comment

#ifdefined UNQ_GENERICA
#info symbol UNQ_GENERICA is already or also defined as a global or local constant
#endif
#define UNQ_GENERICA=CDF_PARTIDASVC
#Comment

#Comment end_of_mappings


#Comment ----------------------------------------------
#Comment start_of_symbols
#Comment end_of_symbols


#Comment ----------------------------------------------
</DAT>
<DAT name="GENERAL" xml:space='preserve'>#include &lt;LIB_PADRAO&gt;:DEF_LOCALPROC
#include &lt;LIB_PADRAO&gt;:CMP_ENT_INFO
#include &lt;LIB_PADRAO&gt;:CMP_ENT_DATA
#include LIB_UTILS:LP_FORMAT
;----------------
entry getParamVaneti ;Parametro alterado.
	;-------------
	variables
		string viParams, voParams
	endvariables

	viParams = ""
	putitem viParams, -1, "CD_ESPECIE_KG"
	putitem viParams, -1, "TP_ALOCACAO_PARTIDA"
 	putitem viParams, -1, "DS_LST_TP_REC_CAMPO_CONF"
	putitem viParams, -1, "TP_MANUTENCAO_FASE_REC"
	putitem viParams, -1, "DS_LST_LOCAL_EMI_REC"
	putitem viParams, -1, "CD_TIPO_CLAS_PADRAO_TEC" ;--&gt; MNSANTOS - Prj 217/602 - 30/08/2017
	putitem viParams, -1, "IN_VALIDAR_SALDO_EMI_REC" ;&lt;-- LOMoreira Prj-&gt;217-708 22/01/2018 --&gt;
	putitem viParams, -1, "DS_LST_TP_CLA_REC_PARTIDA" ;&lt;-- DSantos Prj-&gt;217-771 03/04/2018 --&gt;
	putitem viParams, 'Jhone, proprietario do Vilão!'
	putitem viParams, -1, "TP_INT_ACABAMENTO_TEXTIL";-&gt;HSGARCIA Proj 253/378 DVAIND-1940 05/12/2018
	activate "ADMSVCO001".GetParamEmpresa($item("CD_EMPRESA", $$gParamGlb), viParams, voParams, $xCdErro$, $xCtxerro$)
	if ($procerror)
		$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status &lt; 0)
		return(-1)
	endif
	$cdEspecieKg$ = $item("CD_ESPECIE_KG", voParams)
	$tpAlocacaoPartida$ = $item("TP_ALOCACAO_PARTIDA", voParams)
	$dsLstTpRecCampoConf$ = $replace($item("DS_LST_TP_REC_CAMPO_CONF", voParams), 1, ";", "&uSEP;", -1)
	$tpManutencaoFaseRec$ = $item("TP_MANUTENCAO_FASE_REC", voParams)
	$dsLstLocalEmiRec$ = $replace($item("DS_LST_LOCAL_EMI_REC", voParams), 1, ";", "&uSEP;", -1)
	$cdTipoClasPadraoTec$ = $item("CD_TIPO_CLAS_PADRAO_TEC", voParams) ;--&gt; MNSANTOS - Prj 217/602 - 30/08/2017
	$inValidarSaldoEmiRec$ = $item("IN_VALIDAR_SALDO_EMI_REC", voParams) ;&lt;-- LOMoreira Prj-&gt;217-708 22/01/2018 --&gt;
	$dsLstTpClaRecPartida$ = $replace($item("DS_LST_TP_CLA_REC_PARTIDA", voParams), 1, ";", "&uSEP;", -1) ;&lt;-- DSantos Prj-&gt;217-771 03/04/2018 --&gt;
	$cdClasPermitePartida$ = $item("CD_CLAS_PERMITE_PARTIDA", voParams)	;-&gt;HSGARCIA Proj 253/259 08/10/2018
	$tpIntAcabamentoTextil$ = $item("TP_INT_ACABAMENTO_TEXTIL", voParams) ;-&gt;HSGARCIA Proj 253/378 DVAIND-1940 05/12/2018

	return(0)
end ;getParamEmp

;-----------------------
entry inValidarParametro
	;--------------------
	returns boolean
	params
		string piDsLstValidar : IN
		string piDsLstParams : IN
		string piDsOperation : IN
	endparams

	while (piDsLstValidar != "")
		if ($item($itemnr(1, piDsLstValidar), piDsLstparams) = "")
			$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG14043", "DESCRICAO=Dados incorretos para o processo!", "ADICIONAL=Operação-&gt;CDFSVCO038.%%piDsOperation")
			return(0)
		endif
		delitem piDsLstValidar, 1
	endwhile

	return(1)
end ;inValidarParametro

;--------------------
entry getTempoPartida
	;-----------------
	returns string
	variables
		datetime vDtTempoProdutivo, vDtTempoInterrupcao
		numeric vQtTempoEstiInte
		string vDsRetorno, viParams, vDsRegProcesso
		boolean vInDisponivel
	endvariables

	if ($empty("CDF_PARTIDAPTSVC"))
		vInDisponivel = &lt;TRUE&gt;
		if (!$empty("CDF_PARTIDAISVC"))
			setocc "CDF_PARTIDAISVC", 1
			while ($status &gt;= 0)
				viParams = ""
				putitem/id viParams, "CD_EMPRESA", CD_EMPOP.CDF_PARTIDAISVC
				putitem/id viParams, "NR_CICLO", NR_CICLO.CDF_PARTIDAISVC
				putitem/id viParams, "NR_OP", NR_OP.CDF_PARTIDAISVC
				putitem/id viParams, "CD_PRODUTO", CD_PRODUTO.CDF_PARTIDAISVC
				vDsRegProcesso = getProcessoOp(viParams, CD_PROCESSO.CDF_PARTIDAPSVC, &lt;FALSE&gt;, &lt;TRUE&gt;)

				putitem/id viParams, "NR_LOTE", NR_LOTE.CDF_PARTIDAISVC
				putitem/id viParams, "NR_ITEM", NR_ITEM.CDF_PARTIDAISVC
				putitem/id viParams, "CD_PROCESSOANT", $item("CD_PROCESSO", vDsRegProcesso)
				putitem/id viParams, "CD_MAQUINA", CD_MAQUINA.CDF_PARTIDASVC
				vInDisponivel = inProcessoDisponivel(viParams)
				if (!vInDisponivel)
					break
				endif
				setocc "CDF_PARTIDAISVC", $curocc("CDF_PARTIDAISVC") + 1
			endwhile
		endif
		putitem/id vDsRetorno, "IN_DISPONIVEL", vInDisponivel
		if (NR_ORDEM.CDF_PARTIDASVC = 1)
			if (vInDisponivel)
				putitem/id vDsRetorno, "DT_INICIOPREV", traduzirTexto("Disponível para início imediato")
			else
				putitem/id vDsRetorno, "DT_INICIOPREV", traduzirTexto("Não Disponível para início")
			endif
		endif
		return(vDsRetorno)
	endif

	vDtTempoProdutivo = ""
	vDtTempoInterrupcao = ""
	setocc "CDF_PARTIDAPTSVC", 1
	while ($status &gt;= 0)
		if (TP_TEMPO.CDF_PARTIDAPTSVC = 1 &amp; $item("DT_INICIO", vDsRetorno) = "")
			putitem/id vDsRetorno, "DT_INICIO", DT_INICIO.CDF_PARTIDAPTSVC
		endif
		if (DT_FIM.CDF_PARTIDAPTSVC != "")
			if (TP_TEMPO.CDF_PARTIDAPTSVC = 1)
				vDtTempoProdutivo += (DT_FIM.CDF_PARTIDAPTSVC - DT_INICIO.CDF_PARTIDAPTSVC)
			else
				vDtTempoInterrupcao += (DT_FIM.CDF_PARTIDAPTSVC - DT_INICIO.CDF_PARTIDAPTSVC)
			endif
		else
			if (TP_TEMPO.CDF_PARTIDAPTSVC = 1)
				vDtTempoProdutivo += ($datim - DT_INICIO.CDF_PARTIDAPTSVC)
			else
				if (CD_MOTIVO.CDF_PARTIDAPTSVC != "")
					vQtTempoEstiInte = getFieldData("QT_TEMPO", "PCP_MOTIVOSVC", "CD_MOTIVO=%%CD_MOTIVO.CDF_PARTIDAPTSVC")
					if (converterTempoEmMinuto($datim - DT_INICIO.CDF_PARTIDAPTSVC) &gt; vQtTempoEstiInte)
						;- Quando o tempo decorrido de interrupção é maior que o tempo estimado, assume o tempo decorrido.
						vDtTempoInterrupcao += ($datim - DT_INICIO.CDF_PARTIDAPTSVC)
						vQtTempoEstiInte = 0
					endif
				endif
			endif
		endif
		setocc "CDF_PARTIDAPTSVC", $curocc("CDF_PARTIDAPTSVC") + 1
	endwhile

	putitem/id vDsRetorno, "QT_TEMPOESTIMADOINTE", vQtTempoEstiInte
	if (vDtTempoProdutivo != "")
		putitem/id vDsRetorno, "QT_MINPRODUTIVO", converterTempoEmMinuto(vDtTempoProdutivo)
	endif
	if (vDtTempoInterrupcao!= "")
		putitem/id vDsRetorno, "QT_MININTERRUPCAO", converterTempoEmMinuto(vDtTempoInterrupcao)
	endif

	return(vDsRetorno)
end ;getTempoPartida

;---------------------------
entry getTempoReceitaPartida
	;------------------------
	returns numeric
	params
		numeric piCdEmpresa : IN
		numeric piNrPartida : IN
	endparams
	variables
		string viParams, voParams
	endvariables

	viParams = ""
	putitem/id viParams, "CD_EMPRESA", piCdEmpresa
	putitem/id viParams, "NR_PARTIDA", piNrPartida
	$instancehandle-&gt;buscarReceitaPartida(viParams, voParams, $xCdErro$, $xCtxErro$)
	if ($procerror)
		$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
		$status = -1
		return("")
	elseif ($status &lt; 0)
		return("")
	endif
	if ($item("IN_RECEITAIGUAL", voParams) = &lt;FALSE&gt; | $item("CD_RECEITA", voParams) = "")
		return("")
	endif

	activate "PCPSVCO043".buscarTempoReceita(voParams, voParams, $xCdErro$, $xCtxErro$)
	if ($procerror)
		$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
		$status = -1
		return("")
	elseif ($status &lt; 0)
		return("")
	endif

	return($item("QT_TEMPO", voParams))
end ;getTempoReceitaPartida

;------------------------------
entry getQtProduzidaItemPartida
 	;---------------------------
	returns numeric
	params
		numeric piCdEmpresa : IN
		numeric piNrCiclo : IN
		numeric piNrOp : IN
		numeric piCdProduto : IN
		numeric piCdProcesso : IN
		numeric poQtPartida : OUT
	endparams
	variables
		numeric vQtFinalizada, vQtTotal
	endvariables

	poQtPartida = 0
	vQtTotal = ""
	clear/e "V_CDF_PARTIDASVC"
	CD_EMPOP.V_CDF_PARTIDASVC/init = piCdEmpresa
	NR_CICLO.V_CDF_PARTIDASVC/init = piNrCiclo
	NR_OP.V_CDF_PARTIDASVC/init = piNrOp
	CD_PRODUTO.V_CDF_PARTIDASVC/init = piCdProduto
	CD_PROCESSO.V_CDF_PARTIDASVC/init = piCdProcesso
	retrieve/e "V_CDF_PARTIDASVC"
	if ($status &gt;= 0)
		setocc "V_CDF_PARTIDASVC", 1
		while ($status &gt;= 0)
			poQtPartida = poQtPartida + 1
			clear/e "CDF_PARTIDAFISVC"
			CD_EMPRESA.CDF_PARTIDAFISVC/init = CD_EMPRESA.V_CDF_PARTIDASVC
			NR_PARTIDA.CDF_PARTIDAFISVC/init = NR_PARTIDA.V_CDF_PARTIDASVC
			NR_SEQPARTIDA.CDF_PARTIDAFISVC/init = NR_SEQPROCESSO.V_CDF_PARTIDASVC
			NR_SEQITEM.CDF_PARTIDAFISVC/init = NR_SEQUENCIA.V_CDF_PARTIDASVC
			retrieve/e "CDF_PARTIDAFISVC"
			if($status &gt;= 0)
				setocc "CDF_PARTIDAFISVC", 1
				while($status &gt;= 0)
					if(!inMovFinOpEstornado()) ;- Verifica se o movimento que de O.P. relacionado ao movimento de finalização está estornado.
						vQtTotal = vQtTotal + QT_FINALIZADA.CDF_PARTIDAFISVC
					endif
					setocc "CDF_PARTIDAFISVC", $curocc("CDF_PARTIDAFISVC") + 1
				endwhile
			endif
			setocc "V_CDF_PARTIDASVC", $curocc("V_CDF_PARTIDASVC") + 1
		endwhile
	endif

	return(vQtTotal)
end ;getQtProduzidaItemPartida

;------------------------
entry inMovFinOpEstornado
	;---------------------
	;- Verifica se o movimento de finalização de O.P. que está relacionado com o movimento de finalização da partida está estorando
	returns boolean

	clear/e "CDF_PARTIDAMOVSVC"
	CD_EMPPARTIDA.CDF_PARTIDAMOVSVC/init = CD_EMPRESA.CDF_PARTIDAFISVC
	NR_PARTIDA.CDF_PARTIDAMOVSVC/init = NR_PARTIDA.CDF_PARTIDAFISVC
	NR_SEQPARTIDA.CDF_PARTIDAMOVSVC/init = NR_SEQPARTIDA.CDF_PARTIDAFISVC
	NR_SEQTEMPO.CDF_PARTIDAMOVSVC/init = NR_SEQTEMPO.CDF_PARTIDAFISVC
	NR_SEQITEM.CDF_PARTIDAMOVSVC/init = NR_SEQITEM.CDF_PARTIDAFISVC
	NR_SEQFIN.CDF_PARTIDAMOVSVC/init = NR_SEQFIN.CDF_PARTIDAFISVC
	retrieve/e "CDF_PARTIDAMOVSVC"
	if($status &gt;= 0)
		clear/e "CDF_MOVOPCSVC"
		CD_EMPRESA.CDF_MOVOPCSVC/init = CD_EMPMOV.CDF_PARTIDAMOVSVC
		NR_CICLO.CDF_MOVOPCSVC/init = NR_CICLO.CDF_PARTIDAMOVSVC
		NR_OP.CDF_MOVOPCSVC/init = NR_OP.CDF_PARTIDAMOVSVC
		DT_MOVIMENTO.CDF_MOVOPCSVC/init = DT_MOVIMENTO.CDF_PARTIDAMOVSVC
		NR_SEQMOV.CDF_MOVOPCSVC/init = NR_SEQMOV.CDF_PARTIDAMOVSVC
		retrieve/e "CDF_MOVOPCSVC"
		if($status &gt;= 0)
			return(IN_ESTORNO.CDF_MOVOPCSVC)
		endif
	endif

	return(&lt;FALSE&gt;)
end ;inMovFinOpEstornado

;-------------------------
entry getTempoSetupPartida
	;----------------------
	returns numeric
	params
		boolean piInTempoSetup : IN
	endparams
	variables
		string vDsOrigem, vDsDestino, viParams, voParams
	endvariables

	if (!piInTempoSetup | NR_ORDEM.CDF_PARTIDASVC &lt;= 1 | TP_SITUACAO.CDF_PARTIDASVC != 0)
		;- Quando a máquina está configurada para não considerar setup ou for ordem 1 ou a partida não estiver aguardando o tempo de setup é zero.
		return(0)
	endif

	if (!$empty("CDF_PARTIDAISVC"))
		clear/e "F_CDF_PARTIDASVC"
		CD_EMPRESA.F_CDF_PARTIDASVC/init = CD_EMPRESA.CDF_PARTIDASVC
		CD_MAQUINA.F_CDF_PARTIDASVC/init = CD_MAQUINA.CDF_PARTIDASVC
		NR_ORDEM.F_CDF_PARTIDASVC/init = NR_ORDEM.CDF_PARTIDASVC - 1
		retrieve/e "F_CDF_PARTIDASVC"
		if ($status &gt;= 0)
			clear/e "F_CDF_PARTIISVC"
			CD_EMPRESA.F_CDF_PARTIISVC/init = CD_EMPRESA.F_CDF_PARTIDASVC
			NR_PARTIDA.F_CDF_PARTIISVC/init = NR_PARTIDA.F_CDF_PARTIDASVC
			retrieve/e "F_CDF_PARTIISVC"
			if ($status &gt;= 0)
				;- Identifica produto origem e destino, onde origem é a partida atual e destino a próxima partida.
				vDsOrigem = getItemIgualPartida("F_CDF_PARTIISVC")
				vDsDestino = getItemIgualPartida("CDF_PARTIDAISVC")
			endif
		endif
	endif

	viParams = ""
	putitem/id viParams, "CD_MAQUINA", CD_MAQUINA.CDF_PARTIDASVC
	putitem/id viParams, "DS_ORIGEM", vDsOrigem
	putitem/id viParams, "DS_DESTINO", vDsDestino
	activate "CDFSVCO029".buscarTempoSetupMaquina(viParams, voParams, $xCdErro$, $xCtxErro$)
	if ($procerror)
		$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
		$status = -1
		return("")
	elseif ($status &lt; 0)
		return("")
	endif

	return($item("QT_TEMPO", voParams))
end ;getTempoSetup

;------------------------
entry getItemIgualPartida
	;---------------------
	returns string
	params
		string piDsEntity : IN
	endparams
	variables
		string vDsField, vDsRetorno, vCdCor, vCdAtual, vCdProximo
		numeric vCdProduto, vCdSeqGrupo
		boolean vInIgual
	endvariables

	vDsField = "CD_PRODUTO.%%piDsEntity"
	vInIgual = &lt;TRUE&gt;
	setocc "%%piDsEntity", 1
	while (vInIgual &amp; $status &gt;= 0)
		if ($next(vDsField) != @vDsField &amp; $next(vDsField) != "")
			vInIgual = &lt;FALSE&gt;
		endif
		setocc "%%piDsEntity", $curocc("%%piDsEntity") + 1
	endwhile
	if (vInIgual)
		vCdProduto = @vDsField
		vCdCor = getFieldData("CD_COR", "V_PRD_PRDSSVC", "CD_PRODUTO=%%vCdProduto")
		vCdSeqGrupo = getFieldData("CD_SEQGRUPO", "V_PRD_PRDSSVC", "CD_PRODUTO=%%vCdProduto")
	else
		vInIgual = &lt;TRUE&gt;
		setocc "%%piDsEntity", 1
		while (vInIgual &amp; $status &gt;= 0)
			vCdAtual = getFieldData("CD_COR", "V_PRD_PRDSSVC", "CD_PRODUTO=%%@vDsField")
			if ($next(vDsField) != "")
				vCdProximo = getFieldData("CD_COR", "V_PRD_PRDSSVC", "CD_PRODUTO=%%$next(vDsField)")
				if (vCdAtual != vCdProximo)
					vInIgual = &lt;FALSE&gt;
				endif
			endif
			setocc "%%piDsEntity", $curocc("%%piDsEntity") + 1
		endwhile
		if (vInIgual)
			vCdCor = vCdAtual
		endif

		vInIgual = &lt;TRUE&gt;
		setocc "%%piDsEntity", 1
		while ($status &gt;= 0)
			vCdAtual = getFieldData("CD_SEQGRUPO", "V_PRD_PRDSSVC", "CD_PRODUTO=%%@vDsField")
			if ($next(vDsField) != "")
				vCdProximo = getFieldData("CD_SEQGRUPO", "V_PRD_PRDSSVC", "CD_PRODUTO=%%$next(vDsField)")
				if (vCdAtual != vCdProximo)
					vInIgual = &lt;FALSE&gt;
				endif
			endif
			setocc "%%piDsEntity", $curocc("%%piDsEntity") + 1
		endwhile
		if (vInIgual)
			vCdSeqGrupo = vCdAtual
		endif
	endif

	putitem/id vDsRetorno, "CD_PRODUTO", vCdProduto
	putitem/id vDsRetorno, "CD_COR", vCdCor
	putitem/id vDsRetorno, "CD_SEQGRUPO", vCdSeqGrupo

	return(vDsRetorno)
end ;getItemIgualPartida

;---------------------------
entry converterTempoEmMinuto
	;------------------------
	returns numeric
	params
		datetime piDtTempo : IN
	endparams
	variables
		numeric vQtHora, vQtMinuto
	endvariables

	while (piDtTempo[Y] &gt; 0)
		piDtTempo -= 1
		vQtHora += 24
	endwhile

	while (piDtTempo[M] &gt; 1)
		piDtTempo -= 1
		vQtHora += 24
	endwhile

	vQtHora += piDtTempo[H] + (piDtTempo[D] * 24)
	vQtMinuto = piDtTempo[N] + (vQtHora * 60)

	return(vQtMinuto)
end ;converterDataEmMinuto

;---------------------------
entry converterMinutoEmTempo
	;------------------------
	returns numeric
	params
		numeric piQtMinuto : IN
	endparams
	variables
		numeric vQtRetorno
	endvariables

	vQtRetorno = (piQtMinuto / 60) / 24

	return(vQtRetorno)
end ;converterMinutoEmTempo

;-------------------------
entry descreverTempoMinuto
	;----------------------
	returns string
	params
		numeric piQtMinuto : IN
	endparams
	variables
		numeric vQtDia, vQtHora, vQtSegundo
		string vDsTempo
	endvariables

	vDsTempo = ""
	vQtHora = piQtMinuto / 60
	if (vQtHora &gt; 0)
		vQtHora = vQtHora[trunc]
		piQtMinuto = piQtMinuto - (vQtHora * 60)
	endif
	if (vQtHora &gt; 24)
		vQtDia = vQtHora / 24
		vQtDia = vQtDia[trunc]
		vQtHora = vQtHora - (vQtDia * 24)
	endif
	vQtSegundo = $frac(piQtMinuto)
	if (vQtSegundo &gt; 0)
		vQtSegundo = vQtSegundo * 60
	endif
	piQtMinuto = piQtMinuto[trunc]

	if (vQtDia &gt; 0)
		if (vQtDia &gt; 1)
			vDsTempo = "%%vDsTempo%%vQtDia %%traduzirTexto("dias") "
		else
			vDsTempo = "%%vDsTempo%%vQtDia %%traduzirTexto("dia") "
		endif
	endif
	if (vQtHora &gt; 0)
		if (vQtHora &gt; 1)
			vDsTempo = "%%vDsTempo%%vQthora %%traduzirTexto("horas") "
		else
			vDsTempo = "%%vDsTempo%%vQtHora %%traduzirTexto("hora") "
		endif
	elseif (vDsTempo != "" &amp; piQtMinuto &gt; 0)
		vDsTempo = "%%vDsTempo 0 %%traduzirTexto("hora") "
	endif
	if (piQtMinuto &gt; 0)
		if (piQtMinuto &gt; 1)
			vDsTempo = "%%vDsTempo%%piQtMinuto %%traduzirTexto("minutos") "
		else
			vDsTempo = "%%vDsTempo%%piQtMinuto %%traduzirTexto("minuto") "
		endif
	endif
	vQtSegundo = vQtSegundo[round]
	if (vQtSegundo &gt; 0 &amp; vDsTempo = "")
		if (vQtSegundo &gt; 1)
			vDsTempo = "%%vDsTempo%%vQtSegundo %%traduzirTexto("segundos") "
		else
			vDsTempo = "%%vDsTempo%%vQtSegundo %%traduzirTexto("segundo") "
		endif
	endif

	return(vDsTempo)
end ;descreverTempoMinuto

;----------------------
entry inValidarProcesso
	;-------------------
	returns boolean
	params
		numeric piCdProduto : IN
		numeric piCdProcesso : IN
		numeric piCdMaquina : IN
		string piCdReceita : IN
		string poDsMotivo : OUT
	endparams
	variables
		string viParams, voParams
		numeric vTpPartida, vCdSeqMaq
	endvariables

	viParams = "%%piCdProcesso%%piCdMaquina"
	if ($item(viParams, $dsLstProcMaq$) = &lt;TRUE&gt;)
		return(1)
	endif

	;&lt;-- DSantos 20/06/2016
	vCdSeqMaq = getFieldData("CD_SEQMAQ", "CDF_MAQGMAQSVC", "CD_MAQUINA=%%piCdMaquina")
	$handleEntity$-&gt;consultar("CDF_GMAQPROCESSOSVC", "CD_SEQMAQ=&uEQ;%%vCdSeqMaq&uSEP;CD_PROCESSO=%%piCdProcesso&uSEP;TP_PROCESSO=2")
	if ($status &gt;= 0)
		;- Processo configurado para ser ignorado na máquina.
		return(0)
	endif
	; DSantos --&gt;

	vTpPartida = getMaqConfPar("TP_PARTIDA", piCdMaquina)

	if (vTpPartida = 1)
		if (getFieldData("TP_CALTEMPO", "CDF_PROCESSOSVC", "CD_PROCESSO=%%piCdProcesso") != 2)
			;- Máquina definida como descontínua e processo contínuo
			poDsMotivo = "Máquina definida como descontínua e processo contínuo"
			return(0)
		endif
	else
		if (getFieldData("TP_CALTEMPO", "CDF_PROCESSOSVC", "CD_PROCESSO=%%piCdProcesso") = 2)
			;- Máquina definida como contínua e processo descontínuo
			poDsMotivo = "Máquina definida como contínua e processo descontínuo"
			return(0)
		endif
	endif

	if (piCdReceita = "")
		if (getMaqConfPar("TP_EMISSAO", piCdMaquina) = 1 | getMaqConfPar("TP_CALCTEMPO", piCdMaquina) = 1)
			;- Quando a configuração de emissão da máquina obrigar emissão ou a configuração de tempo for por receita, valida se o processo possui receita.
			viParams = ""
			putitem/id viParams, "CD_PRODUTO", piCdProduto
			putitem/id viParams, "CD_PROCESSO", piCdProcesso
			putitem/id viParams, "CD_PROCREC", &lt;TRUE&gt;
			activate "CDFSVCO030".buscarSeqProc(viParams, voParams, $xCdErro$, $xCtxErro$)
			if ($procerror)
				$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
			return(0)
				elseif ($status &lt; 0)
				return(0)
			endif
			if ($item("CD_RECEITA", $itemnr(1, $item("DS_LSTSEQPROC", voParams))) = "")
				poDsMotivo = "Máquina configurada para obrigar emissão de receita ou o tempo for por receita e processo está sem receita"
				return(0)
			endif
		endif
	endif

	return(1)
end ;inValidarProcesso

;-----------------------------
entry inValidarMaquinaProcesso
	;--------------------------
	returns boolean
	params
		numeric piCdProcesso : IN
		numeric piCdSeqMaq : IN
		numeric piCdMaquina : IN
		string poDsMotivo : OUT
	endparams
	variables
		numeric vCdSeqMaq
		string vDsRegistro
	endvariables

	vCdSeqMaq = getFieldData("CD_SEQMAQ", "CDF_MAQGMAQSVC", "CD_MAQUINA=%%piCdMaquina")

	if (piCdSeqMaq != "" &amp; vCdSeqMaq = piCdSeqMaq)
		;- Quando o processo já possui grupo de máquina na sequência de processo da O.P. e a máquina da alocação pertence a esse grupo.
		return(1)
	endif

	if (getFieldData("CD_PROCESSO", "CDF_GMAQPROCESSOSVC", "CD_PROCESSO=&uEQ;%%piCdProcesso&uSEP;CD_SEQMAQ=%%vCdSeqMaq&uSEP;TP_PROCESSO=1") != "")
		;- Quando o processo está vinculado ao grupo de máquina.
		return(1)
	endif
	poDsMotivo = "Processo não vinculado ao grupo de máquina na sequência de processo do item da O.P. e nem ao grupo de máquina"

	return(0)
end ;inValidarMaquinaProcesso

;---------------------------
entry addItemOpOrigemPartida
	;------------------------
	returns string
	params
		numeric piCdProcesso : IN
		numeric piCdMaquina : IN
		string piCdReceita : IN
		numeric piCdProcAnt : IN
		string piDsRetorno : IN
	endparams
	variables
		numeric vNrStatus
		string vDsRegistro, vDsMotivo, viParams
		date vDtPrevEntrega
	endvariables

	clear/e "PCP_AGRUOPISVC"
	CD_EMPOPI.PCP_AGRUOPISVC/init = CD_EMPRESA.PCP_OPISVC
	NR_CICLO.PCP_AGRUOPISVC/init = NR_CICLO.PCP_OPISVC
	NR_OP.PCP_AGRUOPISVC/init = NR_OP.PCP_OPISVC
	CD_PRODUTO.PCP_AGRUOPISVC/init = CD_PRODUTO.PCP_OPISVC
	retrieve/e "PCP_AGRUOPISVC"
	if ($status &gt;= 0)
		putitem/id vDsRegistro, "CD_EMPRESA", CD_EMPRESA.PCP_AGRUOPISVC
		putitem/id vDsRegistro, "NR_AGRUPADOR", NR_AGRUPADOR.PCP_AGRUOPISVC
		if (!inValidarAgrupadorProcesso(vDsRegistro, piCdProcesso, piCdMaquina, piCdReceita, "PCP_AGRUOPISVC"))
			return(piDsRetorno)
		endif
		putitem/id vDsRegistro, "QT_ALOCAR", getQtAlocarAgrupador(vDsRegistro, piCdProcesso, piCdMaquina, "PCP_AGRUOPISVC", &lt;FALSE&gt;, vDtPrevEntrega, "", piCdProcAnt)
		if ($status &lt; 0)
			return(piDsRetorno)
		endif
		putitem/id vDsRegistro, "CD_RECEITA", piCdReceita
		putitem/id vDsRegistro, "DT_PREVENTREGA", vDtPrevEntrega
		putitem/id vDsRegistro, "CD_PROCESSO", piCdProcesso
		piDsRetorno = adicionarRegistroLista(vDsRegistro, piDsRetorno, "DS_LST_AGRU_OP")
	else
		putitem/id vDsRegistro, "CD_EMPRESA", CD_EMPRESA.PCP_OPISVC
		putitem/id vDsRegistro, "NR_CICLO", NR_CICLO.PCP_OPISVC
		putitem/id vDsRegistro, "NR_OP", NR_OP.PCP_OPISVC
		putitem/id vDsRegistro, "CD_PRODUTO", CD_PRODUTO.PCP_OPISVC
		putitem/id vDsRegistro, "CD_PROCESSO", piCdProcesso
		putitem/id vDsRegistro, "QT_ALOCAR", getQtAlocarItemOp(vDsRegistro, piCdProcesso, piCdMaquina, &lt;FALSE&gt;, vDsMotivo, "")
		vNrStatus = $status
		if(vDsMotivo != "")
			putitem/id vDsRegistro, "DS_MOTIVO", vDsMotivo
			$lstItensDescartados$ = adicionarRegistroLista(vDsRegistro, $lstItensDescartados$, "DS_LSTITEMOPPROC")
		endif
		if (vNrStatus &lt; 0)
			return(piDsRetorno)
		endif
		putitem/id vDsRegistro, "DT_PREVENTREGA", getFieldData("DT_PREVENTREGA", "PCP_OPCSVC", "CD_EMPRESA=%%CD_EMPRESA.PCP_OPISVC&uSEP;NR_CICLO=%%NR_CICLO.PCP_OPISVC&uSEP;NR_OP=%%NR_OP.PCP_OPISVC")
		putitem/id vDsRegistro, "CD_RECEITA", piCdReceita
		;&lt;-- DSantos Prj-&gt;217-255 24/05/2016
		viParams = ""
		putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.PCP_OPISVC
		putitem/id viParams, "NR_CICLO", NR_CICLO.PCP_OPISVC
		putitem/id viParams, "NR_OP", NR_OP.PCP_OPISVC
		putitem/id viParams, "CD_PRODUTO", CD_PRODUTO.PCP_OPISVC
		putitem/id viParams, "CD_PROCESSOANT", piCdProcAnt
		putitem/id viParams, "QT_ALOCAR", $item("QT_ALOCAR", vDsRegistro)
		putitem/id viParams, "DS_LSTPROC", $item("DS_LST_ITEM_OP", piDsRetorno)
		putitem/id viParams, "CD_MAQUINA", piCdMaquina
		putitem/id vDsRegistro, "IN_DISPONIVEL", inProcessoDisponivel(viParams)
		; DSantos --&gt;
		piDsRetorno = adicionarRegistroLista(vDsRegistro, piDsRetorno, "DS_LST_ITEM_OP")
	endif
	return(piDsRetorno)
end ;addItemOpOrigemPartida

;-----------------------------
entry addItemLoteOrigemPartida
	;--------------------------
	returns string
	params
		numeric piCdProcesso : IN
		numeric piCdMaquina : IN
		string piCdReceita : IN
		numeric piCdProcAnt : IN
		string piDsRetorno : IN
	endparams
	variables
		numeric vNrStatus
		string vDsRegistro, vDsLista, vDsMotivo, viParams
		date vDtPrevEntrega
	endvariables

	clear/e "PCP_AGRUOPILISVC"
	CD_EMPOP.PCP_AGRUOPILISVC/init = CD_EMPRESA.PCP_OPILOTEISVC
	NR_CICLO.PCP_AGRUOPILISVC/init = NR_CICLO.PCP_OPILOTEISVC
	NR_OP.PCP_AGRUOPILISVC/init = NR_OP.PCP_OPILOTEISVC
	CD_PRODUTO.PCP_AGRUOPILISVC/init = CD_PRODUTO.PCP_OPILOTEISVC
	NR_LOTE.PCP_AGRUOPILISVC/init = NR_LOTE.PCP_OPILOTEISVC
	NR_ITEM.PCP_AGRUOPILISVC/init = NR_ITEM.PCP_OPILOTEISVC
	retrieve/e "PCP_AGRUOPILISVC"
	if ($status &gt;= 0)
		putitem/id vDsRegistro, "CD_EMPRESA", CD_EMPAGRUPADOR.PCP_AGRUOPILISVC
		putitem/id vDsRegistro, "NR_AGRUPADOR", NR_AGRUPADOR.PCP_AGRUOPILISVC
		if (!inValidarAgrupadorProcesso(vDsRegistro, piCdProcesso, piCdMaquina, piCdReceita, "PCP_AGRUOPILISVC"))
			return(piDsRetorno)
		endif
		putitem/id vDsRegistro, "QT_ALOCAR", getQtAlocarAgrupador(vDsRegistro, piCdProcesso, piCdMaquina, "PCP_AGRUOPILISVC", &lt;FALSE&gt;, vDtPrevEntrega, "", piCdProcAnt)
		if ($status &lt; 0)
			return(piDsRetorno)
		endif
		putitem/id vDsRegistro, "CD_RECEITA", piCdReceita
		putitem/id vDsRegistro, "DT_PREVENTREGA", vDtPrevEntrega
		putitem/id vDsRegistro, "CD_PROCESSO", piCdProcesso
		piDsRetorno = adicionarRegistroLista(vDsRegistro, piDsRetorno, "DS_LST_AGRU_LOTE")
	else
		putitem/id vDsRegistro, "CD_EMPRESA", CD_EMPRESA.PCP_OPILOTEISVC
		putitem/id vDsRegistro, "NR_CICLO", NR_CICLO.PCP_OPILOTEISVC
		putitem/id vDsRegistro, "NR_OP", NR_OP.PCP_OPILOTEISVC
		putitem/id vDsRegistro, "CD_PRODUTO", CD_PRODUTO.PCP_OPILOTEISVC
		putitem/id vDsRegistro, "NR_LOTE", NR_LOTE.PCP_OPILOTEISVC
		putitem/id vDsRegistro, "NR_ITEM", NR_ITEM.PCP_OPILOTEISVC
		putitem/id vDsRegistro, "CD_PROCESSO", piCdProcesso
		putitem/id vDsRegistro, "IN_REPROCESSO", IN_REPROCESSO.PCP_OPILOTEISVC ;-&gt; HSGARCIA Proj 253/129 17/07/2018
		putitem/id vDsRegistro, "QT_ALOCAR", getQtAlocarItemLote(vDsRegistro, piCdProcesso, piCdMaquina, &lt;FALSE&gt;, vDsMotivo, "")
		vNrStatus = $status
		if(vDsMotivo != "")
			putitem/id vDsRegistro, "DS_MOTIVO", vDsMotivo
			$lstItensDescartados$ = adicionarRegistroLista(vDsRegistro, $lstItensDescartados$, "DS_LSTITEMLOTEPROC")
		endif
		if (vNrStatus &lt; 0)
			return(piDsRetorno)
		endif
		putitem/id vDsRegistro, "DT_PREVENTREGA", getFieldData("DT_PREVENTREGA", "PCP_OPCSVC", "CD_EMPRESA=%%CD_EMPRESA.PCP_OPILOTEISVC&uSEP;NR_CICLO=%%NR_CICLO.PCP_OPILOTEISVC&uSEP;NR_OP=%%NR_OP.PCP_OPILOTEISVC")
		putitem/id vDsRegistro, "CD_RECEITA", piCdReceita
		;&lt;-- DSantos Prj-&gt;217-255 24/05/2016
		viParams = ""
		putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.PCP_OPILOTEISVC
		putitem/id viParams, "NR_CICLO", NR_CICLO.PCP_OPILOTEISVC
		putitem/id viParams, "NR_OP", NR_OP.PCP_OPILOTEISVC
		putitem/id viParams, "CD_PRODUTO", CD_PRODUTO.PCP_OPILOTEISVC
		putitem/id viParams, "NR_LOTE", NR_LOTE.PCP_OPILOTEISVC
		putitem/id viParams, "NR_ITEM", NR_ITEM.PCP_OPILOTEISVC
		putitem/id viParams, "CD_PROCESSOANT", piCdProcAnt
		putitem/id viParams, "QT_ALOCAR", $item("QT_ALOCAR", vDsRegistro)
		putitem/id viParams, "DS_LSTPROC", $item("DS_LST_ITEM_LOTE", piDsRetorno)
		putitem/id viParams, "CD_MAQUINA", piCdMaquina
		putitem/id vDsRegistro, "IN_DISPONIVEL", inProcessoDisponivel(viParams)
		; DSantos --&gt;
		piDsRetorno = adicionarRegistroLista(vDsRegistro, piDsRetorno, "DS_LST_ITEM_LOTE")
	endif

	return(piDsRetorno)
end ;addItemLoteOrigemPartida

;-----------------------
entry addOpOrigemPartida
	;--------------------
	;&lt;-- DSantos Prj-&gt;217-539 190/06/2017 --&gt;
	returns string
	params
		numeric piCdProcesso : IN
		numeric piCdMaquina : IN
		string piCdReceita : IN
		string piDsRetorno : IN
	endparams
	variables
		string vDsRegistro, vDsItem, vDsMotivo
		numeric vQtAlocar, vNrStatus
	endvariables

	vDsRegistro = ""
	putitem/id vDsRegistro, "CD_EMPRESA", CD_EMPRESA.PCP_OPISVC
	putitem/id vDsRegistro, "NR_CICLO", NR_CICLO.PCP_OPISVC
	putitem/id vDsRegistro, "NR_OP", NR_OP.PCP_OPISVC
	putitem/id vDsRegistro, "DT_PREVENTREGA", getFieldData("DT_PREVENTREGA", "PCP_OPCSVC", vDsRegistro)
	putitem/id vDsRegistro, "CD_PROCESSO", piCdProcesso
	putitem/id vDsRegistro, "CD_RECEITA", piCdReceita

	vDsItem = vDsRegistro

	setocc "PCP_OPISVC", 1
	while ($status &gt;= 0)
		putitem/id vDsItem, "CD_PRODUTO", CD_PRODUTO.PCP_OPISVC
		vQtAlocar += getQtAlocarItemOp(vDsItem, piCdProcesso, piCdMaquina, &lt;FALSE&gt;, vDsMotivo, "")
		vNrStatus = $status
		if (vDsMotivo != "")
			putitem/id vDsRegistro, "DS_MOTIVO", vDsMotivo
 			$lstItensDescartados$ = adicionarRegistroLista(vDsRegistro, $lstItensDescartados$, "DS_LSTOPPROC")
		endif
		if (vNrStatus &lt; 0)
			return(piDsRetorno)
		endif
		setocc "PCP_OPISVC", $curocc("PCP_OPISVC") + 1
	endwhile

	putitem/id vDsRegistro, "QT_ALOCAR", vQtAlocar
	piDsRetorno = adicionarRegistroLista(vDsRegistro, piDsRetorno, "DS_LST_OP")

	return(piDsRetorno)
end ;addOpOrigempartida

;-------------------------
entry getQtAlocarAgrupador
	;----------------------
	returns numeric
	params
		string piParams : INOUT
		numeric piCdProcesso : IN
		numeric piCdMaquina : IN
		string piDsEntity : IN
		boolean piInConverter : IN
		date poDtPrevEntrega : OUT
		string poDsLstItem : OUT
		numeric piCdProcAnt : IN
	endparams
	variables
		string vDsField, vDsParams, vDsRegistro, vDsMotivo, vTpConversao
		numeric vQtReal, vTpQuantidade, vCdCategoria, vQtAlocar, vQtItem, vNrStatus, vQtItemOri
		date vDtPrevEntrega
		boolean vInDisponivel
	endvariables

	if($item("TP_CONVERSAO", piParams) != "")
		vTpConversao = $item("TP_CONVERSAO", piParams)
	else
		vTpConversao = "MUL"
	endif

	if (piDsEntity = "")
		if (getMaqConfPar("TP_ITEM", piCdMaquina) = 1)
			piDsEntity = "PCP_AGRUOPISVC"
		else
			piDsEntity = "PCP_AGRUOPILISVC"
		endif
	endif

	vQtAlocar = ""

	clear/e "%%piDsEntity"
	if (piDsEntity = "PCP_AGRUOPISVC")
		vDsField = "CD_EMPRESA.%%piDsEntity"
	else
		vDsField = "CD_EMPAGRUPADOR.%%piDsEntity"
	endif
	@vDsField/init = $item("CD_EMPRESA", piParams)
	vDsField = "NR_AGRUPADOR.%%piDsEntity"
	@vDsField/init = $item("NR_AGRUPADOR", piParams)
	retrieve/e "%%piDsEntity"
	if ($status &gt;= 0)
		vInDisponivel = &lt;TRUE&gt;
		setocc "%%piDsEntity", 1
		while ($status &gt;= 0)
			if (piDsEntity = "PCP_AGRUOPISVC")
				vDsParams = ""
				putitem/id vDsParams, "CD_EMPRESA", CD_EMPOPI.PCP_AGRUOPISVC
				putitem/id vDsParams, "NR_CICLO", NR_CICLO.PCP_AGRUOPISVC
				putitem/id vDsParams, "NR_OP", NR_OP.PCP_AGRUOPISVC
				vDtPrevEntrega = getFieldData("DT_PREVENTREGA", "PCP_OPCSVC", vDsParams)
				if(vDtPrevEntrega &lt; poDtPrevEntrega | poDtPrevEntrega = "")
					poDtPrevEntrega = vDtPrevEntrega
				endif
				putitem/id vDsParams, "CD_PRODUTO", CD_PRODUTO.PCP_AGRUOPISVC
				putitem/id vDsParams, "TP_CONVERSAO", vTpConversao
				vQtItem = getQtAlocarItemOp(vDsParams, piCdProcesso, piCdMaquina, piInConverter, vDsMotivo, vQtItemOri)
				vNrStatus = $status
				if(vDsMotivo != "")
					vDsRegistro = vDsParams
					putitem/id vDsRegistro, "CD_EMPAGRUPADOR", CD_EMPRESA.PCP_AGRUOPISVC
					putitem/id vDsRegistro, "NR_AGRUPADOR", NR_AGRUPADOR.PCP_AGRUOPISVC
					putitem/id vDsRegistro, "CD_PROCESSO", piCdProcesso
					putitem/id vDsRegistro, "DS_MOTIVO", vDsMotivo
					$lstItensDescartados$ = adicionarRegistroLista(vDsRegistro, $lstItensDescartados$, "DS_LSTITEMOPAGRUP")
				endif
				if (vNrStatus &lt; 0)
					return("")
				endif
				;--&gt; MNSANTOS - Prj 217/240 - 11/05/2016
				if(vQtItem = 0)
					return(0)
				endif
				;--&lt;MNSANTOS
				vQtAlocar += vQtItem
				putitem/id vDsParams, "CD_EMPAGRUPADOR", CD_EMPRESA.PCP_AGRUOPISVC
				putitem/id vDsParams, "NR_AGRUPADOR", NR_AGRUPADOR.PCP_AGRUOPISVC
				putitem/id vDsParams, "CD_EMPOP", CD_EMPOPI.PCP_AGRUOPISVC
				putitem/id vDsParams, "QT_PARTIDA", vQtItem
				putitem/id vDsParams, "TP_ORIGEM", 1 ;- Item O.P.
				putitem/id vDsParams, "QT_ITEM", vQtItemOri
				putitem poDsLstItem, -1, vDsParams
			else
				vDsParams = ""
				putitem/id vDsParams, "CD_EMPRESA", CD_EMPOP.PCP_AGRUOPILISVC
				putitem/id vDsParams, "NR_CICLO", NR_CICLO.PCP_AGRUOPILISVC
				putitem/id vDsParams, "NR_OP", NR_OP.PCP_AGRUOPILISVC
				vCdCategoria = getFieldData("CD_CATEGORIA", "PCP_OPCADICSVC", vDsParams)
				vDtPrevEntrega = getFieldData("DT_PREVENTREGA", "PCP_OPCSVC", vDsParams)
				if(vDtPrevEntrega &lt; poDtPrevEntrega | poDtPrevEntrega = "")
					poDtPrevEntrega = vDtPrevEntrega
				endif
				putitem/id vDsParams, "CD_PRODUTO", CD_PRODUTO.PCP_AGRUOPILISVC
				putitem/id vDsParams, "NR_LOTE", NR_LOTE.PCP_AGRUOPILISVC
				putitem/id vDsParams, "NR_ITEM", NR_ITEM.PCP_AGRUOPILISVC
				putitem/id vDsParams, "TP_CONVERSAO", vTpConversao
				vQtItem = getQtAlocarItemLote(vDsParams, piCdProcesso, piCdMaquina, piInConverter, vDsMotivo, vQtItemOri)
				vNrStatus = $status
				if(vDsMotivo != "")
					vDsRegistro = vDsParams
					putitem/id vDsRegistro, "CD_EMPAGRUPADOR", CD_EMPAGRUPADOR.PCP_AGRUOPILISVC
					putitem/id vDsRegistro, "NR_AGRUPADOR", NR_AGRUPADOR.PCP_AGRUOPILISVC
					putitem/id vDsRegistro, "CD_PROCESSO", piCdProcesso
					putitem/id vDsRegistro, "DS_MOTIVO", vDsMotivo
					$lstItensDescartados$ = adicionarRegistroLista(vDsRegistro, $lstItensDescartados$, "DS_LSTITEMLOTEAGRUP")
				endif
				if (vNrStatus &lt; 0)
					return("")
				endif
				;--&gt; MNSANTOS - Prj 217/240 - 11/05/2016
				if(vQtItem = 0)
					return(0)
				endif
				;--&lt;MNSANTOS
				vQtAlocar += vQtItem
				putitem/id vDsParams, "CD_EMPAGRUPADOR", CD_EMPAGRUPADOR.PCP_AGRUOPILISVC
				putitem/id vDsParams, "NR_AGRUPADOR", NR_AGRUPADOR.PCP_AGRUOPILISVC
				putitem/id vDsParams, "CD_EMPOP", CD_EMPOP.PCP_AGRUOPILISVC
				putitem/id vDsParams, "QT_PARTIDA", vQtItem
				putitem/id vDsParams, "TP_ORIGEM", 2 ;- Item Lote O.P.
				putitem/id vDsParams, "QT_ITEM", vQtItemOri
				putitem poDsLstItem, -1, vDsParams
			endif

			if(vInDisponivel)
				vDsParams = ""
				if (piDsEntity = "PCP_AGRUOPISVC")
					putitem/id vDsParams, "CD_EMPRESA", CD_EMPOPI.PCP_AGRUOPISVC
					putitem/id vDsParams, "NR_CICLO", NR_CICLO.PCP_AGRUOPISVC
					putitem/id vDsParams, "NR_OP", NR_OP.PCP_AGRUOPISVC
					putitem/id vDsParams, "CD_PRODUTO", CD_PRODUTO.PCP_AGRUOPISVC
					putitem/id vDsParams, "CD_MAQUINA", piCdMaquina
					putitem/id vDsParams, "CD_PROCESSOANT", piCdProcAnt
					putitem/id vDsParams, "QT_ALOCAR", vQtItem
				else
					putitem/id vDsParams, "CD_EMPRESA", CD_EMPOP.PCP_AGRUOPILISVC
					putitem/id vDsParams, "NR_CICLO", NR_CICLO.PCP_AGRUOPILISVC
					putitem/id vDsParams, "NR_OP", NR_OP.PCP_AGRUOPILISVC
					putitem/id vDsParams, "CD_PRODUTO", CD_PRODUTO.PCP_AGRUOPILISVC
					putitem/id vDsParams, "NR_LOTE", NR_LOTE.PCP_AGRUOPILISVC
					putitem/id vDsParams, "NR_ITEM", NR_ITEM.PCP_AGRUOPILISVC
					putitem/id vDsParams, "CD_MAQUINA", piCdMaquina
					putitem/id vDsParams, "CD_PROCESSOANT", piCdProcAnt
					putitem/id vDsParams, "QT_ALOCAR", vQtItem
				endif
				vInDisponivel = inProcessoDisponivel(vDsParams)
			endif
			setocc "%%piDsEntity", $curocc("%%piDsEntity") + 1
		endwhile
	endif

	putitem/id piParams, "IN_DISPONIVEL", vInDisponivel

	return(vQtAlocar)
end ;getQtAlocarAgrupador

;----------------------
entry getQtAlocarItemOp
	;-------------------
	returns numeric
	params
		string piParams : IN
		numeric piCdProcesso : IN
		numeric piCdMaquina : IN
		boolean piInConverter : IN
		string poDsMotivo : OUT
		numeric poQtItem : OUT
	endparams
	variables
		numeric vQtAlocar, vTpQuantidade
		string vTpConversao
	endvariables

	if($item("TP_CONVERSAO", piParams) != "")
		vTpConversao = $item("TP_CONVERSAO", piParams)
	else
		vTpConversao = "MUL"
	endif

	vQtAlocar = ""

	if (getMaqConfPar("TP_PARTIDA", piCdMaquina) = 2)
		;- Maquina configurada para alocação sem quantidade definida.
		return("")
	endif

	vTpQuantidade = getMaqConfPar("TP_QUANTIDADE", piCdMaquina)

	if (vTpQuantidade &gt; 1)
		;- Configuração de quantidade da máquina tem que ser 'Quantidade da O.P.' para alocar item de O.P.
		poDsMotivo = "Configuração de quantidade da máquina tem que ser 'Quantidade da O.P.' para alocar item de O.P."
		return("")
	endif

	vQtAlocar = getFieldData("QT_REAL", "PCP_OPISVC", piParams)

	putitem/id piParams, "CD_EMPOP", $item("CD_EMPRESA", piParams)
	delitem/id piParams, "CD_EMPRESA"

	if (piCdProcesso != "")
		putitem/id piParams, "CD_PROCESSO", piCdProcesso
		putitem/id piParams, "TP_SITUACAO", "0&uSEP;1&uSEP;4" ;- Aguardando, Andamento e Encerrada
		vQtAlocar -= getQtAlocadaPartida(piParams, 1)
		if ($status &lt; 0)
			if($xCtxErro$ != "")
				poDsMotivo = $item("DESCRICAO", $xCtxErro$)
			endif
			return("")
		endif
	endif

	poQtItem = vQtAlocar

	if (piInConverter)
		putitem/id piParams, "CD_MAQUINA", piCdMaquina
		putitem/id piParams, "CD_PROCESSO", piCdProcesso
		vQtAlocar = converterQtProduto(piParams, vQtAlocar, vTpConversao)
		if ($status &lt; 0)
			if($xCtxErro$ != "")
				poDsMotivo = $item("DESCRICAO", $xCtxErro$)
			endif
			return("")
		endif
	endif

	return(vQtAlocar)
end ;getQtAlocarItemOp

;------------------------
entry getQtAlocarItemLote
	;---------------------
	returns numeric
	params
		string piParams : IN
		numeric piCdProcesso : IN
		numeric piCdMaquina : IN
		boolean piInConverter : IN
		string poDsMotivo : OUT
		numeric poQtItem : OUT
	endparams
	variables
		string vDsParams, vTpConversao
		numeric vQtAlocar, vTpQuantidade, vCdCategoria
	endvariables

	if($item("TP_CONVERSAO", piParams) != "")
		vTpConversao = $item("TP_CONVERSAO", piParams)
	else
		vTpConversao = "MUL"
	endif

	vQtAlocar = ""

	if (getMaqConfPar("TP_PARTIDA", piCdMaquina) = 2)
		;- Maquina configurada para alocação sem quantidade definida.
		return("")
	endif

	vTpQuantidade = getMaqConfPar("TP_QUANTIDADE", piCdMaquina)

	vDsParams = ""
	putitem/id vDsParams, "CD_EMPRESA", $item("CD_EMPRESA", piParams)
	putitem/id vDsParams, "NR_CICLO", $item("NR_CICLO", piParams)
	putitem/id vDsParams, "NR_OP", $item("NR_OP", piParams)
	vCdCategoria = getFieldData("CD_CATEGORIA", "PCP_OPCADICSVC", vDsParams)

	if (vTpQuantidade = 2)
		if (getFieldData("IN_REPROCESSO", "PCP_OPILOTEISVC", piParams) = &lt;TRUE&gt;)
			;&lt;-- DSantos Prj-&gt;217-571 27/07/2017
			;- Quando for item de lote de reprocesso, mesmo com quantidade calculada, deve retornar a quantidade do lote.
 			vQtAlocar = getFieldData("QT_LOTE", "PCP_OPILOTEISVC", piParams)
			; DSantos --&gt;
		else
			if (getFieldData("TP_OP", "PCP_CATEGOPSVC", "CD_CATEGORIA=%%vCdCategoria") = 1)
				vQtAlocar = getFieldData("QT_REVISADA", "PCP_OPILOTEISVC", piParams)
				vQtAlocar -= getQtDesmembradaItemLote(piParams) ;&lt;-- DSantos Prj-&gt;217-571 27/07/2017 --&gt;
				if(vQtAlocar = 0)
					poDsmotivo = "Máquina com quantidade calculada e item sem quantidade revisada"
				endif
			else
				vQtAlocar = getQtBaixadaMpPrincipal(piParams, "")
				if(vQtAlocar = 0)
					poDsmotivo = "Máquina com quantidade calculada e item sem quantidade baixada da M.P. principal"
				endif
			endif
		endif
	else
		vQtAlocar = getFieldData("QT_LOTE", "PCP_OPILOTEISVC", piParams)
	endif

	poQtItem = vQtAlocar

	if (piCdProcesso != "")
		putitem/id vDsParams, "CD_EMPOP", $item("CD_EMPRESA", piParams)
		delitem/id vDsParams, "CD_EMPRESA"
		putitem/id vDsParams, "NR_LOTE", $item("NR_LOTE", piParams)
		putitem/id vDsParams, "NR_ITEM", $item("NR_ITEM", piParams)
		putitem/id vDsParams, "CD_PROCESSO", piCdProcesso
		putitem/id vDsParams, "TP_SITUACAO", "0&uSEP;1&uSEP;4" ;- Aguardando, Andamento e Encerrada
		vQtAlocar -= getQtAlocadaPartida(vDsParams, 1)
		if ($status &lt; 0)
			if($xCtxErro$ != "")
				poDsMotivo = $item("DESCRICAO", $xCtxErro$)
			endif
			return("")
		endif
	endif

	if (piInConverter)
		putitem/id piParams, "CD_EMPOP", $item("CD_EMPRESA", piParams)
		putitem/id piParams, "CD_MAQUINA", piCdMaquina
		putitem/id piParams, "CD_PROCESSO", piCdProcesso
		vQtAlocar = converterQtProduto(piParams, vQtAlocar, vTpConversao)
		if ($status &lt; 0)
			if($xCtxErro$ != "")
				poDsMotivo = $item("DESCRICAO", $xCtxErro$)
			endif
			return("")
		endif
	endif

	$status = 0
	return(vQtAlocar)
end ;getQtAlocarItemLote

;----------------------------
entry getQtBaixadaMpPrincipal
	;-------------------------
	returns numeric
	params
		string piParams : IN
		string poParams : OUT ;-&gt;HSGARCIA Proj 253/296 DVAIND-1145 24/10/2018
	endparams
	variables
		numeric vQtBaixada, vQtItemLote, vQtItemOp, vPrConsumo, vQtDesmembrada
		string vDsCondicao, vDsRegMpI, vDsRegMp
	endvariables

	;vQtDesmembrada = getQtDesmembradaItemLote(piParams) ;&lt;-- DSantos Prj-&gt;217-571 27/07/2017 --&gt;;IAS - PRJ/TAR - 220/3967 - DVAIND-2643 - 19/02/2019

	vDsCondicao = ""
	putitem/id vDsCondicao, "CD_PRODUTOPA", $item("CD_PRODUTO", piParams)
	putitem/id vDsCondicao, "IN_PRINCIPAL", &lt;TRUE&gt;
	$handleEntity$-&gt;consultar("V_PCP_FC2SVC", vDsCondicao)
	if ($status &gt;= 0)
		putitem/id poParams, "CD_MPORIGEM", $item("CD_PRODUTOMP", getRegistro($handleEntity$)) ;-&gt;HSGARCIA Proj 253/296 DVAIND-1145 24/10/2018
		vDsCondicao = ""
		putitem/id vDsCondicao, "CD_EMPRESA", $item("CD_EMPRESA", piParams)
		putitem/id vDsCondicao, "NR_CICLO", $item("NR_CICLO", piParams)
		putitem/id vDsCondicao, "NR_OP", $item("NR_OP", piParams)
		putitem/id vDsCondicao, "CD_PRODUTOPA", $item("CD_PRODUTO", piParams)
		putitem/id vDsCondicao, "CD_PRODUTOMP", $item("CD_PRODUTOMP", getRegistro($handleEntity$))
		$handleEntity$-&gt;consultar("PCP_OPMPISVC", vDsCondicao)
		if ($status &gt;= 0)
			$handleEntity$-&gt;getRegistro(vDsRegMpI)
			vDsCondicao = ""
			putitem/id vDsCondicao, "CD_EMPRESA", $item("CD_EMPRESA", piParams)
			putitem/id vDsCondicao, "NR_CICLO", $item("NR_CICLO", piParams)
			putitem/id vDsCondicao, "NR_OP", $item("NR_OP", piParams)
			putitem/id vDsCondicao, "CD_PRODUTO", $item("CD_PRODUTOMP", vDsRegMpI)
			$handleEntity$-&gt;consultar("PCP_OPMPSVC", vDsCondicao)
			if ($status &gt;= 0)
				$handleEntity$-&gt;getRegistro(vDsRegMp)

				;&lt;-- DSantos Prj-&gt;220-1460 22/11/2016
				repeat
					delitem/id vDsCondicao, "CD_PRODUTO"
					putitem/id vDsCondicao, "CD_PRODSUBSTITUIDO", $item("CD_PRODUTOMP", vDsRegMpI)
					$handleEntity$-&gt;consultar("PCP_OPMPSVC", vDsCondicao)
					if ($status &gt;= 0)
						$handleEntity$-&gt;getRegistro(vDsRegMp)
						vDsCondicao = ""
						putitem/id vDsCondicao, "CD_EMPRESA", $item("CD_EMPRESA", piParams)
						putitem/id vDsCondicao, "NR_CICLO", $item("NR_CICLO", piParams)
						putitem/id vDsCondicao, "NR_OP", $item("NR_OP", piParams)
						putitem/id vDsCondicao, "CD_PRODUTOPA", $item("CD_PRODUTO", piParams)
						putitem/id vDsCondicao, "CD_PRODUTOMP", $item("CD_PRODUTO", vDsRegMp)
						$handleEntity$-&gt;consultar("PCP_OPMPISVC", vDsCondicao)
						if ($status &gt;= 0)
							$handleEntity$-&gt;getRegistro(vDsRegMpI)
						else
							return(0)
						endif
					endif
				until($status &lt; 0)
				; DSantos --&gt;

				vQtItemLote = getFieldData("QT_LOTE", "PCP_OPILOTEISVC", piParams); + vQtDesmembrada;IAS - PRJ/TAR - 220/3967 - DVAIND-2643 - 19/02/2019
				delitem/id piParams, "NR_LOTE"
				delitem/id piParams, "NR_ITEM"
				vQtItemOp = getFieldData("QT_REAL", "PCP_OPISVC", piParams)

				;- Identifica quanto da quantidade baixada corresponde para o item da O.P.
				vPrConsumo = (($item("QT_ESTIMADA", vDsRegMpI) * 100) / $item("QT_ESTIMADA", vDsRegMp))
				vQtBaixada = $item("QT_RETIRADA", vDsRegMp) - $item("QT_RETORNADA", vDsRegMp)
				vQtBaixada = ((vQtBaixada * vPrConsumo) / 100)

				;- Identifica quanto da quantidade baixada do item da O.P. corresponde para o item de lote
				vPrConsumo = ((vQtItemLote * 100) / vQtItemOp)
				vQtBaixada = ((vQtBaixada * vPrConsumo) / 100)

				vQtBaixada = vQtBaixada[round, 3]
				;vQtBaixada -= vQtDesmembrada;IAS - PRJ/TAR - 220/3967 - DVAIND-2643 - 19/02/2019

				;-&gt;HSGARCIA Proj 253/296 DVAIND-1145 24/10/2018
				putitem/id poParams, "CD_MPSUBSTITUTA", $item("CD_PRODUTO", vDsRegMp)
				putitem/id poParams, "QT_BAIXADA", vQtBaixada
				;&lt;-
			endif
		endif
	endif

	return(vQtBaixada)
end ;getQtBaixadaMpPrincipal

;-----------------------
entry converterQtProduto
	;--------------------
	returns numeric
	params
		string piParams : IN
		numeric piQtConverter : IN
		string piTpConversao : IN
	endparams
	variables
		string viParams, voParams, vCdReceita, vCdMaquina, vDsRegProcesso
		numeric vQtPeso, vQtConvertida, vQtRelBanho, vTpPartida, vQtPickup, vTpRestricao
		boolean vInPeso, vInVolume
	endvariables

	if (piTpConversao = "VOLUME")
		piTpConversao = "MUL"
		vInVolume = &lt;TRUE&gt;
		vQtPeso = piQtConverter
	else
		if ($cdEspecieKg$ = "")
			$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG35367", "DESCRICAO=Parâmetro CD_ESPECIE_KG não informado para a empresa @@1@@!&uSEP;PARAMETRO=%%$item("CD_EMPRESA", $$gParamGlb)", "ADICIONAL=Operação-&gt;CDFSVCO038.converteQtProduto")
			$status = -1
			return("")
		endif

		if (!inValidarParametro("CD_PRODUTO", piParams, "converterQtProduto"))
			$status = -1
			return("")
		endif

		if (piTpConversao = "MULP")
			piTpConversao = "MUL"
			vInPeso = &lt;TRUE&gt;
		elseif (piTpConversao = "MULV")
			piTpConversao = "MUL"
			vInVolume = &lt;TRUE&gt;
		endif

		if (getFieldData("CD_ESPECIE", "PRD_PRODUTOSVC", "CD_PRODUTO=%%$item("CD_PRODUTO", piParams)") != $cdEspecieKg$)
			;--&gt; MNSANTOS Prj 253 / 4
			vQtPeso = getPesoProduto(piParams)
			if($status &lt; 0)
				return("")
			endif
			;--&lt; MNSANTOS

			if (piTpConversao = "MUL")
				;- Converter
				vQtPeso = piQtConverter * vQtPeso
			else
				;- Desconventer
				vQtPeso = piQtConverter / vQtPeso
			endif
		else
			vQtPeso = piQtConverter
		endif

		if (vInPeso)
			return(vQtPeso)
		endif
	endif

	vCdMaquina = $item("CD_MAQUINA", piParams)
	if (vCdMaquina != "")
		vTpRestricao = getMaqConfPar("TP_RESTRICAO", vCdMaquina)
		vTpPartida = getMaqConfPar("TP_PARTIDA", vCdMaquina)
	else
		vTpPartida = $item("TP_PARTIDA", piParams)
		vTpRestricao = ""
	endif

	if (vTpRestricao = 2 &amp; !vInVolume)
		return(vQtPeso)
	endif

	$inCompMaq$ = &lt;FALSE&gt;

	vInVolume = &lt;FALSE&gt;
	if (vTpPartida = 1)
		;- Partida descontínua
		vCdReceita = $item("CD_RECEITA", piParams)
		if (vCdReceita = "" &amp; inValidarParametro("CD_EMPOP&uSEP;NR_CICLO&uSEP;NR_OP&uSEP;CD_PRODUTO&uSEP;CD_PROCESSO", piParams, "converterQtProduto"))
			viParams = ""
			putitem/id viParams, "CD_EMPRESA", $item("CD_EMPOP", piParams)
			putitem/id viParams, "NR_CICLO", $item("NR_CICLO", piParams)
			putitem/id viParams, "NR_OP", $item("NR_OP", piParams)
			putitem/id viParams, "CD_PRODUTO", $item("CD_PRODUTO", piParams)
			vDsRegProcesso = getProcessoOp(viParams, $item("CD_PROCESSO", piParams), &lt;TRUE&gt;, &lt;FALSE&gt;)
			vCdReceita = $item("CD_RECEITA", vDsRegProcesso)
		endif
		if (vCdReceita != "")
			vQtRelBanho = getQtRelBanhoReceita(vCdReceita)
			;&lt;-- DSantos Prj-&gt;217-511 30/05/2017
			if (vQtRelBanho = "")
				vQtRelBanho = getQtRelBanhoConfMaq(vCdMaquina, vQtPeso)
				if (vQtRelBanho != "")
					$inCompMaq$ = &lt;TRUE&gt;
				endif
			else
				$instancehandle-&gt;armazenarLog(-1, vCdReceita, "", vQtRelBanho)
			endif
			; DSantos --&gt;
			if (vQtRelBanho != "")
				vInVolume = &lt;TRUE&gt;
				if (piTpConversao = "MUL")
					;- Converter
					vQtConvertida = vQtPeso * vQtRelBanho
				else
					;- Desconventer
					vQtConvertida = vQtPeso / vQtRelBanho
				endif
			;&lt;-- DSantos Prj-&gt;217-511 30/05/2017
			else
				putitem/id viParams, "QT_CONE", $item("QT_CONE", piParams)
				vQtConvertida = getVolumeConfMaq(vCdMaquina, getQtConeItemOp(viParams, piQtConverter))
				if (vQtConvertida &gt; 0 &amp; piTpConversao = "MUL")
					vInVolume = &lt;TRUE&gt;
					$inCompMaq$ = &lt;TRUE&gt;
				else
					vQtRelBanho = getFieldData("QT_RELBANHO", "CDF_GMAQBENSVC", "CD_SEQMAQ=%%getFieldData("CD_SEQMAQ", "CDF_MAQGMAQSVC", "CD_MAQUINA=%%vCdMaquina")")
					if (vQtRelBanho != "")
						$instancehandle-&gt;armazenarLog(-4, vCdMaquina, "", vQtRelBanho)
						vInVolume = &lt;TRUE&gt;
						if (piTpConversao = "MUL")
							;- Converter
							vQtConvertida = vQtPeso * vQtRelBanho
						else
							;- Desconventer
							vQtConvertida = vQtPeso / vQtRelBanho
						endif
					endif
				endif
			endif
			; DSantos --&gt;
		endif
	elseif (vTpPartida = 3)
		;- Contínua com quantidade definida
		vQtPickup = getInfTecConf($item("CD_PRODUTO", piParams), vCdMaquina, "", $item("CD_PROCESSO", piParams), 2, 21)
		if (vQtPickup = "")
			vQtPickup = getFieldData("PR_PICKUP", "CDF_GMAQPROCESSOSVC", "CD_SEQMAQ=&uEQ;%%getFieldData("CD_SEQMAQ", "CDF_MAQGMAQSVC", "CD_MAQUINA=%%vCdMaquina")&uSEP;CD_PROCESSO=%%$item("CD_PROCESSO", piParams)&uSEP;TP_PROCESSO=1")
		endif
		if (vQtPickup &gt; 0)
			vInVolume = &lt;TRUE&gt;
			if (piTpConversao = "MUL")
				;- Converter
				vQtConvertida = vQtPeso * vQtPickup
			else
				;- Desconventer
				vQtConvertida = vQtPeso / vQtPickup
			endif
		endif
	endif

	if (vTpRestricao = 1 &amp; !vInVolume)
		$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG39755", "DESCRICAO=Máquina com restrição de partida por volume e o item não possuí volume calculado!", "ADICIONAL=Operação-&gt;CDFSVCO038.converteQtProduto")
		$status = -1
		return("")
	endif

	return(vQtConvertida)
end ;converterQtProduto

;------------------
entry getInfTecConf
	;---------------
	returns string
	params
		numeric piCdProduto : IN
		numeric piCdMaquina : IN
		numeric piCdAplicacao : IN
		numeric piCdProcesso : IN
		numeric piTpConf : IN
		numeric piCdConf : IN
	endparams
	variables
		string viParams, voParams
	endvariables

	viParams = $dsPartidaPadraoTec$
	putitem/id viParams, "CD_PRODUTO", piCdProduto
	putitem/id viParams, "CD_MAQUINA", piCdMaquina
	putitem/id viParams, "CD_APLICACAO", piCdAplicacao
	putitem/id viParams, "CD_PROCESSO", piCdProcesso
	putitem/id viParams, "TP_CONF" , piTpConf
	putitem/id viParams, "CD_CONF", piCdConf
	activate "PCPSVCO047".buscarDadosConf(viParams, voParams, $xCdErro$, $xCtxErro$)
	if ($procerror)
		$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
		$status = -1
		return("")
	elseif ($status &lt; 0)
		return("")
	endif

	return($replace($item("DS_CAMPO", voParams), 1, ",", ".", -1))
end ;getInfTecConf

;--------------------------
entry getDadosPadraoTecnico
	;-----------------------
	;&lt;-- DSantos Prj-&gt;217-730 22/02/2018 --&gt;
	returns string
	params
		numeric piCdConf : IN
		numeric piCdProduto : IN
		numeric piCdMaquina : IN
		numeric piCdProcesso : IN
		numeric piCdEmpresa : IN
		numeric piNrPartida : IN
	endparams
	variables
		string vDsRetorno
	endvariables

	$dsPartidaPadraoTec$ = ""
	putitem/id $dsPartidaPadraoTec$, "CD_EMPPARTIDA", piCdEmpresa
	putitem/id $dsPartidaPadraoTec$, "NR_PARTIDA", piNrPartida

	vDsRetorno = getInfTecConf(piCdProduto, piCdMaquina, "", piCdProcesso, 2, piCdConf)

	$dsPartidaPadraoTec$ = ""

	return(vDsRetorno)
end ;getDadosPadraoTecnico

;-----------------------
entry getDadosIntegracao
	;--------------------
	returns string
	params
		string piCdProduto : IN
		numeric piCdAplicacao : IN
		numeric piCdCampoInt : IN
	endparams
	variables
		string viParams, voParams
	endvariables

	viParams = ""
	putitem/id viParams, "CD_CAMPOINT", piCdCampoInt
	putitem/id viParams, "CD_PRODUTO", piCdProduto
	putitem/id viParams, "CD_APLICACAO", piCdAplicacao
	activate "PCPSVCO047".buscarDadosIntegracao(viParams, voParams, $xCdErro$, $xCtxErro$)
	if ($procerror)
		$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
		$status = -1
		return("")
	elseif ($status &lt; 0)
		return("")
	endif

	return($replace($item("DS_CAMPO", voParams), 1, ",", ".", -1))
end ;getDadosIntegracao

;;--------------
;entry getQtCone
;;--------------
;	;--&gt; MNSANTOS - Prj 217/195 - 23/02/2015
;	returns numeric
;	params
;		numeric piCdEmpresa : IN
;		numeric piNrCiclo : IN
;		numeric piNrOp : IN
;		numeric piCdProduto : IN
;		numeric piQtProduto : IN
;	endparams
;	variables
;		numeric vQtCone, vQtPesoLiquido, vQtEstimada, vQtConsumo
;		string vDsCondicao, vDsRegistro
;	endvariables
;
;	if(piCdEmpresa != "" &amp; piNrCiclo != "" &amp; piNrOp != "" &amp; piCdProduto != "" &amp; piQtProduto != "")
;		vDsCondicao = ""
;		putitem/id vDsCondicao, "CD_EMPRESA", piCdEmpresa
;		putitem/id vDsCondicao, "NR_CICLO", piNrCiclo
;		putitem/id vDsCondicao, "NR_OP", piNrOp
;		putitem/id vDsCondicao, "CD_PRODUTOPA", piCdProduto
;		$handleEntity$-&gt;consultar("PCP_OPMPISVC", vDsCondicao)
;		if($status &gt;= 0)
;			$handleEntity$-&gt;setEntityOcc(1)
;			while($status &gt;= 0)
;				$handleEntity$-&gt;getRegistro(vDsRegistro)
;				if($item("QT_PESOLIQUIDO", vDsRegistro) != "")
;					vQtPesoLiquido = $item("QT_PESOLIQUIDO", vDsRegistro)
;				else
;					vQtPesoLiquido = getFieldData("QT_PESOLIQUIDO", "PRD_PRODUTOFSVC", "CD_PRODUTO=%%$item("CD_PRODUTOMP", vDsRegistro)")
;				endif
;				if(vQtPesoLiquido &gt; 0 &amp; getFieldData("QT_ESTIMADA", "PCP_OPISVC", "CD_EMPRESA=%%piCdEmpresa&uSEP;NR_CICLO=%%piNrCiclo&uSEP;NR_OP=%%piNrOp") != "")
;					vQtConsumo = $item("QT_ESTIMADA", vDsRegistro) / getFieldData("QT_ESTIMADA", "PCP_OPISVC", "CD_EMPRESA=%%piCdEmpresa&uSEP;NR_CICLO=%%piNrCiclo&uSEP;NR_OP=%%piNrOp")
;					vQtEstimada = piQtProduto * vQtConsumo
;					vQtCone += (vQtEstimada / vQtPesoLiquido)
;					if($frac(vQtCone) &gt; 0)
;						vQtCone += 1
;					endif
;					vQtCone = vQtCone[trunc]
;				endif
;				$handleEntity$-&gt;next()
;			endwhile
;		endif
;	endif
;
;	return(vQtCone)
;end ;getQtCone

;---------------------
entry getNrNovaPartida
	;------------------
	returns numeric
	params
		numeric piCdEmpresa : IN
	endparams
	variables
		numeric vNrPartida
		handle vHdInstance
	endvariables

	repeat
		newinstance "GERSVCO001", vHdInstance, "TRANSACTION=TRUE"
		vHdInstance-&gt;GetNumSeqEmp($$gParamGlb, piCdEmpresa, "CDF_PARTIDA", "NR_PARTIDA", 999999999, vNrPartida, $xCdErro$, $xCtxErro$)
		if ($procerror)
			$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;,$procerror,$procerrorcontext,"")
			return("")
		elseif ($status &lt; 0)
			return ("")
		endif
	until (getFieldData("NR_PARTIDA", "CDF_PARTIDASVC", "CD_EMPRESA=%%piCdEmpresa&uSEP;NR_PARTIDA=%%vNrPartida") = "")

	return(vNrPartida)
end ;getNrNovaPartida

;----------------------
entry getNrOrdemPartida
	;-------------------
	returns numeric
	params
		numeric piCdEmpresa : IN
		numeric piCdMaquina : IN
	endparams
	variables
		numeric vNrOrdem
	endvariables

	selectdb max(NR_ORDEM) from "CDF_PARTIDASVC" u_where CD_EMPRESA.CDF_PARTIDASVC = piCdEmpresa &amp; CD_MAQUINA.CDF_PARTIDASVC = piCdMaquina to vNrOrdem
	vNrOrdem += 1

	return(vNrOrdem)
end ;getNrOrdemPartida

;------------------------
entry getNrSeqItemPartida
	;---------------------
	returns numeric
	params
		numeric piCdEmpresa : IN
		numeric piNrPartida : IN
	endparams
	variables
		numeric vNrSequencia
	endvariables

	selectdb max(NR_SEQUENCIA) from "CDF_PARTIDAISVC" u_where CD_EMPRESA.CDF_PARTIDAISVC = piCdEmpresa &amp; NR_PARTIDA.CDF_PARTIDAISVC = piNrPartida to vNrSequencia
	vNrSequencia += 1

	return(vNrSequencia)
end ;getNrSeqItemPartida

;-------------------------------
entry getQtReferenciaItemPartida
	;----------------------------
	returns numeric
	params
		string piParams : IN
		numeric piQtAlocar : IN
		numeric piTpOrigem : IN
		numeric piQtReferencia : IN
	endparams
	variables
		numeric vQtCalculada, vQtOrigem, vQtReferencia
		string vDsParams
	endvariables

	if (piQtReferencia != "")
		return(piQtReferencia)
	endif

	selectcase piTpOrigem
	case 1 ;- Ordem de produção
		vQtReferencia = piQtAlocar
	case 2 ;- Item de lote
		vDsParams = ""
		putitem/id vDsParams, "CD_EMPRESA", $item("CD_EMPOP", piParams)
		putitem/id vDsParams, "NR_CICLO", $item("NR_CICLO", piParams)
		putitem/id vDsParams, "NR_OP", $item("NR_OP", piParams)
		putitem/id vDsParams, "CD_PRODUTO", $item("CD_PRODUTO", piParams)
		putitem/id vDsParams, "NR_LOTE", $item("NR_LOTE", piParams)
		putitem/id vDsParams, "NR_ITEM", $item("NR_ITEM", piParams)
		vQtCalculada = getQtAlocarItemLote(vDsParams, "", $item("CD_MAQUINA", piParams), &lt;FALSE&gt;, "", "")
		if ($status &lt; 0)
			return("")
		endif
		vQtOrigem = getFieldData("QT_LOTE", "PCP_OPILOTEISVC", vDsParams)
		vQtReferencia = ((piQtAlocar * vQtOrigem) / vQtCalculada)
	endselectcase

	return(vQtReferencia)
end ;getQtReferenciaItemPartida

;-------------------------------
entry inValidarAgrupadorProcesso
	;----------------------------
	returns boolean
	params
		string piParams : IN
		numeric piCdProcesso : IN
		numeric piCdMaquina : IN
		string piCdReceita : IN
		string piDsEntity : IN
	endparams
	variables
		string vDsField, vDsFields, viParams, voParams, vDsParams, vDsRegistro, vDsMotivo, vDsRegProcesso
		numeric vCdSeqMaq
	endvariables

	vDsRegistro = "%%$item("CD_EMPRESA", piParams)%%$item("NR_AGRUPADOR", piParams)%%piCdProcesso%%piCdMaquina"
	if ($item(vDsRegistro, $dsLstProcMaq$) = &lt;TRUE&gt;)
		return(1)
	endif

	clear/e "%%piDsEntity"
	if (piDsEntity = "PCP_AGRUOPISVC")
		vDsField = "CD_EMPRESA.%%piDsEntity"
		vDsFields = "CD_EMPOPI&uSEP;NR_CICLO&uSEP;NR_OP&uSEP;CD_PRODUTO"
	else
		vDsField = "CD_EMPAGRUPADOR.%%piDsEntity"
		vDsFields = "CD_EMPOP&uSEP;NR_CICLO&uSEP;NR_OP&uSEP;CD_PRODUTO"
	endif
	@vDsField/init = $item("CD_EMPRESA", piParams)
	vDsField = "NR_AGRUPADOR.%%piDsEntity"
	@vDsField/init = $item("NR_AGRUPADOR", piParams)
	retrieve/e "%%piDsEntity"
	if ($status &gt;= 0)
		setocc "%%piDsEntity", 1
		while ($status &gt;= 0)
			vDsParams = ""
			vDsField = "%%$itemnr(1, vDsFields)%%%.%%piDsEntity"
			putitem/id vDsParams, "CD_EMPRESA", @vDsField
			vDsField = "%%$itemnr(2, vDsFields)%%%.%%piDsEntity"
			putitem/id vDsParams, "NR_CICLO", @vDsField
			vDsField = "%%$itemnr(3, vDsFields)%%%.%%piDsEntity"
			putitem/id vDsParams, "NR_OP", @vDsField
			vDsField = "%%$itemnr(4, vDsFields)%%%.%%piDsEntity"
			putitem/id vDsParams, "CD_PRODUTO", @vDsField

			vDsRegistro = vDsParams
 			putitem/id vDsRegistro, "CD_PROCESSO", piCdProcesso
			putitem/id vDsRegistro, "CD_EMPAGRUPADOR", $item("CD_EMPRESA", piParams)
			putitem/id vDsRegistro, "NR_AGRUPADOR", $item("NR_AGRUPADOR", piParams)

			vDsRegProcesso = getProcessoOp(vDsParams, piCdProcesso, &lt;FALSE&gt;, &lt;FALSE&gt;)
			if ($itemcount(vDsRegProcesso) &gt; 0)
				if (piCdReceita != $item("CD_RECEITA", vDsRegProcesso))
					putitem/id vDsRegistro, "DS_MOTIVO", "Receita diferente para o processo entre os itens"
					$lstItensDescartados$ = adicionarRegistroLista(vDsRegistro, $lstItensDescartados$, "DS_LSTITEMOPAGRUP")
					return(0)
				endif
				vCdSeqMaq = $item("CD_SEQMAQ", vDsRegProcesso)
				if (!inValidarMaquinaProcesso(piCdProcesso, vCdSeqMaq, piCdMaquina, vDsMotivo))
					putitem/id vDsRegistro, "DS_MOTIVO", vDsMotivo
					$lstItensDescartados$ = adicionarRegistroLista(vDsRegistro, $lstItensDescartados$, "DS_LSTITEMOPAGRUP")
					return(0)
				endif
			else
				putitem/id vDsRegistro, "DS_MOTIVO", "Item sem sequência de processo"
				$lstItensDescartados$ = adicionarRegistroLista(vDsRegistro, $lstItensDescartados$, "DS_LSTAGRUP")
				return(0)
			endif

			setocc "%%piDsEntity", $curocc("%%piDsEntity") + 1
		endwhile
	endif

	vDsRegistro = "%%$item("CD_EMPRESA", piParams)%%$item("NR_AGRUPADOR", piParams)%%piCdProcesso%%piCdMaquina"
	putitem/id $dsLstProcMaq$, vDsRegistro, &lt;TRUE&gt;

	return(1)
end ;inValidarAgrupadorProcesso

;------------------------
entry getQtAlocadaPartida
	;---------------------
	returns numeric
	params
		string piParams : IN
		numeric piTpCalculo : IN
	endparams
	variables
		string vDsField, vDsParams, vDsTipo, vDsFields
		numeric vQtAlocada, vQtConverter
	endvariables

	clear/e "V_CDF_PARTIDASVC"
	vDsFields = getEntityFields("V_CDF_PARTIDASVC", 3)
	while (piParams != "")
		vDsField = $idpart($itemnr(1, piParams))
		if ($item(vDsField, vDsFields) = vDsField)
			vDsField = "%%vDsField%%%.V_CDF_PARTIDASVC"
			@vDsField/init = "&uEQ;%%$valuepart($itemnr(1, piParams))"
		endif
		delitem piParams, 1
	endwhile
	retrieve/e "V_CDF_PARTIDASVC"
	if ($status &gt;= 0)
		sort/e "V_CDF_PARTIDASVC", "CD_PRODUTO"
		setocc "V_CDF_PARTIDASVC", 1
		while ($status &gt;= 0)
			if (piTpCalculo = 1)
				;- Partida
				vQtAlocada += QT_PARTIDA.V_CDF_PARTIDASVC
			else
				selectcase piTpCalculo
				case 2 ;- Calculado
					vDsTipo = "MUL"
				case 3 ;- Peso
					vDsTipo = "MULP"
				case 4 ;- Volume
					vDsTipo = "MULV"
				endselectcase
				;&lt;-- DSantos Prj-&gt;217-511 31/05/2017
				vQtConverter += QT_PARTIDA.V_CDF_PARTIDASVC
				if (CD_PRODUTO.V_CDF_PARTIDASVC != $next(CD_PRODUTO.V_CDF_PARTIDASVC))
					vDsParams = ""
					putlistitems/occ vDsParams, "V_CDF_PARTIDASVC"
					vQtAlocada += converterQtProduto(vDsParams, vQtConverter, vDsTipo)
					if ($status &lt; 0)
						return("")
					endif
					vQtConverter = ""
				endif
				;&lt;-- DSantos Prj-&gt;217-730 21/02/2018
				if ($inConePartidaAlocada$)
					vDsParams = ""
					putlistitems/occ vDsParams, "V_CDF_PARTIDASVC"
					$qtConePartidaAlocada$ += getQtConeItemOp(vDsParams, QT_PARTIDA.V_CDF_PARTIDASVC)
				endif
				; DSantos --&gt;
			endif
			setocc "V_CDF_PARTIDASVC", $curocc("V_CDF_PARTIDASVC") + 1
		endwhile
	endif

	$status = 0
	return(vQtAlocada)
end ;getQtAlocadaPartida

;----------------------------
entry getQtAlocadaPartidaCone
	;-------------------------
	;&lt;-- DSantos Prj-&gt;217-730 21/02/2018 --&gt;
	returns numeric
	params
		string piParams : IN
		numeric piTpCalculo : IN
		numeric poQtCone : OUT
	endparams
	variables
		numeric vQtAlocada
	endvariables

	$qtConePartidaAlocada$ = ""
	$inConePartidaAlocada$ = &lt;TRUE&gt;

	vQtAlocada = getQtAlocadaPartida(piParams, piTpCalculo)

	poQtCone = $qtConePartidaAlocada$

	$inConePartidaAlocada$ = &lt;FALSE&gt;
	$qtConePartidaAlocada$ = ""

	return(vQtAlocada)
end ;getQtAlocadaPartidaCone

;-------------------------
entry getCapacidadeMaquina
	;----------------------
	returns numeric
	params
		numeric piCdMaquina : IN
		boolean piInMinimo : IN
	endparams
	variables
		numeric vQtCapacidade, vCdSeqMaq, vTpRestricao
		string vDsField
		boolean vInPeso
	endvariables

	vTpRestricao = getMaqConfPar("TP_RESTRICAO", piCdMaquina)
	if (vTpRestricao = 2)
		if (piInMinimo)
			vDsField = "QT_PESOMIN"
		else
			vDsField = "QT_PESOMAX"
		endif
	else
		if (piInMinimo)
			vDsField = "QT_VOLUMEMIN"
		else
			vDsField = "QT_VOLUMEMAX"
		endif
	endif

	vCdSeqMaq = getFieldData("CD_SEQMAQ", "CDF_MAQGMAQSVC", "CD_MAQUINA=%%piCdMaquina")
	vQtCapacidade = getFieldData(vDsField, "CDF_GMAQBENSVC", "CD_SEQMAQ=%%vCdSeqMaq")

	if (vQtCapacidade = 0 &amp; vTpRestricao = 2 &amp; !piInMinimo)
		vQtCapacidade = getFieldData("QT_CAPACIDADEPARTIDA", "CDF_GMAQSVC", "CD_SEQMAQ=%%vCdSeqMaq")
	endif

	if (vTpRestricao = 1)
		if (piInMinimo)
			vQtCapacidade += getFieldData("QT_LASTRO", "CDF_GMAQBENSVC", "CD_SEQMAQ=%%vCdSeqMaq")
		else
 			vQtCapacidade -= getFieldData("QT_LASTRO", "CDF_GMAQBENSVC", "CD_SEQMAQ=%%vCdSeqMaq")
		endif
	endif

	return(vQtCapacidade)
end ;getCapacidadeMaquina

;------------------------------------
entry inValidarProcessoMaquinaPartida
;------------------------------------
	returns boolean
	params
		string piParams : IN
	endparams
	variables
		string vDsParams, viParams, voParams, vDsRegProcesso
		numeric vCdSeqMaq
	endvariables

	vDsParams = ""
	putitem/id vDsParams, "CD_EMPRESA", $item("CD_EMPOP", piParams)
	putitem/id vDsParams, "NR_CICLO", $item("NR_CICLO", piParams)
	putitem/id vDsParams, "NR_OP", $item("NR_OP", piParams)
	putitem/id vDsParams, "CD_PRODUTO", $item("CD_PRODUTO", piParams)
	vDsRegProcesso = getProcessoOp(vDsParams, $item("CD_PROCESSO", piParams), &lt;FALSE&gt;, &lt;FALSE&gt;)
	if (!inValidarProcesso($item("CD_PRODUTO", piParams), $item("CD_PROCESSO", piParams), $item("CD_MAQUINA", piParams), $item("CD_RECEITA", vDsRegProcesso), ""))
		$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG39701", "DESCRICAO=Processo inválido para item alocado!", "ADICIONAL=Operação-&gt;CDFSVCO038.inValidarProcessoMaquinaPartida")
		return(0)
	endif
	if (!inValidarMaquinaProcesso($item("CD_PROCESSO", piParams), $item("CD_SEQMAQ", vDsRegProcesso), $item("CD_MAQUINA", piParams), ""))
		$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG39701", "DESCRICAO=Processo inválido para item alocado!", "ADICIONAL=Operação-&gt;CDFSVCO038.inValidarProcessoMaquinaPartida")
		return(0)
	endif

	return(1)
end ;inValidarProcessoMaquinaPartida

;-----------------------------
entry inVerificarOrdemAnterior
	;--------------------------
	returns boolean
	params
		numeric piNrOrdem : IN
		numeric piCdMaquina : IN
		boolean piInIniciar : IN
		string poParams : OUT
	endparams
	variables
		numeric vQtPartida
		string vDsTexto
	endvariables

	vQtPartida = getInfTecConf("", piCdMaquina, "", "", 4, 31)
	if(vQtPartida &lt;= 0)
		vQtPartida = 1
	endif
	if (piInIniciar)
		clear/e "F_CDF_PARTIDASVC"
		CD_EMPRESA.F_CDF_PARTIDASVC/init = $item("CD_EMPRESA", $$gParamGlb)
		CD_MAQUINA.F_CDF_PARTIDASVC/init = piCdMaquina
		NR_ORDEM.F_CDF_PARTIDASVC/init = "&uNOT;&uEQ;"
		TP_SITUACAO.F_CDF_PARTIDASVC/init = 1 ;- Em andamento
		retrieve/e "F_CDF_PARTIDASVC"
		if ($status &gt;= 0)
			setocc "F_CDF_PARTIDASVC", -1
			setocc "F_CDF_PARTIDASVC", 1
			if ($totocc("F_CDF_PARTIDASVC") &gt;= vQtPartida)
				$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG39497", "DESCRICAO=Máquina permite apenas @@1@@ partida(s) em andamento!&uSEP;PARAMETRO=%%vQtPartida", "ADICIONAL=Operação-&gt;CDFSVCO038.inVerificarOrdemAnterior")
				return(0)
			endif
		endif
	endif

	;Verifica se existe partida anterior não encerrada
	clear/e "F_CDF_PARTIDASVC"
	CD_EMPRESA.F_CDF_PARTIDASVC/init = $item("CD_EMPRESA", $$gParamGlb)
	CD_MAQUINA.F_CDF_PARTIDASVC/init = piCdMaquina
	NR_ORDEM.F_CDF_PARTIDASVC/init = "&uLT; %%piNrOrdem &amp; &uNOT;&uEQ;"
	if (piInIniciar)
		TP_SITUACAO.F_CDF_PARTIDASVC/init = 0 ;- Aguardando
	else
		;--&gt; MNSANTOS - Prj 253/229 - 25/09/2018
		if(vQtPartida &gt; 1)
			return(1)
		endif
		;--&lt; MNSANTOS
		TP_SITUACAO.F_CDF_PARTIDASVC/init = "0&uSEP;1" ;- Aguardando ou Em andamento
	endif
	retrieve/e "F_CDF_PARTIDASVC"
	if ($status &gt;= 0)
		poParams = ""
		sort/e "F_CDF_PARTIDASVC","NR_ORDEM.F_CDF_PARTIDASVC"
		setocc "F_CDF_PARTIDASVC", 1
		while ($status &gt;= 0)
			poParams = "%%poParams   Empresa...: %%CD_EMPRESA.F_CDF_PARTIDASVC%%^"
			poParams = "%%poParams   Partida...: %%NR_PARTIDA.F_CDF_PARTIDASVC%%^"
			poParams = "%%poParams   Ordem.....: %%NR_ORDEM.F_CDF_PARTIDASVC%%^"
			vDsTexto = "0%%TP_SITUACAO.F_CDF_PARTIDASVC"
			vDsTexto = $item(vDsTexto, $valrep(TP_SITUACAO.F_CDF_PARTIDASVC))
			poParams = "%%poParams   Situação..: %%vDsTexto%%^"
			vDsTexto = getFieldData("DS_MAQUINA", "CDF_MAQSVC", "CD_MAQUINA=%%CD_MAQUINA.F_CDF_PARTIDASVC")
			poParams = "%%poParams   Máquina...: %%CD_MAQUINA.F_CDF_PARTIDASVC - %%vDsTexto%%^%%^"
			setocc "F_CDF_PARTIDASVC", $curocc("F_CDF_PARTIDASVC") + 1
		endwhile
		if (poParams != "")
			if (piInIniciar)
				poParams = "Partidas anteriores a partida %%CD_EMPRESA.CDF_PARTIDASVC / %%NR_PARTIDA.CDF_PARTIDASVC aguardando%%^%%poParams"
			else
				poParams = "Partidas anteriores a partida %%CD_EMPRESA.CDF_PARTIDASVC / %%NR_PARTIDA.CDF_PARTIDASVC não encerradas%%^%%poParams"
			endif
			return(0)
		endif
	endif

	return(1)
end ;inVerificarOrdemAnterior

;------------------
entry inOpDiferente
;------------------
	returns boolean
	params
		string piDsEntity : IN
	endparams
	variables
		string vDsField
	endvariables

	vDsField = "CD_EMPOP.%%piDsEntity"
	if (@vDsField != $next(vDsField))
		return(1)
	endif
	vDsField = "NR_CICLO.%%piDsEntity"
	if (@vDsField != $next(vDsField))
		return(1)
	endif
	vDsField = "NR_OP.%%piDsEntity"
	if (@vDsField != $next(vDsField))
		return(1)
	endif

	return(0)
end ;inOpDiferente

;--------------------
entry getEntityFields
	;-----------------
	returns string
	params
		string  piDsEntity : IN
		numeric piTpField  : IN
	endparams
	variables
		string vDsKeyFields, vDsFields, vDsField
	endvariables

	selectcase piTpField
	case 1
		vDsKeyFields = $keyfields("%%piDsEntity", 1)
		return (vDsKeyFields)
	case 2
		vDsFields = $selectlist("%%piDsEntity")
		vDsKeyFields = $keyfields("%%piDsEntity", 1)
		repeat
			getitem vDsField, vDsKeyFields, 1
			delitem/id vDsFields, vDsField
			delitem vDsKeyFields, 1
		until (vDsKeyFields = "")
		delitem/id vDsFields, "U_VERSION"
		delitem/id vDsFields, "CD_OPERADOR"
		delitem/id vDsFields, "DT_CADASTRO"
		return (vDsFields)
	case 3
		vDsFields = $selectlist("%%piDsEntity")
		delitem/id vDsFields, "U_VERSION"
		delitem/id vDsFields, "CD_OPERADOR"
		delitem/id vDsFields, "DT_CADASTRO"
		return (vDsFields)
	endselectcase

	return ("")
end ;getEntityFields

;---------------
entry inRegBanco
	;------------
	returns boolean
	params
		string piDsEntity : IN
	endparams
	variables
		string vDsFields, vDsField
	endvariables

	vDsFields = getEntityFields(piDsEntity, 2)
	while (vDsFields != "")
		vDsField = ""
		getitem vDsField, vDsFields, -1
		vDsField = "%%vDsField%%%.%%piDsEntity"
		if (@vDsField != $fielddbvalue(vDsField))
			return(0)
		endif
		delitem vDsFields, -1
	endwhile

	return(1)
end ;inRegBanco

;---------------------
entry inValidarPartida
	;------------------
	returns boolean
	variables
		numeric vTpPartidaMaq
	endvariables

	vTpPartidaMaq = getMaqConfPar("TP_PARTIDA", CD_MAQUINA.CDF_PARTIDASVC)

	if (vTpPartidaMaq = 1 &amp; TP_TIPO.CDF_PARTIDASVC != 1 &amp; TP_TIPO.CDF_PARTIDASVC != 2)
		$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG39785", "DESCRICAO=Tipo da partida não corresponde ao tipo de partida da máquina!", "ADICIONAL=Operação-&gt;CDFSVCO038.inValidarPartida")
		return(0)
	endif

	if (vTpPartidaMaq &gt;= 3 &amp; TP_TIPO.CDF_PARTIDASVC = 1)
		$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG39785", "DESCRICAO=Tipo da partida não corresponde ao tipo de partida da máquina!", "ADICIONAL=Operação-&gt;CDFSVCO038.inValidarPartida")
		return(0)
	endif

	if (vTpPartidaMaq = 1 &amp; getFieldData("TP_CALTEMPO", "CDF_PROCESSOSVC", "CD_PROCESSO=%%CD_PROCESSO.CDF_PARTIDAPSVC") != 2)
		$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG39786", "DESCRICAO=Tipo do processo não corresponde ao tipo de partida da máquina!", "ADICIONAL=Operação-&gt;CDFSVCO038.inValidarPartida")
		return(0)
	endif

	if (vTpPartidaMaq &gt;= 3 &amp; getFieldData("TP_CALTEMPO", "CDF_PROCESSOSVC", "CD_PROCESSO=%%CD_PROCESSO.CDF_PARTIDAPSVC") != 1)
		$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG39786", "DESCRICAO=Tipo do processo não corresponde ao tipo de partida da máquina!", "ADICIONAL=Operação-&gt;CDFSVCO038.inValidarPartida")
		return(0)
	endif

	if (TP_TIPO.CDF_PARTIDASVC = 1 &amp; getFieldData("TP_CALTEMPO", "CDF_PROCESSOSVC", "CD_PROCESSO=%%CD_PROCESSO.CDF_PARTIDAPSVC") != 2)
		$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG39793", "DESCRICAO=Tipo do processo não corresponde ao tipo da partida!", "ADICIONAL=Operação-&gt;CDFSVCO038.inValidarPartida")
		return(0)
	endif

	if (TP_TIPO.CDF_PARTIDASVC &gt;= 3 &amp; getFieldData("TP_CALTEMPO", "CDF_PROCESSOSVC", "CD_PROCESSO=%%CD_PROCESSO.CDF_PARTIDAPSVC") != 1)
		$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG39793", "DESCRICAO=Tipo do processo não corresponde ao tipo da partida!", "ADICIONAL=Operação-&gt;CDFSVCO038.inValidarPartida")
		return(0)
	endif

	return(1)
end ;inValidarPartida

;------------------
entry getMaqConfPar
	;---------------
	returns string
	params
		string  piDsCampo : IN
		numeric piCdMaquina : IN
	endparams
	variables
		string vDsConf
		numeric vCdSeqMaq, vTpMaquina
	endvariables

	vDsConf = getFieldData(piDsCampo, "CDF_MAQCONFPARSVC", "CD_MAQUINA=%%piCdMaquina")
	if (vDsConf = "")
		vCdSeqMaq = getFieldData("CD_SEQMAQ", "CDF_MAQGMAQSVC", "CD_MAQUINA=%%piCdMaquina")
		vTpMaquina = getFieldData("TP_FINALIDADE", "CDF_GMAQSVC", "CD_SEQMAQ=%%vCdSeqMaq")
		selectcase piDsCampo
		case "TP_TEMPOPARTIDA"
			vDsConf = 2 ;- Apenas uma partida com tempo em aberto
		case "TP_QUANTIDADE"
			vDsConf = 1 ;- Quantidade da O.P.
		case "IN_TEMPOSETUP"
			vDsConf = "T"
		case "TP_ITEM"
			vDsConf = 1 ;- Item de O.P.
		case "TP_RESTRICAO"
			vDsConf = 1 ;- Volume
		case "TP_DIVISAO"
			if (getMaqConfPar("TP_ITEM", piCdMaquina) = 1)
				vDsConf = 2 ;- Divide
			else
				vDsConf = 1 ;- Não divide
			endif
		elsecase
			if (vTpMaquina = 1)
				;- Contínuo
				selectcase piDsCampo
				case "TP_CALCTEMPO"
					vDsConf = 3 ;- Processo x unidade
				case "TP_PARTIDA"
					vDsConf = 2 ;- Contínua sem qt. definida
				endselectcase
			else
				;- Descontínuo
				selectcase piDsCampo
				case "TP_CALCTEMPO"
					vDsConf = 1 ;- Receita
				case "TP_PARTIDA"
					vDsConf = 1 ;- Descontínua
				endselectcase
			endif
		endselectcase
	endif

	return(vDsConf)
end ;getMaqConfPar

;-----------------------
entry apontarQtProduzida
;-----------------------
	params
		string piDsLstQtProduzida : IN
	endparams
	variables
		numeric vNrSeqFin
	endvariables
	;-- Apontar quantidade produzida
	if(piDsLstQtProduzida != "")
		while(piDsLstQtProduzida != "")
			selectdb max(NR_SEQFIN) from "CDF_PARTIDAFISVC" %\
				u_where (CD_EMPRESA.CDF_PARTIDAFISVC = CD_EMPPARTIDA.CDF_PARTIDAPTSVC %\
				&amp; NR_PARTIDA.CDF_PARTIDAFISVC = NR_PARTIDA.CDF_PARTIDAPTSVC %\
				&amp; NR_SEQPARTIDA.CDF_PARTIDAFISVC = NR_SEQPARTIDA.CDF_PARTIDAPTSVC %\
				&amp; NR_SEQTEMPO.CDF_PARTIDAFISVC = NR_SEQTEMPO.CDF_PARTIDAPTSVC %\
				&amp; NR_SEQITEM.CDF_PARTIDAFISVC = $item("NR_SEQITEM", $itemnr(1, piDsLstQtProduzida))) to vNrSeqFin

			creocc "CDF_PARTIDAFISVC", -1
			CD_EMPRESA.CDF_PARTIDAFISVC = CD_EMPPARTIDA.CDF_PARTIDAPTSVC
			NR_PARTIDA.CDF_PARTIDAFISVC = NR_PARTIDA.CDF_PARTIDAPTSVC
			NR_SEQPARTIDA.CDF_PARTIDAFISVC = NR_SEQPARTIDA.CDF_PARTIDAPTSVC
			NR_SEQTEMPO.CDF_PARTIDAFISVC = NR_SEQTEMPO.CDF_PARTIDAPTSVC
			NR_SEQITEM.CDF_PARTIDAFISVC = $item("NR_SEQITEM", $itemnr(1, piDsLstQtProduzida))
			NR_SEQFIN.CDF_PARTIDAFISVC = vNrSeqFin + 1
			retrieve/o "CDF_PARTIDAFISVC"
			if($status != 0)
				discard "CDF_PARTIDAFISVC"
			else
				CD_OPERADOR.CDF_PARTIDAFISVC = $item("CD_USUARIO", $$gParamGlb)
				DT_CADASTRO.CDF_PARTIDAFISVC = $datim
				QT_FINALIZADA.CDF_PARTIDAFISVC = $item("QT_FINALIZADA", $itemnr(1, piDsLstQtProduzida))
			endif
			delitem piDsLstQtProduzida, 1
		endwhile

		$collhandle("CDF_PARTIDAFISVC")-&gt;Salvar()
		if ($procerror)
			$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status &lt; 0)
			return(-1)
		endif
	endif

	return(0)
end ;apontarQtProduzida

;---------------------
entry inValidarEmissao
	;------------------
	returns boolean
	params
		numeric piQtVolume : IN
		numeric piQtPeso : IN
		numeric piCdSeqMaq : IN
		boolean piInSemItem : IN
		string piCdReceita : IN ;--&gt;ROS--&gt;220/2851--&gt;21/02/2018
	endparams
	variables
		string vDsParams
		numeric vQtRelBanho, vQtAux, vQtVolume
	endvariables

	;--&gt;ROS--&gt;220/2851--&gt;21/02/2018
	if (piCdReceita[1,2] != "RP")
		if (getFieldData("TP_SITUACAO", "TEX_RECEITASVC", "CD_RECEITA=%%piCdReceita") != 1)
			$instancehandle-&gt;setStatus(&lt;STS_ERRO&gt;, "MSG42659", "DESCRICAO=Receita não está ativa para emissão!", "ADICIONAL=Operação-&gt;CDFSVCO038.inValidarEmissao")
			return(0)
		endif
	endif
	;&lt;--ROS.

	if (piCdSeqMaq = "")
		return(1)
	endif

	vQtVolume = piQtVolume[round, 3] ;&lt;-- Cris - DVAIND 1718 Prj-&gt;253-388 10/12/2018 --&gt;

	vQtAux = getFieldData("QT_VOLUMEMIN", "CDF_GMAQBENSVC", "CD_SEQMAQ=%%piCdSeqMaq")
	;if (piQtVolume &lt; vQtAux &amp; vQtAux &gt; 0)
	if (vQtVolume &lt; vQtAux &amp; vQtAux &gt; 0) ;&lt;-- Cris - DVAIND 1718 Prj-&gt;253-388 10/12/2018 --&gt;
		$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG39814", "DESCRICAO=Volume da emissão está abaixo do mínimo configurado para a máquina!", "ADICIONAL=Operação-&gt;CDFSVCO038.inValidarEmissao")
		return(0)
	endif

	vQtAux = getFieldData("QT_VOLUMEMAX", "CDF_GMAQBENSVC", "CD_SEQMAQ=%%piCdSeqMaq")
	;if (piQtVolume &gt; vQtAux &amp; vQtAux &gt; 0)
	if (vQtVolume &gt; vQtAux &amp; vQtAux &gt; 0) ;&lt;-- Cris - DVAIND 1718 Prj-&gt;253-388 10/12/2018 --&gt;
		$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG39815", "DESCRICAO=Volume da emissão está acima do máximo configurado para a máquina!", "ADICIONAL=Operação-&gt;CDFSVCO038.inValidarEmissao")
		return(0)
	endif

	if (piQtPeso &lt; getFieldData("QT_PESOMIN", "CDF_GMAQBENSVC", "CD_SEQMAQ=%%piCdSeqMaq") &amp; !piInSemItem)
		$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG39816", "DESCRICAO=Peso da emissão está abaixo do mínimo configurado para a máquina!", "ADICIONAL=Operação-&gt;CDFSVCO038.inValidarEmissao")
		return(0)
	endif
	if (piQtPeso &gt; getFieldData("QT_PESOMAX", "CDF_GMAQBENSVC", "CD_SEQMAQ=%%piCdSeqMaq") &amp; !piInSemItem)
		$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG39817", "DESCRICAO=Peso da emissão está acima do máximo configurado para a máquina!", "ADICIONAL=Operação-&gt;CDFSVCO038.inValidarEmissao")
		return(0)
	endif

	;&lt;-- DSantos Prj-&gt;217-511 07/06/2017
	vQtRelBanho = piQtVolume / piQtPeso
	vQtAux = getFieldData("QT_RELBANHOMIN", "CDF_GMAQBENSVC", "CD_SEQMAQ=%%piCdSeqMaq")
	if (vQtRelBanho &lt; vQtAux &amp; vQtAux &gt; 0 &amp; !piInSemItem)
		$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG41470", "DESCRICAO=Relação de banho da emissão está abaixo do mínimo configurado para a máquina!", "ADICIONAL=Operação-&gt;CDFSVCO038.inValidarEmissao")
		return(0)
	endif
	vQtAux = getFieldData("QT_RELBANHOMAX", "CDF_GMAQBENSVC", "CD_SEQMAQ=%%piCdSeqMaq")
	if (vQtRelBanho &gt; vQtAux &amp; vQtAux &gt; 0 &amp; !piInSemItem)
		$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG41471", "DESCRICAO=Relação de banho da emissão está acima do máximo configurado para a máquina!", "ADICIONAL=Operação-&gt;CDFSVCO038.inValidarEmissao")
		return(0)
	endif
	; DSantos --&gt;

	return(1)
end ;inValidarEmissao

;---------------------------
entry calcularConsumoProduto
	;------------------------
	returns numeric
	params
		string piParams : IN
		string piDsLstFor : INOUT
		string poParams : OUT
	endparams
	variables
		string viParams, voParams, vDsLstFaixa, vDsLstFor, vCdEspecie
		numeric vTpConsumo, vQtConsumoUn, vQtConsumo, vQtPeso, vQtVolume, vPrConsumo, vQtRepeticao, vQtDosagem
	endvariables

	vQtDosagem = ""
	vQtRepeticao = ""
	vQtConsumoUn = $item("QT_CONSUMO", piParams)
	vQtVolume = $item("QT_VOLUME", piParams)
	vQtPeso = $item("QT_PESO", piParams)
	vTpConsumo = $item("TP_CONSUMO", piParams)
	if (vTpConsumo = 4)
		if (!inValidarParametro("CD_RECEITA&uSEP;NR_FASE&uSEP;CD_PRODUTO&uSEP;NR_SEQPRD", piParams, "calcularConsumoProduto"))
			$status = -1
			return("")
		endif
		viParams = piParams
		putitem/id viParams, "DS_LSTFOR", piDsLstFor
		$instancehandle-&gt;buscarConsumoFaixa(viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)
			$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
			$status = -1
			return("")
		elseif ($status &lt; 0)
			poParams = voParams
			$status = -1
			return("")
		endif
		vDsLstFaixa = $item("DS_LSTPRODUTO", voParams)
		while (vDsLstFaixa != "")
			if ($item("CD_PRODUTO", $itemnr(1, vDsLstFaixa)) = $item("CD_PRODUTO", piParams))
				if ($item("IN_MULTPRODUTO", $itemnr(1, vDsLstFaixa)) = &lt;TRUE&gt;)
					vTpConsumo = $item("TP_CONSUMO", $itemnr(1, vDsLstFaixa))
					if (vQtConsumoUn = 1)
						vQtConsumoUn = $item("QT_DOSAGEM", $itemnr(1, vDsLstFaixa))
					else
						vQtConsumoUn = $item("QT_CONSUMO", $itemnr(1, vDsLstFaixa))
						vQtRepeticao = $item("QT_REPETICAO", $itemnr(1, vDsLstFaixa))
						vQtDosagem = $item("QT_DOSAGEM", $itemnr(1, vDsLstFaixa))
					endif
				else
					vTpConsumo = $item("TP_CONSUMO", $itemnr(1, vDsLstFaixa))
					vQtConsumoUn = $item("QT_CONSUMO", $itemnr(1, vDsLstFaixa))
				endif
				break
			endif
			delitem vDsLstFaixa, 1
		endwhile
		vDsLstFor = $item("DS_LISTAFOR", voParams)
		while (vDsLstFor != "")
			putitem piDsLstFor, -1, $itemnr(1, vDsLstFor)
			delitem vDsLstFor, 1
		endwhile
	endif

	;&lt;-- DSantos Prj-&gt;217-641 26/09/2017 - Adicionado a condição -
	if ($item("IN_RECEITAPARTIDA", piParams) != &lt;TRUE&gt;)
		vQtConsumoUn = calcularCompensacaoProduto($item("CD_PRODUTO", piParams), $item("CD_MAQUINA", piParams), vQtPeso, vQtVolume, vQtConsumoUn, &lt;TRUE&gt;, $item("CD_RECEITA", piParams)) ;&lt;-- DSantos Prj-&gt;217-511 02/06/2017 --&gt;
	endif

	if (vTpConsumo = "" | vQtConsumoUn = "")
		return("")
	endif

	if (vTpConsumo != 5)
		vPrConsumo = $item("PR_CONSUMO", piParams)
		if (vPrConsumo &gt; 0)
			vQtConsumoUn = vQtConsumoUn / (vPrConsumo / 100)
		endif
	endif

	if (vQtRepeticao &gt; 0 &amp; vQtDosagem &gt; 0)
		vQtConsumoUn = ((vQtConsumoUn - vQtDosagem) / vQtRepeticao)
	endif

	vCdEspecie = getFieldData("CD_ESPECIE", "PRD_PRODUTOSVC", "CD_PRODUTO=%%$item("CD_PRODUTO", piParams)")

	selectcase vTpConsumo
	case 1 ;- Grama por quilo
		vQtConsumo = (vQtPeso * vQtConsumoUn)
		if (vCdEspecie = $cdEspecieKg$)
			vQtConsumo /= 1000
		endif
	case 2 ;- Grama por litro
		vQtConsumo = (vQtVolume * vQtConsumoUn)
		if (vCdEspecie = $cdEspecieKg$)
			vQtConsumo /= 1000
		endif
	case 3 ;- Percentual sobre o peso
		vQtConsumo = (vQtPeso * vQtConsumoUn) / 100
		if (vCdEspecie != $cdEspecieKg$)
			vQtConsumo *= 1000
		endif

	case 5 ;- Área em cm²
		vQtConsumo = calcularConsumoArea(piParams, vQtConsumoUn, $item("QT_PRODUTO", piParams))
		if ($status &lt; 0)
			$status = -1
			return("")
		endif
	endselectcase

	putitem/id poParams, "TP_CONSUMO", vTpConsumo
	putitem/id poParams, "QT_CONSUMO", vQtConsumoUn
	putitem/id poParams, "QT_DOSAGEM", vQtDosagem
	putitem/id poParams, "QT_REPETICAO", vQtRepeticao

	return(vQtConsumo)
end ;calcularConsumoProduto

;-----------------
entry getNrEmissao
	;--------------
	returns numeric
	variables
		handle vHandleInstance
		numeric vNrEmissao
	endvariables

	if ($nrEmissao$ != "")
		return($nrEmissao$)
	endif

	repeat
		newinstance "GERSVCO001", vHandleInstance, "TRANSACTION=TRUE"
		vHandleInstance-&gt;getNumSeqEmp($$gParamGlb, $item("CD_EMPRESA", $$gParamGlb), "TEX_RECEMISSAO", "NR_EMISSAO", 999999999, vNrEmissao, $xCdErro$, $xCtxErro$)
		if ($procerror)
			$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
			return("")
		elseif ($status &lt; 0)
			return("")
		endif

		if (getFieldData("CD_EMPRESA", "TEX_RECEMISSASVC", "CD_EMPRESA=%%$item("CD_EMPRESA", $$gParamGlb)&uSEP;NR_EMISSAO=%%vNrEmissao") = "")
			return(vNrEmissao)
		endif
	until (&lt;TRUE&gt; != &lt;TRUE&gt;)

end ;getNrEmissao

;------------------------
entry getCampoConfReceita
	;---------------------
	returns string
	params
		string piCdReceita : IN
		numeric piNrFase : IN
		numeric piNrOper : IN
		numeric piCdCampo : IN
	endparams
	variables
		string viParams, voParams
	endvariables

	viParams = ""
	if (piNrOper = "")
		putitem/id viParams, "DS_ENTITY", "CDF_CFGRECFASESVC"
		putitem/id viParams, "DS_KEYS", "CD_RECEITA&uSEP;NR_FASE"
	else
		putitem/id viParams, "DS_ENTITY", "CDF_CFGRECOPERSVC"
		putitem/id viParams, "DS_KEYS", "CD_RECEITA&uSEP;NR_FASE&uSEP;NR_SEQOPER"
	endif
	putitem/id viParams, "CD_RECEITA", piCdReceita
	putitem/id viParams, "NR_FASE", piNrFase
	putitem/id viParams, "NR_SEQOPER", piNrOper
	putitem/id viParams, "TP_CONF", 3 ;- Receita
	putitem/id viParams, "CD_CONF", piCdCampo
	activate "PCPSVCO047".buscarDadosConf(viParams, voParams, $xCdErro$, $xCtxErro$)
	if ($procerror)
		$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
		$status = -1
		return("")
	elseif ($status &lt; 0)
		return("")
	endif

	return($replace($item("DS_CAMPO", voParams), 1, ",", ".", -1))
end ;getCampoConfReceita

;-------------------------
entry getQtRelBanhoReceita
	;----------------------
	returns numeric
	params
		string piCdReceita : IN
	endparams
	variables
		numeric vQtRelBanho, vQtRelBanhoAtual
		string vDsRegistro, vDsCondicao
	endvariables

	vQtRelBanho = ""

	if (piCdReceita[1,2] = "RP")
		vDsCondicao = ""
		putitem/id vDsCondicao, "CD_EMPRESA", piCdReceita[3,6]
		putitem/id vDsCondicao, "NR_PARTIDA", piCdReceita[7]
		$handleConsulta$-&gt;consultar("CDF_PARTIDARECFASESVC", vDsCondicao)
		if($status &gt;= 0)
			$handleConsulta$-&gt;setEntityOcc(1)
			while($status &gt;= 0)
				$handleConsulta$-&gt;getRegistro(vDsRegistro)
				vQtRelBanhoAtual = getCampoConfPartidaRec($item("CD_EMPRESA", vDsRegistro), $item("NR_PARTIDA", vDsRegistro), $item("NR_FASE", vDsRegistro), "", 33)
				if (vQtRelBanho = "")
					vQtRelBanho = vQtRelBanhoAtual
				elseif (vQtRelBanho != vQtRelBanhoAtual)
					return("")
				endif
				$handleConsulta$-&gt;next()
			endwhile
		endif

		$status = 0
		return(vQtRelBanho)
	endif

	clear/e "TEX_RECEITASVC"
	CD_RECEITA.TEX_RECEITASVC/init = piCdReceita
	retrieve/e "TEX_RECEITASVC"
	if ($status &gt;= 0)
		if (!$empty("TEX_RECFASESVC"))
			setocc "TEX_RECFASESVC", 1
			while ($status &gt;= 0)
				vQtRelBanhoAtual = getCampoConfReceita(CD_RECEITA.TEX_RECFASESVC, NR_FASE.TEX_RECFASESVC, "", 33) ;&lt;-- LOMoreira Prj-&gt;220-963 06/07/2016  PVA-33463--&gt;
				if (vQtRelBanho = "")
					vQtRelBanho = vQtRelBanhoAtual
				elseif (vQtRelBanho != vQtRelBanhoAtual)
					return("")
				endif
				setocc "TEX_RECFASESVC", $curocc("TEX_RECFASESVC") + 1
			endwhile
		;&lt;-- DSantos Prj-&gt;217-511 30/05/2017
		elseif (!$empty("TEX_RECEITAFASESVC"))
			setocc "TEX_RECEITAFASESVC", 1
			while ($status &gt;= 0)
				vQtRelBanhoAtual = getCampoConfFasePadrao(NR_FASE.TEX_RECEITAFASESVC, "" ,33)
				if (vQtRelBanho = "" &amp; $curocc("TEX_RECEITAFASESVC") = 1)
					vQtRelBanho = vQtRelBanhoAtual
				elseif (vQtRelBanho != vQtRelBanhoAtual)
					return("")
				endif
				setocc "TEX_RECEITAFASESVC", $curocc("TEX_RECEITAFASESVC") + 1
			endwhile
		endif
		; DSantos --&gt;
	endif

	$status = 0
	return(vQtRelBanho)
end ;getQtRelBanhoReceita

;--------------------------
entry calcularVolumeEmissao
	;-----------------------
	returns numeric
	params
		numeric piQtVolume : IN
		numeric piQtPeso : IN
		string piCdReceita : IN
		numeric piNrFase : IN
		numeric piQtRelBanho : INOUT
		numeric piQtLastro : IN
		boolean inDesconsiderarLastro : IN
	endparams

	if (piQtRelBanho = "")
		piQtRelBanho = getCampoConfReceita(piCdReceita, piNrFase, "", 33)
	endif
	if (piQtRelBanho != "")
		piQtVolume = piQtPeso * piQtRelBanho
	endif

	if(!inDesconsiderarLastro)
		;- Adiciona o lastro por fase ao volume
		if (piQtLastro = "")
			piQtLastro = getCampoConfReceita(piCdReceita, piNrFase, "", 34)
		endif
		piQtVolume += 	piQtLastro
	endif

	if (piQtRelBanho = "" &amp; piQtVolume &gt; 0 &amp; piQtPeso &gt; 0)
		piQtRelBanho = piQtVolume / piQtPeso
	endif

	return(piQtVolume)
end ;calcularVolumeEmissao

;----------------------------
entry inVerificarTempoFechado
;----------------------------
	returns boolean
	params
		numeric piCdEmpresa : IN
		numeric piNrPartida : IN
		numeric piCdMaquina : IN
	endparams
	variables
		string vDsCondicao, vDsRegistro
	endvariables

	if(getMaqConfPar("TP_TEMPOPARTIDA", piCdMaquina) = 2)
		vDsCondicao = ""
		putitem/id vDsCondicao, "CD_EMPRESA", piCdEmpresa
		putitem/id vDsCondicao, "NR_PARTIDA", "&uNOT;&uEQ;%%piNrPartida"
		putitem/id vDscondicao, "CD_MAQUINA", piCdMaquina
		putitem/id vDsCondicao, "TP_SITUACAO", "01"
		$handleEntity$-&gt;consultar("CDF_PARTIDASVC", vDsCondicao)
		if($status &gt;= 0)
			$handleEntity$-&gt;setEntityOcc(1)
			while($status &gt;= 0)
				$handleEntity$-&gt;getRegistro(vDsRegistro)
				vDsCondicao = ""
				putitem/id vDsCondicao, "CD_EMPPARTIDA", $item("CD_EMPRESA", vDsRegistro)
				putitem/id vDsCondicao, "NR_PARTIDA", $item("NR_PARTIDA", vDsRegistro)
				putitem/id vDsCondicao, "DT_FIM", "&uEQ;"
				putitem/id vDsCondicao, "TP_TEMPO", 1
				$handleConsulta$-&gt;consultar("CDF_PARTIDAPTSVC", vDsCondicao)
				if($status &gt;= 0)
					$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG39911", "DESCRICAO=Máquina permite apenas uma partida com tempo aberto por vez!", "ADICIONAL=Operação-&gt;CDFSVCO038.inVerificarTempoFechado")
					return(&lt;FALSE&gt;)
				endif
				$handleEntity$-&gt;next()
			endwhile
		endif
	endif

	return(&lt;TRUE&gt;)
end ;inValidarTempoAberto

;---------------------------
entry adicionarRegistroLista
;---------------------------
	returns string
	params
		string piDsRegistro : IN
		string piDsLista : IN
		string piDsId : IN
	endparams
	variables
		string vDsLista
	endvariables

	vDsLista = $item(piDsId, piDsLista)
	putitem vDsLista, -1, piDsRegistro
	putitem/id piDsLista, piDsId, vDsLista

	return(piDsLista)
end  ;adicionarRegistroLista

;--------------------
entry getStatusExiste
	;-----------------
	returns boolean
	params
		string piDsEntity : IN
	endparams

	retrieve/o piDsEntity
	if ($status = -7)
		retrieve/x piDsEntity
		return(1)
	elseif ($status = 4 | $status = 3)
		return(1)
	endif

	return(0)
end ;getStatusExiste

;-------------------------
entry inProcessoDisponivel
	;----------------------
	;&lt;-- DSantos Prj-&gt;217-255 23/05/2016 --&gt;
	returns boolean
	params
		string piParams : IN
	endparams
	variables
		numeric vCdProcessoAnt, vQtRestante, vQtPartida, vCdSeqMaq
	endvariables

	if (!inValidarParametro("CD_EMPRESA&uSEP;NR_CICLO&uSEP;NR_OP&uSEP;CD_PRODUTO&uSEP;CD_MAQUINA", piParams, "inProcessoDisponivel"))
		;- Caso não receber os parâmetros corretamente o processo fica indisponível.
		return(0)
	endif

	if (getMaqConfPar("TP_PARTIDA", $item("CD_MAQUINA", piParams)) = 2)
		;- Quando a máquina for contínua sem quantidade todos os processos são disponiveis
		return(1)
	endif

	vCdProcessoAnt = $item("CD_PROCESSOANT", piParams)
	delitem/id piParams, "CD_PROCESSOANT"

	if (vCdProcessoAnt = "")
		;- Quando não existir processo anterior o processo fica disponível.
		return(1)
	endif

	if (!inSeqProcDisponivel(piParams))
		return(0)
	endif

	vCdSeqMaq = getFieldData("CD_SEQMAQ", "CDF_MAQGMAQSVC", "CD_MAQUINA=%%$item("CD_MAQUINA", piParams)")
	$handleEntity$-&gt;consultar("CDF_GMAQPROCESSOSVC", "CD_SEQMAQ=&uEQ;%%vCdSeqMaq&uSEP;CD_PROCESSO=%%vCdProcessoAnt&uSEP;TP_PROCESSO=2")
	if ($status &gt;= 0)
		;- Caso o processo anterior estiver configurado para não considerar na validação, o processo fica disponível.
		return(1)
	endif

	if ($item("NR_LOTE", piParams) != "" &amp; $item("NR_ITEM", piParams) != "")
		vQtRestante = getFieldData("QT_LOTE", "PCP_OPILOTEISVC", piParams)

		selectdb sum(QT_REFERENCIA) from "V_CDF_PARTIDASVC" u_where %\
			CD_EMPOP.V_CDF_PARTIDASVC = $item("CD_EMPRESA", piParams) %\
			&amp; NR_CICLO.V_CDF_PARTIDASVC = $item("NR_CICLO", piParams) %\
			&amp; NR_OP.V_CDF_PARTIDASVC = $item("NR_OP", piParams) %\
			&amp; CD_PRODUTO.V_CDF_PARTIDASVC = $item("CD_PRODUTO", piParams) %\
			&amp; NR_LOTE.V_CDF_PARTIDASVC = $item("NR_LOTE", piParams) %\
			&amp; NR_ITEM.V_CDF_PARTIDASVC = $item("NR_ITEM", piParams) %\
			&amp; CD_PROCESSO.V_CDF_PARTIDASVC = vCdProcessoAnt %\
			&amp; TP_SITUACAO.V_CDF_PARTIDASVC = 4 %\
		to vQtPartida

		vQtRestante -= vQtPartida
	else
		vQtRestante = getFieldData("QT_REAL", "PCP_OPISVC", piParams)

		selectdb sum(QT_REFERENCIA) from "V_CDF_PARTIDASVC" u_where %\
			CD_EMPOP.V_CDF_PARTIDASVC = $item("CD_EMPRESA", piParams) %\
			&amp; NR_CICLO.V_CDF_PARTIDASVC = $item("NR_CICLO", piParams) %\
			&amp; NR_OP.V_CDF_PARTIDASVC = $item("NR_OP", piParams) %\
			&amp; CD_PRODUTO.V_CDF_PARTIDASVC = $item("CD_PRODUTO", piParams) %\
			&amp; CD_PROCESSO.V_CDF_PARTIDASVC = vCdProcessoAnt %\
			&amp; TP_SITUACAO.V_CDF_PARTIDASVC = 4 %\
		to vQtPartida

		vQtRestante -= vQtPartida
	endif

	if (vQtRestante &gt; 0)
		return(0)
	endif

	return(1)
end ;inProcessoDisponivel

;------------------
entry getProcessoOp
	;---------------
	;&lt;-- DSantos Prj-&gt;217-256 01/06/2016 --&gt;
	returns string
	params
		string piParamsOp : IN
		numeric piCdProcesso : IN
		boolean piInProcRec : IN
		boolean piInProcAnterior : IN
	endparams
	variables
		string viParams, voParams, vDsRegistro
		numeric vNrOrdem
	endvariables

	putitem/id piParamsOp, "CD_PROCESSO", piCdProcesso
	$handleEntity$-&gt;consultar("PCP_OPISEQPROSVC", piParamsOp)
	if ($status &gt;= 0)
		$handleEntity$-&gt;getRegistro(vDsRegistro)
		if (piInProcAnterior)
			delitem/id piParamsOp, "CD_PROCESSO"
			vNrOrdem = $item("NR_ORDEM", vDsRegistro) - 1
			vDsRegistro = ""
			if (vNrOrdem &gt; 0)
				putitem/id piParamsOp, "NR_ORDEM", vNrOrdem
				$handleEntity$-&gt;consultar("PCP_OPISEQPROSVC", piParamsOp)
				if ($status &gt;= 0)
					$handleEntity$-&gt;getRegistro(vDsRegistro)
				endif
			endif
		endif
		if (piInProcRec &amp; $item("CD_RECEITA", vDsRegistro) = "")
			return("")
		endif
		putitem/id vDsRegistro, "DS_LSTTPUTILIZACAO", getLstTpUtilizacaoOpi(vDsRegistro) ;--&gt; MNSANTOS - Prj 217/305 - 25/07/2016
	endif

	if (vDsRegistro = "")
		viParams = ""
		putitem/id viParams, "CD_PRODUTO", $item("CD_PRODUTO", piParamsOp)
		putitem/id viParams, "CD_PROCESSO", piCdProcesso
		putitem/id viParams, "IN_PROCREC", piInProcRec
		putitem/id viParams, "IN_PROCANTERIOR", piInProcAnterior
		activate "CDFSVCO030".buscarSeqProc(viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)
			$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
			$status = -1
			return("")
		elseif ($status &lt; 0)
			return("")
		endif
		vDsRegistro = $itemnr(1, $item("DS_LSTSEQPROC", voParams))
	endif

	return(vDsRegistro)
end ;getProcessoOp

;------------------------
entry inSeqProcDisponivel
;------------------------
	returns boolean
	params
		string piParams : IN
	endparams
	variables
		string vDsFields, vDsField
	endvariables

	vDsFields = "CD_EMPRESA&uSEP;NR_CICLO&uSEP;NR_OP&uSEP;CD_PRODUTO"
	while(vDsFields != "")
		vDsField = $itemnr(1, vDsFields)
		if($item(vDsField, piParams) != $item(vDsField, $itemnr(-1, $item("DS_LSTPROC", piParams))))
			return(1)
		endif
		delitem vDsFields, 1
	endwhile

	if ($item("IN_DISPONIVEL", $itemnr(-1, $item("DS_LSTPROC", piParams))) != &lt;TRUE&gt; &amp; $item("DS_LSTPROC", piParams) != "")
		;- Quando existir processo na lista e o último não estiver disponível o processo atual também fica indisponível.
		return(0)
	endif

	return(1)
end ;inSeqProcDisponivel

;------------------------
entry calcularConsumoArea
	;---------------------
	;&lt;-- DSantos Prj-&gt;217-278 20/06/2016 --&gt;
	returns numeric
	params
		string piParams : IN
		numeric piQtArea : IN
		numeric piQtProduto : IN
	endparams
	variables
		numeric vQtConsumoPeso, vCdTpUtilizacao
		string vDsLstTpUtilizacao, vDsId
	endvariables

	if (!inValidarParametro("NR_FASE&uSEP;NR_SEQOPER&uSEP;NR_SEQPRD&uSEP;CD_PRODUTO", piParams, "calcularConsumoArea"))
		$status = 0
		return("")
	endif

	vDsLstTpUtilizacao = $item("DS_LSTTPUTILIZACAO", piParams)

	vDsId = $concat($item("NR_FASE", piParams), $item("NR_SEQOPER", piParams), $item("NR_SEQPRD", piParams), $item("CD_PRODUTO", piParams))
	vCdTpUtilizacao = $item("CD_TPUTILIZACAO", $item(vDsId, vDsLstTpUtilizacao))
	if (vCdTpUtilizacao = "")
		vCdTpUtilizacao = $item("CD_TPUTILIZACAO", piParams)
	endif

	if (vCdTpUtilizacao = "")
		;Quando não existir utilização configurada o consumo é 0(zero)
		return(0)
	endif

	vQtConsumoPeso = getFieldData("QT_CONSUMO", "CDF_TPUTILIZACAOISVC", "CD_TPUTILIZACAO=%%vCdTpUtilizacao&uSEP;CD_PRODUTO=%%$item("CD_PRODUTO", piParams)")
	if (vQtConsumoPeso != "")
		vQtConsumoPeso = vQtConsumoPeso * piQtArea * piQtProduto
	endif

	return(vQtConsumoPeso)
end ;calcularConsumoArea

;-----------------------
entry getRateioOpPartida
;-----------------------
	;--&gt; MNSANTOS - Prj 217/280 - 24/06/2016
	returns numeric
	params
		string piParams : IN
		string piDsOpI : IN
	endparams
	variables
		numeric vPrRateio, vQtPartida, vQtOpI
		string vDsCondicao
	endvariables

	if($item("NR_PARTIDA", piParams) = "")
		return(100)
	endif

	vDsCondicao = ""
	putitem/id vDsCondicao, "CD_EMPRESA", $item("CD_EMPOP", piDsOpI)
	putitem/id vDsCondicao, "NR_CICLO", $item("NR_CICLO", piDsOpI)
	putitem/id vDsCondicao, "NR_OP", $item("NR_OP", piDsOpI)
	putitem/id vDsCondicao, "CD_PRODUTO", $item("CD_PRODUTO", piDsOpI)
	vQtOpI = getFieldData("QT_REAL", "PCP_OPISVC", vDsCondicao)

	vQtPartida = $item("QT_REFERENCIA", piDsOpI)

	vPrRateio = (vQtPartida * 100) / vQtOpi

	return(vPrRateio)
end ;getRareioOpPartida

;--------------------------
entry getLstTpUtilizacaoOpi
;--------------------------
	;--&gt; MNSANTOS - Prj 217/305 - 25/07/2016
	params
		string piParams : IN
	endparams
	variables
		string vDsLstTpUtilizacao, vDsCondicao, vDsRegistro, vDsId, vDsRegTpUtilizacao
	endvariables

	if (!inValidarParametro("CD_EMPRESA&uSEP;NR_CICLO&uSEP;NR_OP&uSEP;CD_PRODUTO&uSEP;NR_SEQUENCIA", piParams, "getLstTpUtilizacaoOpi"))
		return("")
	endif

	vDsLstTpUtilizacao = ""
	vDsCondicao = ""
	putitem/id vDsCondicao, "CD_EMPRESA", $item("CD_EMPRESA", piParams)
	putitem/id vDsCondicao, "NR_CICLO", $item("NR_CICLO", piParams)
	putitem/id vDsCondicao, "NR_OP", $item("NR_OP", piParams)
	putitem/id vDsCondicao, "CD_PRODUTO", $item("CD_PRODUTO", piParams)
	putitem/id vDsCondicao, "NR_SEQUENCIA", $item("NR_SEQUENCIA", piParams)
	$handleEntity$-&gt;consultar("PCP_OPISEQPROCMPSVC", vDsCondicao)
	if($status &gt;= 0)
		$handleEntity$-&gt;setEntityOcc(1)
		while($status &gt;= 0)
			$handleEntity$-&gt;getRegistro(vDsRegistro)
			vDsId = $concat($item("NR_FASE", vDsRegistro), $item("NR_SEQOPER", vDsRegistro), $item("NR_SEQPRD", vDsRegistro), $item("CD_PRODUTOMP", vDsRegistro))
			vDsRegTpUtilizacao = ""
			putitem/id vDsRegTpUtilizacao, "NR_FASE", $item("NR_FASE", vDsRegistro)
			putitem/id vDsRegTpUtilizacao, "NR_SEQOPER", $item("NR_SEQOPER", vDsRegistro)
			putitem/id vDsRegTpUtilizacao, "NR_SEQPRD", $item("NR_SEQPRD", vDsRegistro)
			putitem/id vDsRegTpUtilizacao, "CD_PRODUTOMP", $item("CD_PRODUTOMP", vDsRegistro)
			putitem/id vDsRegTpUtilizacao, "CD_TPUTILIZACAO", $item("CD_TPUTILIZACAO", vDsRegistro)
			putitem/id vDsLstTpUtilizacao, vDsId, vDsRegTpUtilizacao
			$handleEntity$-&gt;next()
		endwhile
	endif

	return(vDsLstTpUtilizacao)
end ;getLstTpUtilizacaoOpi

;--------------------------
entry inOpiPartidaDiferente
	;-----------------------
	;--&gt; MNSANTOS - Prj 217/322 - 01/08/2016
	returns boolean

	if(CD_EMPOP.CDF_PARTIDAISVC != $next(CD_EMPOP.CDF_PARTIDAISVC))
		return(&lt;TRUE&gt;)
	endif

	if(NR_CICLO.CDF_PARTIDAISVC != $next(NR_CICLO.CDF_PARTIDAISVC))
		return(&lt;TRUE&gt;)
	endif

	if(NR_OP.CDF_PARTIDAISVC != $next(NR_OP.CDF_PARTIDAISVC))
		return(&lt;TRUE&gt;)
	endif

	if(CD_PRODUTO.CDF_PARTIDAISVC != $next(CD_PRODUTO.CDF_PARTIDAISVC))
		return(&lt;TRUE&gt;)
	endif

	return(&lt;FALSE&gt;)
end ;inOpiPartidaDiferente

;---------------------------
entry inClassificacaoProduto
	;------------------------
	returns boolean
	params
		numeric piCdProduto : IN
		numeric piCdTipoClas : IN
		string piCdClas : IN
	endparams
	variables
		string viParams, voParams, vDsLstClas
	endvariables

	vDsLstClas = ""
	putitem vDsLstClas, -1, piCdTipoClas
	putitem vDsLstClas, -1, piCdClas

	viParams = ""
	putitem/id viParams, "CD_PRODUTO", piCdProduto
	putitem/id viParams, "DS_LSTCLAS", vDsLstClas
	activate "PRDSVCO026".validarClassificacaoProduto(viParams, voParams, $xCdErro$, $xCtxErro$)
	if ($procerror)
		$instancehandle-&gt;setStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
		return(&lt;FALSE&gt;)
	elseif ($status &lt; 0 | voParams = "")
		return(&lt;FALSE&gt;)
	endif

	return(&lt;TRUE&gt;)
end ;inClassificacaoProduto

;------------------------------
entry montarFaixaConsumoProduto
	;---------------------------
	returns string
	params
		numeric piCdProduto : IN
		numeric piPrCorante : IN
		numeric piQtRepeticao : IN
	endparams
	variables
		string vDsRegistro
	endvariables

	if ($empty("CDF_PRDFORPERSVC"))
		return("")
	endif

	setocc "CDF_PRDFORPERSVC", 1
	while ($status &gt;= 0)
		if (piPrCorante &gt;= PR_CONSUMOINI.CDF_PRDFORPERSVC &amp; piPrCorante &lt;= PR_CONSUMOFIN.CDF_PRDFORPERSVC)
			vDsRegistro = ""
			putitem/id vDsRegistro, "CD_PRODUTO", piCdProduto
			putitem/id vDsRegistro, "QT_CONSUMO", QT_CONSUMO.CDF_PRDFORPERSVC
			putitem/id vDsRegistro, "TP_CONSUMO", TP_CONSUMO.CDF_PRDFORPERSVC
			putitem/id vDsRegistro, "QT_DOSAGEM", QT_DOSAGEM.CDF_PRDFORPERSVC
			if (piQtRepeticao &gt; 1)
				putitem/id vDsRegistro, "IN_MULTPRODUTO", &lt;TRUE&gt;
				piQtRepeticao -= 1
				putitem/id vDsRegistro, "QT_REPETICAO", piQtRepeticao
			endif
			return(vDsRegistro)
		endif
		setocc "CDF_PRDFORPERSVC", $curocc("CDF_PRDFORPERSVC") + 1
	endwhile

	return("")
end ; montarFaixaConsumoProduto

;---------------------------
entry getFornecedorPrincipal
	;------------------------
	returns numeric
	params
		numeric piCdProduto : IN
	endparams
	variables
		string vDsCondicao
	endvariables

	vDsCondicao = ""
	putitem/id vDsCondicao, "CD_PRODUTO", piCdProduto
	putitem/id vDsCondicao, "IN_PADRAO", &lt;TRUE&gt;
	$handleConsulta$-&gt;consultar("PRD_PRODUTOFOSVC", vDsCondicao)
	if ($status &gt;= 0)
		return($item("CD_FORNECEDOR", getRegistro($handleConsulta$)))
	endif

	return("")
end ;getFornecedorPrincipal

;-------------------------
entry getQtRelBanhoConfMaq
	;----------------------
	;&lt;-- DSantos Prj-&gt;217-511 17/05/2017
	returns numeric
	params
		numeric piCdMaquina : IN
		numeric piQtPeso : IN
	endparams
	variables
		numeric vQtRelBanho
		string vDsCondicao
	endvariables

	if (piCdMaquina = "")
		return("")
	endif

	vDsCondicao = ""
	putitem/id vDsCondicao, "CD_MAQUINA", piCdMaquina
	putitem/id vDsCondicao, "QT_PESOINICIAL", "&uLT;&uEQ;%%piQtPeso"
	putitem/id vDsCondicao, "QT_PESOFINAL", "&uGT;&uEQ;%%piQtPeso"
	vQtRelBanho = getFieldData("QT_RELBANHO", "CDF_MAQCONFPESOSVC", vDsCondicao)

	if (vQtRelBanho != "")
		$instancehandle-&gt;armazenarLog(-2, piCdMaquina, piQtPeso, vQtRelBanho)
	endif

	return(vQtRelBanho)
end ;getQtRelBanhoConfMaq

;---------------------
entry getVolumeConfMaq
	;------------------
	;&lt;-- DSantos Prj-&gt;217-511 30/05/2017
	returns numeric
	params
		numeric piCdMaquina : IN
		numeric piQtCone : IN
	endparams
	variables
		numeric vQtVolume
		string vDsCondicao
	endvariables

	if (piCdMaquina = "")
		return("")
	endif

	vDsCondicao = ""
	putitem/id vDsCondicao, "CD_MAQUINA", piCdMaquina
	putitem/id vDsCondicao, "QT_CONEINICIAL", "&uLT;&uEQ;%%piQtCone"
	putitem/id vDsCondicao, "QT_CONEFINAL", "&uGT;&uEQ;%%piQtCone"
	vQtVolume = getFieldData("QT_VOLUME", "CDF_MAQCONFVOLUMESVC", vDsCondicao)

	if (vQtVolume != "")
		$instancehandle-&gt;armazenarLog(-3, piCdMaquina, piQtCone, vQtVolume)
	endif

	return(vQtVolume)
end ;getVolumeConfMaq

;--------------------
entry getQtConeItemOp
	;-----------------
	;&lt;-- DSantos Prj-&gt;217-511 30/05/2017 --&gt;
	params
		string piParams : IN
		numeric piQtItem : IN
	endparams
	variables
		string vDsCondicao, vDsRegistro, vDsCondicaoLote
		numeric vQtCone, vQtReal, vQtPesoLiquido, vQtEstimada, vQtConsumo, vTpCalculo
		handle vHandleReprocesso
		boolean vInRegistro
	endvariables

	;&lt;-- DSantos Prj-&gt;217-730 21/08/2017
	if ($item("QT_CONE", piParams) != "")
		return($item("QT_CONE", piParams))
	endif
	; DSantos --&gt;

	if (!inValidarParametro("CD_EMPRESA&uSEP;NR_CICLO&uSEP;NR_OP&uSEP;CD_PRODUTO", piParams, "getQtConeItemOp"))
		return("")
	endif

	vInRegistro = &lt;TRUE&gt;

	vDsCondicao = ""
	putitem/id vDsCondicao, "CD_EMPRESA", $item("CD_EMPRESA", piParams)
	putitem/id vDsCondicao, "NR_CICLO", $item("NR_CICLO", piParams)
	putitem/id vDsCondicao, "NR_OP", $item("NR_OP", piParams)
	putitem/id vDsCondicao, "CD_PRODUTOPA", $item("CD_PRODUTO", piParams)
	$handleConsulta$-&gt;consultar("PCP_OPMPISVC", vDsCondicao)
	if ($status &lt; 0)
		;&lt;-- DSantos Prj-&gt;253-018 11/04/2018 --&gt;
		if ($item("NR_LOTE", piParams) != "" &amp; $item("NR_ITEM", piParams))
			newinstance "ENTSVCO001", vHandleReprocesso
			;--&gt; MNSANTOS - Prj 253/249 - 08/10/2018
			;vDsCondicaoLote = vDsCondicao
			vDsCondicaoLote = ""
			putitem/id vDsCondicaoLote, "CD_EMPRESADES",  $item("CD_EMPRESA", piParams)
			putitem/id vDsCondicaoLote, "NR_CICLODES", $item("NR_CICLO", piParams)
			putitem/id vDsCondicaoLote, "NR_OPDES", $item("NR_OP", piParams)
			putitem/id vDsCondicaoLote, "NR_LOTEDES", $item("NR_LOTE", piParams)
			putitem/id vDsCondicaoLote, "NR_ITEMDES", $item("NR_ITEM", piParams)
			putitem/id vDsCondicaoLote, "TP_RELACIONAMENTO", 4 ;- Reprocesso
			vHandleReprocesso-&gt;consultar("PCP_OPILOTEIRSVC", vDsCondicaoLote)
			while ($status &gt;= 0)
				vHandleReprocesso-&gt;getRegistro(vDsRegistro)
				putitem/id vDsCondicaoLote, "CD_EMPRESADES", $item("CD_EMPRESAORI", vDsRegistro)
				putitem/id vDsCondicaoLote, "NR_CICLODES", $item("NR_CICLOORI", vDsRegistro)
				putitem/id vDsCondicaoLote, "NR_OPDES", $item("NR_OPORI", vDsRegistro)
				putitem/id vDsCondicaoLote, "NR_LOTEDES", $item("NR_LOTEORI", vDsRegistro)
				putitem/id vDsCondicaoLote, "NR_ITEMDES", $item("NR_ITEMORI", vDsRegistro)
				vhandleReprocesso-&gt;consultar("PCP_OPILOTEIRSVC", vDsCondicaoLote)
			endwhile
			vDsCondicaoLote = vDsCondicao
			delitem/id vDsCondicaoLote, "CD_PRODUTOPA"
			putitem/id vDsCondicaoLote, "NR_LOTE", $item("NR_LOTEORI", vDsRegistro)
			putitem/id vDsCondicaoLote, "NR_ITEM", $item("NR_ITEMORI", vDsRegistro)
			putitem/id vDsCondicao, "CD_PRODUTOPA", getFieldData("CD_PRODUTO", "PCP_OPILOTEISVC", vDsCondicaoLote)
			$handleConsulta$-&gt;consultar("PCP_OPMPISVC", vDsCondicao)
			if ($status &lt; 0)
				vInRegistro = &lt;FALSE&gt;
			endif
		endif
		; DSantos --&gt;
	endif

	if (vInRegistro)
		putitem/id vDsCondicao, "CD_PRODUTO", $item("CD_PRODUTOPA", vDsCondicao) ;--&gt; MNSANTOS - Prj 253/249 - 08/10/2018
		delitem/id vDsCondicao, "CD_PRODUTOPA"

		$handleConsulta$-&gt;setEntityOcc(1)
		$handleConsulta$-&gt;getRegistro(vDsRegistro)

		if ($item("QT_PESOLIQUIDO", vDsRegistro) != "")
			vTpCalculo = 1 ;- Peso liquido
		elseif ($item("QT_CONE", vDsRegistro) != "")
			vTpCalculo = 2 ;- Qt. cone baixada
		else
			vTpCalculo = 1 ;- Peso liquido
		endif

		while ($status &gt;= 0)
			$handleConsulta$-&gt;getRegistro(vDsRegistro)
			if (vTpCalculo = 1)
				if ($item("QT_PESOLIQUIDO", vDsRegistro) != "")
					vQtPesoLiquido = $item("QT_PESOLIQUIDO", vDsRegistro)
				else
					vQtPesoLiquido = getFieldData("QT_PESOLIQUIDO", "PRD_PRODUTOFSVC", "CD_PRODUTO=%%$item("CD_PRODUTOMP", vDsRegistro)")
				endif
				if (vQtPesoLiquido &gt; 0 &amp; getFieldData("QT_ESTIMADA", "PCP_OPISVC", vDsCondicao) != "")
					vQtConsumo = $item("QT_ESTIMADA", vDsRegistro) / getFieldData("QT_ESTIMADA", "PCP_OPISVC", vDsCondicao)
					vQtEstimada = piQtItem * vQtConsumo
					vQtCone += (vQtEstimada / vQtPesoLiquido)
					if($frac(vQtCone) &gt; 0)
						vQtCone += 1
					endif
					vQtCone = vQtCone[trunc]
				endif
			else
				vQtCone += $item("QT_CONE", vDsRegistro)
			endif
			$handleConsulta$-&gt;next()
		endwhile
	endif

	if (vQtCone &gt; 0 &amp; vTpCalculo = 2)
		vQtReal = getFieldData("QT_REAL", "PCP_OPISVC", vDsCondicao)
		vQtCone = ((piQtItem * vQtCone) / vQtReal)
		vQtCone = vQtCone[round]
		vQtCone = vQtCone[trunc]
	endif

	return(vQtCone)
end ;getConeItemOp

;---------------------------
entry getCampoConfFasePadrao
	;------------------------
	;&lt;-- DSantos Prj-&gt;217-511 30/05/2017
	returns string
	params
		numeric piNrFase : IN
		numeric piNrOper : IN
		numeric piCdCampo : IN
	endparams
	variables
		string viParams, voParams
	endvariables

	viParams = ""
	if(piNrOper = "")
		putitem/id viParams, "DS_ENTITY", "CDF_CFGFASEPADSVC"
		putitem/id viParams, "DS_KEYS", "NR_FASE"
	else
		putitem/id viParams, "DS_ENTITY", "CDF_CFGFPADOPERSVC"
		putitem/id viParams, "DS_KEYS", "NR_FASE&uSEP;NR_SEQOPER"
	endif
	putitem/id viParams, "NR_FASE", piNrFase
	putitem/id viParams, "NR_SEQOPER", piNrOper
	putitem/id viParams, "TP_CONF", 5 ;- Fase padrão
	putitem/id viParams, "CD_CONF", piCdCampo
	activate "PCPSVCO047".buscarDadosConf(viParams, voParams, $xCdErro$, $xCtxErro$)
	if ($procerror)
		$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
		$status = -1
		return("")
	elseif ($status &lt; 0)
		return("")
	endif

	return($replace($item("DS_CAMPO", voParams), 1, ",", ".", -1))
end ;getCampoConfFasePadrao

;-------------------------------
entry calcularCompensacaoProduto
	;----------------------------
	;&lt;-- DSantos Prj-&gt;217-511 02/06/2017 --&gt;
	returns numeric
	params
		numeric piCdProduto : IN
		numeric piCdMaquina : IN
		numeric piQtPeso : IN
		numeric piQtVolume : IN
		numeric piQtConsumo : IN
		boolean piInLog : IN
		string piCdReceita : IN
	endparams
	variables
		numeric vQtRelBanho, vPrVariacao, vPrCorante
		string vDsCondicao, vDsRegistro
	endvariables

	if (piCdMaquina = "" | piQtPeso = "" | piQtVolume = "")
		return(piQtConsumo)
	endif

	if ($item(piCdMaquina, $dsLstMaqComp$) = "")
		$handleConsulta$-&gt;consultar("CDF_MAQCONFVARIACAOSVC", "CD_MAQUINA=%%piCdMaquina")
		if ($status &gt;= 0)
			putitem/id $dsLstMaqComp$, piCdMaquina, &lt;TRUE&gt;
		else
			putitem/id $dsLstMaqComp$, piCdMaquina, &lt;FALSE&gt;
		endif
	endif

	if ($item(piCdMaquina, $dsLstMaqComp$) = &lt;TRUE&gt;)
		$handleConsulta$-&gt;consultar("CDF_MAQCONFVARIACAOSVC", "CD_MAQUINA=%%piCdMaquina")
		if ($status &gt;= 0)
			vDsCondicao = ""
			$handleConsulta$-&gt;setEntityOcc(1)
			while ($status &gt;= 0)
				$handleConsulta$-&gt;getRegistro(vDsRegistro)
				if (inClassificacaoProduto(piCdProduto, $item("CD_TIPOCLAS", vDsRegistro), $item("CD_CLASSIFICACAO", vDsRegistro)))
					putitem/id vDsCondicao, "CD_TIPOCLAS", $item("CD_TIPOCLAS", vDsRegistro)
					putitem/id vDsCondicao, "CD_CLASSIFICACAO", $item("CD_CLASSIFICACAO", vDsRegistro)
					break
				endif
				$handleConsulta$-&gt;next()
			endwhile
			if (vDsCondicao != "")
				vQtRelBanho = piQtVolume / piQtPeso
				putitem/id vDsCondicao, "CD_MAQUINA", piCdMaquina
				putitem/id vDsCondicao, "QT_RELBANHOINICIAL", "&uLT;&uEQ;%%vQtRelBanho"
				putitem/id vDsCondicao, "QT_RELBANHOFINAL", "&uGT;&uEQ;%%vQtRelBanho"
				;&lt;-- LOMoreira Prj-&gt;217-586 31/07/2017 --&gt;
				$handleConsulta$-&gt;consultar("CDF_MAQCONFVARIACAOSVC", vDsCondicao)
				if ($status &gt;= 0)
					$handleConsulta$-&gt;getRegistro(vDsRegistro)
					if ($item("PR_VARIACAOMAIOR", vDsRegistro) != "" | $item("PR_VARIACAOMENOR", vDsRegistro) != "")
						vPrCorante = getPrCoranteReceita(piCdProduto, piCdMaquina, piQtPeso, piQtVolume, piQtConsumo, piInLog, piCdReceita)
						if (piQtConsumo &gt; vPrCorante)
							vPrVariacao = $item("PR_VARIACAOMAIOR", vDsRegistro)
						elseif (piQtConsumo &lt; vPrCorante)
							vPrVariacao = $item("PR_VARIACAOMENOR", vDsRegistro)
						else
							vPrVariacao = $item("PR_VARIACAO", vDsRegistro)
						endif
					else
						vPrVariacao = $item("PR_VARIACAO", vDsRegistro)
					endif
					if (vPrVariacao != "")
						piQtConsumo = (piQtConsumo + ((piQtConsumo * vPrVariacao) / 100))
						if (piInLog)
							$instancehandle-&gt;armazenarLog(piCdProduto, piCdMaquina, vQtRelBanho, vPrVariacao)
						endif
					endif
				endif
				;&lt;-- LOMoreira Prj-&gt;217-586 31/07/2017 --&gt;
			endif
		endif
	endif

	$status = 0
 	return(piQtConsumo)
end ;calcularCompensacaoProduto

;----------------------
entry getMaquinaEmissao
	;-------------------
	;&lt;-- DSantos Prj-&amp;gt;217-511 17/05/2017
	returns numeric
	params
		string piParams : IN
	endparams
	variables
		string vDsCondicao, vDsRetorno
		numeric vCdMaquina
	endvariables

	if ($item("CD_EMPPARTIDA", piParams) != "" &amp; $item("NR_PARTIDA", piParams) != "")
		vDsCondicao = ""
		putitem/id vDsCondicao, "CD_EMPRESA", $item("CD_EMPPARTIDA", piParams)
		putitem/id vDsCondicao, "NR_PARTIDA", $item("NR_PARTIDA", piParams)
		vCdMaquina = getFieldData("CD_MAQUINA", "CDF_PARTIDASVC", vDsCondicao)
	endif

	if (vCdMaquina = "")
		vDsCondicao = ""
		putitem/id vDsCondicao, "CD_SEQMAQ", $item("CD_SEQMAQ", piParams)
 		vCdMaquina = getFieldData("CD_MAQUINA", "CDF_MAQGMAQSVC", vDsCondicao)
	endif

	return(vCdMaquina)
end ;getMaquinaEmissao

;---------------------------------
entry inValidarRelBanhoFaseEmissao
	;------------------------------
	;&lt;-- DSantos Prj-&gt;217-511 07/06/2017 --&gt;
	returns boolean
	params
		numeric piCdSeqMaq : IN
		numeric piQtRelBanho : IN
		numeric piNrFase : IN
		numeric piQtPeso : IN
	endparams
	variables
		numeric vQtAux, vQtVolume
	endvariables

	if (piQtRelBanho = "")
		return(1)
	endif

	vQtVolume = piQtRelBanho * piQtPeso

	vQtAux = getFieldData("QT_VOLUMEMIN", "CDF_GMAQBENSVC", "CD_SEQMAQ=%%piCdSeqMaq")
	if (vQtAux &gt; 0 &amp; vQtVolume &lt; vQtAux)
		$instancehandle-&gt;setStatus(&lt;STS_ERRO&gt;, "MSG41476", "DESCRICAO=Volume da fase @@1@@ menor que o mínimo configurado para a máquina!&uSEP;PARAMETRO=%%piNrFase", "ADICIONAL=Operação-&gt;CDFSVCO038.inValidarRelBanhoFaseEmissao")
		return(0)
	endif

	vQtAux = getFieldData("QT_VOLUMEMAX", "CDF_GMAQBENSVC", "CD_SEQMAQ=%%piCdSeqMaq")
	if (vQtAux &gt; 0 &amp; vQtVolume &gt; vQtAux)
		$instancehandle-&gt;setStatus(&lt;STS_ERRO&gt;, "MSG41475", "DESCRICAO=Volume da fase @@1@@ maior que o máximo configurado para a máquina!&uSEP;PARAMETRO=%%piNrFase", "ADICIONAL=Operação-&gt;CDFSVCO038.inValidarRelBanhoFaseEmissao")
		return(0)
	endif

	vQtAux = getFieldData("QT_RELBANHOMIN", "CDF_GMAQBENSVC", "CD_SEQMAQ=%%piCdSeqMaq")
	if (vQtAux &gt; 0 &amp; piQtRelBanho &lt; vQtAux)
		$instancehandle-&gt;setStatus(&lt;STS_ERRO&gt;, "MSG41473", "DESCRICAO=Relação de banho da fase @@1@@ menor que o mínimo configurado para a máquina!&uSEP;PARAMETRO=%%piNrFase", "ADICIONAL=Operação-&gt;CDFSVCO038.inValidarRelBanhoFaseEmissao")
		return(0)
	endif

	vQtAux = getFieldData("QT_RELBANHOMAX", "CDF_GMAQBENSVC", "CD_SEQMAQ=%%piCdSeqMaq")
	if (vQtAux &gt; 0 &amp; piQtRelBanho &gt; vQtAux)
		$instancehandle-&gt;setStatus(&lt;STS_ERRO&gt;, "MSG41474", "DESCRICAO=Relação de banho da fase @@1@@ maior que o máximo configurado para a máquina!&uSEP;PARAMETRO=%%piNrFase", "ADICIONAL=Operação-&gt;CDFSVCO038.inValidarRelBanhoFaseEmissao")
		return(0)
	endif

	return(1)
end ;inValidarRelBanhoFaseEmissao

;---------------------
entry addItemLstProcOp
	;------------------
	;&lt;-- DSantos Prj-&gt;217-539 20/06/2017 --&gt;
	params
		numeric piCdProcesso : IN
		string piCdReceita : IN
		string piDsLstProcOp : IN
	endparams
	variables
		string vDsRegistro, vDsLstRec
		numeric vNrOcc
	endvariables

	vDsRegistro = $item(piCdProcesso, piDsLstProcOp)

	vNrOcc = $item("NR_OCC", vDsRegistro) + 1
	putitem/id vDsRegistro, "NR_OCC", vNrOcc

	vDsLstRec = $item("DS_LSTRECEITA", vDsRegistro)
	putitem vDsLstRec, -1, piCdReceita
	putitem/id vDsRegistro, "DS_LSTRECEITA", vDsLstRec

	putitem/id vDsRegistro, "CD_PROCESSO", piCdProcesso

	putitem/id piDsLstProcOp, piCdProcesso, vDsRegistro

	return(piDsLstProcOp)
end ;addItemLstProcOp

;------------------
entry getQtAlocarOp
	;---------------
	;&lt;-- DSantos Prj-&gt;217-539 21/06/2017 --&gt;
	returns numeric
	params
		string piParams : IN
		numeric piCdProcesso : IN
		numeric piCdMaquina : IN
		boolean piInConverter : IN
		string poDsLstItem : OUT
	endparams
	variables
		string vTpConversao, vDsParams
		numeric vQtItem, vQtAlocar, vQtItemOri
		boolean vInItem
	endvariables

	if($item("TP_CONVERSAO", piParams) != "")
		vTpConversao = $item("TP_CONVERSAO", piParams)
	else
		vTpConversao = "MUL"
	endif

	vQtAlocar = 0
	vInItem = &lt;FALSE&gt;

	clear/e "PCP_OPISVC"
	CD_EMPRESA.PCP_OPISVC/init = $item("CD_EMPOP", piParams)
	NR_CICLO.PCP_OPISVC/init = $item("NR_CICLO", piParams)
	NR_OP.PCP_OPISVC/init = $item("NR_OP", piParams)
	retrieve/e "PCP_OPISVC"
	if ($status &gt;= 0)
		setocc "PCP_OPISVC", 1
		while ($status &gt;= 0)
			vDsParams = ""
			putitem/id vDsParams, "CD_EMPRESA", CD_EMPRESA.PCP_OPISVC
			putitem/id vDsParams, "NR_CICLO", NR_CICLO.PCP_OPISVC
			putitem/id vDsParams, "NR_OP", NR_OP.PCP_OPISVC
			putitem/id vDsParams, "CD_PRODUTO", CD_PRODUTO.PCP_OPISVC
			putitem/id vDsParams, "TP_CONVERSAO", vTpConversao
			;&lt;-- DSantos Prj-&gt;217-607 03/08/2017
			if (!$empty("PCP_OPILOTECSVC"))
				setocc "PCP_OPILOTECSVC", 1
				while ($status &gt;= 0)
					setocc "PCP_OPILOTEISVC", 1
					while ($status &gt;= 0)
						if (TP_SITUACAO.PCP_OPILOTEISVC != 3) ;- Diferente de cancelado
							putitem/id vDsParams, "CD_EMPOP", CD_EMPRESA.PCP_OPISVC
							putitem/id vDsParams, "NR_LOTE", NR_LOTE.PCP_OPILOTEISVC
							putitem/id vDsParams, "NR_ITEM", NR_ITEM.PCP_OPILOTEISVC
							putitem/id vDsParams, "CD_PROCESSO", piCdProcesso
							vQtItem = getQtAlocarItemLote(vDsParams, piCdProcesso, piCdMaquina, piInConverter, "", vQtItemOri)
							if ($status &lt; 0)
								return("")
							endif
							if (vQtItem &gt; 0)
								vInItem = &lt;TRUE&gt;
								putitem/id vDsParams, "QT_PARTIDA", vQtItem
								putitem/id vDsParams, "TP_ORIGEM", 2 ;-Item Lote O.P.
								putitem/id vDsParams, "QT_ITEM", vQtItemOri
								putitem/id vDsParams, "NR_AGRUPADOR", NR_OP.PCP_OPISVC
								putitem poDsLstItem, -1, vDsParams
							endif
							vQtAlocar += vQtItem
						endif
						setocc "PCP_OPILOTEISVC", $curocc("PCP_OPILOTEISVC") + 1
					endwhile
					setocc "PCP_OPILOTECSVC", $curocc("PCP_OPILOTECSVC") + 1
				endwhile
			endif
			if (!vInItem) ;&lt;-- DSantos Prj-&gt;217-771 02/04/2018
				vQtItem = getQtAlocarItemOp(vDsParams, piCdProcesso, piCdMaquina, piInConverter, "", vQtItemOri)
				if ($status &lt; 0)
					return("")
				endif
				if (vQtItem &gt; 0)
					delitem/id vDsParams, "CD_EMPRESA"
					putitem/id vDsParams, "CD_EMPOP", CD_EMPRESA.PCP_OPISVC
					putitem/id vDsParams, "QT_PARTIDA", vQtItem
					putitem/id vDsParams, "TP_ORIGEM", 1 ;-Item O.P.
					putitem/id vDsParams, "QT_ITEM", vQtItemOri
					putitem/id vDsParams, "NR_AGRUPADOR", NR_OP.PCP_OPISVC
					putitem poDsLstItem, -1, vDsParams
				endif
				vQtAlocar += vQtItem
			endif
			setocc "PCP_OPISVC", $curocc("PCP_OPISVC") + 1
		endwhile
	endif

	$status = 0
	return(vQtAlocar)
end ;getQtAlocarOp

;---------------------
entry getLstLoteItemOp
	;------------------
	returns string
	params
		numeric piCdEmpresa : IN
		numeric piNrCiclo : IN
		numeric piNrOp : IN
		numeric piCdProduto : IN
		string piDsLstLote : IN
		numeric pioQtItemLote : INOUT
	endparams
	variables
		string vDsRegLote
	endvariables

	clear/e "PCP_OPISVC"
	CD_EMPRESA.PCP_OPISVC/init = piCdEmpresa
	NR_CICLO.PCP_OPISVC/init = piNrCiclo
	NR_OP.PCP_OPISVC/init = piNrOp
	CD_PRODUTO.PCP_OPISVC/init = piCdProduto
	retrieve/e "PCP_OPISVC"
	if ($status &gt;= 0 &amp; !$empty("PCP_OPILOTECSVC"))
		setocc "PCP_OPILOTECSVC", 1
		while ($status &gt;= 0)
			if (!$empty("PCP_OPILOTEISVC"))
				setocc "PCP_OPILOTEISVC", 1
				while ($status &gt;= 0)
					vDsRegLote = ""
					putitem/id vDsRegLote, "NR_LOTE", NR_LOTE.PCP_OPILOTEISVC
					putitem/id vDsRegLote, "NR_ITEM", NR_ITEM.PCP_OPILOTEISVC
					putitem/id vDsRegLote, "QT_LOTE", QT_LOTE.PCP_OPILOTEISVC
					putitem piDsLstLote, -1, vDsRegLote
					pioQtItemLote += QT_LOTE.PCP_OPILOTEISVC
					setocc "PCP_OPILOTEISVC", $curocc("PCP_OPILOTEISVC") + 1
				endwhile
			endif
			setocc "PCP_OPILOTECSVC", $curocc("PCP_OPILOTECSVC") + 1
		endwhile
	endif

	return(piDsLstLote)
end ;getLstLoteItemOp

;-----------------------------
entry inValidarLocalizacaoItem
	;--------------------------
	returns boolean
	;&lt;-- LOMoreira Prj-&gt;217-583 25/07/2017 --&gt;
	variables
		string vDsCondicao, vDsEntity
	endvariables

	if ($empty("CDF_PARTIDAISVC"))
		return(&lt;TRUE&gt;)
	endif

	if ($dsLstLocalEmiRec$ = "")
		return(&lt;TRUE&gt;)
	endif

	;&lt;-- DSantos Prj-&gt;217-747 28/02/2018
	setocc "CDF_PARTIDAISVC", 1
	while ($status &gt;= 0)
		vDsCondicao = ""
		putitem/id vDsCondicao, "CD_EMPRESA", CD_EMPOP.CDF_PARTIDAISVC
		putitem/id vDsCondicao, "NR_CICLO", NR_CICLO.CDF_PARTIDAISVC
		putitem/id vDsCondicao, "NR_OP", NR_OP.CDF_PARTIDAISVC
		putitem/id vDsCondicao, "CD_PRODUDO", CD_PRODUTO.CDF_PARTIDAISVC
		putitem/id vDsCondicao, "CD_LOCAL", $dsLstLocalEmiRec$
		if (NR_LOTE.CDF_PARTIDAISVC != "" &amp; NR_ITEM.CDF_PARTIDAISVC != "")
			putitem/id vDsCondicao, "NR_LOTE", NR_LOTE.CDF_PARTIDAISVC
			putitem/id vDsCondicao, "NR_ITEM", NR_ITEM.CDF_PARTIDAISVC
			vDsEntity = "CDF_LOCOPLOTESVC"
		else
			vDsEntity = "CDF_LOCOPSVC"
		endif
		$handleEntity$-&gt;consultar(vDsEntity, vDsCondicao)
		if ($status &lt; 0)
			return(&lt;FALSE&gt;)
		endif
		setocc "CDF_PARTIDAISVC", $curocc("CDF_PARTIDAISVC") + 1
	endwhile
	; DSantos --&gt;

	return(&lt;TRUE&gt;)
end ;inValidarLocalizacaoItem

;---------------------------
entry associarItemLoteCriado
	;------------------------
	;&lt;-- DSantos Prj-&gt;217-571 27/07/2017 --&gt;
	returns string
	params
		string piDsLstLote : IN
		string piDsLstPartida : IN
	endparams
	variables
		string vDsLstItem, vDsRegPartida
		numeric vNrItem
	endvariables

	if (piDsLstLote = "")
		return(piDsLstPartida)
	endif

	while (piDsLstPartida != "")
		vDsRegPartida = $itemnr(1, piDsLstPartida)
		vNrItem = 1
		while (vNrItem &lt;= $itemcount(piDsLstLote))
			if ($item("NR_LOTEORI", vDsRegPartida) = $item("NR_LOTEORI", $itemnr(vNrItem, piDsLstLote)))
				if ($item("NR_ITEMORI", vDsRegPartida) = $item("NR_ITEMORI", $itemnr(vNrItem, piDsLstLote)))
					putitem/id vDsRegPartida, "NR_LOTE", $item("NR_LOTE", $itemnr(vNrItem, piDsLstLote))
					putitem/id vDsRegPartida, "NR_ITEM", $item("NR_ITEM", $itemnr(vNrItem, piDsLstLote))
					putitem/id vDsRegPartida, "QT_REFERENCIA", $item("QT_LOTE", $itemnr(vNrItem, piDsLstLote)) ;&lt;-- DSantos MVA-1221 220/2669 12/12/2017 --&gt;
					delitem piDsLstLote, vNrItem
					break
				endif
			endif
		endwhile
		putitem vDsLstItem, -1, vDsRegPartida
		delitem piDsLstPartida, 1
	endwhile

	return(vDsLstItem)
end ;associarItemLoteCriado

;---------------------------
entry getDsItemItemCliLoteOp
	;------------------------
	;&lt;-- DSantos Prj-&gt;217-571 27/07/2017 --&gt;
	returns string
	params
		string piDsParams : IN
	endparams
	variables
		string vDsCondicao
	endvariables

	vDsCondicao = ""
	putitem/id vDsCondicao, "CD_EMPRESA", $item("CD_EMPRESA", piDsParams)
	putitem/id vDsCondicao, "NR_CICLO", $item("NR_CICLO", piDsParams)
	putitem/id vDsCondicao, "NR_OP", $item("NR_OP", piDsParams)
	putitem/id vDsCondicao, "CD_PRODUTO", $item("CD_PRODUTOORI", piDsParams)
	putitem/id vDsCondicao, "NR_LOTE", $item("NR_LOTEORI", piDsParams)
	putitem/id vDsCondicao, "NR_ITEM", $item("NR_ITEMORI", piDsParams)
	return(getFieldData("DS_ITEMCLI", "PCP_OPILOTEISVC", vDsCondicao))

end ;getDsItemItemCliLoteOp

;-----------------------------
entry getQtDesmembradaItemLote
	;--------------------------
	;&lt;-- DSantos Prj-&gt;217-571 27/07/2017 --&gt;
	returns numeric
	params
		string piDsParams : IN
	endparams
	variables
		string vDsCondicao, vDsRegistro
		numeric vQtDesmembrada
	endvariables

	;--&gt; MNSANTOS - Prj 253/248 - 08/10/2018
	vDsCondicao = ""
	putitem/id vDsCondicao, "CD_EMPRESAORI", $item("CD_EMPRESA", piDsParams)
	putitem/id vDsCondicao, "NR_CICLOORI", $item("NR_CICLO", piDsParams)
	putitem/id vDsCondicao, "NR_OPORI", $item("NR_OP", piDsParams)
	putitem/id vDsCondicao, "CD_EMPRESADES", $item("CD_EMPRESA", piDsParams)
	putitem/id vDsCondicao, "NR_CICLODES", $item("NR_CICLO", piDsParams)
	putitem/id vDsCondicao, "NR_OPDES", $item("NR_OP", piDsParams)
	putitem/id vDsCondicao, "NR_LOTEORI", $item("NR_LOTE", piDsParams)
	putitem/id vDsCondicao, "NR_ITEMORI", $item("NR_ITEM", piDsParams)
	putitem/id vDsCondicao, "TP_RELACIONAMENTO", 1
	$handleConsulta$-&gt;consultar("PCP_OPILOTEIRSVC", vDsCondicao)
	if ($status &gt;= 0)
		$handleConsulta$-&gt;getRegistro(vDsRegistro)
		putitem/id piDsParams, "CD_PRODUTO", $item("CD_PRODUTODES", vDsRegistro)
		putitem/id piDsParams, "NR_LOTE", $item("NR_LOTEDES", vDsRegistro)
		putitem/id piDsParams, "NR_ITEM", $item("NR_ITEMDES", vDsRegistro)
		vQtDesmembrada = getFieldData("QT_LOTE", "PCP_OPILOTEISVC", piDsParams)
		vQtDesmembrada += getQtDesmembradaItemLote(piDsParams)
	endif

	return(vQtDesmembrada)
end ;getQtDesmembradaItemLote

;------------------------
entry getPrCoranteReceita
	;---------------------
	;&lt;-- LOMoreira Prj-&gt;217-586 31/07/2017 --&gt;
	returns numeric
	params
		numeric piCdProduto : IN
		numeric piCdMaquina : IN
		numeric piQtPeso : IN
		numeric piQtVolume : IN
		numeric piQtConsumo : IN
		boolean piInLog : IN
		string piCdReceita : IN
	endparams
	variables
		numeric vQtConsumo, vPrCorante
		string vDsCondicao, vDsRegistro
	endvariables

	vDsCondicao = ""
	putitem/id vDsCondicao, "CD_RECEITA", piCdReceita
	putitem/id vDsCondicao, "CD_PRODUTO", "&uNOT;&uEQ;%%piCdProduto"
	$handleReceitaPrd$-&gt;consultar("TEX_RECEITAPRDSVC", vDsCondicao)
	if ($status &gt;= 0)
		$handleReceitaPrd$-&gt;setEntityOcc(1)
		while ($status &gt;= 0)
			$handleReceitaPrd$-&gt;getRegistro(vDsRegistro)
			vQtConsumo = calcularCompensacaoProduto($item("CD_PRODUTO", vDsRegistro), piCdMaquina, piQtPeso, piQtVolume, $item("QT_CONSUMO", vDsRegistro), &lt;FALSE&gt;, piCdReceita)
			if ($item("TP_CONSUMO", vDsRegistro) = 1)
				vPrCorante += vQtConsumo / 10
			elseif ($item("TP_CONSUMO", vDsRegistro) = 3)
				vPrCorante += vQtConsumo
			endif
			$handleReceitaPrd$-&gt;next()
		endwhile
	endif

	return(vPrCorante)
end ;getPrCoranteReceita

;-------------------
entry getCdPrdSeguro
;-------------------
	;--&gt; MNSANTOS - Prj 217/602 - 30/08/2017
	returns numeric
	params
		string piDsLstPrd : IN
	endparams
	variables
		string vDsRegistro, vDsLstPrd, vDsLstClas, vCdClasSegura
		numeric vNrItem
	endvariables

	sort/list piDsLstPrd, "unique"
	if($itemcount(piDsLstPrd) = 1)
		return(piDsLstPrd)
	endif

	if($cdTipoClasPadraoTec$ = "")
		return("")
	endif

	while(piDsLstPrd != "")
		vDsRegistro = ""
		putitem/id vDsRegistro, "CD_PRODUTO", $itemnr(1, piDsLstPrd)
		putitem/id vDsRegistro, "CD_TIPOCLAS", $cdTipoClasPadraoTec$
		putitem/id vDsRegistro, "CD_CLASSIFICACAO", getFieldData("CD_CLASSIFICACAO", "PRD_PRODUTOCLSVC", vDsRegistro)
		putitem vDsLstPrd, -1, vDsRegistro
		if($item("CD_CLASSIFICACAO", vDsRegistro) != "")
			putitem vDsLstClas, -1, $item("CD_CLASSIFICACAO", vDsRegistro)
		endif
		delitem piDsLstPrd, 1
	endwhile

	if(vDsLstClas != "")
		sort/list vDsLstClas, "unique"
		if($itemcount(vDsLstClas) = 1)
			return($item("CD_PRODUTO", $itemnr(1, vDsLstPrd)))
		endif

		vNrItem = 1
		while(vNrItem &lt;= $itemcount(vDsLstClas) &amp; vCdClasSegura = "")
			vCdClasSegura = getCdClasSegura($itemnr(vNrItem, vDsLstClas), vNrItem, vDsLstClas)
			vNrItem += 1
		endwhile
	endif

	if(vCdClasSegura = "")
		$instancehandle-&gt;setStatus(&lt;STS_ERRO&gt;, "MSG41961", "DESCRICAO=Tipo seguro não cadastrado para os produtos da partida!", "ADICIONAL=Operação-&gt;CDFSVCO038.getCdPrdSeguro")
		$status = -1
		return("")
	endif

	while(vDsLstPrd != "")
		if($item("CD_CLASSIFICACAO", $itemnr(1, vDsLstPrd)) = vCdClasSegura)
			return($item("CD_PRODUTO", $itemnr(1, vDsLstPrd)))
		endif
		delitem vDsLstPrd, 1
	endwhile

	return("")
end ;getCdPrdSeguro

;--------------------
entry getCdClasSegura
;--------------------
	;--&gt; MNSANTOS - Prj 217/602 - 30/08/2017
	returns string
	params
		string piCdClas : IN
		numeric piNrItem : IN
		string piDsLstClas : IN
	endparams
	variables
		numeric vNrItem
		string vDsCondicao
	endvariables

	vNrItem = 0
	while(piDsLstClas != "")
		vNrItem += 1
		if(vNrItem != piNrItem)
			vDsCondicao = ""
			putitem/id vDsCondicao, "CD_TIPOCLAS", $cdTipoClasPadraoTec$
			putitem/id vDsCondicao, "CD_CLASSIFICACAO", piCdClas
			putitem/id vDsCondicao, "CD_CLASSEGURO", $itemnr(1, piDsLstClas)
			$handleEntity$-&gt;consultar("CDF_TIPOSEGUROSVC", vDsCondicao)
			if($status &gt;= 0)
				return($itemnr(1, piDsLstClas))
			endif
		endif
		delitem piDsLstClas, 1
	endwhile

	return("")
end ; getCdClasSegura

;---------------------------
entry getCampoConfPartidaRec
;---------------------------
	;--&gt; MNSANTOS - Prj 217/590 - 11/08/2017
	returns string
	params
		numeric piCdEmpresa : IN
		numeric piNrPartida : IN
		numeric piNrFase : IN
		numeric piNrOper : IN
		numeric piCdCampo : IN
	endparams
	variables
		string viParams, voParams
	endvariables

	viParams = ""
	if (piNrOper = "")
		putitem/id viParams, "DS_ENTITY", "CDF_PARTIDARECFASECAMPOSVC"
		putitem/id viParams, "DS_KEYS", "CD_EMPRESA&uSEP;NR_PARTIDA&uSEP;NR_FASE"
	else
		putitem/id viParams, "DS_ENTITY", "CDF_PARTIDARECOPERCAMPOSVC"
		putitem/id viParams, "DS_KEYS", "CD_EMPRESA&uSEP;NR_PARTIDA&uSEP;NR_FASE&uSEP;NR_OPER"
	endif
	putitem/id viParams, "CD_EMPRESA", piCdEmpresa
	putitem/id viParams, "NR_PARTIDA", piNrPartida
	putitem/id viParams, "NR_FASE", piNrFase
	putitem/id viParams, "NR_OPER", piNrOper
	putitem/id viParams, "TP_CONF", 7 ;- Partida
	putitem/id viParams, "CD_CONF", piCdCampo
	activate "PCPSVCO047".buscarDadosConf(viParams, voParams, $xCdErro$, $xCtxErro$)
	if ($procerror)
		$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
		$status = -1
		return("")
	elseif ($status &lt; 0)
		return("")
	endif

	return($replace($item("DS_CAMPO", voParams), 1, ",", ".", -1))
end ;getCampoConfEmissao

;-------------------
entry getProcOrgatex
;-------------------
	;--&gt; MNSANTOS - Prj  - 26/10/2017
	returns numeric
	params
		string piCdReceita : IN
	endparams
	variables
		numeric vCdProcOrgatex
		string vDsCondicao
	endvariables

	vDsCondicao = ""
	if(piCdReceita[1,2] = "RP")
		putitem/id vDsCondicao, "CD_EMPRESA", piCdReceita[3:4]
		putitem/id vDsCondicao, "NR_PARTIDA", piCdReceita[7]
		vCdProcOrgatex = getFieldData("CD_PROCORGATEX", "CDF_PARTIDARECSVC", vDsCondicao)
	else
		vCdProcOrgatex = getFieldData("CD_PROCORGATEX", "TEX_RECEITASVC", "CD_RECEITA=%%piCdReceita")
	endif

	return(vCdProcOrgatex)
end ;getProcOrgatex

;---------------------------
entry getDsLstTipoUtilizacao
	;------------------------
	returns string
	params
		string piDsRegProc : IN
	endparams
	variables
		string vDsCondicao,vDsRegistro, vDsRegTpUtilizacao, vDsLstTpUtilizacao, vDsId
	endvariables

	if ($item("NR_OP", piDsRegProc) != "") ;--&gt;ROS--&gt;220/2849--&gt;20/02/2018
		vDsCondicao = ""
		putitem/id vDsCondicao, "CD_EMPRESA", $item("CD_EMPRESA", piDsRegProc)
		putitem/id vDsCondicao, "NR_CICLO", $item("NR_CICLO", piDsRegProc)
		putitem/id vDsCondicao, "NR_OP", $item("NR_OP", piDsRegProc)
		putitem/id vDsCondicao, "CD_PRODUTO", $item("CD_PRODUTO", piDsRegProc)
		putitem/id vDsCondicao, "NR_SEQUENCIA", $item("NR_SEQUENCIA", piDsRegProc)
		$handleEntity$-&gt;consultar("PCP_OPISEQPROCMPSVC", vDsCondicao)
		if ($status &gt;= 0)
			vDsLstTpUtilizacao = ""
			$handleEntity$-&gt;setEntityOcc(1)
			while ($status &gt;= 0)
				vDsRegistro = ""
				$handleEntity$-&gt;getRegistro(vDsRegistro)
				vDsId = $concat($item("NR_FASE", vDsRegistro), $item("NR_SEQOPER", vDsRegistro), $item("NR_SEQPRD", vDsRegistro), $item("CD_PRODUTOMP", vDsRegistro))
				vDsRegTpUtilizacao = ""
				putitem/id vDsRegTpUtilizacao, "NR_FASE", $item("NR_FASE", vDsRegistro)
				putitem/id vDsRegTpUtilizacao, "NR_SEQOPER", $item("NR_SEQOPER", vDsRegistro)
				putitem/id vDsRegTpUtilizacao, "NR_SEQPRD", $item("NR_SEQPRD", vDsRegistro)
				putitem/id vDsRegTpUtilizacao, "CD_PRODUTOMP", $item("CD_PRODUTOMP", vDsRegistro)
				putitem/id vDsRegTpUtilizacao, "CD_TPUTILIZACAO", $item("CD_TPUTILIZACAO", vDsRegistro)
				putitem/id vDsLstTpUtilizacao, vDsId, vDsRegTpUtilizacao
				$handleEntity$-&gt;next()
			endwhile
		endif
	else
		vDsLstTpUtilizacao = $item("DS_LSTTPUTILIZACAO", piDsRegProc) ;--&gt;ROS--&gt;220/2849--&gt;20/02/2018
	endif

	return(vDsLstTpUtilizacao)
end ;getDsLstTipoUtilizacao

;------------------------
entry getLstDefeitoLoteOp
	;---------------------
	;&lt;-- DSantos Prj-&gt;217-710 24/01/2018 --&gt;
	params
		string piParams : IN
	endparams
	variables
		string vDsLista, vDsCondicao
	endvariables

	vDsLista = ""
	vDsCondicao = ""

	putitem/id vDsCondicao, "CD_EMPRESA", $item("CD_EMPRESA", piParams)
	putitem/id vDsCondicao, "NR_CICLO", $item("NR_CICLO", piParams)
	putitem/id vDsCondicao, "NR_OP", $item("NR_OP", piParams)
	putitem/id vDsCondicao, "CD_PRODUTO", $item("CD_PRODUTOORI", piParams)
	putitem/id vDsCondicao, "NR_LOTE", $item("NR_LOTEORI", piParams)
	putitem/id vDsCondicao, "NR_ITEM", $item("NR_ITEMORI", piParams)
	$handleEntity$-&gt;consultar("PCP_OPILOTEIDEFSVC", vDsCondicao)
	if ($status &lt; 0)
		return("")
	endif

	$handleEntity$-&gt;setEntityOcc(1)
	while ($status &gt;= 0)
		putitem vDsLista, -1, getRegistro($handleEntity$)
		$handleEntity$-&gt;next()
	endwhile

	return(vDsLista)
end ;getLstDefeitoLoteOp

;---------------------
entry getObsItemLoteOp
	;------------------
	;&lt;-- DSantos Prj-&gt;217-710 24/01/2018 --&gt;
	params
		string piParams : IN
	endparams
	variables
		string vDsCondicao
	endvariables

	vDsCondicao = ""
	putitem/id vDsCondicao, "CD_EMPRESA", $item("CD_EMPRESA", piParams)
	putitem/id vDsCondicao, "NR_CICLO", $item("NR_CICLO", piParams)
	putitem/id vDsCondicao, "NR_OP", $item("NR_OP", piParams)
	putitem/id vDsCondicao, "CD_PRODUTO", $item("CD_PRODUTOORI", piParams)
	putitem/id vDsCondicao, "NR_LOTE", $item("NR_LOTEORI", piParams)
	putitem/id vDsCondicao, "NR_ITEM", $item("NR_ITEMORI", piParams)
	return(getFieldData("DS_OBSERVACAO", "PCP_OPILOTEISVC", vDsCondicao))

end ;

;-------------------
entry getPesoProduto
;-------------------
	;--&gt; MNSANTOS - Prj 253/4 - 05/03/2018
	returns numeric
	params
		string piParams : IN
	endparams
	variables
		numeric vQtPeso, vCdMp
	endvariables

	if (!inValidarParametro("CD_PRODUTO", piParams, "getPesoProduto"))
		$status = -1
		return("")
	endif

	vQtPeso = getDadosIntegracao($item("CD_PRODUTO", piParams), 1, 9) ;- Gramatura linear em cru, considerando integração.
	if ($status &lt; 0)
		return("")
	endif
	if (vQtPeso = "")
		vQtPeso = getInfTecConf($item("CD_PRODUTO", piParams), "", "", "", 1, 5) ;- Gramatura linear em cru, considerando configuração(PCPFM221).
		if ($status &lt; 0)
			return("")
		endif
		if (vQtPeso = "")
			vCdMp = getMpPrincipal(piParams)
			if(vCdMp != "")
				vQtPeso = getDadosIntegracao(vCdMp, 1, 9) ;- Gramatura linear em cru, considerando integração.
				if ($status &lt; 0)
					return("")
				endif
				if (vQtPeso = "")
					vQtPeso = getInfTecConf(vCdMp, "", "", "", 1, 5) ;- Gramatura linear em cru, considerando configuração(PCPFM221).
					if ($status &lt; 0)
						return("")
					endif
				endif
			endif
			if(vQtPeso = "")
				vQtPeso = getFieldData("QT_PESO", "PRD_PRODUTOSVC", "CD_PRODUTO=%%$item("CD_PRODUTO", piParams)")
				if (vQtPeso = "")
					$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG39679", "DESCRICAO=Produto sem peso informado para conversão!", "ADICIONAL=Operação-&gt;CDFSVCO038.converteQtProduto")
					$status = -1
					return("")
				endif
				return(vQtPeso)
			endif
		endif
	endif
	vQtPeso /= 1000

	return(vQtPeso)
end ;getPesoProduto

;-------------------
entry getMpPrincipal
;-------------------
	;--&gt;MNSANTOS - Prj 253/4 - 07/03/2018
	returns numeric
	params
		string piParams : IN
	endparams
	variables
		numeric vCdMp
		string vDsCondicao, vDsRegMpI, vDsRegMp
	endvariables

	if (!inValidarParametro("CD_PRODUTO", piParams, "getMpPrincipal"))
		$status = -1
		return("")
	endif

	vDsCondicao = ""
	putitem/id vDsCondicao, "CD_PRODUTOPA", $item("CD_PRODUTO", piParams)
	putitem/id vDsCondicao, "IN_PRINCIPAL", &lt;TRUE&gt;
	$handleEntity$-&gt;consultar("V_PCP_FC2SVC", vDsCondicao)
	if ($status &gt;= 0)
		vCdMp = $item("CD_PRODUTOMP", getRegistro($handleEntity$))
		;if($item("NR_OP", piParams) != "")
;			vDsCondicao = ""
;			putitem/id vDsCondicao, "CD_EMPRESA", $item("CD_EMPRESA", piParams)
;			putitem/id vDsCondicao, "NR_CICLO", $item("NR_CICLO", piParams)
;			putitem/id vDsCondicao, "NR_OP", $item("NR_OP", piParams)
;			putitem/id vDsCondicao, "CD_PRODUTOPA", $item("CD_PRODUTO", piParams)
;			putitem/id vDsCondicao, "CD_PRODUTOMP", $item("CD_PRODUTOMP", getRegistro($handleEntity$))
;			$handleEntity$-&gt;consultar("PCP_OPMPISVC", vDsCondicao)
;			if ($status &gt;= 0)
;				$handleEntity$-&gt;getRegistro(vDsRegMpI)
;				vDsCondicao = ""
;				putitem/id vDsCondicao, "CD_EMPRESA", $item("CD_EMPRESA", piParams)
;				putitem/id vDsCondicao, "NR_CICLO", $item("NR_CICLO", piParams)
;				putitem/id vDsCondicao, "NR_OP", $item("NR_OP", piParams)
;				putitem/id vDsCondicao, "CD_PRODUTO", $item("CD_PRODUTOMP", vDsRegMpI)
;				$handleEntity$-&gt;consultar("PCP_OPMPSVC", vDsCondicao)
;				if ($status &gt;= 0)
;					$handleEntity$-&gt;getRegistro(vDsRegMp)
;
;					repeat
;						delitem/id vDsCondicao, "CD_PRODUTO"
;						putitem/id vDsCondicao, "CD_PRODSUBSTITUIDO", $item("CD_PRODUTOMP", vDsRegMpI)
;						$handleEntity$-&gt;consultar("PCP_OPMPSVC", vDsCondicao)
;						if ($status &gt;= 0)
;							$handleEntity$-&gt;getRegistro(vDsRegMp)
;							vDsCondicao = ""
;							putitem/id vDsCondicao, "CD_EMPRESA", $item("CD_EMPRESA", piParams)
;							putitem/id vDsCondicao, "NR_CICLO", $item("NR_CICLO", piParams)
;							putitem/id vDsCondicao, "NR_OP", $item("NR_OP", piParams)
;							putitem/id vDsCondicao, "CD_PRODUTOPA", $item("CD_PRODUTO", piParams)
;							putitem/id vDsCondicao, "CD_PRODUTOMP", $item("CD_PRODUTO", vDsRegMp)
;							$handleEntity$-&gt;consultar("PCP_OPMPISVC", vDsCondicao)
;							if ($status &gt;= 0)
;								$handleEntity$-&gt;getRegistro(vDsRegMpI)
;								vCdMp = $item("CD_PRODUTOMP", vDsRegMpI)
;							else
;								return("")
;							endif
;						endif
;					until($status &lt; 0)
;				endif
;			endif
;		endif
	endif

	return(vCdMp)
end ;getMpPrincipal

;------------------------
entry dsBuscarClasReceita
	;---------------------
	;&lt;-- DSantos Prj-&gt;217-771 03/04/2018 --&gt;
	returns string
	params
		string piCdReceita : IN
	endparams
	variables
		string vDsCondicao, vDsLstClas
	endvariables

	if ($dsLstTpClaRecPartida$ = "")
		return("")
	endif

	vDsCondicao = ""
	putitem/id vDsCondicao, "CD_RECEITA", piCdReceita
	putitem/id vDsCondicao, "CD_TIPCLA", $dsLstTpClaRecPartida$
	putitem/id vDsCondicao, "CD_TPCLAS", "R" ;- Cadastro de receita
	$handleRecClas$-&gt;consultar("TEX_RECCLASSVC", vDsCondicao)
	if ($status &gt;= 0)
		$handleRecClas$-&gt;setEntityOcc(1)
		while ($status &gt;= 0)
			putitem vDsLstClas, -1, getRegistro($handleRecClas$)
			$handleRecClas$-&gt;next()
		endwhile
	endif

	return(vDsLstClas)
end ;dsBuscarClasReceita


;IAS - PRJ/TAR - 253/0028 - 23/04/2018
;--------------------------------
entry prCalcularEficienciaPartida
;--------------------------------
	returns numeric
	params
		string piCdEmpresa : IN
		numeric piNrPartida : IN
		numeric piCdMaquina : IN
	endparams
	variables
		string viParams, voParams
		numeric vQtTempoEstimado, vQtTempoReal, vQtEficiencia
		handle vDsHandle
	endvariables

	if(getFieldData("IN_EFICIENCIA", "CDF_MAQCONFPARSVC", "CD_MAQUINA=%%piCdMaquina") != "T")
		return("")
	endif

	viParams = ""
	putitem/id viParams, "CD_EMPRESA", piCdEmpresa
	putitem/id viParams, "NR_PARTIDA", piNrPartida
	newinstance "CDFSVCO038", vDsHandle
	vDsHandle-&gt;calcularTempoPartida(viParams , voParams, $xCdErro$, $xCtxErro$)
	if($procerror) | ($status &lt; 0)
		return("")
	endif
	vQtTempoEstimado = $item("QT_TEMPOESTIMADO" , voParams)
	vQtTempoReal     = $item("QT_TEMPOPRODUTIVO", voParams)
	vQtEficiencia 		= (vQtTempoEstimado * 100) / vQtTempoReal
	if(vQtEficiencia &gt;= 1000)
		vQtEficiencia = 999.99
	endif

	return(vQtEficiencia)
End;prCalcularEficienciaPartida
;--

;---------------------------------
entry dsBuscarPadraoTecnicoMaquina
;---------------------------------
	;HSGARCIA Proj 253/100 02/07/2018
	returns string
	params
		numeric piCdProduto : IN
		numeric piCdMaquina : IN
		numeric piCdTipoCampo : IN
		numeric piCdProcesso : IN
		numeric piCdEmpPartida : IN
		numeric piNrPartida : IN
	endparams
	variables
		string viParams, voParams
	endvariables

	viParams = ""
	putitem/id viParams, "CD_PRODUTO", piCdProduto
	putitem/id viParams, "CD_MAQUINA", piCdMaquina
	putitem/id viParams, "CD_TIPOCAMPO", piCdTipoCampo
	putitem/id viParams, "CD_PROCESSO", piCdProcesso
	putitem/id viParams, "CD_EMPPARTIDA", piCdEmpPartida
	putitem/id viparams, "NR_PARTIDA", piNrPartida
	activate "CDFSVCO029".buscarCamposPadraoTecnico(viParams, voParams, $xCdErro$, $xCtxErro$)
	if ($procerror)
		$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
		return("")
	elseif ($status &lt; 0)
		return("")
	endif

	return($item("DS_CAMPO", $itemnr(1, $item("DS_LSTIT", voParams))))
end; dsBuscarPadraoTecnicoMaquina

;-------------------------------
entry inVerificarRetiradaEmissao
;-------------------------------
	;-&gt;HSGARCIA Proj 253/259 08/10/2018
	returns boolean
	variables
		string vDsCondicao, vDsRegistro
	endvariables

	clear/e "CDF_PARTIDAEMISSAOSVC"
	;-&gt;HSGARCIA Proj 220/3852 DVAIND-2253 20/12/18
	TP_SITUACAO.CDF_PARTIDAEMISSAOSVC/init = 1
	TP_EMISSAO.CDF_PARTIDAEMISSAOSVC/init = "&uNOT;&uEQ;3" ;--Simulação
	;&lt;-
	retrieve/e "CDF_PARTIDAEMISSAOSVC"
	if($status &gt;= 0)
		setocc "CDF_PARTIDAEMISSAOSVC", 1
		while($status &gt;= 0)
			vDsCondicao = ""
			putitem/id vDsCondicao, "CD_EMPRESA", CD_EMPEMISSAO.CDF_PARTIDAEMISSAOSVC
			putitem/id vDsCondicao, "NR_EMISSAO", NR_EMISSAO.CDF_PARTIDAEMISSAOSVC
			$handleEntity$-&gt;consultar("TEX_RECEMIMPSVC", vDsCondicao)
			if($status &gt;= 0)
				$handleEntity$-&gt;setEntityOcc(1)
				while($status &gt;= 0)
					$handleEntity$-&gt;getRegistro(vDsRegistro)
					if(!inValidarListaClasProduto($item("CD_PRODUTO", vDsRegistro), $cdClasPermitePartida$))
						if($item("QT_RETIRADA", vDsRegistro) - $item("QT_RETORNADA", vDsRegistro) &lt;= 0 &amp; $item("DT_FECHAMENTO", vDsRegistro) = "")
							$instancehandle-&gt;setStatus(&lt;STS_ERRO&gt;, "MSG43574", "DESCRICAO=Partida possui emissão sem baixa de matéria-prima!", "ADICIONAL=Operação-&gt;CDFSVCO038.inVerificarRetiradaEmissao")
							return(&lt;FALSE&gt;)
						endif
					endif
					$handleEntity$-&gt;next()
				endwhile
			endif
			setocc "CDF_PARTIDAEMISSAOSVC", $curocc("CDF_PARTIDAEMISSAOSVC") + 1
		endwhile
	endif

	return(&lt;TRUE&gt;)
end; inVerificarRetiradaEmissao

;-------------------------------
entry inValidarListaClasProduto
	;---------------------------
	;-&gt;HSGARCIA Proj 253/259 08/10/2018
	returns boolean
	params
		numeric piCdProduto : IN
		string piDsLstClas : IN
	endparams
	variables
		string viParams, voParams
	endvariables

	if(piDsLstClas = "")
		return(&lt;FALSE&gt;)
	endif

	viParams = ""
	putitem/id viParams, "CD_PRODUTO", piCdProduto
	putitem/id viParams, "DS_LSTCLAS", piDsLstClas
	activate "PRDSVCO026".validarClassificacaoProduto(viParams, voParams, $xCdErro$, $xCtxErro$)
	if ($procerror)
		$instancehandle-&gt;setStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
		return(&lt;FALSE&gt;)
	elseif ($status &lt; 0 | voParams = "")
		return(&lt;FALSE&gt;)
	endif

	return(&lt;TRUE&gt;)
end ;inValidarListaClasProduto

;IAS - PRJ/TAR - 253/0276 - 15/10/2018
;------------------------------
entry dsMontarParamentroCalculo
;------------------------------
	variables
		string viParams
	endvariables

	viParams = ""
	putitem/id viParams, "CD_RECEITA" , CD_RECEITA.TEX_RECEMISSASVC
	putitem/id viParams, "NR_FASE"    , NR_FASE.TEX_RECEOPPRDSVC
	putitem/id viParams, "NR_SEQOPER" , NR_SEQOPER.TEX_RECEOPPRDSVC
	putitem/id viParams, "NR_SEQPRD"  , NR_SEQPRD.TEX_RECEOPPRDSVC
	putitem/id viParams, "CD_PRODUTO" , CD_PRODUTO.TEX_RECEOPPRDSVC
	putitem/id viParams, "QT_PESO"    , QT_PESO.TEX_RECEMISSASVC
	putitem/id viParams, "QT_VOLUME"  , calcularVolumeEmissao(QT_VOLUME.TEX_RECEMISSASVC, QT_PESO.TEX_RECEMISSASVC, CD_RECEITA.TEX_RECEMISSASVC, NR_FASE.TEX_RECEMIFASSVC, QT_RELBANHO.TEX_RECEMIFASSVC, "", "")
	putitem/id viParams, "TP_CONSUMO" , TP_CONSUMO.TEX_RECEOPPRDSVC
	putitem/id viParams, "QT_CONSUMO" , QT_CONSUMO.TEX_RECEOPPRDSVC
	putitem/id viParams, "QT_RELBANHO", QT_RELBANHO.TEX_RECEMIFASSVC
	putitem/id viParams, "QT_PRODUTO" , $item("QT_PRODUTO", DS_INFO.TEX_RECEMISSASVC)
	putitem/id viParams, "CD_TPUTILIZACAO", $item("CD_TPUTILIZACAO", DS_INFO.TEX_RECEMISSASVC)
	putitem/id viParams, "DS_LSTTPUTILIZACAO", $item("DS_LSTTPUTILIZACAO", DS_INFO.TEX_RECEMISSASVC)

	return(viParams)

End;dsMontarParamentroCalculo

;IAS - PRJ/TAR - 253/0276 - 15/10/2018
;-------------------
entry nrBuscarSeqRel
;-------------------
	returns numeric
	params
		string piParams : IN
	endparams
	variables
		numeric vNrSeq
	endvariables

	selectdb max(NR_SEQUENCIA) from "TEX_RELSUBPRDRECEMISVC" u_where %\
		CD_EMPRESA.TEX_RELSUBPRDRECEMISVC = $item("CD_EMPRESA", piParams) %\
		&amp; NR_EMISSAO.TEX_RELSUBPRDRECEMISVC = $item("NR_EMISSAO", piParams) %\
		&amp; NR_FASE.TEX_RELSUBPRDRECEMISVC = $item("NR_FASE", piParams) %\
		&amp; NR_SEQOPER.TEX_RELSUBPRDRECEMISVC = $item("NR_SEQOPER", piParams) %\
		&amp; NR_SEQPRD.TEX_RELSUBPRDRECEMISVC = $item("NR_SEQPRD", piParams) %\
	to vNrSeq

	return(vNrSeq + 1)

End;nrBuscarSeqRel

;--------------------
entry dsBuscarReceita
	;----------------
	;IES Proj/tar 253/349 21/11/2018 DVAIND-1254
	returns string
	params
		numeric piCdEmpresa : IN
		numeric piNrCiclo	 : IN
		numeric piNrOp		 : IN
		numeric piCdProcesso: IN
	endparams
	variables
		string vDsReceita, vDsLstReceitas
		numeric vNrEmissao
	endvariables

	vDsLstReceitas = ""
	clear/e "V_CDF_PARTIDASVC"
	CD_EMPRESA.V_CDF_PARTIDASVC/init = piCdEmpresa
	NR_CICLO.V_CDF_PARTIDASVC/init = piNrCiclo
	NR_OP.V_CDF_PARTIDASVC/init = piNrOp
	TP_SITUACAO.V_CDF_PARTIDASVC/init = 4
	CD_PROCESSO.V_CDF_PARTIDASVC/init = piCdProcesso
	retrieve/e "V_CDF_PARTIDASVC"
	if ($status &gt;= 0)
		setocc "V_CDF_PARTIDASVC", 1
		while($status &gt;= 0)
			clear/e "CDF_PARTIDAEMISSAOSVC"
			CD_EMPPARTIDA.CDF_PARTIDAEMISSAOSVC/init = CD_EMPRESA.V_CDF_PARTIDASVC
			NR_PARTIDA.CDF_PARTIDAEMISSAOSVC/init = NR_PARTIDA.V_CDF_PARTIDASVC
			TP_EMISSAO.CDF_PARTIDAEMISSAOSVC/init = 1
			retrieve/e "CDF_PARTIDAEMISSAOSVC"
			if ($status &gt;= 0)
				setocc "CDF_PARTIDAEMISSAOSVC", 1
				while($status &gt;= 0)
					vNrEmissao = getFieldData("NR_EMISSAO", "CDF_PARTIDAEMISSAOSVC", "CD_EMPPARTIDA=%%CD_EMPRESA.V_CDF_PARTIDASVC&uSEP;NR_PARTIDA=%%NR_PARTIDA.V_CDF_PARTIDASVC")
					if (NR_EMISSAO.CDF_PARTIDAEMISSAOSVC &gt; 0)
						vDsReceita = getFieldData("CD_RECEITA", "TEX_RECEMISSASVC", "CD_EMPRESA=%%CD_EMPRESA.V_CDF_PARTIDASVC&uSEP;NR_EMISSAO=%%vNrEmissao&uSEP;TP_SITUACAO=1")
						if ($item(vDsReceita, vDsLstReceitas) = "")
							putitem vDsLstreceitas, -1, vDsReceita
						endif
					endif
					setocc "CDF_PARTIDAEMISSAOSVC", $curocc("CDF_PARTIDAEMISSAOSVC") + 1
				endwhile
			endif
			setocc "V_CDF_PARTIDASVC", $curocc("V_CDF_PARTIDASVC") + 1
		endwhile
	endif

	return(vDsLstReceitas)
end;dsBuscarReceita</DAT>
<DAT name="FORMPIC" xml:space='preserve'>
 &uFRM;TYP=E&uSEP;NAM=CDF_PARTIDARESVC.CDF&uSEP;WID=20&uSEP;HEI=1&uSEP;HOC=20&uSEP;VOC=1&uFRM;

 &uFRM;TYP=E&uSEP;NAM=TMP_K06NR10SVC.TMP&uSEP;WID=25&uSEP;HEI=4&uSEP;HOC=25&uSEP;VOC=4&uFRM;
  &uFRM;TYP=F&uSEP;NAM=QT_MOVIMENTO&uSEP;WID=20&uSEP;HEI=1&uFRM;
  &uFRM;TYP=F&uSEP;NAM=DS_LSTLOTE&uSEP;WID=20&uSEP;HEI=1&uFRM;


 &uFRM;TYP=E&uSEP;NAM=TMP_K03NRSVC.TMP&uSEP;WID=25&uSEP;HEI=3&uSEP;HOC=25&uSEP;VOC=3&uFRM;
  &uFRM;TYP=F&uSEP;NAM=CD_FORNECEDOR&uSEP;WID=20&uSEP;HEI=1&uFRM;


 &uFRM;TYP=E&uSEP;NAM=CDF_PRDCLARECSVC.CDF&uSEP;WID=30&uSEP;HEI=5&uSEP;HOC=30&uSEP;VOC=5&uFRM;
  &uFRM;TYP=E&uSEP;NAM=CDF_PRDCLAFORSVC.CDF&uSEP;WID=25&uSEP;HEI=3&uSEP;HOC=25&uSEP;VOC=3&uFRM;
   &uFRM;TYP=E&uSEP;NAM=CDF_PRDFORPERSVC.CDF&uSEP;WID=20&uSEP;HEI=1&uSEP;HOC=20&uSEP;VOC=1&uFRM;



 &uFRM;TYP=E&uSEP;NAM=TEX_RECEITASVC.TEX&uSEP;WID=35&uSEP;HEI=13&uSEP;HOC=35&uSEP;VOC=13&uFRM;
  &uFRM;TYP=E&uSEP;NAM=TEX_RECEITAFASESVC.TEX&uSEP;WID=20&uSEP;HEI=1&uSEP;HOC=20&uSEP;VOC=1&uFRM;

  &uFRM;TYP=E&uSEP;NAM=TEX_RECFASESVC.TEX&uSEP;WID=30&uSEP;HEI=9&uSEP;HOC=30&uSEP;VOC=9&uFRM;
   &uFRM;TYP=E&uSEP;NAM=CDF_CFGRECFASESVC.CDF&uSEP;WID=20&uSEP;HEI=1&uSEP;HOC=20&uSEP;VOC=1&uFRM;

   &uFRM;TYP=E&uSEP;NAM=TEX_RECOPERSVC.TEX&uSEP;WID=25&uSEP;HEI=5&uSEP;HOC=25&uSEP;VOC=5&uFRM;
    &uFRM;TYP=E&uSEP;NAM=CDF_CFGRECOPERSVC.CDF&uSEP;WID=20&uSEP;HEI=1&uSEP;HOC=20&uSEP;VOC=1&uFRM;

    &uFRM;TYP=E&uSEP;NAM=TEX_RECOPERPRSVC.TEX&uSEP;WID=20&uSEP;HEI=1&uSEP;HOC=20&uSEP;VOC=1&uFRM;




 &uFRM;TYP=E&uSEP;NAM=TEX_RECEMISSASVC.TEX&uSEP;WID=35&uSEP;HEI=15&uSEP;HOC=35&uSEP;VOC=15&uFRM;
  &uFRM;TYP=E&uSEP;NAM=TEX_RECEMIOPSVC.TEX&uSEP;WID=20&uSEP;HEI=1&uSEP;HOC=20&uSEP;VOC=1&uFRM;

  &uFRM;TYP=E&uSEP;NAM=TEX_RECEMIMPSVC.TEX&uSEP;WID=20&uSEP;HEI=1&uSEP;HOC=20&uSEP;VOC=1&uFRM;

  &uFRM;TYP=E&uSEP;NAM=TEX_RECEMIFASSVC.TEX&uSEP;WID=30&uSEP;HEI=9&uSEP;HOC=30&uSEP;VOC=9&uFRM;
   &uFRM;TYP=E&uSEP;NAM=CDF_CFGRECEMIFASESVC.CDF&uSEP;WID=20&uSEP;HEI=1&uSEP;HOC=20&uSEP;VOC=1&uFRM;

   &uFRM;TYP=E&uSEP;NAM=TEX_RECEMIOPESVC.TEX&uSEP;WID=25&uSEP;HEI=5&uSEP;HOC=25&uSEP;VOC=5&uFRM;
    &uFRM;TYP=E&uSEP;NAM=CDF_CFGRECEMIOPERSVC.CDF&uSEP;WID=20&uSEP;HEI=1&uSEP;HOC=20&uSEP;VOC=1&uFRM;

    &uFRM;TYP=E&uSEP;NAM=TEX_RECEOPPRDSVC.TEX&uSEP;WID=20&uSEP;HEI=1&uSEP;HOC=20&uSEP;VOC=1&uFRM;




 &uFRM;TYP=E&uSEP;NAM=CDF_MAQSVC.CDF&uSEP;WID=20&uSEP;HEI=1&uSEP;HOC=20&uSEP;VOC=1&uFRM;

 &uFRM;TYP=E&uSEP;NAM=PCP_AGRUOPISVC.PCP&uSEP;WID=20&uSEP;HEI=1&uSEP;HOC=20&uSEP;VOC=1&uFRM;

 &uFRM;TYP=E&uSEP;NAM=PCP_AGRUOPILISVC.PCP&uSEP;WID=20&uSEP;HEI=1&uSEP;HOC=20&uSEP;VOC=1&uFRM;

 &uFRM;TYP=E&uSEP;NAM=PCP_OPISVC.PCP&uSEP;WID=30&uSEP;HEI=7&uSEP;HOC=30&uSEP;VOC=7&uFRM;
  &uFRM;TYP=E&uSEP;NAM=PCP_OPILOTECSVC.PCP&uSEP;WID=25&uSEP;HEI=3&uSEP;HOC=25&uSEP;VOC=3&uFRM;
   &uFRM;TYP=E&uSEP;NAM=PCP_OPILOTEISVC.PCP&uSEP;WID=20&uSEP;HEI=1&uSEP;HOC=20&uSEP;VOC=1&uFRM;


  &uFRM;TYP=E&uSEP;NAM=PCP_OPISEQPROSVC.PCP&uSEP;WID=20&uSEP;HEI=1&uSEP;HOC=20&uSEP;VOC=1&uFRM;


 &uFRM;TYP=E&uSEP;NAM=F_CDF_PARTIISVC.CDF&uSEP;WID=20&uSEP;HEI=1&uSEP;HOC=20&uSEP;VOC=1&uFRM;

 &uFRM;TYP=E&uSEP;NAM=F_CDF_PARTIDASVC.CDF&uSEP;WID=20&uSEP;HEI=1&uSEP;HOC=20&uSEP;VOC=1&uFRM;

 &uFRM;TYP=E&uSEP;NAM=CDF_MOVOPCSVC.CDF&uSEP;WID=20&uSEP;HEI=1&uSEP;HOC=20&uSEP;VOC=1&uFRM;

 &uFRM;TYP=E&uSEP;NAM=CDF_PARTIDAMOVSVC.CDF&uSEP;WID=20&uSEP;HEI=1&uSEP;HOC=20&uSEP;VOC=1&uFRM;

 &uFRM;TYP=E&uSEP;NAM=CDF_PARTIDAFISVC.CDF&uSEP;WID=20&uSEP;HEI=1&uSEP;HOC=20&uSEP;VOC=1&uFRM;

 &uFRM;TYP=E&uSEP;NAM=V_CDF_PARTIDASVC.CDF&uSEP;WID=20&uSEP;HEI=1&uSEP;HOC=20&uSEP;VOC=1&uFRM;

 &uFRM;TYP=E&uSEP;NAM=V_CDF_REC_PARTISVC.CDF&uSEP;WID=20&uSEP;HEI=1&uSEP;HOC=20&uSEP;VOC=1&uFRM;

 &uFRM;TYP=E&uSEP;NAM=CDF_PARTIDASVC.CDF&uSEP;WID=30&uSEP;HEI=13&uSEP;HOC=30&uSEP;VOC=13&uFRM;
  &uFRM;TYP=E&uSEP;NAM=CDF_PARTIDATEMPOSVC.CDF&uSEP;WID=20&uSEP;HEI=1&uSEP;HOC=20&uSEP;VOC=1&uFRM;

  &uFRM;TYP=E&uSEP;NAM=CDF_PARTIDACFGMAQSVC.CDF&uSEP;WID=20&uSEP;HEI=1&uSEP;HOC=20&uSEP;VOC=1&uFRM;

  &uFRM;TYP=E&uSEP;NAM=CDF_PARTIDAISVC.CDF&uSEP;WID=20&uSEP;HEI=1&uSEP;HOC=20&uSEP;VOC=1&uFRM;

  &uFRM;TYP=E&uSEP;NAM=CDF_PARTIDAPSVC.CDF&uSEP;WID=25&uSEP;HEI=5&uSEP;HOC=25&uSEP;VOC=5&uFRM;
   &uFRM;TYP=E&uSEP;NAM=CDF_PARTIDAEMISSAOSVC.CDF&uSEP;WID=20&uSEP;HEI=1&uSEP;HOC=20&uSEP;VOC=1&uFRM;

   &uFRM;TYP=E&uSEP;NAM=CDF_PARTIDAPTSVC.CDF&uSEP;WID=20&uSEP;HEI=1&uSEP;HOC=20&uSEP;VOC=1&uFRM;



 &uFRM;TYP=E&uSEP;NAM=CDF_PARTIDAREALOCSVC.CDF&uSEP;WID=20&uSEP;HEI=1&uSEP;HOC=20&uSEP;VOC=1&uFRM;

 &uFRM;TYP=E&uSEP;NAM=F_CDF_PARTIPTSVC.CDF&uSEP;WID=20&uSEP;HEI=1&uSEP;HOC=20&uSEP;VOC=1&uFRM;

 &uFRM;TYP=E&uSEP;NAM=TMP_K06NRDTSVC.TMP&uSEP;WID=20&uSEP;HEI=1&uSEP;HOC=20&uSEP;VOC=1&uFRM;

 &uFRM;TYP=E&uSEP;NAM=TEX_RELSUBPRDRECEMISVC.TEX&uSEP;WID=20&uSEP;HEI=1&uSEP;HOC=20&uSEP;VOC=1&uFRM;</DAT>
<DAT name="LISTING" xml:space='preserve'>DSantos Prj-&gt;217-189 05/02/2016</DAT>
<DAT name="PERF">#DEF</DAT>
<DAT name="SFUNC" xml:space='preserve'>#include &lt;LIB_PADRAO&gt;:DEF_TEMPLATE_SVC
;--------------------
public operation INIT
;--------------------
#include &lt;LIB_PADRAO&gt;:PRC_INIT

	newinstance "ENTSVCO001", $handleEntity$
	newinstance "ENTSVCO001", $handleConsulta$
	newinstance "ENTSVCO001", $handleReceitaPrd$
	newinstance "ENTSVCO001", $handleRecClas$
	$inCompMaq$ = &lt;FALSE&gt;

	call getParamEmp()
end ;INIT

;-----------------------
public operation CLEANUP
;-----------------------
#include &lt;LIB_PADRAO&gt;:PRC_CLEANUP
$dsTempopartida$ = ""
end ; CLEANUP

;------------------------------------
public operation calcularTempoPartida
	;---------------------------------
	;&lt;-- DSantos Prj-&gt;217-189 05/02/2016 --&gt;
	params
		string piParams : IN
		string poParams : OUT
		string $xCdErro$ : OUT
		string $xCtxErro$ : OUT
	endparams
	variables
		string vDsParams, vDsLstTempo, viParams, voParams
		numeric vTpTempoMaq, vQtTempoPartida, vQtTempoProcesso, vQtTempoProdutivo, vQtTempoInterrupcao, vQtTempoEstimadoInte, vPrProduzida, vQtPartida, vQtVelocidade
		numeric vQtProduzida, vQtPendente, vQtEstimada, vQtTotalProduzida, vQtTotalPendente, vQtTotalEstimada, vQtTempoRestante, vQtTempoSetup, vQtTempoTotal
		boolean vInTempoSetup
		datetime vDtInicio
	endvariables

	if (!inValidarParametro("CD_EMPRESA&uSEP;NR_PARTIDA", piParams, "calcularTempoPartida"))
		return(-1)
	endif

	poParams = $item("%%$item("CD_EMPRESA", piParams)%%$item("NR_PARTIDA", piParams)", $dsTempopartida$)
	if (poParams != "")
		return(0)
	endif

	clear/e "CDF_PARTIDASVC"
	CD_EMPRESA.CDF_PARTIDASVC/init = $item("CD_EMPRESA", piParams)
	NR_PARTIDA.CDF_PARTIDASVC/init = $item("NR_PARTIDA", piParams)
	retrieve/e "CDF_PARTIDASVC"
	if ($status &lt; 0)
		$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG1349", "DESCRICAO=Partida não encontrada!","ADICIONAL=Operação-&gt;CDFSVCO038.calcularTempoPartida")
		return(-1)
	endif
	if ($empty("CDF_PARTIDAPSVC"))
		return(0)
	endif

	vTpTempoMaq = $item("TP_TEMPOMAQ", piParams)
	if (vTpTempoMaq = "")
		;- Quando não receber o tipo de cálculo, busca de acordo com a configuração da máquina
		vTpTempoMaq = getMaqConfPar("TP_CALCTEMPO", CD_MAQUINA.CDF_PARTIDASVC)
	endif
	vQtTempoProcesso = getFieldData("NR_TEMPO", "CDF_PROCESSOSVC", "CD_PROCESSO=%%CD_PROCESSO.CDF_PARTIDAPSVC")

	selectcase vTpTempoMaq
	case 1 ;- Receita
		if (getFieldData("TP_CALTEMPO", "CDF_PROCESSOSVC", "CD_PROCESSO=%%CD_PROCESSO.CDF_PARTIDAPSVC") != 2)
			vDsParams = ""
			putitem vDsParams, -1, CD_PROCESSO.CDF_PARTIDAPSVC
			putitem vDsParams, -1, CD_MAQUINA.CDF_PARTIDASVC
			$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG39612", "DESCRICAO=Tipo de processo @@1@@ incompátivel com a configuração de cálculo de tempo da máquina @@2@@!&uSEP;PARAMETRO=%%vDsParams", "ADICIONAL=Operação-&gt;CDFSVCO038.calcularTempoPartida")
			return(-1)
		endif
		if ($empty("CDF_PARTIDAISVC"))
			viParams = ""
			putitem/id viParams, "CD_RECEITA", getFieldData("CD_RECEITA", "CDF_PROCESSOSVC", "CD_PROCESSO=%%CD_PROCESSO.CDF_PARTIDAPSVC")
			if ($item("CD_RECEITA", viParams) != "")
				activate "PCPSVCO043".buscarTempoReceita(viParams, voParams, $xCdErro$, $xCtxErro$)
				if ($procerror)
					$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
					return(-1)
				elseif ($status &lt; 0)
					return(-1)
				endif
				vQtTempoPartida = $item("QT_TEMPO", voParams)
			else
				;- Partida sem item e sem receita vinculada ao processo, o tempo da partida é o tempo do processo.
				vQtTempoPartida = vQtTempoProcesso
			endif
		else
			;- Calcula o tempo da receita.
			vQtTempoPartida = getTempoReceitaPartida(CD_EMPRESA.CDF_PARTIDASVC, NR_PARTIDA.CDF_PARTIDASVC)
			if ($status &lt; 0)
				return(-1)
			endif
		endif
		vDsLstTempo = getTempoPartida()
		vQtTempoProdutivo = $item("QT_MINPRODUTIVO", vDsLstTempo)
		vQtTempoInterrupcao = $item("QT_MININTERRUPCAO", vDsLstTempo)
		vQtTempoEstimadoInte = $item("QT_TEMPOESTIMADOINTE", vDsLstTempo)
	case 2 ;- Processo
		;- Considera apenas o tempo definido no cadastro do processo.
		vQtTempoPartida = vQtTempoProcesso
		vDsLstTempo = getTempoPartida()
		vQtTempoProdutivo = $item("QT_MINPRODUTIVO", vDsLstTempo)
		vQtTempoInterrupcao = $item("QT_MININTERRUPCAO", vDsLstTempo)
		vQtTempoEstimadoInte = $item("QT_TEMPOESTIMADOINTE", vDsLstTempo)
	case 3 ;- Processo x unidade
		if (vQtTempoProcesso &gt; 0)
			if (getFieldData("TP_CALTEMPO", "CDF_PROCESSOSVC", "CD_PROCESSO=%%CD_PROCESSO.CDF_PARTIDAPSVC") != 1)
				vDsParams = ""
				putitem vDsParams, -1, CD_PROCESSO.CDF_PARTIDAPSVC
				putitem vDsParams, -1, CD_MAQUINA.CDF_PARTIDASVC
				$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG39612", "DESCRICAO=Tipo de processo @@1@@ incompátivel com a configuração de cálculo de tempo da máquina @@2@@!&uSEP;PARAMETRO=%%vDsParams", "ADICIONAL=Operação-&gt;CDFSVCO038.calcularTempoPartida")
				return(-1)
			endif
			if ($empty("CDF_PARTIDAISVC"))
				;- Partida sem item,  o tempo da partida é o tempo do processo.
				vQtTempoPartida = vQtTempoProcesso
				vDsLstTempo = getTempoPartida()
				vQtTempoProdutivo = $item("QT_MINPRODUTIVO", vDsLstTempo)
				vQtTempoInterrupcao = $item("QT_MININTERRUPCAO", vDsLstTempo)
				vQtTempoEstimadoInte = $item("QT_TEMPOESTIMADOINTE", vDsLstTempo)
			else
				;- Partida com item, o tempo da partida é calculado considerando a quantidade dos itens de O.P. alocados e o tempo definido no processo.
				setocc "CDF_PARTIDAISVC", 1
				while ($status &gt;= 0)
					vQtPartida = ""
					;- Busca a quantidade já produzida para este item e processo.
					vQtProduzida = getQtProduzidaItemPartida(CD_EMPOP.CDF_PARTIDAISVC, NR_CICLO.CDF_PARTIDAISVC, NR_OP.CDF_PARTIDAISVC, CD_PRODUTO.CDF_PARTIDAISVC, CD_PROCESSO.CDF_PARTIDAPSVC, vQtPartida)
					vQtTotalProduzida += vQtProduzida

					vDsParams = ""
					putitem/id vDsParams, "CD_EMPRESA", CD_EMPOP.CDF_PARTIDAISVC
					putitem/id vDsParams, "NR_CICLO", NR_CICLO.CDF_PARTIDAISVC
					putitem/id vDsParams, "NR_OP", NR_OP.CDF_PARTIDAISVC
					putitem/id vDsParams, "CD_PRODUTO", CD_PRODUTO.CDF_PARTIDAISVC
					vQtEstimada = getFieldData("QT_ESTIMADA", "PCP_OPISVC", vDsParams)
					vQtTotalEstimada += vQtEstimada

					vQtPendente = vQtEstimada - vQtProduzida
					if (vQtPendente &gt; 0)
						;- Divide a quantidade pendente pela quantidade de partida do item pois a O.P. pode estar alocado em mais de uma máquina.
						vQtPendente = vQtPendente / vQtPartida
					endif
					vQtTotalPendente += vQtPendente

					setocc "CDF_PARTIDAISVC", $curocc("CDF_PARTIDAISVC") + 1
				endwhile

				;- Divide a quantidade pelo número de tempo, que indica quanto é produzido por minuto para o processo, dessa forma temos o tempo em minutos.
				vQtTempoPartida = vQtTotalEstimada / vQtTempoProcesso
				vQtTempoProdutivo = vQtTotalProduzida / vQtTempoProcesso

				vDsLstTempo = getTempoPartida()
				vQtTempoInterrupcao = $item("QT_MININTERRUPCAO", vDsLstTempo)
				vQtTempoEstimadoInte = $item("QT_TEMPOESTIMADOINTE", vDsLstTempo)
			endif
		endif
	case 4 ;- Velocidade
		if ($empty("CDF_PARTIDAISVC"))
			;- Partida sem item,  o tempo da partida é o tempo do processo.
			vQtTempoPartida = vQtTempoProcesso
			vDsLstTempo = getTempoPartida()
			vQtTempoProdutivo = $item("QT_MINPRODUTIVO", vDsLstTempo)
			vQtTempoInterrupcao = $item("QT_MININTERRUPCAO", vDsLstTempo)
			vQtTempoEstimadoInte = $item("QT_TEMPOESTIMADOINTE", vDsLstTempo)
		else
			vQtTempoPartida = ""
			setocc "CDF_PARTIDAISVC", 1
			while ($status &gt;= 0)
				;&lt;-- DSantos Prj-&gt;217-730 22/02/2018
				;vQtVelocidade = getInfTecConf(CD_PRODUTO.CDF_PARTIDAISVC, CD_MAQUINA.CDF_PARTIDASVC, "", CD_PROCESSO.CDF_PARTIDAPSVC, 2, 32)
				vQtVelocidade = getDadosPadraoTecnico(32, CD_PRODUTO.CDF_PARTIDAISVC, CD_MAQUINA.CDF_PARTIDASVC, CD_PROCESSO.CDF_PARTIDAPSVC, CD_EMPRESA.CDF_PARTIDASVC, NR_PARTIDA.CDF_PARTIDASVC)
				; DSantos --&gt;
				vQtTempoPartida += QT_PARTIDA.CDF_PARTIDAISVC / vQtVelocidade
				setocc "CDF_PARTIDAISVC", $curocc("CDF_PARTIDAISVC") + 1
			endwhile
			vDsLstTempo = getTempoPartida()
			vQtTempoProdutivo = $item("QT_MINPRODUTIVO", vDsLstTempo)
			vQtTempoInterrupcao = $item("QT_MININTERRUPCAO", vDsLstTempo)
			vQtTempoEstimadoInte = $item("QT_TEMPOESTIMADOINTE", vDsLstTempo)
		endif
	endselectcase

	vInTempoSetup = $item("IN_TEMPOSETUP", piParams)
	if (vInTempoSetup = "")
		;- Quando não receber o indicador de setup considera a configuração da máquina
		vInTempoSetup = getMaqConfPar("IN_TEMPOSETUP", CD_MAQUINA.CDF_PARTIDASVC)
	endif

	if($empty("CDF_PARTIDAISVC"))
		;- Quando a partida não possuir item não considera tempo de setup
		vInTempoSetup = &lt;FALSE&gt;
	endif

	vQtTempoSetup = getTempoSetupPartida(vInTempoSetup)
	if ($status &lt; 0)
		return(-1)
	endif

	vPrProduzida = (vQtTempoProdutivo * 100) / vQtTempoPartida
	vPrProduzida = vPrProduzida[Round, 2]
	vQtTempoRestante = vQtTempoPartida - vQtTempoProdutivo
	if (vQtTempoRestante &lt; 0)
		vQtTempoRestante = 0
	endif
	if (vQtTempoPartida &gt; vQtTempoProdutivo)
		vQtTempoTotal = vQtTempoPartida + vQtTempoInterrupcao + vQtTempoEstimadoInte + vQtTempoSetup
	else
		vQtTempoTotal = vQtTempoProdutivo + vQtTempoInterrupcao + vQtTempoEstimadoInte + vQtTempoSetup
	endif

	if ($item("DT_INICIO", vDsLstTempo) = "" &amp; $item("DT_INICIOPREV", vDsLstTempo) = "" &amp; $item("IN_CONSIDERARANTERIOR", piParams) != &lt;FALSE&gt;)
		;- Quando a partida ainda não foi iniciada, calcula uma data prevista de início considerando todas as partidas anteriores.
		clear/e "F_CDF_PARTIDASVC"
		CD_EMPRESA.F_CDF_PARTIDASVC/init = CD_EMPRESA.CDF_PARTIDASVC
		CD_MAQUINA.F_CDF_PARTIDASVC/init = CD_MAQUINA.CDF_PARTIDASVC
		NR_ORDEM.F_CDF_PARTIDASVC/init = NR_ORDEM.CDF_PARTIDASVC - 1
		retrieve/e "F_CDF_PARTIDASVC"
		if ($status &gt;= 0)
			viParams = piParams
			putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.F_CDF_PARTIDASVC
			putitem/id viParams, "NR_PARTIDA", NR_PARTIDA.F_CDF_PARTIDASVC
			if($item("IN_TEMPOTOTAL", piParams) != &lt;TRUE&gt;)
				putitem/id viParams, "IN_CONSIDERARANTERIOR", &lt;FALSE&gt;
			endif
			$instancehandle-&gt;calcularTempoPartida(viParams, voParams, $xCdErro$, $xCtxErro$)
			if ($procerror)
				$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
				return(-1)
			elseif ($status &lt; 0)
				return(-1)
			endif
			vDtInicio = $item("DT_PREVFIM", voParams)
			putitem/id poParams, "DT_INICIOPREV", vDtInicio
		endif
	else
		vDtInicio = $item("DT_INICIO", vDsLstTempo)
		if (vDtInicio = "")
			vDtInicio = $item("DT_INICIOPREV", vDsLstTempo)
			if (vDtInicio != $item("DT_INICIOPREV", vDsLstTempo))
				vDtInicio = ""
			endif
		endif
	endif
	if (vDtInicio != "")
		vDtInicio += converterMinutoEmTempo(vQtTempoTotal)
		putitem/id poParams, "DT_PREVFIM", vDtInicio
	endif

	putitem/id poParams, "PR_PRODUCAO", vPrProduzida
	putitem/id poParams, "QT_TEMPOESTIMADO", vQtTempoPartida
	putitem/id poParams, "DS_TEMPOESTIMADO", descreverTempoMinuto(vQtTempoPartida)
	putitem/id poParams, "QT_TEMPOPRODUTIVO", vQtTempoProdutivo
	putitem/id poParams, "DS_TEMPOPRODUTIVO", descreverTempoMinuto(vQtTempoProdutivo)
	putitem/id poParams, "QT_TEMPOINTERRUPCAO", vQtTempoInterrupcao
	putitem/id poParams, "DS_TEMPOINTERRUPCAO", descreverTempoMinuto(vQtTempoInterrupcao)
	putitem/id poParams, "QT_TEMPOESTIMADOINTE", vQtTempoEstimadoInte
	putitem/id poParams, "DS_TEMPOESTIMADOINTE", descreverTempoMinuto(vQtTempoEstimadoInte)
	putitem/id poParams, "QT_TEMPORESTANTE", vQtTempoRestante
	putitem/id poParams, "DS_TEMPORESTANTE", descreverTempoMinuto(vQtTempoRestante)
	putitem/id poParams, "QT_TEMPOSETUP", vQtTempoSetup
	putitem/id poParams, "DS_TEMPOSETUP", descreverTempoMinuto(vQtTempoSetup)
	putitem/id poParams, "QT_TEMPOTOTAL", vQtTempoTotal
	putitem/id poParams, "DS_TEMPOTOTAL", descreverTempoMinuto(vQtTempoTotal)
	putitem/id poParams, "DT_INICIO", $item("DT_INICIO", vDsLstTempo)
	if ($item("DT_INICIOPREV", poParams) = "")
		putitem/id poParams, "DT_INICIOPREV", $item("DT_INICIOPREV", vDsLstTempo)
	endif
	vQtTempoRestante += vQtTempoSetup
	putitem/id poParams, "QT_TEMPORESTANTETOTAL", vQtTempoRestante
	putitem/id poParams, "IN_DISPONIVEL", $item("IN_DISPONIVEL", vDsLstTempo)

	;viParams = CD_EMPRESA.CDF_PARTIDASVC
	;viParams = "%%viParams%%NR_PARTIDA.CDF_PARTIDASVC"
	viParams = $concat($item("CD_EMPRESA", piParams), $item("NR_PARTIDA", piParams))
	putitem/id $dsTempoPartida$, viParams, poParams
	return(0)
end ;calcularTempoPartida

;------------------------------------
public operation buscarReceitaPartida
	;---------------------------------
	;&lt;-- DSantos Prj-&gt;217-189 05/02/2016 --&gt;
	params
		string piParams : IN
		string poParams : OUT
		string $xCdErro$ : OUT
		string $xCtxErro$ : OUT
	endparams
	variables
		string vDsRegistro, viParams, vDsCondicao
		boolean vInTpUtilizacaoIgual, vInLstTpUtilizacaoIgual
	endvariables

	if (!inValidarParametro("CD_EMPRESA&uSEP;NR_PARTIDA", piParams, "buscarReceitaPartida"))
		return(-1)
	endif

	;&lt;-- DSantos Prj-&gt;217-280 29/06/2016
	clear/e "CDF_PARTIDASVC"
	CD_EMPRESA.CDF_PARTIDASVC/init = $item("CD_EMPRESA", piParams)
	NR_PARTIDA.CDF_PARTIDASVC/init = $item("NR_PARTIDA", piParams)
	retrieve/e "CDF_PARTIDASVC"
	if ($status &gt;= 0)
			;&lt;-- LOMoreira Prj-&gt;217-558 07/08/2017 --&gt;
			vDsCondicao = ""
			putitem/id vDsCondicao, "CD_EMPRESA", CD_EMPRESA.CDF_PARTIDASVC
			putitem/id vDsCondicao, "NR_PARTIDA", NR_PARTIDA.CDF_PARTIDASVC
			$handleEntity$-&gt;consultar("CDF_PARTIDARECSVC", vDsCondicao)
			if ($status &gt;= 0)
				$cdEmpresa$ = $item("CD_EMPRESA", getRegistro($handleEntity$))
				putitem/id poParams, "CD_RECEITA", $concat("RP", "%%$cdEmpresa$", $item("NR_PARTIDA", getRegistro($handleEntity$)))
				putitem/id poParams, "IN_RECEITAIGUAL", &lt;TRUE&gt;
				return(0)
			endif
			;&lt;-- LOMoreira Prj-&gt;217-558 --&gt;

		if (!$empty("CDF_PARTIDAISVC"))
			vInTpUtilizacaoIgual = &lt;TRUE&gt;
			vInLstTpUtilizacaoIgual = &lt;TRUE&gt;
			setocc "CDF_PARTIDAISVC", 1
			while ($status &gt;= 0)
				viParams = ""
				putitem/id viParams, "CD_EMPRESA", CD_EMPOP.CDF_PARTIDAISVC
				putitem/id viParams, "NR_CICLO", NR_CICLO.CDF_PARTIDAISVC
				putitem/id viParams, "NR_OP", NR_OP.CDF_PARTIDAISVC
				putitem/id viParams, "CD_PRODUTO", CD_PRODUTO.CDF_PARTIDAISVC
				vDsRegistro = getProcessoOp(viParams, CD_PROCESSO.CDF_PARTIDAPSVC, &lt;TRUE&gt;, &lt;FALSE&gt;)
				if ($item("CD_RECEITA", poParams) = "")
					putitem/id poParams, "CD_RECEITA", $item("CD_RECEITA", vDsRegistro)
					putitem/id poParams, "IN_RECEITAIGUAL", &lt;TRUE&gt;
				elseif ($item("CD_RECEITA", poParams) != $item("CD_RECEITA", vDsRegistro))
					delitem/id poParams, "CD_RECEITA"
					delitem/id poParams, "CD_TPUTILIZACAO"
					putitem/id poParams, "IN_RECEITAIGUAL", &lt;FALSE&gt;
					return(0)
				endif
				if(vInTpUtilizacaoIgual)
					if($item("CD_TPUTILIZACAO", poParams) = "")
						putitem/id poParams, "CD_TPUTILIZACAO", $item("CD_TPUTILIZACAO", vDsRegistro)
					elseif($item("CD_TPUTILIZACAO", poParams) != $item("CD_TPUTILIZACAO", vDsRegistro))
						vInTpUtilizacaoIgual = &lt;FALSE&gt;
					endif
				endif
				if(vInLstTpUtilizacaoIgual)
					if($item("DS_LSTTPUTILIZACAO", poParams) = "")
						putitem/id poParams, "DS_LSTTPUTILIZACAO", $item("DS_LSTTPUTILIZACAO", vDsRegistro)
					elseif($item("DS_LSTTPUTILIZACAO", poParams) != $item("DS_LSTTPUTILIZACAO", vDsRegistro))
						vInLstTpUtilizacaoIgual = &lt;FALSE&gt;
					endif
				endif
				setocc "CDF_PARTIDAISVC", $curocc("CDF_PARTIDAISVC") + 1
			endwhile
		else
			putitem/id poParams, "CD_RECEITA", getFieldData("CD_RECEITA", "CDF_PROCESSOSVC", "CD_PROCESSO=%%CD_PROCESSO.CDF_PARTIDAPSVC")
			putitem/id poParams, "IN_RECEITAIGUAL", &lt;TRUE&gt;
		endif
	endif
	if(!vInTpUtilizacaoIgual)
		putitem/id poParams, "CD_TPUTILIZACAO", ""
	endif
	putitem/id poParams, "IN_TPUTILIZACAOIGUAL", vInTpUtilizacaoIgual

	if(!vInLstTpUtilizacaoIgual)
		putitem/id poParams, "DS_LSTTPUTILIZACAO", ""
	endif
	putitem/id poParams, "IN_LSTTPUTILIZACAOIGUAL", vInLstTpUtilizacaoIgual
	; DSantos --&gt;

	return(0)
end ;buscarReceitaPartida

;------------------------------------------
public operation buscarOrigemPartidaMaquina
	;---------------------------------------
	;&lt;-- DSantos Prj-&gt;217-195 13/02/2016 --&gt;
	params
		string piParams : IN
		string poParams : OUT
		string $xCdErro$ : OUT
		string $xCtxErro$ : OUT
	endparams
	variables
		string vDsLstOp, vDsRegOp, viParams, voParams, vDsLstProc, vDsRegistro, vDsMotivo, vDsLstProcOp, vDsRegProcOp, vDsLstRecOp
		numeric vCdMaquina, vTpItemMaq, vTpPartida, vQtPartida, vNrPerc, vNrRegTotal, vCdProcessoAnterior
		boolean vInConsulta
	endvariables

	if (!inValidarParametro("CD_MAQUINA", piParams, "buscarOrigemPartidaMaquina"))
		return(-1)
	endif

	$lstItensDescartados$ = ""

	vInConsulta = $item("IN_CONSULTA", piParams)
	vCdMaquina = $item("CD_MAQUINA", piParams)

	clear/e "CDF_PARTIDASVC"
	CD_EMPRESA.CDF_PARTIDASVC/init = $item("CD_EMPRESA", $$gParamGlb)
	CD_MAQUINA.CDF_PARTIDASVC/init = "&uEQ;%%vCdMaquina&uOR;&uEQ;"
	TP_SITUACAO.CDF_PARTIDASVC/init = "00&uSEP;01" ;Aguardando e Em andamento
	if (vInConsulta)
		NR_ORDEM.CDF_PARTIDASVC/init = "&uNOT;&uEQ;"
	endif
	retrieve/e "CDF_PARTIDASVC"
	if ($status &gt;= 0)
		sort/e "CDF_PARTIDASVC", "NR_ORDEM.CDF_PARTIDASVC"
		setocc "CDF_PARTIDASVC", 1
		while ($status &gt;= 0)
			if (!$empty("CDF_PARTIDAPSVC"))
				vDsRegistro = ""
				putitem/id vDsRegistro, "CD_EMPRESA", CD_EMPRESA.CDF_PARTIDASVC
				putitem/id vDsRegistro, "NR_PARTIDA", NR_PARTIDA.CDF_PARTIDASVC
				putitem/id vDsRegistro, "CD_PROCESSO", CD_PROCESSO.CDF_PARTIDAPSVC
				putitem/id vDsRegistro, "DS_PROCESSO", getFieldData("DS_PROCESSO", "CDF_PROCESSOSVC", "CD_PROCESSO=%%CD_PROCESSO.CDF_PARTIDAPSVC")
				if (NR_ORDEM.CDF_PARTIDASVC != "")
					putitem/id vDsRegistro, "NR_ORDEM", NR_ORDEM.CDF_PARTIDASVC
					poParams = adicionarRegistroLista(vDsRegistro, poParams, "DS_LST_PARTIDA_ALOCADA")
				else
					selectdb sum(QT_PARTIDA) from "V_CDF_PARTIDASVC" %\
						u_where CD_EMPRESA.V_CDF_PARTIDASVC = CD_EMPRESA.CDF_PARTIDASVC %\
						&amp; NR_PARTIDA.V_CDF_PARTIDASVC = NR_PARTIDA.CDF_PARTIDASVC to vQtPartida
					putitem/id vDsRegistro, "QT_PARTIDA", vQtPartida
					poParams = adicionarRegistroLista(vDsRegistro, poParams, "DS_LST_PARTIDA_ALOCAR")
				endif
			endif
			setocc "CDF_PARTIDASVC", $curocc("CDF_PARTIDASVC") + 1
		endwhile
	endif

	vDsLstOp = $item("DS_LSTOP", piParams)

	if (vInConsulta | vDsLstOp = "")
		return(0)
	endif

	vTpItemMaq = getMaqConfPar("TP_ITEM", vCdMaquina)

	vNrRegTotal = $itemcount(vDsLstOp)
	while (vDsLstOp != "")
		vDsLstProcOp = ""
		vDsRegOp = ""
		getitem vDsRegOp, vDsLstOp, 1
		clear/e "PCP_OPISVC"
		CD_EMPRESA.PCP_OPISVC/init = $item("CD_EMPRESA", vDsRegOp)
		NR_CICLO.PCP_OPISVC/init = $item("NR_CICLO", vDsRegOp)
		NR_OP.PCP_OPISVC/init = $item("NR_OP", vDsRegOp)
		TP_SITUACAO.PCP_OPISVC/init = "10&uSEP;20" ;- Aguardando liberação e Andamento
		retrieve/e "PCP_OPISVC"
		if ($status &gt;= 0)
			setocc "PCP_OPISVC", 1
			;--&gt; MNSANTOS - Prj 217/246 - 18/05/2016
			vDsRegistro = ""
			putitem/id vDsRegistro, "CD_EMPRESA", CD_EMPRESA.PCP_OPISVC
			putitem/id vDsRegistro, "NR_CICLO", NR_CICLO.PCP_OPISVC
			putitem/id vDsRegistro, "NR_OP", NR_OP.PCP_OPISVC
			putitem/id vDsRegistro, "CD_PRODUTO", CD_PRODUTO.PCP_OPISVC
			;--&lt; MNSANTOS
			while ($status &gt;= 0)
				if (!$empty("PCP_OPISEQPROSVC"))
					vCdProcessoAnterior = ""
					sort/e "PCP_OPISEQPROSVC", "NR_ORDEM.PCP_OPISEQPROSVC"
					setocc "PCP_OPISEQPROSVC", 1
					while ($status &gt;= 0)
						putitem/id vDsRegistro, "CD_PROCESSO", CD_PROCESSO.PCP_OPISEQPROSVC ;--&gt; MNSANTOS - Prj 217/246 - 18/05/2016
						if (inValidarProcesso(CD_PRODUTO.PCP_OPISVC, CD_PROCESSO.PCP_OPISEQPROSVC, vCdMaquina, CD_RECEITA.PCP_OPISEQPROSVC, vDsMotivo) &amp; inValidarMaquinaProcesso(CD_PROCESSO.PCP_OPISEQPROSVC, CD_SEQMAQ.PCP_OPISEQPROSVC, vCdMaquina, vDsMotivo))
							viParams = "%%CD_PROCESSO.PCP_OPISEQPROSVC%%vCdMaquina"
							putitem/id $dsLstProcMaq$, viParams, &lt;TRUE&gt;
							if (vTpItemMaq = 1)
								poParams = addItemOpOrigemPartida(CD_PROCESSO.PCP_OPISEQPROSVC, vCdMaquina, CD_RECEITA.PCP_OPISEQPROSVC, vCdProcessoAnterior, poParams)
							;--&gt; MNSANTOS - Prj 220/3568 - 26/08/2018
							elseif (!$empty("PCP_OPILOTECSVC") &amp; vTpItemMaq = 2)
								setocc "PCP_OPILOTECSVC", 1
								while($status &gt;= 0)
									setocc "PCP_OPILOTEISVC", 1
									while ($status &gt;= 0)
										poParams = addItemLoteOrigemPartida(CD_PROCESSO.PCP_OPISEQPROSVC, vCdMaquina, CD_RECEITA.PCP_OPISEQPROSVC, vCdProcessoAnterior, poParams)
										setocc "PCP_OPILOTEISVC", $curocc("PCP_OPILOTEISVC") + 1
									endwhile
									setocc "PCP_OPILOTECSVC", $curocc("PCP_OPILOTECSVC") + 1
								endwhile
							;--&lt; MNSANTOS
							;&lt;-- DSantos Prj-&gt;217-539 19/06/2017
							elseif (vTpItemMaq = 3)
								vDsLstProcOp = addItemLstProcOp(CD_PROCESSO.PCP_OPISEQPROSVC, CD_RECEITA.PCP_OPISEQPROSVC, vDsLstProcOp)
							endif
							; DSantos --&gt;
						elseif (vDsMotivo != "");--&gt; MNSANTOS - Prj 217/246 - 18/05/2016
							putitem/id vDsRegistro, "DS_MOTIVO", vDsMotivo
							$lstItensDescartados$ = adicionarRegistroLista(vDsRegistro, $lstItensDescartados$, "DS_LSTITEMOPPROC")
							;--&lt; MNSANTOS
						endif
						vCdProcessoAnterior = CD_PROCESSO.PCP_OPISEQPROSVC ;&lt;-- DSantos Prj-&gt;217-255 23/05/2016 --&gt;
						setocc "PCP_OPISEQPROSVC", $curocc("PCP_OPISEQPROSVC") + 1
					endwhile
				else
					viParams = ""
					putitem/id viParams, "CD_PRODUTO", CD_PRODUTO.PCP_OPISVC
					putitem/id viParams, "IN_PROCREC", &lt;FALSE&gt;
					activate "CDFSVCO030".buscarSeqProc(viParams, voParams, $xCdErro$, $xCtxErro$)
					if ($procerror)
						$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
						return(-1)
					elseif ($status &lt; 0)
						return(-1)
					endif
					vDsLstProc = $item("DS_LSTSEQPROC",voParams)
					;--&gt; MNSANTOS - Prj 217/246 - 18/05/2016
					if(vDsLstProc = "")
						putitem/id vDsRegistro, "DS_MOTIVO", "Item de O.P. sem sequência de processo"
						$lstItensDescartados$ = adicionarRegistroLista(vDsRegistro, $lstItensDescartados$, "DS_LSTITEMOP")
					endif
					;--&gt; MNSANTOS
					vCdProcessoAnterior = ""
					while (vDsLstProc != "")
						putitem/id vDsRegistro, "CD_PROCESSO", $item("CD_PROCESSO", $itemnr(1, vDsLstProc)) ;--&gt; MNSANTOS - Prj 217/246 - 18/05/2016
						if (inValidarProcesso(CD_PRODUTO.PCP_OPISVC, $item("CD_PROCESSO", $itemnr(1, vDsLstProc)), vCdMaquina, $item("CD_RECEITA", $itemnr(1, vDsLstProc)), vDsMotivo) &amp; inValidarMaquinaProcesso($item("CD_PROCESSO", $itemnr(1, vDsLstProc)), $item("CD_SEQMAQ", $itemnr(1, vDsLstProc)), vCdMaquina, vDsMotivo))
							if (vTpItemMaq = 1)
								poParams = addItemOpOrigemPartida($item("CD_PROCESSO", $itemnr(1, vDsLstProc)), vCdMaquina, $item("CD_RECEITA", $itemnr(1, vDsLstProc)), vCdProcessoAnterior, poParams)
							;--&gt; MNSANTOS - Prj 220/3568 - 26/08/2018
							elseif (!$empty("PCP_OPILOTECSVC") &amp; vTpItemMaq = 2)
								setocc "PCP_OPILOTECSVC", 1
								while($status &gt;= 0)
									setocc "PCP_OPILOTEISVC", 1
									while ($status &gt;= 0)
										poParams = addItemLoteOrigemPartida($item("CD_PROCESSO", $itemnr(1, vDsLstProc)), vCdMaquina, $item("CD_RECEITA", $itemnr(1, vDsLstProc)), vCdProcessoAnterior, poParams)
										setocc "PCP_OPILOTEISVC", $curocc("PCP_OPILOTEISVC") + 1
									endwhile
									setocc "PCP_OPILOTECSVC", $curocc("PCP_OPILOTECSVC") + 1
								endwhile
							;--&lt; MNSANTOS
							;&lt;-- DSantos Prj-&gt;217-539 19/06/2017
							elseif (vTpItemMaq = 3)
								vDsLstProcOp = addItemLstProcOp($item("CD_PROCESSO", $itemnr(1, vDsLstProc)), $item("CD_RECEITA", $itemnr(1, vDsLstProc)), vDsLstProcOp)
							endif
							; DSantos --&gt;
						elseif (vDsMotivo != "");--&gt; MNSANTOS - Prj 217/246 - 18/05/2016
							putitem/id vDsRegistro, "DS_MOTIVO", vDsMotivo
							$lstItensDescartados$ = adicionarRegistroLista(vDsRegistro, $lstItensDescartados$, "DS_LSTITEMOPPROC")
							;--&lt; MNSANTOS
						endif
						vCdProcessoAnterior = $item("CD_PROCESSO", $itemnr(1, vDsLstProc)) ;&lt;-- DSantos Prj-&gt;217-255 23/05/2016 --&gt;
						delitem vDsLstProc, 1
					endwhile
				endif
				setocc "PCP_OPISVC", $curocc("PCP_OPISVC") + 1
			endwhile
		endif

		;&lt;-- DSantos Prj-&gt;217-539 20/06/2017
		vDsRegistro = ""
		putitem/id vDsRegistro, "CD_EMPRESA", CD_EMPRESA.PCP_OPISVC
		putitem/id vDsRegistro, "NR_CICLO", NR_CICLO.PCP_OPISVC
		putitem/id vDsRegistro, "NR_OP", NR_OP.PCP_OPISVC
		while (vDsLstProcOp != "")
			vDsRegProcOp = $valuepart($itemnr(1, vDsLstProcOp))
			if ($item("NR_OCC", vDsRegProcOp) = $totocc("PCP_OPISVC"))
				vDsLstRecOp = $item("DS_LSTRECEITA", vDsRegProcOp)
				sort/list vDsLstRecOp, "unique"
				if ($itemcount(vDsLstRecOp) &lt;= 1)
					poParams = addOpOrigemPartida($item("CD_PROCESSO", vDsRegProcOp), vCdMaquina, vDsLstRecOp, poParams)
				else
					putitem/id vDsRegistro, "CD_PROCESSO", $item("CD_PROCESSO", vDsRegProcOp)
					putitem/id vDsRegistro, "DS_MOTIVO", "Processo com receita diferente entre os itens da O.P."
					$lstItensDescartados$ = adicionarRegistroLista(vDsRegistro, $lstItensDescartados$, "DS_LSTOP")
				endif
			else
				putitem/id vDsRegistro, "CD_PROCESSO", $item("CD_PROCESSO", vDsRegProcOp)
				putitem/id vDsRegistro, "DS_MOTIVO", "Processo não encontrado em todos os itens da O.P."
				$lstItensDescartados$ = adicionarRegistroLista(vDsRegistro, $lstItensDescartados$, "DS_LSTOP")
			endif
			delitem vDsLstProcOp, 1
		endwhile
		; DSantos --&gt;

		delitem vDsLstOp, 1
		vNrPerc = (((vNrRegTotal - $itemcount(vDsLstOp)) * 100) / vNrRegTotal)
		vNrPerc = vNrPerc[round]
		$instancehandle-&gt;setDisplay("Carregando %%$item("DS_PERC", piParams) - %%vNrPerc %", "", "")
	endwhile

	putitem/id poParams, "DS_LSTINCONSISTENCIA", $lstItensDescartados$ ;--&gt; MNSANTOS - Prj 217/246 - 19/05/2016

	return(0)
end ;buscarOrigemPartidaMaquina

;---------------------------------
public operation alocarItemPartida
	;------------------------------
	;&lt;-- DSantos Prj-&gt;217-189 18/02/2016 --&gt;
	params
		string piParams : IN
		string poParams : OUT
		string $xCdErro$ : OUT
		string $xCtxErro$ : OUT
	endparams
	variables
		handle vHdInstance
		string viParams, voParams, vDsLstPartida, vDsRegistro, vDsLstItemGravar, vDsCondicao, vDsLstItem
		numeric vNrOrdem, vTpOrigem, vCdMaquina, vQtCapacidadeMaq, vTpPartida, vQtTotalPartida, vQtPartida, vQtPendente, vCdEmpPartida, vNrPartida, vQtDisponivel, vNrItem
		boolean vInGerarPartida
	endvariables

	if (!inValidarParametro("TP_ORIGEM&uSEP;TP_ALOCACAO&uSEP;CD_MAQUINA&uSEP;CD_PROCESSO", piParams, "alocarItemPartida"))
		return(-1)
	endif

	vCdMaquina = $item("CD_MAQUINA", piParams)
	vTpOrigem = $item("TP_ORIGEM", piParams)
	vDsLstItem = $item("DS_LSTITEM", piParams)

	selectcase vTpOrigem
	case 1 ;- Item de O.P.
		if (!inValidarParametro("CD_EMPOP&uSEP;NR_CICLO&uSEP;NR_OP&uSEP;CD_PRODUTO", piParams, "alocarItemPartida"))
			return(-1)
		endif
	case 2 ;- Item de lote
		if (!inValidarParametro("CD_EMPOP&uSEP;NR_CICLO&uSEP;NR_OP&uSEP;CD_PRODUTO&uSEP;NR_LOTE&uSEP;NR_ITEM", piParams, "alocarItemPartida"))
			return(-1)
		endif
	case 3 ;- Agrupador
		if (!inValidarParametro("CD_EMPAGRUPADOR&uSEP;NR_AGRUPADOR", piParams, "alocarItemPartida"))
			return(-1)
		endif
	case 5 ;- Ordem de produção
		if (!inValidarParametro("CD_EMPOP&uSEP;NR_CICLO&uSEP;NR_OP", piParams, "alocarItemPartida"))
			return(-1)
		endif
	endselectcase

	vCdEmpPartida = $item("CD_EMPRESA", $$gParamGlb)

	if ($item("TP_ALOCACAO", piParams) = 1 | $item("TP_ALOCACAO", piParams) = 2)
		if (!inValidarParametro("CD_EMPPARTIDA&uSEP;NR_PARTIDA", piParams, "alocarItemPartida"))
			return(-1)
		endif
		clear/e "CDF_PARTIDASVC"
		CD_EMPRESA.CDF_PARTIDASVC/init = $item("CD_EMPPARTIDA", piParams)
		NR_PARTIDA.CDF_PARTIDASVC/init = $item("NR_PARTIDA", piParams)
		retrieve/e "CDF_PARTIDASVC"
		if ($status &lt; 0)
			$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG2721", "DESCRICAO=Partida não encontrada para adicionar item!", "ADICIONAL=Operação-&gt;CDFSVCO038.alocarItemPartida")
			return(-1)
		endif
		if (CD_MAQUINA.CDF_PARTIDASVC != vCdMaquina)
			$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG39684", "DESCRICAO=Máquina da partida diferente da máquina alocada!", "ADICIONAL=Operação-&gt;CDFSVCO038.alocarItemPartida")
			return(-1)
		endif
		vCdEmpPartida = CD_EMPRESA.CDF_PARTIDASVC
		vNrPartida = NR_PARTIDA.CDF_PARTIDASVC
		vNrOrdem = NR_ORDEM.CDF_PARTIDASVC
	endif

	if ($item("TP_ALOCACAO", piParams) = 2)

		;&lt;-- LOMoreira Prj-&gt;217-221 24/03/2016 --&gt;
		;- Validar se a partida possui emissão de receita ativa e não permitir adicionar item.
		clear/e "CDF_PARTIDAEMISSAOSVC"
		TP_SITUACAO.CDF_PARTIDAEMISSAOSVC/init = 1 ;--Normal
		retrieve/e "CDF_PARTIDAEMISSAOSVC"
		if ($status &gt;= 0)
			$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG39822", "DESCRICAO=Não é permitido adicionar item a uma partida com receita emitida!", "ADICIONAL=Operação-&gt;CDFSVCO038.alocarItemPartida")
			return(-1)
		endif
		;&lt;-- LOMoreira --&gt;

		if (vNrOrdem != "" &amp; $empty("CDF_PARTIDAISVC"))
			$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG2722", "DESCRICAO=Não é permitido incluir item pois a partida foi alocada sem item!", "ADICIONAL=Operação-&gt;CDFSVCO038.alocarItemPartida")
			return(-1)
		endif
		if (getFieldData("CD_EMPORI", "CDF_PARTIDARESVC", "CD_EMPDEST=%%CD_EMPRESA.CDF_PARTIDASVC&uSEP;NR_PARTIDADEST=%%NR_PARTIDA.CDF_PARTIDASVC&uSEP;TP_PARTIDAREL=1") != "")
			$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG2723", "DESCRICAO=Não é permitido incluir item em partida de reprocesso!", "ADICIONAL=Operação-&gt;CDFSVCO038.alocarItemPartida")
			return(-1)
		endif
		if (TP_SITUACAO.CDF_PARTIDASVC != 0)
			$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG35337", "DESCRICAO=Não é permitido incluir item em partida que não esteja com a situação 'Aguardando'!", "ADICIONAL=Operação-&gt;CDFSVCO038.alocarItemPartida")
			return(-1)
		endif
		if (CD_PROCESSO.CDF_PARTIDAPSVC != $item("CD_PROCESSO", piParams))
			$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG39685", "DESCRICAO=Processo da partida não corresponde ao processo alocado!", "ADICIONAL=Operação-&gt;CDFSVCO038.alocarItemPartida")
			return(-1)
		endif
		vNrOrdem += 1
	endif

	if (vTpOrigem = 4)
		;- Alocar partida para a máquina
		newinstance "CDFSVCO038", vHdInstance
		if($item("CD_EMPPARTIDA", piParams) = "" | $item("NR_PARTIDA", piParams) = "")
			viParams = piParams
			putitem/id viParams, "CD_EMPRESA", vCdEmpPartida
			vHdInstance-&gt;gerarPartida(viParams, voParams, $xCdErro$, $xCtxErro$)
			if ($procerror)
				$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
				return(-1)
			elseif ($status &lt; 0)
				return(-1)
			endif
			if(voParams != "")
				vDsLstPartida = ""
				putitem vDsLstPartida, -1, voParams
			endif
		else
			;--&gt; HSGARCIA - Prj 253/100 - 09/07/2018
			$instancehandle-&gt;validarTipoSeguro(vCdEmpPartida, $item("NR_PARTIDA", piParams), vCdMaquina)
			if ($procerror)
				$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
				return(-1)
			elseif ($status &lt; 0)
				return(-1)
			endif
			;--&lt; HSGARCIA

			putitem/id piParams, "CD_EMPRESA", $item("CD_EMPPARTIDA", piParams)
			putitem vDsLstPartida, -1, piParams

			vDsCondicao = ""
			putitem/id vDsCondicao, "CD_EMPRESA", $item("CD_EMPRESA", piParams)
			putitem/id vDsCondicao, "NR_PARTIDA", $item("NR_PARTIDA", piParams)
			if(getFieldData("CD_MAQUINA", "CDF_PARTIDASVC", vDsCondicao) = "")
				putitem/id vDsCondicao, "CD_MAQUINA", $item("CD_MAQUINA", piParams)
				putitem/id vDsCondicao, "DS_ENTITY", "CDF_PARTIDASVC"
				$instancehandle-&gt;salvarEntidade(vDsCondicao, "", $xCdErro$, $xCtxErro$)
				if ($procerror)
					$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
					return(-1)
				elseif ($status &lt; 0)
					return(-1)
				endif
			endif
		endif

		viParams = ""
		putitem/id viParams, "DS_LSTPARTIDA", vDsLstPartida
		putitem/id viParams, "NR_ORDEM", $item("NR_ORDEM", piParams)
		vHdInstance-&gt;reordenarPartida(viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)
			$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status &lt; 0)
			return(-1)
		endif

		;-&gt;HSGARCIA Proj 217/610 09/08/2017
		if($tpIntAcabamentoTextil$ &gt; 0 &amp; getInfTecConf("", vCdMaquina, "", "", 4, 42) != "") ;-&gt;HSGARCIA Proj 217/664 03/11/17 ---- ;-&gt;HSGARCIA Proj 253/378 DVAIND-1940 05/12/2018
			viParams = ""
			putitem/id viParams, "CD_EMPRESA", $item("CD_EMPRESA", $itemnr(1, vDsLstPartida))
			putitem/id viParams, "NR_PARTIDA", $item("NR_PARTIDA", $itemnr(1, vDsLstPartida))
			activate "CDFSVCO039".enviarPartida(viParams, voParams, $xCdErro$, $xCtxerro$)
			if ($procerror)
				$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
				return(-1)
			elseif ($status &lt; 0)
				$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $xCdErro$, $xCtxErro$, "")
				return(-1)
			endif
		endif
		;&lt;-
		return(0)
	else
		if (vTpOrigem = 1 &amp; getMaqConfPar("TP_ITEM", vCdMaquina) != 1)
			$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG39676", "DESCRICAO=Configuração de tipo de item da máquina não permite alocar item de O.P.!", "ADICIONAL=Operação-&gt;CDFSVCO038.alocarItemPartida")
			return(-1)
		endif
		if (vTpOrigem = 2 &amp; getMaqConfPar("TP_ITEM", vCdMaquina) != 2)
			$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG39677", "DESCRICAO=Configuração de tipo de item da máquina não permite alocar item de lote!", "ADICIONAL=Operação-&gt;CDFSVCO038.alocarItemPartida")
			return(-1)
		endif
		;&lt;-- DSantos Prj-&gt;217-359 20/06/2017
		if (vTpOrigem = 5 &amp; getMaqConfPar("TP_ITEM", vCdMaquina) != 3)
			$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG41516", "DESCRICAO=Configuração de tipo de item da máquina não permite alocar ordem de produção!", "ADICIONAL=Operação-&gt;CDFSVCO038.alocarItemPartida")
			return(-1)
		endif
		; DSantos --&gt;
	endif

	vQtCapacidadeMaq = getCapacidadeMaquina(vCdMaquina, &lt;FALSE&gt;)
	vTpPartida = getMaqConfPar("TP_PARTIDA", vCdMaquina)

	vDsLstItemGravar = ""
	if (vTpPartida = 1 | vTpPartida = 3)
		if (!inValidarParametro("QT_PARTIDA", piParams, "alocarItemPartida"))
			return(-1)
		endif
		if (vQtCapacidadeMaq = 0)
			$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG39691", "DESCRICAO=Máquina configurada para partida com quantidade e sem capacidade definida!", "ADICIONAL=Operação-&gt;CDFSVCO038.alocarItemPartida")
			return(-1)
		endif
		if (vTpOrigem = 3)
			viParams = ""
			putitem/id viParams, "CD_EMPRESA", $item("CD_EMPAGRUPADOR", piParams)
			putitem/id viParams, "NR_AGRUPADOR", $item("NR_AGRUPADOR", piparams)
			vQtPartida = getQtAlocarAgrupador(viParams, $item("CD_PROCESSO", piParams), vCdMaquina, "", &lt;TRUE&gt;, "", vDsLstItemGravar, "")
		elseif (vTpOrigem = 5)
			vQtPartida = getQtAlocarOp(piParams, $item("CD_PROCESSO", piParams), vCdMaquina, &lt;TRUE&gt;, vDsLstItemGravar) ;&lt;-- DSantos Prj-&gt;217-359 20/06/2017 --&gt;
		else
			vQtPartida = converterQtProduto(piParams, $item("QT_PARTIDA", piParams), "MUL")
			if ($status &lt; 0)
				return(-1)
			endif
			viParams = ""
			putitem/id viParams, "CD_EMPRESA", $item("CD_EMPOP", piParams)
			putitem/id viParams, "NR_CICLO", $item("NR_CICLO", piParams)
			putitem/id viParams, "NR_OP", $item("NR_OP", piParams)
			putitem/id viParams, "CD_PRODUTO", $item("CD_PRODUTO", piParams)
			if (vTpOrigem = 1)
				if (vQtPartida &gt; getQtAlocarItemOp(viParams, $item("CD_PROCESSO", piParams), vCdMaquina, &lt;TRUE&gt;, "", ""))
					$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG39762", "DESCRICAO=Item sem quantidade disponível para alocação!", "ADICIONAL=Operação-&gt;CDFSVCO038.alocarItemPartida")
					return(-1)
				endif
			else
				putitem/id viParams, "NR_LOTE", $item("NR_LOTE", piParams)
				putitem/id viParams, "NR_ITEM", $item("NR_ITEM", piParams)
				if (vQtPartida &gt; getQtAlocarItemLote(viParams, $item("CD_PROCESSO", piParams), vCdMaquina, &lt;TRUE&gt;, "", ""))
					$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG39762", "DESCRICAO=Item sem quantidade disponível para alocação!", "ADICIONAL=Operação-&gt;CDFSVCO038.alocarItemPartida")
					return(-1)
				endif
			endif
		endif
		;&lt;-- DSantos Prj-&gt;217-565 13/07/2017
		if (vQtPartida &gt; vQtCapacidadeMaq &amp; getMaqConfPar("TP_DIVISAO", vCdMaquina) = 1)
			;- Quando a quantidade a alocar for maior que a capacidade e não estiver configurada para dividir partida.
			$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG39737", "DESCRICAO=Quantidade do item alocado maior que a capacidade da máquina!", "ADICIONAL=Operação-&gt;CDFSVCO038.alocarItemPartida")
			return(-1)
		endif
		if (vQtPartida &gt; vQtCapacidadeMaq &amp; vTpOrigem &gt;= 3 &amp; vDsLstItem = "" &amp; getMaqConfPar("TP_DIVISAO", vCdMaquina) != 3) ;--&lt; MNSANTOS - Prj 182/1084 - 25/10/2017
			;- Quando for alocar Agrupador = 3 ou Ordem de produção = 5 e a quantidade for maior que a capacidade da máquina, deve receber a lista de item por partida.
			$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG41617", "DESCRICAO=Lista de item por partida não informada!", "ADICIONAL=Operação-&gt;CDFSVCO038.alocarItemPartida")
			return(-1)
		endif
		; DSantos --&gt;

		if (vQtPartida = 0)
			$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG39762", "DESCRICAO=Item sem quantidade disponível para alocação!", "ADICIONAL=Operação-&gt;CDFSVCO038.alocarItemPartida")
			return(-1)
		endif

		if ($item("IN_PARTIDAIGUAL", piParams) = &lt;TRUE&gt;)
			;- Partida com quantidade definida e indicador para gerar partidas iguais, deve recalcular a capacidade da máquina
			vQtTotalPartida = vQtPartida / vQtCapacidadeMaq
			if ($frac(vQtTotalPartida) &gt; 0)
				vQtTotalPartida = $int(vQtTotalPartida) + 1
			else
				vQtTotalPartida = $int(vQtTotalPartida)
			endif
			vQtCapacidadeMaq = vQtPartida / vQtTotalPartida
			if ($frac(vQtCapacidadeMaq) &gt; 0)
				vQtCapacidadeMaq = $int(vQtCapacidadeMaq) + 1
			else
				vQtCapacidadeMaq = $int(vQtCapacidadeMaq)
			endif
		endif
	endif

	vDsLstPartida = ""
	vQtPendente = vQtPartida
	vInGerarPartida = &lt;TRUE&gt;
	if ($item("TP_ALOCACAO", piParams) = 2)
		vInGerarPartida = &lt;FALSE&gt;
	endif
	repeat
		newinstance "CDFSVCO038", vHdInstance
		if (vInGerarPartida)
			;- Caso seja para realocar ou uma nova ordem deve gerar novas partidas
			viParams = ""
			putitem/id viParams, "CD_EMPRESA", vCdEmpPartida
			putitem/id viParams, "CD_PROCESSO", $item("CD_PROCESSO", piParams)
			putitem/id viParams, "CD_MAQUINA", $item("CD_MAQUINA", piParams)
			putitem/id viParams, "TP_ALOCACAO", $item("TP_ALOCACAO", piParams)
			putitem/id viParams, "DS_LSTPADTEC", $item("DS_LSTPADTEC", piParams)
			vHdInstance-&gt;gerarPartida(viParams, voParams, $xCdErro$, $xCtxErro$)
			if ($procerror)
				$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
				return(-1)
			elseif ($status &lt; 0)
				$instancehandle-&gt;removerEntidadeGerada("CDF_PARTIDAPSVC", vDsLstPartida)
				$instancehandle-&gt;removerEntidadeGerada("CDF_PARTIDACFGMAQSVC", vDsLstPartida) ;&lt;-- DSantos Prj-&gt;217-730 20/02/2018 --&gt;
				$instancehandle-&gt;removerEntidadeGerada("CDF_PARTIDASVC", vDsLstPartida)
				return(-1)
			endif
			putitem vDsLstPartida, -1, voParams
			vCdEmpPartida = $item("CD_EMPRESA", voParams)
			vNrPartida = $item("NR_PARTIDA", voParams)
		endif

		if (vTpPartida = 1 | vTpPartida = 3)
			viParams = ""
			putitem/id viParams, "CD_EMPRESA", vCdEmpPartida
			putitem/id viParams, "NR_PARTIDA", vNrPartida
			vQtDisponivel = vQtCapacidadeMaq - getQtAlocadaPartida(viParams, 2)
			if ($status &lt; 0)
				return(-1)
			endif
			;-&gt;HSGARCIA Proj 220/4003 dvaind-2840 28/02/2019
			if(vTpOrigem = 3 &amp; vQtDisponivel &lt; vQtPartida)
				$instancehandle-&gt;setStatus(&lt;STS_ERRO&gt;, "MSG44015", "DESCRICAO=O agrupador ultrapassa a capacidade máxima da máquina ao completar!", "ADICIONAL=Operação-&gt;CDFSVCO038.alocarItemPartida")
				return(-1)
			endif
			;&lt;--
			if ((vTpOrigem = 3 | vTpOrigem = 5) &amp; vDsLstItem = "")
				vQtPendente = 0
				vNrItem = 1
				while (vNrItem &lt;= $itemcount(vDsLstItemGravar))
					vDsRegistro = $itemnr(vNrItem, vDsLstItemGravar)
					putitem/id vDsRegistro, "CD_EMPPARTIDA", vCdEmpPartida
					putitem/id vDsRegistro, "NR_PARTIDA", vNrPartida
					putitem vDsLstItemGravar, vNrItem, vDsRegistro
					vNrItem += 1
				endwhile
			else
				if (vQtDisponivel &gt; 0)
					if (vDsLstItem = "")
						if (vQtPendente &gt; vQtDisponivel)
							vQtPartida = vQtDisponivel
							vQtPendente -= vQtPartida
							if (vQtPendente[round, 3] = 0)
								vQtPendente = 0
							endif
						else
							vQtPartida = vQtPendente
							vQtPendente = 0
						endif
						if (vQtPartida &gt; 0)
							vDsRegistro = piParams
							putitem/id vDsRegistro, "CD_EMPPARTIDA", vCdEmpPartida
							putitem/id vDsRegistro, "NR_PARTIDA", vNrPartida
							putitem/id vDsRegistro, "QT_PARTIDA", vQtPartida
							putitem vDsLstItemGravar, -1, vDsRegistro
						endif
					else
						;&lt;-- DSantos Prj-&gt;217-565 17/07/2017
						vDsLstItemGravar = $itemnr(1, vDsLstItem)
						delitem vDsLstItem, 1
						vNrItem = 1
						while (vNrItem &lt;= $itemcount(vDsLstItemGravar))
							vDsRegistro = $itemnr(vNrItem, vDsLstItemGravar)
							putitem/id vDsRegistro, "CD_EMPPARTIDA", vCdEmpPartida
							putitem/id vDsRegistro, "NR_PARTIDA", vNrPartida
							if (inValidarParametro("CD_EMPAGRUPADOR&uSEP;NR_AGRUPADOR", piParams, "alocarItemPartida"))
								putitem/id vDsRegistro, "CD_EMPAGRUPADOR", $item("CD_EMPAGRUPADOR", piParams)
								putitem/id vDsRegistro, "NR_AGRUPADOR", $item("NR_AGRUPADOR", piParams)
							endif
							putitem vDsLstItemGravar, vNrItem, vDsRegistro
							vNrItem += 1
						endwhile
						if (vDsLstItem = "")
							vQtPendente = 0
						endif
						; DSantos --&gt;
					endif
				elseif (vQtPendente[round, 3] = 0)
					vQtPendente = 0
				endif
			endif
		else
			if (vTpOrigem != 3)
				vDsRegistro = piParams
				putitem/id vDsRegistro, "CD_EMPPARTIDA", vCdEmpPartida
				putitem/id vDsRegistro, "NR_PARTIDA", vNrPartida
				putitem/id vDsRegistro, "QT_PARTIDA", ""
				putitem vDsLstItemGravar, -1, vDsRegistro
			endif
		endif

		viParams = ""
		putitem/id viParams, "DS_LSTITEM", vDsLstItemGravar
		putitem/id viParams, "CD_PROCESSO", $item("CD_PROCESSO", piParams)
		vHdInstance-&gt;incluirItemPartida(viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)
			$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status &lt; 0)
			$instancehandle-&gt;removerEntidadeGerada("CDF_PARTIDAPSVC", vDsLstPartida)
			$instancehandle-&gt;removerEntidadeGerada("CDF_PARTIDACFGMAQSVC", vDsLstPartida) ;&lt;-- DSantos Prj-&gt;217-730 20/02/2018 --&gt;
			$instancehandle-&gt;removerEntidadeGerada("CDF_PARTIDASVC", vDsLstPartida)
			return(-1)
		endif
		if ($instance$)
			$instance$-&gt;limparTempoPartida(CD_EMPRESA.CDF_PARTIDASVC, NR_PARTIDA.CDF_PARTIDASVC)
		endif
		vDsLstItemGravar = ""

		;--&gt; MNSANTOS - Prj 217/602 - 30/08/2017
		$instancehandle-&gt;validarTipoSeguro(vCdEmpPartida, vNrPartida, vCdMaquina)
		if ($procerror)
			$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status &lt; 0)
			$instancehandle-&gt;removerEntidadeGerada("CDF_PARTIDAISVC", vDsLstPartida)
			$instancehandle-&gt;removerEntidadeGerada("CDF_PARTIDAPSVC", vDsLstPartida)
			$instancehandle-&gt;removerEntidadeGerada("CDF_PARTIDACFGMAQSVC", vDsLstPartida) ;&lt;-- DSantos Prj-&gt;217-730 20/02/2018 --&gt;
			$instancehandle-&gt;removerEntidadeGerada("CDF_PARTIDASVC", vDsLstPartida)
			return(-1)
		endif
		;--&lt; MNSANTOS

		vInGerarPartida = &lt;TRUE&gt;
	until (vQtPendente = 0 | vTpPartida = 2)

	if (($item("TP_ALOCACAO", piParams) = 1 | $item("TP_ALOCACAO", piParams) = 2) &amp; (vDsLstPartida != ""))
		viParams = ""
		putitem/id viParams, "NR_ORDEM", vNrOrdem
		putitem/id viParams, "DS_LSTPARTIDA", vDsLstPartida
		vHdInstance-&gt;reordenarPartida(viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)
			$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status &lt; 0)
			$instancehandle-&gt;removerEntidadeGerada("CDF_PARTIDAISVC", vDsLstPartida)
			$instancehandle-&gt;removerEntidadeGerada("CDF_PARTIDAPSVC", vDsLstPartida)
			$instancehandle-&gt;removerEntidadeGerada("CDF_PARTIDACFGMAQSVC", vDsLstPartida) ;&lt;-- DSantos Prj-&gt;217-730 20/02/2018 --&gt;
			$instancehandle-&gt;removerEntidadeGerada("CDF_PARTIDASVC", vDsLstPartida)
			return(-1)
		endif
	endif

	;-&gt;HSGARCIA Proj 217/610 09/08/2017
	if(vInGerarPartida &amp; $tpIntAcabamentoTextil$ &gt; 0 &amp; vDsLstPartida != "" &amp; getInfTecConf("", vCdMaquina, "", "", 4, 42) != "");-&gt;HSGARCIA Proj 217/664 03/11/17 ---- ;-&gt;HSGARCIA Proj 253/378 DVAIND-1940 05/12/2018
		while(vDsLstPartida != "")
			viParams = ""
			putitem/id viParams, "CD_EMPRESA", $item("CD_EMPRESA", $itemnr(1, vDsLstPartida))
			putitem/id viParams, "NR_PARTIDA", $item("NR_PARTIDA", $itemnr(1, vDsLstPartida))
			activate "CDFSVCO039".enviarPartida(viParams, voParams, $xCdErro$, $xCtxerro$)
			if ($procerror)
				$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
				return(-1)
			elseif ($status &lt; 0)
				$instancehandle-&gt;removerEntidadeGerada("CDF_PARTIDAISVC", vDsLstPartida)
				$instancehandle-&gt;removerEntidadeGerada("CDF_PARTIDAPSVC", vDsLstPartida)
				$instancehandle-&gt;removerEntidadeGerada("CDF_PARTIDACFGMAQSVC", vDsLstPartida) ;&lt;-- DSantos Prj-&gt;217-730 20/02/2018 --&gt;
				$instancehandle-&gt;removerEntidadeGerada("CDF_PARTIDASVC", vDsLstPartida)
				return(-1)
			endif
			delitem vDsLstPartida, 1
		endwhile
	endif
	;&lt;-

	return(0)
end ;alocarItemPartida

;--------------------------------
public operation buscarInfPartida
;--------------------------------
	;--&gt; MNSANTOS - Prj 217/195 - 22/02/2015
	params
		string piParams : IN
		string poParams : OUT
		string $xCdErro$ : OUT
		string $xCtxErro$ : OUT
	endparams
	variables
		string vDsRegistro, vDsLstConfLinha, vDsConteudo, vDsInfo, vDsTexto, viParams, voParams, vCdCor, vDsOp, vDsCondicao, vDsLstLocal, vDsLstPrdSeguro
		numeric vQtCone, vQtAux, vQtCapacidade, vQtPartida, vCdSeqGrupo, vCdProduto, vQtPartidaConv, vNrAgrupador
		handle vHandleInstance
	endvariables

	if (!inValidarParametro("CD_EMPRESA&uSEP;NR_PARTIDA", piParams, "buscarInfPartida"))
		return(-1)
	endif

	clear/e "CDF_PARTIDASVC"
	CD_EMPRESA.CDF_PARTIDASVC/init = $item("CD_EMPRESA", piParams)
	NR_PARTIDA.CDF_PARTIDASVC/init = $item("NR_PARTIDA", piParams)
	retrieve/e "CDF_PARTIDASVC"
	if($status &gt;= 0)
		putitem/id vDsInfo, "CD_EMPRESA", CD_EMPRESA.CDF_PARTIDASVC
		putitem/id vDsInfo, "NR_PARTIDA", NR_PARTIDA.CDF_PARTIDASVC
		putitem/id vDsInfo, "NR_ORDEM", NR_ORDEM.CDF_PARTIDASVC
		putitem/id vDsInfo, "DS_PARTIDA", DS_PARTIDA.CDF_PARTIDASVC
		putitem/id vDsInfo, "TP_TIPO", TP_TIPO.CDF_PARTIDASVC
		vDsTexto = "0%%TP_SITUACAO.CDF_PARTIDASVC"
		vDsTexto = $item(vDsTexto, traduzirValrep("TP_SITUACAO.CDF_PARTIDASVC"))
		putitem/id vDsInfo, "TP_SITUACAO", vDsTexto
		putitem/id vDsInfo, "CD_MAQUINA", CD_MAQUINA.CDF_PARTIDASVC
		putitem/id vDsInfo, "DS_MAQUINA", getFieldData("DS_MAQUINA", "CDF_MAQSVC", "CD_MAQUINA=%%CD_MAQUINA.CDF_PARTIDASVC")
		putitem/id vDsInfo, "CD_SEQMAQ", getFieldData("CD_SEQMAQ", "CDF_MAQGMAQSVC", "CD_MAQUINA=%%CD_MAQUINA.CDF_PARTIDASVC") ;--&gt; MNSANTOS - Prj 217/602 - 30/08/2017

		if (!$empty("CDF_PARTIDAPSVC"))
			putitem/id vDsInfo, "CD_PROCESSO", CD_PROCESSO.CDF_PARTIDAPSVC
			vDsTexto = getFieldData("DS_PROCESSO", "CDF_PROCESSOSVC", "CD_PROCESSO=%%CD_PROCESSO.CDF_PARTIDAPSVC")
			putitem/id vDsInfo, "DS_PROCESSO", vDsTexto
		endif

		if (!$empty("CDF_PARTIDAISVC"))
			viParams = ""
			putitem/id viParams, "CD_EMPRESA", CD_EMPOP.CDF_PARTIDAISVC
			putitem/id viParams, "NR_CICLO", NR_CICLO.CDF_PARTIDAISVC
			putitem/id viParams, "NR_OP", NR_OP.CDF_PARTIDAISVC
			putitem/id viParams, "CD_PRODUTO", CD_PRODUTO.CDF_PARTIDAISVC
			activate "PCPSVCO034".buscarLoteCliOpComponente(viParams, voParams, $xCdErro$, $xCtxErro$)
			if ($procerror)
				$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
				return(-1)
			elseif ($status &lt; 0)
				return(-1)
			endif
			putitem/id vDsInfo, "DS_LOTECLI", $item("DS_LOTECLI", voParams)

			sort/e "CDF_PARTIDAISVC", "CD_EMPOP.CDF_PARTIDAISVC, NR_CICLO.CDF_PARTIDAISVC, NR_OP.CDF_PARTIDAISVC"
			setocc "CDF_PARTIDAISVC", 1
			vQtPartida = ""
			vCdProduto = CD_PRODUTO.CDF_PARTIDAISVC
			vNrAgrupador = NR_AGRUPADOR.CDF_PARTIDAISVC
			vCdCor = getFieldData("CD_COR", "V_PRD_PRDSSVC", "CD_PRODUTO=%%CD_PRODUTO.CDF_PARTIDAISVC")
			vCdSeqGrupo = getFieldData("CD_SEQGRUPO", "V_PRD_PRDSSVC", "CD_PRODUTO=%%CD_PRODUTO.CDF_PARTIDAISVC")
			vDsOp = ""
			putitem/id vDsOp, "CD_EMPRESA", CD_EMPOP.CDF_PARTIDAISVC
			putitem/id vDsOp, "NR_CICLO", NR_CICLO.CDF_PARTIDAISVC
			putitem/id vDsOp, "NR_OP", NR_OP.CDF_PARTIDAISVC
			setocc "CDF_PARTIDAISVC", 1
			while ($status &gt;= 0)
				putitem vDsLstPrdSeguro, -1, CD_PRODUTO.CDF_PARTIDAISVC ;--&gt; MNSANTOS - Prj 217/602 - 30/08/2017
				if (vCdProduto != CD_PRODUTO.CDF_PARTIDAISVC)
					vCdProduto = ""
				endif
				if (vNrAgrupador != NR_AGRUPADOR.CDF_PARTIDAISVC);&lt;-- LOMoreira Prj-&gt;200-1124 02/02/2018 --&gt;
					vNrAgrupador = ""
				endif
				if (vCdCor != getFieldData("CD_COR", "V_PRD_PRDSSVC", "CD_PRODUTO=%%CD_PRODUTO.CDF_PARTIDAISVC"))
					vCdCor = ""
				endif
				if (vCdSeqGrupo != getFieldData("CD_SEQGRUPO", "V_PRD_PRDSSVC", "CD_PRODUTO=%%CD_PRODUTO.CDF_PARTIDAISVC"))
					vCdSeqGrupo = ""
				endif
				if (inOpDiferente("CDF_PARTIDAISVC") &amp; $curocc("CDF_PARTIDAISVC") &lt; $totocc("CDF_PARTIDAISVC"))
					vDsOp = ""
				endif
				if (TP_TIPO.CDF_PARTIDASVC = 1) ;- Descontinua
					;&lt;-- DSantos Prj-&gt;217-730 21/02/2018
					viParams = ""
					putlistitems/occ viParams, "CDF_PARTIDAISVC"
					vQtCone += getQtConeItemOp(viParams, QT_PARTIDA.CDF_PARTIDAISVC)
 					;vQtCone += getQtCone(CD_EMPOP.CDF_PARTIDAISVC, NR_CICLO.CDF_PARTIDAISVC, NR_OP.CDF_PARTIDAISVC, CD_PRODUTO.CDF_PARTIDAISVC, QT_PARTIDA.CDF_PARTIDAISVC)
					; DSantos --&gt;
				endif

				;&lt;-- DSantos Prj-&gt;217-747 27/02/2018
				vDsCondicao = ""
				putitem/id vDsCondicao, "CD_EMPRESA", CD_EMPOP.CDF_PARTIDAISVC
				putitem/id vDsCondicao, "NR_CICLO", NR_CICLO.CDF_PARTIDAISVC
				putitem/id vDsCondicao, "NR_OP", NR_OP.CDF_PARTIDAISVC
				putitem/id vDsCondicao, "CD_PRODUTO", CD_PRODUTO.CDF_PARTIDAISVC
				if (NR_LOTE.CDF_PARTIDAISVC != "" &amp; NR_ITEM.CDF_PARTIDAISVC != "")
					putitem/id vDsCondicao, "NR_LOTE", NR_LOTE.CDF_PARTIDAISVC
					putitem/id vDsCondicao, "NR_ITEM", NR_ITEM.CDF_PARTIDAISVC
					vDsLstLocal = $concat(vDsLstLocal, "&uSEP;", getListFieldData("CD_LOCAL", "CDF_LOCOPLOTESVC", vDsCondicao))
				else
					vDsLstLocal = $concat(vDsLstLocal, "&uSEP;", getListFieldData("CD_LOCAL", "CDF_LOCOPSVC", vDsCondicao))
				endif
				; DSantos --&gt;

				vQtPartida += QT_PARTIDA.CDF_PARTIDAISVC
				setocc "CDF_PARTIDAISVC", $curocc("CDF_PARTIDAISVC") + 1
			endwhile

			;--&gt; MNSANTOS - Prj 217/602 - 30/08/2017
			putitem/id vDsInfo, "CD_PRODUTOSEGURO", getCdPrdSeguro(vDsLstPrdSeguro)
			putitem/id vDsInfo, "CD_PRODUTO", vCdProduto
			putitem/id vDsInfo, "NR_AGRUPADOR", vNrAgrupador ;&lt;-- LOMoreira Prj-&gt;200-1124 02/02/2018 --&gt;
			putitem/id vDsInfo, "CD_COR", vCdCor
			putitem/id vDsInfo, "CD_SEQGRUPO", vCdSeqGrupo
			putitem/id vDsInfo, "QT_CONE", vQtCone
			putitem/id vDsInfo, "QT_ALOCADA", vQtPartida
			putitem/id vDsInfo, "DS_OP", vDsOp

			if (TP_TIPO.CDF_PARTIDASVC = 1 | TP_TIPO.CDF_PARTIDASVC = 4)
				viParams = ""
				putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.CDF_PARTIDASVC
				putitem/id viParams, "NR_PARTIDA", NR_PARTIDA.CDF_PARTIDASVC

				vQtCapacidade = getCapacidadeMaquina(CD_MAQUINA.CDF_PARTIDASVC, &lt;FALSE&gt;)
				$vl12d2$ = vQtCapacidade
				putitem/id vDsInfo, "QT_CAPACIDADE", "%%$vl12d2$"

				$vl12d2$ = getQtAlocadaPartida(viParams, 3)
				if ($status &lt; 0)
					putitem/id vDsInfo, "QT_PESOPARTIDA", "Erro na converção"
				endif
				putitem/id vDsInfo, "QT_PESOPARTIDA", "%%$vl12d2$"

				if($vl12d2$ &lt; getCapacidadeMaquina(CD_MAQUINA.CDF_PARTIDASVC, &lt;TRUE&gt;))
					putitem/id vDsInfo, "IN_QTMINIMA", &lt;FALSE&gt;
				else
					putitem/id vDsInfo, "IN_QTMINIMA", &lt;TRUE&gt;
				endif

				;&lt;-- DSantos Prj-&gt;217-730 22/02/2018
				;vDsTexto = getInfTecConf(CD_PRODUTO.CDF_PARTIDAISVC, CD_MAQUINA.CDF_PARTIDASVC, "", CD_PROCESSO.CDF_PARTIDAPSVC, 2, 32)
				vDsTexto = getDadosPadraoTecnico(32, CD_PRODUTO.CDF_PARTIDAISVC, CD_MAQUINA.CDF_PARTIDASVC, CD_PROCESSO.CDF_PARTIDAPSVC, CD_EMPRESA.CDF_PARTIDASVC, NR_PARTIDA.CDF_PARTIDASVC)
				; DSantos --&gt;
				if (vDsTexto != "")
					vDsTexto = "%%vDsTexto %%$lowercase(getFieldData("CD_ESPECIE", "PRD_PRODUTOSVC", "CD_PRODUTO=%%CD_PRODUTO.CDF_PARTIDAISVC"))/min"
					vDsTexto = $replace(vDsTexto, 1, ".", ",", -1)
					putitem/id vDsInfo, "QT_VELOCIDADE", vDsTexto
				endif

				vQtPartidaConv = getQtAlocadaPartida(viParams, 2)
				if(vQtCapacidade &gt; 0 &amp; vQtPartidaConv &gt; 0)
					vQtAux = (vQtPartidaConv / vQtCapacidade) * 100
					putitem/id vDsInfo, "PR_APROVEITAMENTO", vQtAux
				endif

				if (getMaqConfPar("TP_RESTRICAO", CD_MAQUINA.CDF_PARTIDASVC) = 1)
					putitem/id vDsInfo, "QT_VOLUME", $replace(vQtPartidaConv[round,2], 1, ".", ",", -1)
				endif
			endif
		else
			putitem/id vDsInfo, "IN_SEMITEM", &lt;TRUE&gt;
		endif

		if (TP_TIPO.CDF_PARTIDASVC = 2)
			putitem/id vDsInfo, "IN_DESATIVACAO", &lt;TRUE&gt;
		endif

		if(getFieldData("CD_EMPORI", "CDF_PARTIDARESVC", "CD_EMPDEST=%%CD_EMPRESA.CDF_PARTIDASVC&uSEP;NR_PARTIDADEST=%%NR_PARTIDA.CDF_PARTIDASVC&uSEP;TP_PARTIDAREL=1") != "");Reprocesso
			putitem/id vDsInfo, "IN_REPROCESSO", &lt;TRUE&gt;
		endif

		viParams = ""
		putitem/id viParams, "CD_EMPRESA" , CD_EMPRESA.CDF_PARTIDASVC
		putitem/id viParams, "NR_PARTIDA" , NR_PARTIDA.CDF_PARTIDASVC
		newinstance "CDFSVCO038", vHandleInstance
		vHandleInstance-&gt;buscarReceitaPartida(viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)
			$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status &lt; 0)
			return(-1)
		endif
		putitem/id vDsInfo, "CD_RECEITA", $item("CD_RECEITA", voParams)
		putitem/id vDsInfo, "CD_PROCORGATEX", getProcOrgatex($item("CD_RECEITA", vDsInfo)) ;--&gt; MNSANTOS - 26/10/2017
		putitem/id vDsInfo, "DS_LSTCLASREC", dsBuscarClasReceita($item("CD_RECEITA", vDsInfo)) ;&lt;-- DSantos Prj-&gt;217-771 03/04/2018 --&gt;

		if ($item("IN_CALCULARTEMPO", piParams) != &lt;FALSE&gt;)
			if (!$instance$)
				newinstance "CDFSVCO038", $instance$
			endif
			viParams = ""
			putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.CDF_PARTIDASVC
			putitem/id viParams, "NR_PARTIDA", NR_PARTIDA.CDF_PARTIDASVC
			$instance$-&gt;calcularTempoPartida(viParams, voParams, $xCdErro$, $xCtxErro$)
			if ($procerror)
				$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
				return(-1)
			elseif ($status &lt; 0)
				return(-1)
			endif
			if(voParams != "")
				vDsInfo = "%%vDsInfo&uSEP;%%voParams"
			endif
		endif
		;--&gt; MNSANTOS - Prj 217/745 - 28/02/2018
		setocc "CDF_PARTIDAPTSVC", 1
		putitem/id vDsInfo, "DT_INICIOPT", DT_INICIO.CDF_PARTIDAPTSVC
		putitem/id vDsInfo, "CD_OPERINIPT", CD_OPERINICIO.CDF_PARTIDAPTSVC
		setocc "CDF_PARTIDAPTSVC", -1
		putitem/id vDsInfo, "DT_FIMPT", DT_FIM.CDF_PARTIDAPTSVC
		putitem/id vDsInfo, "CD_OPERFIMPT", CD_OPERFIM.CDF_PARTIDAPTSVC
		;--&lt; MNSANTOS

		;&lt;-- DSantos Prj-&gt;217-747 21/02/2018
		vDsCondicao = ""

		if (vDsLstLocal != "")
			delitem vDsLstLocal, 1
			sort/list vDsLstLocal, "unique"
			if ($itemcount(vDsLstLocal) = 1)
				putitem/id vDsCondicao, "CD_LOCAL", vDsLstLocal
				putitem/id vDsInfo, "CD_LOCALPARTIDA", vDsLstLocal
			endif
		endif
		vDsCondicao = ""
		putitem/id vDsCondicao, "CD_MAQUINA", CD_MAQUINA.CDF_PARTIDASVC
		$handleEntity$-&gt;consultar("CDF_MAQCONFLOCALSVC", vDsCondicao)
		if ($status &gt;= 0)
			putitem/id vDsCondicao, "CD_LOCAL", $item("CD_LOCALPARTIDA", vDsInfo)
			vDsRegistro = ""
			if ($item("CD_LOCAL", vDsCondicao) != "")
				putitem/id vDsCondicao, "TP_SITUACAO", 6 ;- Localização
				$handleEntity$-&gt;consultar("CDF_MAQCONFLOCALSVC", vDsCondicao)
				if ($status &gt;= 0)
					$handleEntity$-&gt;getRegistro(vDsRegistro)
				else
					delitem/id vDsCondicao, "CD_LOCAL"
				endif
			endif
			if (vDsRegistro = "")
				delitem/id vDsCondicao, "TP_SITUACAO"
				if ($item("IN_REPROCESSO", vDsInfo) = &lt;TRUE&gt;)
					putitem/id vDsCondicao, "TP_SITUACAO", 1 ;- Reprocesso
				elseif ($item("IN_DESATIVACAO", vDsInfo) = &lt;TRUE&gt;)
					putitem/id vDsCondicao, "TP_SITUACAO", 2 ;- Desativação
				elseif ($item("IN_SEMITEM", vDsInfo) = &lt;TRUE&gt;)
					putitem/id vDsCondicao, "TP_SITUACAO", 3 ;- Sem item
				elseif ($item("IN_QTMINIMA", vDsInfo) = &lt;FALSE&gt;)
					putitem/id vDsCondicao, "TP_SITUACAO", 4 ;- Abaixo do mínimo
				elseif ($item("IN_DISPONIVEL", vDsInfo) = &lt;FALSE&gt;)
					putitem/id vDsCondicao, "TP_SITUACAO", 5 ;- Indisponível
				elseif ($item("CD_LOCALPARTIDA", vDsInfo) = "")
					putitem/id vDsCondicao, "TP_SITUACAO", 6 ;- Localização
					putitem/id vDsCondicao, "CD_LOCAL", "&uEQ;"
				endif
				if ($item("TP_SITUACAO", vDsCondicao) != "")
					$handleEntity$-&gt;consultar("CDF_MAQCONFLOCALSVC", vDsCondicao)
					if ($status &gt;= 0)
						$handleEntity$-&gt;getRegistro(vDsRegistro)
					endif
				endif
			endif
			if (vDsRegistro != "")
				putitem/id vDsInfo, "CD_LOCALOP", $item("CD_LOCAL", vDsRegistro)
				putitem/id vDsInfo, "DS_CORTEXTO", $item("DS_CORTEXTO", vDsRegistro)
				putitem/id vDsInfo, "DS_CORFUNDO", $item("DS_CORFUNDO", vDsRegistro)
				putitem/id vDsInfo, "DS_SITUACAOAUX", $item("DS_SITUACAOAUX", vDsRegistro)
				putitem/id vDsInfo, "CD_COMPONENTE", $item("CD_COMPONENTE", vDsRegistro)
			endif
		endif
		; DSantos --&gt;

		$handleEntity$-&gt;consultar("CDF_MAQCONFPARSVC", "CD_MAQUINA=%%CD_MAQUINA.CDF_PARTIDASVC")
		if($status &gt;= 0)
			vDsLstConfLinha = $item("DS_CONFLINHA", getRegistro($handleEntity$))
			while(vDsLstConfLinha != "")
				vDsConteudo = ""
				vDsRegistro = $itemnr(1, vDsLstConfLinha)
				selectcase $item("TP_INFORMACAO", vDsRegistro)
				case 1 ;Número da partida
					vDsConteudo = NR_PARTIDA.CDF_PARTIDASVC
				case 2 ;Código da cor do produto da partida
					vDsConteudo = vCdCor
				case 3 ;Descrição da cor do produto da partida
					vDsConteudo = getFieldData("DS_COR", "PRD_CORSVC", "CD_COR=%%vCdCor")
				case 4 ;4 - Progresso em percentual numérico
					if ($item("TP_TIPO", vDsInfo) != 2)
						vDsConteudo = $item("PR_PRODUCAO", vDsInfo)
						vDsConteudo = $replace(vDsConteudo, 1, ".", ",", -1)
					endif
				case 5 ;5 - Progresso em barra
					if ($item("TP_TIPO", vDsInfo) != 2)
						vDsConteudo = $item("PR_PRODUCAO", vDsInfo)
						putitem/id vDsInfo, "IN_PROGRESSO%%$item("NR_LINHA", vDsRegistro)", &lt;TRUE&gt;
					endif
				case 6 ;Descrição completa do grupo de produto da partida
					if(vCdSeqGrupo != "")
						vDsConteudo = getFieldData("DS_NIVEL", "PRD_GRUPOADICSVC", "CD_SEQGRUPO=%%vCdSeqGrupo")
					endif
				case 7 ;Descrição do último nível do grupo de produto da partida
					if(vCdSeqGrupo != "")
						vDsConteudo = getFieldData("DS_GRUPO", "PRD_GRUPOSVC", "CD_SEQ=%%vCdSeqGrupo")
					endif
				case 8 ;Quantidade total da partida na unidade do produto
					if (!$empty("CDF_PARTIDAISVC"))
						$vl12d2$ = vQtPartida
						vDsConteudo = "%%$VL12D2$"
					endif
				case 9 ;Quantidade total da partida em Kg (convertido pela gramatura)
					vDsConteudo = $item("QT_PESOPARTIDA", vDsInfo)
				case 10 ;Código do grupo
					vDsConteudo = vCdSeqGrupo
				case 11 ;Código do produto
					vDsConteudo = vCdProduto
				case 12 ;Data e hora de previsão de término da partida
					$dataHora$ = $item("DT_PREVFIM", vDsInfo)
					vDsConteudo = "%%$dataHora$"
				case 13 ;Data e hora de previsão de início
					$dataHora$ = $item("DT_INICIOPREV", vDsInfo)
					if ($dataHora$ = $item("DT_INICIOPREV", vDsInfo) &amp; $item("DT_INICIOPREV", vDsInfo) != "")
						vDsConteudo = "%%$dataHora$"
					elseif ($item("DT_INICIOPREV", vDsInfo) = "")
						if ($item("DT_INICIO", vDsInfo) != "")
							$dataHora$ = $item("DT_INICIO", vDsInfo)
							vDsConteudo = "%%$dataHora$"
						endif
					else
						vDsConteudo = $item("DT_INICIOPREV", vDsInfo)
					endif
				case 14 ;Código da receita
					vDsConteudo = $item("CD_RECEITA", vDsInfo)
				;--&gt; MNSANTOS - Prj 217/240 - 11/05/2016
				case 15 ;Códugo do processo
					vDsConteudo = CD_PROCESSO.CDF_PARTIDAPSVC
				case 16 ;Descrição do processo
					vDsConteudo = getFieldData("DS_PROCESSO", "CDF_PROCESSOSVC", "CD_PROCESSO=%%CD_PROCESSO.CDF_PARTIDAPSVC")
				;--&lt; MNSANTOS
				case 17 ;- Numero da O.P.
					vDsConteudo = $item("NR_OP", vDsOp)
				case 18 ;- Situação auxiliar
					vDsConteudo = $item("DS_SITUACAOAUX", vDsInfo)
				case 19 ;-- Número do agrupador ;&lt;-- LOMoreira Prj-&gt;200-1124 02/02/2018 --&gt;
					vDsConteudo = $item("NR_AGRUPADOR", vDsInfo)
				endselectcase

				if(vDsConteudo != "")
					if($item("NR_LINHA", vDsRegistro) = 1)
						vDsTexto = $item("DS_LINHA1", vDsInfo)
						vDsTexto = "%%vDsTexto%%$item("DS_SEPARADOR", vDsRegistro)%%$item("DS_IDENTIFICADOR", vDsRegistro)%%vDsConteudo"
						putitem/id vDsInfo, "DS_LINHA1", vDsTexto
						if($item("TP_FONTE", vDsRegistro) != "")
							putitem/id vDsInfo, "TP_FONTE1", $item("TP_FONTE", vDsRegistro)
						endif
					elseif($item("NR_LINHA", vDsRegistro) = 2)
						vDsTexto = $item("DS_LINHA2", vDsInfo)
						vDsTexto = "%%vDsTexto%%$item("DS_SEPARADOR", vDsRegistro)%%$item("DS_IDENTIFICADOR", vDsRegistro)%%vDsConteudo"
						putitem/id vDsInfo, "DS_LINHA2", vDsTexto
						if($item("TP_FONTE", vDsRegistro) != "")
							putitem/id vDsInfo, "TP_FONTE2", $item("TP_FONTE", vDsRegistro)
						endif
					elseif($item("NR_LINHA", vDsRegistro) = 3)
						vDsTexto = $item("DS_LINHA3", vDsInfo)
						vDsTexto = "%%vDsTexto%%$item("DS_SEPARADOR", vDsRegistro)%%$item("DS_IDENTIFICADOR", vDsRegistro)%%vDsConteudo"
						putitem/id vDsInfo, "DS_LINHA3", vDsTexto
						if($item("TP_FONTE", vDsRegistro) != "")
							putitem/id vDsInfo, "TP_FONTE3", $item("TP_FONTE", vDsRegistro)
						endif
					endif
				endif

				delitem vDsLstConfLinha, 1
			endwhile
			putitem/id vDsInfo, "TP_PARTIDA", TP_TIPO.CDF_PARTIDASVC
		endif

		;--&gt; MNSANTOS - Prj 217/539 - 21/06/2017
		vDsCondicao = ""
		putitem/id vDsCondicao, "CD_EMPPARTIDA", CD_EMPRESA.CDF_PARTIDASVC
		putitem/id vDsCondicao, "NR_PARTIDA", NR_PARTIDA.CDF_PARTIDASVC
		putitem/id vDsCondicao, "TP_EMISSAO", 1 ;Normal
		putitem/id vDscondicao, "TP_SITUACAO", 1 ;Normal
		$handleEntity$-&gt;consultar("CDF_PARTIDAEMISSAOSVC", vDsCondicao)
		if($status &gt;= 0)
			$handleEntity$-&gt;getRegistro(vDsRegistro)
			putitem/id vDsInfo, "CD_EMPEMISSAO", $item("CD_EMPEMISSAO", vDsRegistro)
			putitem/id vDsInfo, "NR_EMISSAO", $item("NR_EMISSAO", vDsRegistro)
		endif
		;--&lt; MNSANTOS
	endif

	poParams = vDsInfo
	return(0)
end ;buscarInfPartida

;----------------------------
public operation gerarPartida
	;-------------------------
	params
		string piParams : IN
		string poParams : OUT
		string $xCdErro$ : OUT
		string $xCtxErro$ : OUT
	endparams
	variables
		string vDsParametros
		numeric vCdSeqMaq, vTpTipo
		date vDtPartida
	endvariables

	;--&gt; MNSANTOS - Prj 217/611 - 04/09/2017
	vDsParametros = "CD_EMPRESA&uSEP;CD_PROCESSO&uSEP;TP_ALOCACAO"
	if($item("IN_NAO_VALIDAR_MAQUINA", piParams) != &lt;TRUE&gt;)
		putitem vDsParametros, -1, "CD_MAQUINA"
	else
		putitem vDsParametros, -1, "TP_TIPO"
	endif
	;--&lt; MNSANTOS

	if (!inValidarParametro(vDsParametros, piParams, "gerarPartida"))
		return(-1)
	endif

	vTpTipo = $item("TP_TIPO", piParams)

	;--&gt; MNSANTOS - Prj 217/611 - 04/09/2017
	if($item("CD_MAQUINA", piParams) != "")
		vCdSeqMaq = getFieldData("CD_SEQMAQ", "CDF_MAQGMAQSVC", "CD_MAQUINA=%%$item("CD_MAQUINA", piParams)")
		if (getFieldData("TP_FINALIDADE", "CDF_GMAQSVC", "CD_SEQMAQ=%%vCdSeqMaq") != getFieldData("TP_CALTEMPO", "CDF_PROCESSOSVC", "CD_PROCESSO=%%$item("CD_PROCESSO", piParams)"))
			$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "", "DESCRICAO=Tipo de cálculo do processo diferente do tipo de finalidade do grupo de máquina!", "ADICIONAL=Operação-&gt;CDFSVCO038.gerarPartida")
			return(-1)
		endif

		if (vTpTipo = "")
			vTpTipo = getMaqConfPar("TP_PARTIDA", $item("CD_MAQUINA", piParams))
			if (vTpTipo &gt; 1)
				vTpTIpo += 1
			endif
		endif
	endif
	;--&lt; MNSANTOS

	;--&gt; MNSANTOS - Prj 217/590 - 11/08/2017
	vDtPartida = $item("DT_PARTIDA", piParams)
	if(vDtPartida = "")
		vDtPartida = $datim
	endif
	;--&lt; MNSANTOS

	creocc "CDF_PARTIDASVC", -1
	CD_EMPRESA.CDF_PARTIDASVC = $item("CD_EMPRESA", piParams)
	NR_PARTIDA.CDF_PARTIDASVC = getNrNovaPartida($item("CD_EMPRESA", piParams))
	retrieve/o "CDF_PARTIDASVC"
	if ($status = -7)
		retrieve/x "CDF_PARTIDASVC"
	endif
	if ($item("TP_ALOCACAO", piParams) = 0 &amp; $item("CD_MAQUINA", piParams) != "")
		NR_ORDEM.CDF_PARTIDASVC = getNrOrdemPartida($item("CD_EMPRESA", piParams), $item("CD_MAQUINA", piParams))
	endif
	CD_MAQUINA.CDF_PARTIDASVC = $item("CD_MAQUINA", piParams)
	TP_SITUACAO.CDF_PARTIDASVC = 0 ;- Aguardando
	DT_PARTIDA.CDF_PARTIDASVC = vDtPartida
	CD_MOTIVO.CDF_PARTIDASVC = $item("CD_MOTIVO", piParams)
	TP_TIPO.CDF_PARTIDASVC = vTpTipo
	NR_PERIODO.CDF_PARTIDASVC = $item("NR_PERIODO", piParams) ;&lt;-- LOMoreira Prj-&gt;253-48 15/04/2018 --&gt;
	DS_OBSERVACAO.CDF_PARTIDASVC = $item("DS_OBSERVACAO", piParams) ;&lt;-- LOMoreira Prj-&gt;253-48 15/04/2018 --&gt;
	CD_OPERADOR.CDF_PARTIDASVC = $item("CD_USUARIO", $$gParamGlb)
	DT_CADASTRO.CDF_PARTIDASVC = $datim

	creocc "CDF_PARTIDAPSVC", -1
	NR_SEQUENCIA.CDF_PARTIDAPSVC = 1
	retrieve/o "CDF_PARTIDAPSVC"
	if ($status = -7)
		retrieve/x "CDF_PARTIDAPSVC"
	endif
	TP_SITUACAO.CDF_PARTIDAPSVC = 1
	CD_EMPRECEMISSAO.CDF_PARTIDAPSVC = CD_EMPRESA.CDF_PARTIDASVC
	CD_MAQUINA.CDF_PARTIDAPSVC = $item("CD_MAQUINA", piParams)
	CD_PROCESSO.CDF_PARTIDAPSVC = $item("CD_PROCESSO", piParams)
	CD_OPERADOR.CDF_PARTIDAPSVC = $item("CD_USUARIO", $$gParamGlb)
	DT_CADASTRO.CDF_PARTIDAPSVC = $datim

	$collhandle("CDF_PARTIDASVC")-&gt;Salvar()
	if ($procerror)
		$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status &lt; 0)
		return(-1)
	endif

	;&lt;-- DSantos Prj-&gt;217-718 20/02/2018
	$instancehandle-&gt;gravarPadraoTecPartida(CD_EMPRESA.CDF_PARTIDASVC, NR_PARTIDA.CDF_PARTIDASVC, $item("DS_LSTPADTEC", piParams))
	if ($procerror)
		$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status &lt; 0)
		return(-1)
	endif
	; DSantos --&gt;

	putitem/id poParams, "CD_EMPRESA", CD_EMPRESA.CDF_PARTIDASVC
	putitem/id poParams, "NR_PARTIDA", NR_PARTIDA.CDF_PARTIDASVC

	return(0)
end ;gerarPartida

;----------------------------------
public operation incluirItemPartida
	;-------------------------------
	params
		string piParams : IN
		string poParams : OUT
		string $xCdErro$ : OUT
		string $xCtxErro$ : OUT
	endparams
	variables
		string vDsLstItem, vDsLstItemGerado, vDsRegistro, vDsParams, viParams, voParams
		numeric vCdSeqMaq, vQtPartida, vQtCapacidadeMaq
	endvariables

	vDsLstItem = $item("DS_LSTITEM", piParams)
	while (vDsLstItem != "")
		clear/e "CDF_PARTIDASVC"
		CD_EMPRESA.CDF_PARTIDASVC/init = $item("CD_EMPPARTIDA", $itemnr(1, vDsLstItem))
		NR_PARTIDA.CDF_PARTIDASVC/init = $item("NR_PARTIDA", $itemnr(1, vDsLstItem))
		retrieve/e "CDF_PARTIDASVC"
		if ($status &gt;= 0)
			if (TP_TIPO.CDF_PARTIDASVC = 3)
				;- Quando for partida continua sem quantidade, um item pode ser alocada apenas uma vez em cada máquina e processo.
				clear/e "V_CDF_PARTIDASVC"
				CD_EMPOP.V_CDF_PARTIDASVC/init = $item("CD_EMPOP", $itemnr(1, vDsLstItem))
				NR_CICLO.V_CDF_PARTIDASVC/init = $item("NR_CICLO", $itemnr(1, vDsLstItem))
				NR_OP.V_CDF_PARTIDASVC/init = $item("NR_OP", $itemnr(1, vDsLstItem))
				CD_PRODUTO.V_CDF_PARTIDASVC/init = $item("CD_PRODUTO", $itemnr(1, vDsLstItem))
				CD_MAQUINA.V_CDF_PARTIDASVC/init = CD_MAQUINA.CDF_PARTIDASVC
				TP_SITUACAO.V_CDF_PARTIDASVC/init = "0&uSEP;1" ;- Aguardando e Em andamento
				retrieve/e "V_CDF_PARTIDASVC"
				if ($status &gt;= 0)
					$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG35297", "DESCRICAO=Item da já está relacionado em partida para a máquina @@1@@!&uSEP;PARAMETRO=%%CD_MAQUINA.CDF_PARTIDASVC", "ADICIONAL=Operação-&gt;CDFSVCO038.incluirItemPartida")
					$instancehandle-&gt;removerEntidadeGerada("CDF_PARTIDAISVC", vDsLstItemGerado)
					return(-1)
				endif
			endif
			vDsParams = ""
			putitem/id vDsParams, "CD_EMPRESA", $item("CD_EMPOP", $itemnr(1, vDsLstItem))
			putitem/id vDsParams, "NR_CICLO", $item("NR_CICLO", $itemnr(1, vDsLstItem))
			putitem/id vDsParams, "NR_OP", $item("NR_OP", $itemnr(1, vDsLstItem))
			putitem/id vDsParams, "CD_PRODUTO", $item("CD_PRODUTO", $itemnr(1, vDsLstItem))
			putitem/id vDsParams, "CD_PROCESSO", CD_PROCESSO.CDF_PARTIDAPSVC
			putitem/id vDsParams, "CD_MAQUINA", CD_MAQUINA.CDF_PARTIDASVC
			if ($item("IN_VALIDARPROCESSO", piParams) != &lt;FALSE&gt;)
				if(!inValidarProcessoMaquinaPartida(vDsParams))
					return(-1)
				endif
			endif
			creocc "CDF_PARTIDAISVC", -1
			NR_SEQUENCIA.CDF_PARTIDAISVC = getNrSeqItemPartida(CD_EMPRESA.CDF_PARTIDASVC, NR_PARTIDA.CDF_PARTIDASVC)
			TP_ITEM.CDF_PARTIDAISVC = $item("TP_ORIGEM", $itemnr(1, vDsLstItem))
			CD_EMPOP.CDF_PARTIDAISVC = $item("CD_EMPOP", $itemnr(1, vDsLstItem))
			NR_CICLO.CDF_PARTIDAISVC = $item("NR_CICLO", $itemnr(1, vDsLstItem))
			NR_OP.CDF_PARTIDAISVC = $item("NR_OP", $itemnr(1, vDsLstItem))
			CD_PRODUTO.CDF_PARTIDAISVC = $item("CD_PRODUTO", $itemnr(1, vDsLstItem))
			if ($item("TP_ORIGEM", $itemnr(1, vDsLstItem)) = 2)
				NR_LOTE.CDF_PARTIDAISVC = $item("NR_LOTE", $itemnr(1, vDsLstItem))
				NR_ITEM.CDF_PARTIDAISVC = $item("NR_ITEM", $itemnr(1, vDsLstItem))
			endif
			if (TP_TIPO.CDF_PARTIDASVC = 1 | TP_TIPO.CDF_PARTIDASVC = 4)
				vDsParams = $itemnr(1, vDsLstItem)
				putitem/id vDsParams, "CD_MAQUINA", CD_MAQUINA.CDF_PARTIDASVC
				putitem/id vDsParams, "CD_PROCESSO", CD_PROCESSO.CDF_PARTIDAPSVC
				if ($item("IN_CONVERTER", $itemnr(1, vDsLstItem)) = &lt;FALSE&gt;)
					QT_PARTIDA.CDF_PARTIDAISVC = $item("QT_PARTIDA", $itemnr(1, vDsLstItem))
					;--&gt; MNSANTOS - Prj 217-593 - 19/09/2017
					if($item("IN_VALIDARCAPACIDADEMAQ", piParams) = &lt;TRUE&gt;)
						vQtPartida += converterQtProduto(vDsParams, $item("QT_PARTIDA", $itemnr(1, vDsLstItem)), "MUL")
					endif
					;--&lt; MNSANTOS
				else
					QT_PARTIDA.CDF_PARTIDAISVC = converterQtProduto(vDsParams, $item("QT_PARTIDA", $itemnr(1, vDsLstItem)), "DIV")
					vQtPartida += $item("QT_PARTIDA", $itemnr(1, vDsLstItem)) ;--&gt; MNSANTOS - Prj 217-593 - 19/09/2017
				endif
				if ($status &lt; 0)
					return(-1)
				endif
				QT_REFERENCIA.CDF_PARTIDAISVC = getQtReferenciaItemPartida(vDsParams, QT_PARTIDA.CDF_PARTIDAISVC, $item("TP_ORIGEM", $itemnr(1, vDsLstItem)), $item("QT_REFERENCIA", $itemnr(1, vDsLstItem)))
				if ($status &lt; 0)
					return(-1)
				endif
			endif
			CD_EMPAGRUPADOR.CDF_PARTIDAISVC = $item("CD_EMPAGRUPADOR", $itemnr(1, vDsLstItem))
			NR_AGRUPADOR.CDF_PARTIDAISVC = $item("NR_AGRUPADOR", $itemnr(1, vDsLstItem))
			CD_OPERADOR.CDF_PARTIDAISVC = $item("CD_USUARIO", $$gParamGlb)
			DT_CADASTRO.CDF_PARTIDAISVC = $datim
			$collhandle("CDF_PARTIDAISVC")-&gt;Salvar()
			if ($procerror)
				$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
				return(-1)
			elseif ($status &lt; 0)
				return(-1)
			endif
			vDsRegistro = ""
			putlistitems/occ vDsRegistro, "CDF_PARTIDAISVC"
			putitem vDsLstItemGerado, -1, vDsRegistro
		endif

		clear/e "V_CDF_REC_PARTISVC"
		CD_EMPRESA.V_CDF_REC_PARTISVC/init = "&uEQ;%%CD_EMPRESA.CDF_PARTIDASVC"
		NR_PARTIDA.V_CDF_REC_PARTISVC/init = NR_PARTIDA.CDF_PARTIDASVC
		retrieve/e "V_CDF_REC_PARTISVC"
		if ($status &gt;= 0)
			if (CD_RECEITA.V_CDF_REC_PARTISVC = "RECEITADIF")
				$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG39721", "DESCRICACAO=Itens da partida com receita diferente para o processo!", "ADICIONAL=Operação-&gt;CDFSVCO038.incluirItemPartida")
				$instancehandle-&gt;removerEntidadeGerada("CDF_PARTIDAISVC", vDsLstItemGerado)
				return(-1)
			endif
		endif
		delitem vDsLstItem, 1
	endwhile

	;--&gt; MNSANTOS - Prj 217-593 - 19/09/2017
	if($item("IN_VALIDARCAPACIDADEMAQ", piParams) = &lt;TRUE&gt;)
		vQtCapacidadeMaq = getCapacidadeMaquina(CD_MAQUINA.CDF_PARTIDASVC, &lt;FALSE&gt;)
		if (vQtPartida &gt; vQtCapacidadeMaq)
			;- Quando a quantidade a alocar for maior que a capacidade e não estiver configurada para dividir partida.
			$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG39737", "DESCRICAO=Quantidade do item alocado maior que a capacidade da máquina!", "ADICIONAL=Operação-&gt;CDFSVCO038.incluirItemPartida")
			return(-1)
		endif
	endif
	;--&lt; MNSANTOS

	return(0)
end ;incluirItemPartida

;--------------------------------------
partner operation removerEntidadeGerada
	;-----------------------------------
	params
		string piDsEntity : IN
		string piDsLista : IN
	endparams
	variables
		string vDsKeyFields, vDsField, vDsKey, vCdErro, vCtxErro
		numeric vNrKey
	endvariables

	vCdErro = $xCdErro$
	vCtxErro = $xCtxErro$

	vDsKeyFields = $keyfields("%%piDsEntity", 1)
	while (piDsLista != "")
		if (piDsEntity != "CDF_PARTIDASVC")
			clear/e "CDF_PARTIDASVC"
			CD_EMPRESA.CDF_PARTIDASVC/init = $item("CD_EMPRESA", $itemnr(1, piDsLista))
			NR_PARTIDA.CDF_PARTIDASVC/init = $item("NR_PARTIDA", $itemnr(1, piDsLista))
			retrieve/e "CDF_PARTIDASVC"
			if ($status &lt; 0)
				return(0)
			endif
		endif
		clear/e "%%piDsEntity"
		vNrKey = 1
		while (vNrKey &lt;= $itemcount(vDsKeyFields))
			vDsField = "%%$itemnr(vNrKey, vDsKeyFields)%%%.%%piDsEntity"
			if ($itemnr(vNrKey, vDsKeyFields) = "CD_EMPPARTIDA")
				@vDsField/init = $item("CD_EMPRESA", $itemnr(1, piDsLista))
			else
				@vDsField/init = $item($itemnr(vNrKey, vDsKeyFields), $itemnr(1, piDsLista))
			endif
			vNrKey += 1
		endwhile
		retrieve/e "%%piDsEntity"
		if ($status &gt;= 0)
			$collhandle("%%piDsEntity")-&gt;Excluir()
			if ($procerror)
				$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
				return(-1)
			elseif ($status &lt; 0)
				return(-1)
			endif
		endif
		delitem piDsLista, 1
	endwhile

	$xCdErro$ = vCdErro
	$xCtxErro$ = vCtxErro

	return(0)
end ;removerPartidaGerada

;--------------------------------
public operation reordenarPartida
	;-----------------------------
	params
		string piParams : IN
		string poParams : OUT
		string $xCdErro$ : OUT
		string $xCtxErro$ : OUT
	endparams
	variables
		string vDsLstPartida
		numeric vNrOrdem, vNrAux
	endvariables

	vDsLstPartida = $item("DS_LSTPARTIDA", piParams)

	if (vDsLstPartida != "")
		if (!inValidarParametro("NR_ORDEM", piParams, "reordenarPartida"))
			return(-1)
		endif
		vNrOrdem = $item("NR_ORDEM", piParams)
		repeat
			creocc "CDF_PARTIDASVC", -1
			CD_EMPRESA.CDF_PARTIDASVC/init = $item("CD_EMPRESA", $itemnr(1, vDsLstPartida))
			NR_PARTIDA.CDF_PARTIDASVC/init = $item("NR_PARTIDA", $itemnr(1, vDsLstPartida))
			retrieve/o "CDF_PARTIDASVC"
			if ($status = -7)
				retrieve/x "CDF_PARTIDASVC"
			endif
			NR_ORDEM.CDF_PARTIDASVC = vNrOrdem
			CD_OPERADOR.CDF_PARTIDASVC = $item("CD_USUARIO", $$gParamGlb)
			DT_CADASTRO.CDF_PARTIDASVC = $datim

			clear/e "F_CDF_PARTIDASVC"
			CD_EMPRESA.F_CDF_PARTIDASVC/init = CD_EMPRESA.CDF_PARTIDASVC
			CD_MAQUINA.F_CDF_PARTIDASVC/init = CD_MAQUINA.CDF_PARTIDASVC
			NR_ORDEM.F_CDF_PARTIDASVC/init = "&uGT;&uEQ;%%vNrOrdem"
			retrieve/e "F_CDF_PARTIDASVC"
			if ($status &gt;= 0)
				setocc "F_CDF_PARTIDASVC", 1
				while ($status &gt;= 0)
					creocc "CDF_PARTIDASVC", -1
					CD_EMPRESA.CDF_PARTIDASVC = CD_EMPRESA.F_CDF_PARTIDASVC
					NR_PARTIDA.CDF_PARTIDASVC = NR_PARTIDA.F_CDF_PARTIDASVC
					retrieve/o "CDF_PARTIDASVC"
					if ($status = -7)
						retrieve/x "CDF_PARTIDASVC"
					endif
					if (TP_SITUACAO.CDF_PARTIDASVC = 1)
						vNrAux = NR_ORDEM.CDF_PARTIDASVC + 1
						$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG39696", "PARAMETRO=%%CD_EMPRESA.CDF_PARTIDASVC&uNOT;&uSEP;%%NR_PARTIDA.CDF_PARTIDASVC&uNOT;&uSEP;%%NR_ORDEM.CDF_PARTIDASVC&uNOT;&uSEP;%%vNrAux", "ADICIONAL=Operação-&gt;CDFSVCO038.reordenarPartida")
						return(-1)
					endif
					NR_ORDEM.CDF_PARTIDASVC += 1
					CD_OPERADOR.CDF_PARTIDASVC = $item("CD_USUARIO", $$gParamGlb)
					DT_CADASTRO.CDF_PARTIDASVC = $datim
					setocc "F_CDF_PARTIDASVC", $curocc("F_CDF_PARTIDASVC") + 1
				endwhile
			endif

			$collhandle("CDF_PARTIDASVC")-&gt;Salvar()
			if ($procerror)
				$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
				return(-1)
			elseif ($status &lt; 0)
				return(-1)
			endif

			clear/e "CDF_PARTIDASVC"
			vNrOrdem += 1

			delitem vDsLstPartida, 1
		until (vDsLstPartida = "")
	else
		if (!inValidarParametro("CD_EMPRESA&uSEP;CD_MAQUINA", piParams, "reordenarPartida"))
			return(-1)
		endif

		clear/e "CDF_PARTIDASVC"
		CD_EMPRESA.CDF_PARTIDASVC/init = $item("CD_EMPRESA", piParams)
		CD_MAQUINA.CDF_PARTIDASVC/init = $item("CD_MAQUINA", piParams)
		NR_ORDEM.CDF_PARTIDASVC/init = "&uNOT;&uEQ;"
		retrieve/e "CDF_PARTIDASVC"
		if ($status &gt;= 0)
			vNrOrdem = 1
			sort/e "CDF_PARTIDASVC", "NR_ORDEM.CDF_PARTIDASVC"
			setocc "CDF_PARTIDASVC", 1
			while ($status &gt;= 0)
				if (NR_ORDEM.CDF_PARTIDASVC &lt; vNrOrdem &amp; TP_SITUACAO.CDF_PARTIDASVC = 1)
					$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG39696", "PARAMETRO=%%CD_EMPRESA.CDF_PARTIDASVC&uNOT;&uSEP;%%NR_PARTIDA.CDF_PARTIDASVC&uNOT;&uSEP;%%NR_ORDEM.CDF_PARTIDASVC&uNOT;&uSEP;%%vNrOrdem", "ADICIONAL=Operação-&gt;CDFSVCO038.reordenarPartida")
					return(-1)
				endif
				NR_ORDEM.CDF_PARTIDASVC = vNrOrdem
				CD_OPERADOR.CDF_PARTIDASVC = $item("CD_USUARIO", $$gParamGlb)
				DT_CADASTRO.CDF_PARTIDASVC = $datim
				vNrOrdem += 1
				setocc "CDF_PARTIDASVC", $curocc("CDF_PARTIDASVC") + 1
			endwhile
			$collhandle("CDF_PARTIDASVC")-&gt;Salvar()
			if ($procerror)
				$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
				return(-1)
			elseif ($status &lt; 0)
				return(-1)
			endif
		endif
	endif

	return(0)
end ;reordenarPartida

;--------------------------------------
public operation verificarTipoQtPartida
;--------------------------------------
	params
		string piParams : IN
		string poParams : OUT
		string $xCdErro$ : OUT
		string $xCtxErro$ : OUT
	endparams
	variables
		numeric vQtPartida, vQtCapacidade
		string vDsLstItem
	endvariables

	if ($tpAlocacaoPartida$ = 0 | $item("NR_PARTIDA", piParams) != "")
		;- Alocação padrão e partida já existente.
		return(0)
	endif

	if (!inValidarParametro("CD_MAQUINA", piParams, "verificarTipoQtPartida"))
		return(-1)
	endif

	if (getMaqConfPar("TP_PARTIDA", $item("CD_MAQUINA", piParams)) = 2)
		;- Partida continua sem quantidade definida.
		return(0)
	endif

	if (getMaqConfPar("TP_DIVISAO", $item("CD_MAQUINA", piParams)) = 1)
		;- Máquina configurada para não dividir partida.
		return(0)
	endif

	if ($item("TP_ORIGEM", piParams) = 1 | $item("TP_ORIGEM", piParams) = 2)
		;- Item de O.P. ou Item de lote
		if (!inValidarParametro("CD_EMPOP&uSEP;NR_CICLO&uSEP;NR_OP&uSEP;CD_PRODUTO&uSEP;CD_PROCESSO&uSEP;QT_PARTIDA", piParams, "verificarTipoQtPartida"))
			return(-1)
		endif
		vQtPartida = converterQtProduto(piParams, $item("QT_PARTIDA", piParams), "MUL")
		if ($status &lt; 0)
			return(-1)
		endif
	elseif ($item("TP_ORIGEM", piParams) = 3)
		;- Agrupador
		if (!inValidarParametro("CD_EMPAGRUPADOR&uSEP;NR_AGRUPADOR&uSEP;CD_PROCESSO", piParams, "verificarTipoQtPartida"))
			return(-1)
		endif
		putitem/id piParams, "CD_EMPRESA", $item("CD_EMPAGRUPADOR", piParams) ;-&gt;HSGARCIA Proj 253/481 dvaind-2731 28/02/2019
		vQtPartida = getQtAlocarAgrupador(piParams, $item("CD_PROCESSO", piParams), $item("CD_MAQUINA", piParams), "", &lt;TRUE&gt;, "", vDsLstItem, "")
		if ($status &lt; 0)
			return(-1)
		endif
		putitem/id poParams, "DS_LSTITEM", vDsLstItem
	elseif ($item("TP_ORIGEM", piParams) = 5)
		;- Ordem de produção
		if (!inValidarParametro("CD_EMPOP&uSEP;NR_CICLO&uSEP;NR_OP&uSEP;CD_PROCESSO", piParams, "verificarTipoQtPartida"))
			return(-1)
		endif
		vQtPartida = getQtAlocarOp(piParams, $item("CD_PROCESSO", piParams), $item("CD_MAQUINA", piParams), &lt;TRUE&gt;, vDsLstItem)
		if ($status &lt; 0)
			return(-1)
		endif
		putitem/id poParams, "DS_LSTITEM", vDsLstItem
	endif

	vQtCapacidade = getCapacidadeMaquina($item("CD_MAQUINA", piParams), &lt;FALSE&gt;)
	if (vQtCapacidade &lt;= 0)
		$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG39691", "DESCRICAO=Máquina configurada para partida com quantidade e sem capacidade definida!", "ADICIONAL=Operação-&gt;CDFSVCO038.verificarTipoQtPartida")
		return(-1)
	endif
	if (vQtPartida &gt; vQtCapacidade)
		putitem/id poParams, "IN_QTACIMA", &lt;TRUE&gt;
		if ($tpAlocacaoPartida$ = 1)
			;- Aloca partidas com quantidades iguais sem perguntar
			putitem/id poParams, "TP_QTPARTIDA", 1
		else
			putitem/id poParams, "TP_QTPARTIDA", 2
		endif
		;--&gt; MNSANTOS - Prj 182/1084 - 25/10/2017
		if(getMaqConfPar("TP_DIVISAO", $item("CD_MAQUINA", piParams)) = 3)
			putitem/id poParams, "IN_QTTOTAL", &lt;TRUE&gt;
		endif
		;--&lt; MNSANTOS
	endif

	return(0)
end ;verificarTipoQtPartida

;-------------------------------------------
public operation calcularQtDisponivelPartida
;-------------------------------------------
	params
		string piParams : IN
		string poParams : OUT
		string $xCdErro$ : OUT
		string $xCtxErro$ : OUT
	endparams
	variables
		numeric vQtCapacidade, vQtAlocada, vQtDisponivel
		string vDsParams
	endvariables

	if($item("NR_PARTIDA", piParams) = "")
		return(0)
	endif

	if (!inValidarParametro("CD_MAQUINA", piParams, "calcularQtDisponivelPartida"))
		return(-1)
	endif

	if (getMaqConfPar("TP_PARTIDA", $item("CD_MAQUINA", piParams)) = 2)
		;- Partida continua sem quantidade definida
		putitem/id poParams, "QT_DISPONIVEL", 1
		return(0)
	endif

	vQtCapacidade = getCapacidadeMaquina($item("CD_MAQUINA", piParams), &lt;FALSE&gt;)

	vDsParams = ""
	putitem/id vDsParams, "CD_EMPRESA", $item("CD_EMPPARTIDA", piParams)
	putitem/id vDsParams, "NR_PARTIDA", $item("NR_PARTIDA", piParams)
	vQtDisponivel = vQtCapacidade - getQtAlocadaPartida(vDsParams, 2)
	if ($status &lt; 0)
		return(-1)
	endif

	putitem/id poParams, "QT_DISPONIVEL", vQtDisponivel

	return(0)
end ;calcularQtDisponivelPartida

;-----------------------------------
public operation realocarItemPartida
;-----------------------------------
	params
		string piParams : IN
		string poParams : OUT
		string $xCdErro$ : OUT
		string $xCtxErro$ : OUT
	endparams
	variables
		handle  vHdInstance
		string  viParams, voParams, vDsLstPartida, vDsPartida, vDsParams
		Numeric vNrOrdemOrigem, vNrOrdemDest, vNrSeq, vCdMaquina
	endvariables

	if (!inValidarParametro("CD_MAQORIGEM&uSEP;NR_ORDEMORIGEM", piParams, "calcularQtDisponivelPartida"))
		return(-1)
	endif
	if(getFieldData("TP_SITUACAO", "CDF_PARTIDASVC", "CD_EMPRESA=%%$item("CD_EMPORIGEM", piParams)&uSEP;NR_PARTIDA=%%$item("NR_PARTIDAORIGEM", piParams)") != 00)
		$instancehandle-&gt;setStatus(&lt;STS_ERRO&gt;, "MSG39752", "DESCRICAO=Partida não pode ser realocada pois não está com situação 'Aguardando'", "ADICIONAL=Operação-&gt;CDFSVCO038.realocarItemPartida")
		return(-1)
	endif
	if($item("NR_PARTIDADESTINO", piParams) != "")
		if(getFieldData("TP_SITUACAO", "CDF_PARTIDASVC", "CD_EMPRESA=%%$item("CD_EMPDESTINO", piParams)&uSEP;NR_PARTIDA=%%$item("NR_PARTIDADESTINO", piParams)") != 00)
			$instancehandle-&gt;setStatus(&lt;STS_ERRO&gt;, "MSG39752", "DESCRICAO=Partida não pode ser realocada pois não está com situação 'Aguardando'", "ADICIONAL=Operação-&gt;CDFSVCO038.realocarItemPartida")
			return(-1)
		endif
	endif

	newinstance "CDFSVCO038", vHdInstance
	if($item("TP_REALOCACAO", piParams) = 1);Realocar
		if($item("CD_MAQDESTINO", piParams) != $item("CD_MAQORIGEM", piParams));- Realocação entre maquinaS diferentes
			if(getMaqConfPar("TP_PARTIDA", $item("CD_MAQDESTINO", piParams)) != getMaqConfPar("TP_PARTIDA", $item("CD_MAQORIGEM", piParams)))
				$instancehandle-&gt;setStatus(&lt;STS_ERRO&gt;, "MSG39759", "DESCRICAO=Máquinas com tipo de partida diferentes!", "ADICIONAL=Operação-&gt;CDFSVCO038.realocarItemPartida")
				return(-1)
			endif
			if(getMaqConfPar("TP_ITEM", $item("CD_MAQDESTINO", piParams)) != getMaqConfPar("TP_ITEM", $item("CD_MAQORIGEM", piParams)))
				$instancehandle-&gt;setStatus(&lt;STS_ERRO&gt;, "MSG39766", "DESCRICAO=Configuração do tipo de item diferente entre as máquinas!", "ADICIONAL=Operação-&gt;CDFSVCO038.realocarItemPartida")
				return(-1)
			endif

			creocc "CDF_PARTIDASVC", -1
			CD_EMPRESA.CDF_PARTIDASVC/init = $item("CD_EMPORIGEM", piParams)
			NR_PARTIDA.CDF_PARTIDASVC/init = $item("NR_PARTIDAORIGEM", piParams)
			retrieve/o "CDF_PARTIDASVC"
			if($status = -7)
				retrieve/x "CDF_PARTIDASVC"
			elseif($status &lt;= 0)
				return(-1)
			endif
			NR_ORDEM.CDF_PARTIDASVC = ""
			CD_MAQUINA.CDF_PARTIDASVC = $item("CD_MAQDESTINO", piParams)

			if (!$empty("CDF_PARTIDAISVC"))
				setocc "CDF_PARTIDAISVC", 1
				while($status &gt;= 0)
					vDsParams = ""
					putlistitems/occ vDsParams, "CDF_PARTIDAISVC"
					putitem/id vDsParams, "CD_PROCESSO", CD_PROCESSO.CDF_PARTIDAPSVC
					putitem/id vDsParams, "CD_MAQUINA", CD_MAQUINA.CDF_PARTIDASVC
					if(!inValidarProcessoMaquinaPartida(vDsParams))
						return(-1)
					endif
					setocc "CDF_PARTIDAISVC", $curocc("CDF_PARTIDAISVC") + 1
				endwhile
			endif

			$collhandle("CDF_PARTIDASVC")-&gt;Salvar()
			if ($procerror)
				$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
				return(-1)
			elseif ($status &lt; 0)
				return(-1)
			endif

			putitem/id vDsPartida, "CD_EMPRESA", CD_EMPRESA.CDF_PARTIDASVC
			putitem/id vDsPartida, "NR_PARTIDA", NR_PARTIDA.CDF_PARTIDAISVC
			putitem vDsLstPartida, -1, vDsPartida

			viParams = ""
			putitem/id viParams, "DS_LSTPARTIDA", vDsLstPartida
			putitem/id viParams, "NR_ORDEM", $item("NR_ORDEMDESTINO", piParams)
			vHdInstance-&gt;reordenarPartida(viParams, voParams, $xCdErro$, $xCtxErro$)
			if ($procerror)
				$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
				return(-1)
			elseif ($status &lt; 0)
				return(-1)
			endif
			viParams = ""
			putitem/id viParams, "CD_EMPRESA", $item("CD_EMPORIGEM", piParams)
			putitem/id viParams, "CD_MAQUINA", $item("CD_MAQORIGEM", piParams)
			vHdInstance-&gt;reordenarPartida(viParams, voParams, $xCdErro$, $xCtxErro$)
			if ($procerror)
				$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
				return(-1)
			elseif ($status &lt; 0)
				return(-1)
			endif
		else
			clear/e "CDF_PARTIDASVC"
			CD_EMPRESA.CDF_PARTIDASVC/init = $item("CD_EMPORIGEM", piParams)
			CD_MAQUINA.CDF_PARTIDASVC/init = $item("CD_MAQORIGEM", piParams)
			NR_ORDEM.CDF_PARTIDASVC/init = "&uNOT;&uEQ;"
			retrieve/e "CDF_PARTIDASVC"
			if($status &gt;= 0)
				sort/e "CDF_PARTIDASVC", "NR_ORDEM.CDF_PARTIDASVC"
				vNrOrdemOrigem = $item("NR_ORDEMORIGEM", piParams) ;--&gt;ROS--&gt;220/1872--&gt;24/04/2017
				vNrOrdemDest   = $item("NR_ORDEMDESTINO", piParams);--&gt;ROS--&gt;220/1872--&gt;24/04/2017
				setocc "CDF_PARTIDASVC", vNrOrdemDest ;$item("NR_ORDEMDESTINO", piParams);--&gt;ROS--&gt;220/1872--&gt;24/04/2017--&gt;ALTARADO PARA A VARIAVEL
				if(vNrOrdemOrigem &gt; vNrOrdemDest);--&gt;ROS--&gt;220/1872--&gt;24/04/2017--&gt;ALTERADO PARA AS VARIAVEIS
					while($curocc(CDF_PARTIDASVC) &lt; vNrOrdemOrigem);--&gt;ROS--&gt;220/1872--&gt;24/04/2017--&gt;ALTARADO PARA A VARIAVEL
						NR_ORDEM.CDF_PARTIDASVC += 1
						setocc "CDF_PARTIDASVC", $curocc("CDF_PARTIDASVC") + 1
					endwhile
				elseif(vNrOrdemOrigem &lt; vNrOrdemDest);--&gt;ROS--&gt;220/1872--&gt;24/04/2017--&gt;ALTERADO PARA AS VARIAVEIS
					while($curocc("CDF_PARTIDASVC") &gt; vNrOrdemOrigem);--&gt;ROS--&gt;220/1872--&gt;24/04/2017--&gt;ALTARADO PARA A VARIAVEL
						NR_ORDEM.CDF_PARTIDASVC -= 1
						setocc "CDF_PARTIDASVC", $curocc("CDF_PARTIDASVC") - 1
					endwhile
				endif
				NR_ORDEM.CDF_PARTIDASVC = vNrOrdemDest ;$item("NR_ORDEMDESTINO", piParams) ;--&gt;ROS--&gt;220/1872--&gt;24/04/2017--&gt;ALTARADO PARA A VARIAVEL
				$collhandle("CDF_PARTIDASVC")-&gt;Salvar()
				if ($procerror)
					$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
					return(-1)
				elseif ($status &lt; 0)
					return(-1)
				endif
			endif
		endif

		vCdMaquina = $item("CD_MAQORIGEM", piParams)
		;-&gt;HSGARCIA Proj 217/610 09/08/2017
		if($tpIntAcabamentoTextil$ &gt; 0 &amp; getInfTecConf("", vCdMaquina, "", "", 4, 42) != "" &amp; $item("IN_ENVIAR_ORGATEX", piParams) != &lt;FALSE&gt;);-&gt;HSGARCIA Proj 217/664 03/11/17 - Proj 253/118 16/06/2018 --- ;-&gt;HSGARCIA Proj 253/378 DVAIND-1940 05/12/2018
			viParams = ""
			putitem/id viParams, "CD_EMPRESA", $item("CD_EMPORIGEM", piParams)
			putitem/id viParams, "NR_PARTIDA", $item("NR_PARTIDAORIGEM", piParams)
			activate "CDFSVCO039".atualizarAlocacao(viParams, voParams, $xCdErro$, $xCtxerro$)
			if ($procerror)
				$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
				return(-1)
			elseif ($status &lt; 0)
				$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $xCdErro$, $xCtxErro$, "")
				return(-1)
			endif
		endif
		;&lt;-

	elseif($item("TP_REALOCACAO", piParams) = 2);Substituir
		creocc "CDF_PARTIDASVC", -1
		CD_EMPRESA.CDF_PARTIDASVC/init = $item("CD_EMPORIGEM", piParams)
		NR_PARTIDA.CDF_PARTIDASVC/init = $item("NR_PARTIDAORIGEM", piParams)
		retrieve/o "CDF_PARTIDASVC"
		if($status = -7)
			retrieve/x "CDF_PARTIDASVC"
		elseif($status &lt;= 0)
			return(-1)
		endif
		NR_ORDEM.CDF_PARTIDASVC = $item("NR_ORDEMDESTINO", piParams)

		creocc "CDF_PARTIDASVC", -1
		CD_EMPRESA.CDF_PARTIDASVC/init = $item("CD_EMPDESTINO", piParams)
		NR_PARTIDA.CDF_PARTIDASVC/init = $item("NR_PARTIDADESTINO", piParams)
		retrieve/o "CDF_PARTIDASVC"
		if($status = -7)
			retrieve/x "CDF_PARTIDASVC"
		elseif($status &lt;= 0)
			return(-1)
		endif
		NR_ORDEM.CDF_PARTIDASVC = $item("NR_ORDEMORIGEM", piParams)

		$collhandle("CDF_PARTIDASVC")-&gt;Salvar()
		if ($procerror)
			$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status &lt; 0)
			return(-1)
		endif
	endif

	;--&gt; MNSANTOS - Prj 217/548 - 27/06/2017
	if($item("CD_MOTIVO", piParams) != "")
		selectdb max(NR_SEQUENCIA) from "CDF_PARTIDAREALOCSVC" u_where (CD_EMPRESA.CDF_PARTIDAREALOCSVC = $item("CD_EMPORIGEM", piParams) %\
			&amp; NR_PARTIDA.CDF_PARTIDAREALOCSVC = $item("NR_PARTIDAORIGEM", piParams)) to vNrSeq

		clear/e "CDF_PARTIDASVC"

		vNrSeq += 1
		creocc "CDF_PARTIDAREALOCSVC", -1
		CD_EMPRESA.CDF_PARTIDAREALOCSVC = $item("CD_EMPORIGEM", piParams)
		NR_PARTIDA.CDF_PARTIDAREALOCSVC = $item("NR_PARTIDAORIGEM", piParams)
		NR_SEQUENCIA.CDF_PARTIDAREALOCSVC = vNrSeq
		CD_OPERADOR.CDF_PARTIDAREALOCSVC = $item("CD_USUARIO", $$gParamGlb)
		DT_CADASTRO.CDF_PARTIDAREALOCSVC = $datim
		CD_MAQUINAORI.CDf_PARTIDAREALOCSVC = $item("CD_MAQORIGEM", piParams)
		NR_ORDEMORI.CDF_PARTIDAREALOCSVC = $item("NR_ORDEMORIGEM", piParams)
		CD_MAQUINADEST.CDf_PARTIDAREALOCSVC = $item("CD_MAQDESTINO", piParams)
		NR_ORDEMDEST.CDF_PARTIDAREALOCSVC = $item("NR_ORDEMDESTINO", piParams)
		CD_MOTIVO.CDF_PARTIDAREALOCSVC = $item("CD_MOTIVO", piParams)

		$collhandle("CDF_PARTIDAREALOCSVC")-&gt;Salvar()
		if ($procerror)
			$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status &lt; 0)
			return(-1)
		endif
	endif
	;--&lt; MNSANTOS

	return(0)
end ;realocarItemPartida

;----------------------------------
public operation removerItemPartida
	;-------------------------------
	params
		string piParams : IN
		string poParams : OUT
		string $xCdErro$ : OUT
		string $xCtxErro$ : OUT
	endparams
	variables
		string vDsRegistro, viParams, voParams
		handle vHdInstance
		numeric vCdMaquina
	endvariables

	if (!inValidarParametro("CD_EMPRESA&uSEP;NR_PARTIDA", piParams, "removerItemPartida"))
		return(-1)
	endif

	clear/e "CDF_PARTIDASVC"
	CD_EMPRESA.CDF_PARTIDASVC/init = $item("CD_EMPRESA", piParams)
	NR_PARTIDA.CDF_PARTIDASVC/init = $item("NR_PARTIDA", piParams)
	retrieve/e "CDF_PARTIDASVC"
	if ($status &gt;= 0)
		vCdMaquina = CD_MAQUINA.CDF_PARTIDASVC
		if (TP_SITUACAO.CDF_PARTIDASVC != 0)
			$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG39749", "DESCRICAO=Situação da partida não permite que o item seja removido!", "ADICIONAL=Operação-&gt;CDFSVCO038.removerItemPartida")
			return(-1)
		endif
		if (getFieldData("CD_EMPORI", "CDF_PARTIDARESVC", "CD_EMPDEST=%%CD_EMPRESA.CDF_PARTIDASVC&uSEP;NR_PARTIDADEST=%%NR_PARTIDA.CDF_PARTIDASVC&uSEP;TP_PARTIDAREL=1") != "")
			$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG39750", "DESCRICAO=Não é permitido remover item de partida de reprocesso!", "ADICIONAL=Operação-&gt;CDFSVCO038.removerItemPartida")
			return(-1)
		endif
	else
		return(0)
	endif

	if (!$empty("CDF_PARTIDAISVC"))
		if (!inValidarParametro("NR_SEQUENCIA", piParams, "removerItemPartida"))
			if ($item("IN_TOTAL", piParams) != &lt;TRUE&gt;)
				return(-1)
			endif
		endif

		clear/e "CDF_PARTIDAISVC"
		NR_SEQUENCIA.CDF_PARTIDAISVC/init = $item("NR_SEQUENCIA", piParams)
		retrieve/e "CDF_PARTIDAISVC"
		if ($status &gt;= 0)
			if (NR_AGRUPADOR.CDF_PARTIDAISVC != "" &amp; $item("IN_TOTAL", piParams) != &lt;TRUE&gt;)
				putlistitems/occ vDsRegistro, "CDF_PARTIDAISVC"
				clear/e "CDF_PARTIDAISVC"
				CD_EMPAGRUPADOR.CDF_PARTIDAISVC/init = $item("CD_EMPAGRUPADOR", vDsRegistro)
				NR_AGRUPADOR.CDF_PARTIDAISVC/init = $item("NR_AGRUPADOR", vDsRegistro)
				retrieve/e "CDF_PARTIDAISVC"
				if ($status &lt; 0)
					clear/e "CDF_PARTIDAISVC"
				endif
			endif
			if (!$empty("CDF_PARTIDAISVC"))
				$collhandle("CDF_PARTIDAISVC")-&gt;Excluir()
				if ($procerror)
					$instancehandle-&gt;setStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
					return(-1)
				elseif ($status &lt; 0)
					return(-1)
				endif
			endif

			clear/e "CDF_PARTIDAISVC"
			retrieve/e "CDF_PARTIDAISVC"
		endif
	endif

	if ($empty("CDF_PARTIDAISVC") &amp; $item("IN_TOTAL", piParams) != &lt;TRUE&gt;)
		;--&gt; MNSANTOS - Prj 217/330 - 16/08/2016
		if(!$empty("CDF_PARTIDAEMISSAOSVC"))
			$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG40418", "DESCRICAO=Partida não pode ser removida pois possui emissão ralacionada!", "ADICIONAL=Operação-&gt;CDFSVCO038.removerItemPartida")
			return(-1)
		endif
		;--&lt; MNSANTOS

		putlistitems/occ vDsRegistro, "CDF_PARTIDASVC"

		$collhandle("CDF_PARTIDAPSVC")-&gt;Excluir()
		if ($procerror)
			$instancehandle-&gt;setStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status &lt; 0)
			return(-1)
		endif
		$collhandle("CDF_PARTIDASVC")-&gt;Excluir()
		if ($procerror)
			$instancehandle-&gt;setStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status &lt; 0)
			return(-1)
		endif

		;-&gt;HSGARCIA Proj 217/610 09/08/2017
		if($tpIntAcabamentoTextil$ &gt; 0 &amp; getInfTecConf("", vCdMaquina, "", "", 4, 42) != "");-&gt;HSGARCIA Proj 217/664 03/11/17 -- ;-&gt;HSGARCIA Proj 253/378 DVAIND-1940 05/12/2018
			newinstance "CDFSVCO039", vHdInstance, "TRANSACTION=TRUE" ;-&gt;HSGARCIA Proj 253/449 DVAIND-2383 31/01/2019
			viParams = ""
			putitem/id viParams, "CD_EMPRESA", $item("CD_EMPRESA", piParams)
			putitem/id viParams, "NR_PARTIDA", $item("NR_PARTIDA", piParams)
			vHdInstance-&gt;cancelarPartida(viParams, voParams, $xCdErro$, $xCtxerro$)
			if ($procerror)
				$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
				return(-1)
			elseif ($status &lt; 0)
				$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $xCdErro$, $xCtxErro$, "")
				return(-1)
			endif
		endif
		;&lt;-
		vHdInstance = ""
		newinstance "CDFSVCO038", vHdInstance
		viParams = ""
		putitem/id viParams, "CD_EMPRESA", $item("CD_EMPRESA", vDsRegistro)
		putitem/id viParams, "CD_MAQUINA", $item("CD_MAQUINA", vDsRegistro)
		vHdInstance-&gt;reordenarPartida(viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)
			$instancehandle-&gt;setStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status &lt; 0)
			return(-1)
		endif
	else
		;--&gt; MNSANTOS - Prj 217/330 - 16/08/2016
		if(!$empty("CDF_PARTIDAEMISSAOSVC"))
			newinstance "CDFSVCO038", vHdInstance
			setocc "CDF_PARTIDAEMISSAOSVC", 1
			while($status &gt;= 0)
				viParams = ""
				putitem/id viParams, "CD_EMPRESA", CD_EMPEMISSAO.CDF_PARTIDAEMISSAOSVC
				putitem/id viParams, "NR_EMISSAO", NR_EMISSAO.CDF_PARTIDAEMISSAOSVC
				putitem/id viParams, "TP_SITUACAO", "06" ;Inativo
				vHdInstance-&gt;alterarSituacaoEmissao(viParams, voParams, $xCdErro$, $xCtxErro$)
				if ($procerror)
					$instancehandle-&gt;setStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
					return(-1)
				elseif ($status &lt; 0)
					return(-1)
				endif
				setocc "CDF_PARTIDAEMISSAOSVC", $curocc("CDF_PARTIDAEMISSAOSVC") + 1
			endwhile
		endif
		;--&lt; MNSANTOS
	endif

	if ($instance$)
		$instance$-&gt;limparTempoPartida($item("CD_EMPRESA", piParams), $item("NR_PARTIDA", piParams))
	endif

	return(0)
end ;removerItemPartida

;---------------------------
public operation lockMaquina
	;------------------------
	params
		numeric vCdMaquina : IN
		string $xCdErro$ : OUT
		string $xCtxErro$ : OUT
	endparams

	if (vCdMaquina != "")
		creocc "CDF_MAQSVC", 1
		CD_MAQUINA.CDF_MAQSVC = vCdMaquina
		retrieve/o "CDF_MAQSVC"
		if ($status = -7)
			retrieve/x "CDF_MAQSVC"
		endif
		CD_OPERADOR.CDF_MAQSVC = $item("CD_USUARIO", $$gParamGlb)
		if ($status = -11)
			$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG39760", "DESCRICAO=Maquina @@1@@ está sendo alocada em outra sessão!&uSEP;PARAMETRO=%%vCdMaquina","ADICIONAL=Operação-&gt;CDFSVCO038.lockMaquina")
			return(-11)
		endif
	endif

	return(0)
end ;lockMaquina

;-----------------------------
public operation unlockMaquina
	;--------------------------
	rollback
	exit(0)
end ;unlockMaquina

;---------------------------------
public operation gerarTempoPartida
	;------------------------------
	params
		string piParams : IN
		string poParams : OUT
		string $xCdErro$ : OUT
		string $xCtxErro$ : OUT
	endparams
	variables
		string vDsOperacao, viParams, voParams, vDsAux, vDsLstQtProduzida, vDsCondicao, vDsRegistro, vDsRegProgOri, vDsRegProgDest, vDsLstRegMov, vDsLstLote, vDsRegLocOp
		numeric vTpSituacao, vNrSeqTempo, vNrSeqFin, vCdNovoMotivo, vTpEmissaoMaq, vCdLocalMov, vNrOrdemMov, vQtItemLote, vQtMovimento
		boolean vInApontarQt, vInEncerrar, vInMovimentar
		datetime vDtFimAnterior
		handle vHandleInstance
	endvariables

	if (!inValidarParametro("CD_EMPRESA&uSEP;NR_PARTIDA&uSEP;DS_OPERACAO", piParams, "gerarTempoPartida"))
		return(-1)
	endif

	vDsOperacao = $item("DS_OPERACAO", piParams)
 	vDsLstRegMov = ""
	vInMovimentar = &lt;FALSE&gt;

	clear/e "CDF_PARTIDASVC"
	CD_EMPRESA.CDF_PARTIDASVC/init = $item("CD_EMPRESA", piParams)
	NR_PARTIDA.CDF_PARTIDASVC/init = $item("NR_PARTIDA", piParams)
	retrieve/e "CDF_PARTIDASVC"
	if ($status &lt; 0)
		return(0)
	endif

	sort/e "CDF_PARTIDAPTSVC", "NR_SEQTEMPO.CDF_PARTIDAPTSVC"
	setocc "CDF_PARTIDAPTSVC", -1

	vInEncerrar = $item("IN_ENCERRARPARTIDA", piParams)
	selectcase vDsOperacao
	case "INICIAR"
		if (!$empty("CDF_PARTIDAPTSVC"))
			$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG39763", "DESCRICAO=Operação '@@1@@' não permitida!&uSEP;PARAMETRO=%%vDsOperacao", "ADICIONAL=Operação-&gt;CDFSVCO038.gerarTempoPartida")
			return(-1)
		endif
		;IES Proj/tar 253/227 25/09/2018
		if (NR_ORDEM.CDF_PARTIDASVC = 0)
			$instancehandle-&gt;setStatus(&lt;STS_ERRO&gt;, "MSG43520", "DESCRICAO=Partida não está alocada!", "ADICIONAL=Operação-&gt;CDFSVCO038.gerarTempoPartida")
			return(-1)
		endif
		;IES
		if (!inVerificarOrdemAnterior(NR_ORDEM.CDF_PARTIDASVC, CD_MAQUINA.CDF_PARTIDASVC, &lt;TRUE&gt;, poParams))
			return(-1)
		endif
		if(!inVerificarTempoFechado(CD_EMPRESA.CDF_PARTIDASVC, NR_PARTIDA.CDF_PARTIDASVC, CD_MAQUINA.CDF_PARTIDASVC))
			return(-1)
		endif
		vTpSituacao = 1 ;Em andamento
		vTpEmissaoMaq = getMaqConfPar("TP_EMISSAO", CD_MAQUINA.CDF_PARTIDASVC)
		if(vTpEmissaoMaq = 1)
			if(getFieldData("CD_EMPPARTIDA", "CDF_PARTIDAEMISSAOSVC", "CD_EMPPARTIDA=%%CD_EMPRESA.CDF_PARTIDASVC&uSEP;NR_PARTIDA=%%NR_PARTIDA.CDF_PARTIDASVC&uSEP;TP_SITUACAO=1") = "")
				$instancehandle-&gt;setStatus(&lt;STS_ERRO&gt;, "MSG30687", "DESCRICAO=Ainda não foi realizado a emissão de receita, a partida não pode ser iniciada.", "ADICIONAL=Operação-&gt;CDFSVCO038.gerarTempoPartida")
				return(-1)
			endif
		elseif(vTpEmissaoMaq = 2)
			viParams = ""
			putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.CDF_PARTIDASVC
			putitem/id viParams, "NR_PARTIDA", NR_PARTIDA.CDF_PARTIDASVC
			newinstance "CDFSVCO038", vHandleInstance
			vHandleInstance-&gt;buscarReceitaPartida(viParams, voParams, $xCdErro$, $xCtxErro$)
			if ($procerror)
				$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
				return(-1)
			elseif ($status &lt; 0)
				return(-1)
			endif
			if($item("CD_RECEITA", voParams) != "")
				vDsCondicao = ""
				putitem/id vDsCondicao, "CD_EMPPARTIDA", CD_EMPRESA.CDF_PARTIDASVC
				putitem/id vDsCondicao, "NR_PARTIDA", NR_PARTIDA.CDF_PARTIDASVC
				putitem/id vDsCondicao, "TP_SITUACAO", 1
				putitem/id vDsCondicao, "TP_EMISSAO", "&uNOT;&uEQ;3" ;-&gt;HSGARCIA Proj 220/3852 DVAIND-2253 20/12/18
				if(getFieldData("CD_EMPPARTIDA", "CDF_PARTIDAEMISSAOSVC", vDsCondicao) = "")
					$instancehandle-&gt;setStatus(&lt;STS_ERRO&gt;, "MSG30687", "DESCRICAO=Ainda não foi realizado a emissão de receita, a partida não pode ser iniciada.", "ADICIONAL=Operação-&gt;CDFSVCO038.gerarTempoPartida")
					return(-1)
				endif
			endif
		;-&gt;HSGARCIA Proj 253/259 08/10/2018
		elseif(vTpEmissaoMaq = 7) ;Obrigatório para iniciar partida com processo com receita, validando baixa
			viParams = ""
			putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.CDF_PARTIDASVC
			putitem/id viParams, "NR_PARTIDA", NR_PARTIDA.CDF_PARTIDASVC
			newinstance "CDFSVCO038", vHandleInstance
			vHandleInstance-&gt;buscarReceitaPartida(viParams, voParams, $xCdErro$, $xCtxErro$)
			if ($procerror)
				$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
				return(-1)
			elseif ($status &lt; 0)
				return(-1)
			endif

			if($item("CD_RECEITA", voParams) != "")
				vDsCondicao = ""
				putitem/id vDsCondicao, "CD_EMPPARTIDA", CD_EMPRESA.CDF_PARTIDASVC
				putitem/id vDsCondicao, "NR_PARTIDA", NR_PARTIDA.CDF_PARTIDASVC
				putitem/id vDsCondicao, "TP_SITUACAO", 1
				putitem/id vDsCondicao, "TP_EMISSAO", "&uNOT;&uEQ;3" ;-&gt;HSGARCIA Proj 220/3852 DVAIND-2253 20/12/18
				$handleEntity$-&gt;consultar("CDF_PARTIDAEMISSAOSVC", vDsCondicao)
				if($status &gt;= 0)
					if(!inVerificarRetiradaEmissao())
						return(-1)
					endif
				else
					$instancehandle-&gt;setStatus(&lt;STS_ERRO&gt;, "MSG30687", "DESCRICAO=Ainda não foi realizado a emissão de receita, a partida não pode ser iniciada.", "ADICIONAL=Operação-&gt;CDFSVCO038.gerarTempoPartida")
					return(-1)
				endif
			endif
		;&lt;--HSGARCIA
		endif
	case "PARAR"
		if (DT_FIM.CDF_PARTIDAPTSVC != "")
			$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG39763", "DESCRICAO=Operação '@@1@@' não permitida!&uSEP;PARAMETRO=%%vDsOperacao", "ADICIONAL=Operação-&gt;CDFSVCO038.gerarTempoPartida")
			return(-1)
		endif
	case "INTERROMPER"
		if (!inValidarParametro("CD_MOTIVO", piParams, "gerarTempoPartida"))
			return(-1)
		endif
	case "ENCERRAR"
		if (!inVerificarOrdemAnterior(NR_ORDEM.CDF_PARTIDASVC, CD_MAQUINA.CDF_PARTIDASVC, &lt;FALSE&gt;, poParams))
			return(-1)
		endif
		vInApontarQt = getMaqConfPar("IN_QTPRODUZIDAFIN", CD_MAQUINA.CDF_PARTIDASVC)
		if (vInApontarQt &amp; $item("DS_LSTQTPRODUZIDA", piParams) = "" &amp; !$empty("CDF_PARTIDAISVC"));--&gt; MNSANTOS - Prj 217/240 - 10/05/2016
			$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG39764", "DESCRICAO=Configuração da máquina obriga apontar quantidade produzida e essa não foi informada!", "ADICIONAL=Operação-&gt;CDFSVCO038.gerarTempoPartida")
			return(-1)
		endif
		if(!vInEncerrar &amp; !vInApontarQt)
			$instancehandle-&gt;setStatus(&lt;STS_ERRO&gt;, "MSG39824", "DESCRICAO=Máquina deve estar configurada para apontar quantidade produzida!", "ADICIONAL=Operação-&gt;CDFSVCO038.gerarTempoPartida")
			return(-1)
		endif

		;--&gt; MNSANTOS - Prj 217/623 - 11/09/2017
		vTpEmissaoMaq = getMaqConfPar("TP_EMISSAO", CD_MAQUINA.CDF_PARTIDASVC)
		if(vTpEmissaoMaq = 5)
			vDsCondicao = ""
			putitem/id vDsCondicao, "CD_EMPPARTIDA", CD_EMPRESA.CDF_PARTIDASVC
			putitem/id vDsCondicao, "NR_PARTIDA", NR_PARTIDA.CDF_PARTIDASVC
			putitem/id vDsCondicao, "TP_SITUACAO", 1
			$handleEntity$-&gt;consultar("CDF_PARTIDAEMISSAOSVC", vDsCondicao)
			if($status &lt; 0)
				$instancehandle-&gt;setStatus(&lt;STS_ERRO&gt;, "MSG42016", "DESCRICAO=Partida sem emissão, a partida não pode ser encerrada!", "ADICIONAL=Operação-&gt;CDFSVCO038.gerarTempoPartida")
				return(-1)
			endif
		endif
		if(vTpEmissaoMaq = 6)
			viParams = ""
			putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.CDF_PARTIDASVC
			putitem/id viParams, "NR_PARTIDA", NR_PARTIDA.CDF_PARTIDASVC
			newinstance "CDFSVCO038", vHandleInstance
			vHandleInstance-&gt;buscarReceitaPartida(viParams, voParams, $xCdErro$, $xCtxErro$)
			if ($procerror)
				$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
				return(-1)
			elseif ($status &lt; 0)
				return(-1)
			endif
			if($item("CD_RECEITA", voParams) != "")
				vDsCondicao = ""
				putitem/id vDsCondicao, "CD_EMPPARTIDA", CD_EMPRESA.CDF_PARTIDASVC
				putitem/id vDsCondicao, "NR_PARTIDA", NR_PARTIDA.CDF_PARTIDASVC
				putitem/id vDsCondicao, "TP_SITUACAO", 1
				$handleEntity$-&gt;consultar("CDF_PARTIDAEMISSAOSVC", vDsCondicao)
				if($status &lt; 0)
					$instancehandle-&gt;setStatus(&lt;STS_ERRO&gt;, "MSG42016", "DESCRICAO=Partida sem emissão, a partida não pode ser encerrada!", "ADICIONAL=Operação-&gt;CDFSVCO038.gerarTempoPartida")
					return(-1)
				endif
			endif
		endif
		;--&lt; MNSANTOS

		vTpSituacao = 4 ;Encerrada
		vDsLstQtProduzida = $item("DS_LSTQTPRODUZIDA", piParams)

		;&lt;-- LOMoreira/DSantos Prj-&gt;217-545 22/06/2017 --&gt;
		vCdLocalMov = getMaqConfPar("CD_LOCALMOV", CD_MAQUINA.CDF_PARTIDASVC)
		if (vCdLocalMov != "" &amp; !$empty("CDF_PARTIDAISVC"))
			vInMovimentar = &lt;TRUE&gt;
 			sort/e "CDF_PARTIDAISVC", "CD_EMPOP.CDF_PARTIDAISVC, NR_CICLO.CDF_PARTIDAISVC, NR_OP.CDF_PARTIDAISVC, CD_PRODUTO.CDF_PARTIDAISVC, NR_LOTE.CDF_PARTIDAISVC, NR_ITEM.CDF_PARTIDAISVC"
			setocc "CDF_PARTIDAISVC", 1
			while ($status &gt;= 0)
				if (vInMovimentar)
					if (NR_LOTE.CDF_PARTIDAISVC != "" &amp; NR_ITEM.CDF_PARTIDAISVC != "")
						vDsAux = ""
						putitem/id vDsAux, "NR_LOTE", NR_LOTE.CDF_PARTIDAISVC
						putitem/id vDsAux, "NR_ITEM", NR_ITEM.CDF_PARTIDAISVC
						putitem/id vDsAux, "QT_LOTE", QT_PARTIDA.CDF_PARTIDAISVC
						vQtItemLote += QT_REFERENCIA.CDF_PARTIDAISVC
						putitem vDsLstLote, -1, vDsAux
					else
						vDsLstLote = getLstLoteItemOp(CD_EMPOP.CDF_PARTIDAISVC, NR_CICLO.CDF_PARTIDAISVC, NR_OP.CDF_PARTIDAISVC, CD_PRODUTO.CDF_PARTIDAISVC, vDsLstLote, vQtItemLote)
					endif
					vQtMovimento += QT_REFERENCIA.CDF_PARTIDAISVC

					if (inOpiPartidaDiferente())
						if (vQtMovimento = 0 | (vQtItemLote &gt; 0 &amp; vQtMovimento != vQtItemLote))
							vInMovimentar = &lt;FALSE&gt;
						else
							vDsCondicao = ""
							putitem/id vDsCondicao, "CD_EMPRESA", CD_EMPOP.CDF_PARTIDAISVC
							putitem/id vDsCondicao, "NR_CICLO", NR_CICLO.CDF_PARTIDAISVC
							putitem/id vDsCondicao, "NR_OP", NR_OP.CDF_PARTIDAISVC
							putitem/id vDsCondicao, "CD_SEQGRUPO", getFieldData("CD_SEQGRUPO", "V_PRD_PRDSSVC", "CD_PRODUTO=%%CD_PRODUTO.CDF_PARTIDAISVC")
							putitem/id vDsCondicao, "CD_LOCAL", vCdLocalMov
							$handleConsulta$-&gt;consultar("CDF_PROPSVC", vDsCondicao)
							if ($status &gt;= 0)
								$handleConsulta$-&gt;getRegistro(vDsRegProgOri)
								delitem/id vDsCondicao, "CD_LOCAL"
								vNrOrdemMov = $item("NR_ORDEM", vDsRegProgOri) + 1
								putitem/id vDsCondicao, "NR_ORDEM", vNrOrdemMov
	 							$handleConsulta$-&gt;consultar("CDF_PROPSVC", vDsCondicao)
								if ($status &gt;= 0)
									$handleConsulta$-&gt;getRegistro(vDsRegProgDest)
									delitem/id vDsCondicao, "NR_SEQPROG"
									delitem/id vDsCondicao, "CD_SEQGRUPO"
									putitem/id vDsCondicao, "CD_PRODUTO", CD_PRODUTO.CDF_PARTIDAISVC
									putitem/id vDsCondicao, "CD_LOCAL", $item("CD_LOCAL", vDsRegProgOri)
									$handleEntity$-&gt;consultar("V_CDF_LOCOPLOSVC", vDsCondicao)
									if ($status &gt;= 0)
										$handleEntity$-&gt;getRegistro(vDsRegLocOp)
										if (vQtItemLote &gt; 0)
											if (vQtItemLote &gt; $item("QT_LOTE", vDsRegLocOp))
												vInMovimentar = &lt;FALSE&gt;
											endif
										else
											if (vQtMovimento &gt; $item("QT_SEMLOTE", vDsRegLocOp))
												vInMovimentar = &lt;FALSE&gt;
											endif
										endif
										if (vInMovimentar)
											vDsAux = ""
											putitem/id vDsAux, "CD_EMPRESA", CD_EMPOP.CDF_PARTIDAISVC
											putitem/id vDsAux, "NR_CICLO", NR_CICLO.CDF_PARTIDAISVC
											putitem/id vDsAux, "NR_OP", NR_OP.CDF_PARTIDAISVC
											putitem/id vDsAux, "CD_PRODUTO", CD_PRODUTO.CDF_PARTIDAISVC
											putitem/id vDsAux, "QT_PRODUTO", vQtMovimento
											putitem/id vDsAux, "CD_SEQGRUPO", $item("CD_SEQGRUPO", vDsRegProgOri)
											putitem/id vDsAux, "CD_LOCALORIGEM", $item("CD_LOCAL", vDsRegProgOri)
											putitem/id vDsAux, "NR_SEQPROGORIGEM", $item("NR_SEQPROG", vDsRegProgOri)
											putitem/id vDsAux, "NR_ORDEMORIGEM", $item("NR_ORDEM", vDsRegProgOri)
											putitem/id vDsAux, "CD_LOCALDESTINO", $item("CD_LOCAL", vDsRegProgDest)
											putitem/id vDsAux, "NR_SEQPROGDESTINO", $item("NR_SEQPROG", vDsRegProgDest)
											putitem/id vDsAux, "NR_ORDEMDESTINO", $item("NR_ORDEM", vDsRegProgDest)
											putitem/id vDsAux, "DS_LSTLOTE", vDsLstLote
											putitem vDsLstRegMov, -1, vDsAux
										endif
									endif
								endif
							endif
							vDsLstLote = ""
							vQtItemLote = 0
							vQtMovimento = 0
						endif
					endif
				endif
				setocc "CDF_PARTIDAISVC", $curocc("CDF_PARTIDAISVC") + 1
			endwhile
		endif
		;&lt;-- LOMoreira/DSantos Prj-&gt;217-545 --&gt;
		;--&gt; MNSANTOS - Prj 217/714 - 26/01/2018
		$instancehandle-&gt;baixarMpEmissaoAut(CD_EMPRESA.CDF_PARTIDASVC, NR_PARTIDA.CDF_PARTIDASVC, $item("DS_LSTPRD", piParams))
		if ($procerror)
			$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status &lt; 0)
			return(-1)
		endif
		;--&lt;MNSANTOS
	case "REINICIAR"
		if (TP_TEMPO.CDF_PARTIDAPTSVC = 1 &amp; DT_FIM.CDF_PARTIDAPTSVC = "")
			$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG39763", "DESCRICAO=Operação '@@1@@' não permitida!&uSEP;PARAMETRO=%%vDsOperacao", "ADICIONAL=Operação-&gt;CDFSVCO038.gerarTempoPartida")
			return(-1)
		endif
		if(!inVerificarTempoFechado(CD_EMPRESA.CDF_PARTIDASVC, NR_PARTIDA.CDF_PARTIDASVC, CD_MAQUINA.CDF_PARTIDASVC))
			return(-1)
		endif
		vCdNovoMotivo = $item("CD_NOVOMOTIVO", piParams)
	endselectcase

	;-- Fechar tempo do ultimo registro
	if(DT_FIM.CDF_PARTIDAPTSVC = "" &amp; !$empty("CDF_PARTIDAPTSVC"))
		; Quando for "Tempo manual", não pega a data do servidor
		if($item("DS_DATAHORA", piParams) = "")
			DT_FIM.CDF_PARTIDAPTSVC = $datim
			IN_MANUAL.CDF_PARTIDAPTSVC = &lt;FALSE&gt;
		else
			DT_FIM.CDF_PARTIDAPTSVC = $item("DS_DATAHORA", piParams)
			IN_MANUAL.CDF_PARTIDAPTSVC = &lt;TRUE&gt;
		endif
		CD_OPERFIM.CDF_PARTIDAPTSVC = $item("CD_USUARIO", $$gParamGlb)
		DT_OPERFIM.CDF_PARTIDAPTSVC = $datim

		if (DT_FIM.CDF_PARTIDAPTSVC &lt; DT_INICIO.CDF_PARTIDAPTSVC)
			$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG2671", "DESCRICAO=Data fim menor que data início!", "ADICIONAL=Operação-&gt;CDFSVCO033.gravaItemTempoPartida")
			return(-1)
		endif
		CD_OPERADOR.CDF_PARTIDAPTSVC = $item("CD_USUARIO", $$gParamGlb)
		DT_CADASTRO.CDF_PARTIDAPTSVC = $datim
	endif

	if(vCdNovoMotivo != "")
		CD_MOTIVO.CDF_PARTIDAPTSVC = vCdNovoMotivo
	endif

	;-- Criar novo registro
	if((vDsOperacao != "ENCERRAR" &amp; vDsOperacao != "PARAR") | (vDsOperacao = "ENCERRAR" &amp; !vInEncerrar))
		if(!vInEncerrar &amp; vDsOperacao = "ENCERRAR")
			call apontarQtProduzida(vDsLstQtProduzida)
			if($status &lt; 0)
				return(-1)
			endif
		endif
		vDtFimAnterior = DT_FIM.CDF_PARTIDAPTSVC
		vNrSeqTempo = NR_SEQTEMPO.CDF_PARTIDAPTSVC
		creocc "CDF_PARTIDAPTSVC", -1
		NR_SEQTEMPO.CDF_PARTIDAPTSVC = vNrSeqTempo + 1
		retrieve/o "CDF_PARTIDAPTSVC"
		if($status != 0)
			discard "CDF_PARTIDAPTSVC"
			return (-1)
		endif
		if (vDsOperacao = "INTERROMPER")
			TP_TEMPO.CDF_PARTIDAPTSVC = 2
			CD_MOTIVO.CDF_PARTIDAPTSVC = $item("CD_MOTIVO", piParams)
		else
			TP_TEMPO.CDF_PARTIDAPTSVC = 1
		endif
		IN_ESTORNO.CDF_PARTIDAPTSVC = &lt;FALSE&gt;
		if($item("DS_DATAHORA", piParams) = "")
			DT_INICIO.CDF_PARTIDAPTSVC = $datim
		else
			DT_INICIO.CDF_PARTIDAPTSVC = $item("DS_DATAHORA", piParams)
		endif
		CD_OPERINICIO.CDF_PARTIDAPTSVC = $item("CD_USUARIO", $$gParamGlb)
		DT_OPERINICIO.CDF_PARTIDAPTSVC = $datim
		CD_OPERADOR.CDF_PARTIDAPTSVC = $item("CD_USUARIO", $$gParamGlb)
		DT_CADASTRO.CDF_PARTIDAPTSVC = $datim

		if (DT_INICIO.CDF_PARTIDAPTSVC &lt; vDtFimAnterior)
			$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG2672", "DESCRICAO=Data início menor que a data fim do item anterior!", "ADICIONAL=Operação-&gt;CDFSVCO033.gravaItemTempoPartida")
			return(-1)
		endif
		if(!vInEncerrar &amp; vDsOperacao = "ENCERRAR")
			$collhandle("CDF_PARTIDASVC")-&gt;Salvar()
			if ($procerror)
				$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
				return(-1)
			elseif ($status &lt; 0)
				return(-1)
			endif
			return(0)
		endif
	endif

	if(vTpSituacao != "")
		TP_SITUACAO.CDF_PARTIDAPSVC = vTpSituacao
		TP_SITUACAO.CDF_PARTIDASVC = vTpSituacao

		if(TP_SITUACAO.CDF_PARTIDASVC = 1)
			if(!$empty("CDF_PARTIDAISVC"))
				setocc "CDF_PARTIDAISVC", 1
				while ($status &gt;= 0)
					IN_ENCERRADO.CDF_PARTIDAISVC/init = &lt;FALSE&gt;
					setocc "CDF_PARTIDAISVC", $curocc ("CDF_PARTIDAISVC") + 1
				endwhile
			endif
		endif
	endif

	if (vDsOperacao = "INICIAR" &amp; !$empty("CDF_PARTIDAISVC"))
		;&lt;-- LOMoreira/DSantos Prj-&gt;217-545 22/06/2017 --&gt;
		vCdLocalMov = getMaqConfPar("CD_LOCALMOV", CD_MAQUINA.CDF_PARTIDASVC)
		if (vCdLocalMov != "")
			vInMovimentar = &lt;TRUE&gt;
		else
			vInMovimentar = &lt;FALSE&gt;
		endif
		;&lt;-- LOMoreira/DSantos Prj-&gt;217-545 --&gt;

		;-- Quando for iniciar uma partida deverá realizar movimento inicial para
		; as ordens que estiverem aguardando liberação.
 		sort/e "CDF_PARTIDAISVC", "CD_EMPOP.CDF_PARTIDAISVC, NR_CICLO.CDF_PARTIDAISVC, NR_OP.CDF_PARTIDAISVC, CD_PRODUTO.CDF_PARTIDAISVC, NR_LOTE.CDF_PARTIDAISVC, NR_ITEM.CDF_PARTIDAISVC"
		setocc "CDF_PARTIDAISVC", 1
		while ($status &gt;= 0)
			if (inOpDiferente("CDF_PARTIDAISVC"))
				vDsAux = ""
				putitem/id vDsAux, "CD_EMPRESA", CD_EMPOP.CDF_PARTIDAISVC
				putitem/id vDsAux, "NR_CICLO", NR_CICLO.CDF_PARTIDAISVC
				putitem/id vDsAux, "NR_OP", "&uEQ;%%NR_OP.CDF_PARTIDAISVC"
				putitem/id vDsAux, "TP_SITUACAO", 10
				if (getFieldData("NR_OP", "PCP_OPCSVC", vDsAux) != "")
					putitem/id vDsAux, "NR_OP", NR_OP.CDF_PARTIDAISVC
					activate "PCPSVCO030".geraMovimentoInicialOp($$gParamGlb, vDsAux, voParams, $xCdErro$, $xCtxerro$)
					if ($procerror)
						$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
						return(-1)
					elseif ($status &lt; 0)
						return(-1)
					endif
					vInMovimentar = &lt;FALSE&gt;
				endif
			endif

			;&lt;-- LOMoreira/DSantos Prj-&gt;217-545 22/06/2017 --&gt;
			if (vInMovimentar)
				if (NR_LOTE.CDF_PARTIDAISVC != "" &amp; NR_ITEM.CDF_PARTIDAISVC != "")
					vDsAux = ""
					putitem/id vDsAux, "NR_LOTE", NR_LOTE.CDF_PARTIDAISVC
					putitem/id vDsAux, "NR_ITEM", NR_ITEM.CDF_PARTIDAISVC
					putitem/id vDsAux, "QT_LOTE", QT_PARTIDA.CDF_PARTIDAISVC
					vQtItemLote += QT_REFERENCIA.CDF_PARTIDAISVC
					putitem vDsLstLote, -1, vDsAux
				else
					vDsLstLote = getLstLoteItemOp(CD_EMPOP.CDF_PARTIDAISVC, NR_CICLO.CDF_PARTIDAISVC, NR_OP.CDF_PARTIDAISVC, CD_PRODUTO.CDF_PARTIDAISVC, vDsLstLote, vQtItemLote)
				endif
				vQtMovimento += QT_REFERENCIA.CDF_PARTIDAISVC

				if (inOpiPartidaDiferente())
					if (vQtMovimento = 0 | (vQtItemLote &gt; 0 &amp; vQtMovimento != vQtItemLote))
						vInMovimentar = &lt;FALSE&gt;
					else
						vDsCondicao = ""
						putitem/id vDsCondicao, "CD_EMPRESA", CD_EMPOP.CDF_PARTIDAISVC
						putitem/id vDsCondicao, "NR_CICLO", NR_CICLO.CDF_PARTIDAISVC
						putitem/id vDsCondicao, "NR_OP", NR_OP.CDF_PARTIDAISVC
						putitem/id vDsCondicao, "CD_SEQGRUPO", getFieldData("CD_SEQGRUPO", "V_PRD_PRDSSVC", "CD_PRODUTO=%%CD_PRODUTO.CDF_PARTIDAISVC")
						putitem/id vDsCondicao, "CD_LOCAL", vCdLocalMov
						$handleConsulta$-&gt;consultar("CDF_PROPSVC", vDsCondicao)
						if ($status &gt;= 0)
							$handleConsulta$-&gt;getRegistro(vDsRegProgDest)
							delitem/id vDsCondicao, "CD_LOCAL"
							vNrOrdemMov = $item("NR_ORDEM", vDsRegProgDest) - 1
							putitem/id vDsCondicao, "NR_ORDEM", vNrOrdemMov
	 						$handleConsulta$-&gt;consultar("CDF_PROPSVC", vDsCondicao)
							if ($status &gt;= 0)
								$handleConsulta$-&gt;getRegistro(vDsRegProgOri)
								delitem/id vDsCondicao, "NR_SEQPROG"
								delitem/id vDsCondicao, "CD_SEQGRUPO"
								putitem/id vDsCondicao, "CD_PRODUTO", CD_PRODUTO.CDF_PARTIDAISVC
								putitem/id vDsCondicao, "CD_LOCAL", $item("CD_LOCAL", vDsRegProgOri)
								$handleEntity$-&gt;consultar("V_CDF_LOCOPLOSVC", vDsCondicao)
								if ($status &gt;= 0)
									$handleEntity$-&gt;getRegistro(vDsRegLocOp)
									if (vQtItemLote &gt; 0)
										if (vQtItemLote &gt; $item("QT_LOTE", vDsRegLocOp))
											vInMovimentar = &lt;FALSE&gt;
										endif
									else
										if (vQtMovimento &gt; $item("QT_SEMLOTE", vDsRegLocOp))
											vInMovimentar = &lt;FALSE&gt;
										endif
									endif
									if (vInMovimentar)
										vDsAux = ""
										putitem/id vDsAux, "CD_EMPRESA", CD_EMPOP.CDF_PARTIDAISVC
										putitem/id vDsAux, "NR_CICLO", NR_CICLO.CDF_PARTIDAISVC
										putitem/id vDsAux, "NR_OP", NR_OP.CDF_PARTIDAISVC
										putitem/id vDsAux, "CD_PRODUTO", CD_PRODUTO.CDF_PARTIDAISVC
										putitem/id vDsAux, "QT_PRODUTO", vQtMovimento
										putitem/id vDsAux, "CD_SEQGRUPO", $item("CD_SEQGRUPO", vDsRegProgOri)
										putitem/id vDsAux, "CD_LOCALORIGEM", $item("CD_LOCAL", vDsRegProgOri)
										putitem/id vDsAux, "NR_SEQPROGORIGEM", $item("NR_SEQPROG", vDsRegProgOri)
										putitem/id vDsAux, "NR_ORDEMORIGEM", $item("NR_ORDEM", vDsRegProgOri)
										putitem/id vDsAux, "CD_LOCALDESTINO", $item("CD_LOCAL", vDsRegProgDest)
										putitem/id vDsAux, "NR_SEQPROGDESTINO", $item("NR_SEQPROG", vDsRegProgDest)
										putitem/id vDsAux, "NR_ORDEMDESTINO", $item("NR_ORDEM", vDsRegProgDest)
										putitem/id vDsAux, "DS_LSTLOTE", vDsLstLote
										putitem vDsLstRegMov, -1, vDsAux
									endif
								endif
							endif
							putitem/id vDsCondicao, "NR_SEQPROG"
						endif
						vDsLstLote = ""
						vQtItemLote = 0
						vQtMovimento = 0
					endif
				endif
			endif
			;&lt;-- LOMoreira/DSantos Prj-&gt;217-545 --&gt;
			setocc "CDF_PARTIDAISVC", $curocc("CDF_PARTIDAISVC") + 1
		endwhile
	endif

	$collhandle("CDF_PARTIDASVC")-&gt;Salvar()
	if ($procerror)
		$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status &lt; 0)
		return(-1)
	endif

	call apontarQtProduzida(vDsLstQtProduzida)
	if($status &lt; 0)
		return(-1)
	endif

	if(TP_SITUACAO.CDF_PARTIDASVC &gt; 1)
		vTpEmissaoMaq = getMaqConfPar("TP_EMISSAO", CD_MAQUINA.CDF_PARTIDASVC)
		vDsCondicao = "CD_EMPPARTIDA=%%CD_EMPRESA.CDF_PARTIDASVC&uSEP;NR_PARTIDA=%%NR_PARTIDA.CDF_PARTIDASVC&uSEP;TP_EMISSAO="
		if((vTpEmissaoMaq = 3 &amp; getFieldData("NR_EMISSAO", "CDF_PARTIDAEMISSAOSVC", "%%vDsCondicao%%%1") = "") | (vTpEmissaoMaq = 4 &amp; getFieldData("NR_EMISSAO", "CDF_PARTIDAEMISSAOSVC", "%%vDsCondicao%%%3") = ""))
			if (!$empty("CDF_PARTIDAISVC"))
				vDsAux = ""
				putitem/id vDsAux, "CD_EMPRESA", CD_EMPRESA.CDF_PARTIDASVC
				putitem/id vDsAux, "NR_PARTIDA", NR_PARTIDA.CDF_PARTIDASVC
				newinstance "CDFSVCO038", vHandleInstance
				vHandleInstance-&gt;buscarReceitaPartida(vDsAux,voParams,$xCdErro$,$xCtxErro$)
				if ($procerror)
					$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
					return(-1)
				elseif ($status &lt; 0)
					return(-1)
				endif
				if($item("CD_RECEITA", voParams) != "")
					vDsAux = ""
					putitem/id vDsAux, "CD_RECEITA", $item("CD_RECEITA", voParams)
					;--&gt; MNSANTOS - Prj 217/436 - 17/02/2017
					activate "PCPSVCO043".validarReceita(vDsAux, voParams, $xCdErro$, $xCtxerro$)
					if ($procerror)
						$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
						return(-1)
					elseif ($status &lt; 0)
							return(-1)
					endif
					if($item("DS_ERRO", voParams) != "")
						poParams = voParams
						return(-1)
					endif

					viParams = ""
					if(vTpEmissaoMaq = 4)
						putitem/id viParams, "TP_VINCULO", 3
					else
						putitem/id viParams, "TP_VINCULO", 1
					endif
					putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.CDF_PARTIDASVC
					putitem/id viParams, "NR_PARTIDA", NR_PARTIDA.CDF_PARTIDASVC
					putitem/id viParams, "IN_GERAR_EMISSAO", &lt;TRUE&gt;
					putitem/id viParams, "IN_DESCONSIDERARLASTRO", $item("IN_DESCONSIDERARLASTRO", piParams)
					newinstance "CDFSVCO038", vHandleInstance
					vHandleInstance-&gt;gerarEmissaoPartida(viParams,voParams,$xCdErro$,$xCtxErro$)
					if ($procerror)
						$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
						return(-1)
					elseif ($status &lt; 0)
						return(-1)
					endif

					if(vTpEmissaoMaq = 3 &amp; voParams != "")
						putitem/id poParams, "IN_EMISSAOAUTOMATICA", &lt;TRUE&gt;
						putitem/id poParams, "CD_EMPEMISSAO", $item("CD_EMPRESA", voParams)
						putitem/id poParams, "NR_EMISSAO", $item("NR_EMISSAO", voParams)
					endif
				endif
			endif
		endif

		NR_ORDEM.CDF_PARTIDASVC = ""
		CD_OPERADOR.CDF_PARTIDASVC = $item("CD_USUARIO", $$gParamGlb)
		DT_CADASTRO.CDF_PARTIDASVC = $datim

		;IAS - PRJ/TAR - 253/0028 - 23/04/2018
		;-&gt;HSGARCIA Proj 253/31 25/04/2018
		PR_EFICIENCIA.CDF_PARTIDASVC = prCalcularEficienciaPartida(CD_EMPRESA.CDF_PARTIDASVC, NR_PARTIDA.CDF_PARTIDASVC, CD_MAQUINA.CDF_PARTIDASVC)

		viParams = ""
		putitem/id viParams,"CD_EMPRESA", CD_EMPRESA.CDF_PARTIDASVC
		putitem/id viParams,"NR_PARTIDA", NR_PARTIDA.CDF_PARTIDASVC
		$instancehandle-&gt;gravarTempoPartida(viParams, "", $xCdErro$, $xCtxerro$)
		if ($procerror)
			$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status &lt; 0)
			return(-1)
		endif
		;&lt;--

		$collhandle("CDF_PARTIDASVC")-&gt;Salvar()
		if ($procerror)
			$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status &lt; 0)
			return(-1)
		endif

		viParams = ""
		putitem/id viParams, "CD_EMPRESA", $item("CD_EMPRESA", piParams)
		putitem/id viParams, "CD_MAQUINA", $item("CD_MAQUINA", piParams)
		$instancehandle-&gt;reordenarPartida(viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)
			$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status &lt; 0)
			return(-1)
		endif
	endif

	;-&gt;HSGARCIA Proj 217/610 10/08/2017
	if($tpIntAcabamentoTextil$ &gt; 0 &amp; getInfTecConf("", $item("CD_MAQUINA", piParams), "", "", 4, 42) != "");-&gt;HSGARCIA Proj 217/664 03/11/17 -- ;-&gt;HSGARCIA Proj 253/378 DVAIND-1940 05/12/2018
		viParams = ""
		putitem/id viParams, "CD_EMPRESA", $item("CD_EMPRESA", piParams)
		putitem/id viParams, "NR_PARTIDA", $item("NR_PARTIDA", piParams)
		if(vDsOperacao = "INICIAR")
			activate "CDFSVCO039".iniciarPartida(viParams, voParams, $xCdErro$, $xCtxerro$)
			if ($procerror)
				$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
				return(-1)
			elseif ($status &lt; 0)
				return(-1)
			endif
		elseif(vDsOperacao = "ENCERRAR")
			activate "CDFSVCO039".finalizarPartida(viParams, voParams, $xCdErro$, $xCtxerro$)
			if ($procerror)
				$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
				return(-1)
			elseif ($status &lt; 0)
				return(-1)
			endif
		endif
	endif
	;&lt;-

	;&lt;-- LOMoreira/DSantos Prj-&gt;217-545 22/06/2017 --&gt;
	if (vDsLstRegMov != "" &amp; vInMovimentar)
		viParams = ""
		putitem/id viParams, "DS_LSTMOVIMENTO", vDsLstRegMov
		putitem/id viParams, "DT_MOVIMENTO", $item("DT_PRODUCAO", $$gParamGlb)
		putitem/id viParams, "HR_MOVIMENTOREAL", $clock
		putitem/id viParams, "TP_HISTORICOMOV", 51 ;- Normal
		if (vDsOperacao = "INICIAR")
			putitem/id viParams, "CD_MAQUINA", CD_MAQUINA.CDF_PARTIDASVC ;--&gt; MNSANTOS - Prj 217/611 - 24/08/2017
		endif
		activate "CDFSVCO025".movimentarOP($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxerro$)
		if ($procerror)
			$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status &lt; 0)
			return(-1)
		endif
	endif
	;&lt;-- LOMoreira/DSantos Prj-&gt;217-545 --&gt;

	return(0)
end ;gerarTempoPartida

;-----------------------------
public operation salvarPartida
	;--------------------------
	params
		string piParams : IN
		string poParams : OUT
		string $xCdErro$ : OUT
		string $xCtxErro$ : OUT
	endparams
	variables
		string vDsRegPartida, vDsLstItem, viParams
		boolean vInExiste
		numeric vQtTotalItem, vQtPartida, vTpItemMaq
	endvariables

	if (!inValidarParametro("DS_REGPARTIDA", piParams, "salvarPartida"))
		return(-1)
	endif

	vDsRegPartida = $item("DS_REGPARTIDA", piParams)
	if (!inValidarParametro("CD_PROCESSO", vDsRegPartida, "salvarPartida"))
		return(-1)
	endif

	creocc "CDF_PARTIDASVC", -1
	CD_EMPRESA.CDF_PARTIDASVC = $item("CD_EMPRESA", vDsRegPartida)
	NR_PARTIDA.CDF_PARTIDASVC = $item("NR_PARTIDA", vDsRegPartida)
	retrieve/o "CDF_PARTIDASVC"
	if ($status = -7)
		retrieve/x "CDF_PARTIDASVC"
		vInExiste = &lt;TRUE&gt;
	elseif ($status = 4 | $status = 3)
		vInExiste = &lt;TRUE&gt;
	else
		vInExiste = &lt;FALSE&gt;
	endif
	delitem/id vDsRegPartida, "CD_EMPRESA"
	delitem/id vDsRegPartida, "NR_PARTIDA"

	getlistitems/occ vDsRegPartida, "CDF_PARTIDASVC"
	if (!vInExiste | !inRegBanco("CDF_PARTIDASVC"))
		if (TP_TIPO.CDF_PARTIDASVC = "")
			TP_TIPO.CDF_PARTIDASVC = getMaqConfPar("TP_PARTIDA", CD_MAQUINA.CDF_PARTIDASVC)
			if (TP_TIPO.CDF_PARTIDASVC &gt; 1)
				TP_TIPO.CDF_PARTIDASVC += 1
			endif
		endif
		if (TP_SITUACAO.CDF_PARTIDASVC = "")
			TP_SITUACAO.CDF_PARTIDASVC = 0
		endif
		DT_CADASTRO.CDF_PARTIDASVC = $datim
		CD_OPERADOR.CDF_PARTIDASVC = $item("CD_USUARIO", $$gParamGlb)
	endif

	creocc "CDF_PARTIDAPSVC"
	NR_SEQUENCIA.CDF_PARTIDAPSVC = 1
	retrieve/o "CDF_PARTIDAPSVC"
	if ($status = -7)
		retrieve/x "CDF_PARTIDAPSVC"
		vInExiste = &lt;TRUE&gt;
	elseif ($status = 4 | $status = 3)
		vInExiste = &lt;TRUE&gt;
	else
		vInExiste = &lt;FALSE&gt;
	endif
	CD_PROCESSO.CDF_PARTIDAPSVC = $item("CD_PROCESSO", vDsRegPartida)
	if (!vInExiste | !inRegBanco("CDF_PARTIDAPSVC"))
		if (TP_SITUACAO.CDF_PARTIDAPSVC = "")
			TP_SITUACAO.CDF_PARTIDAPSVC = 1
		endif
		DT_CADASTRO.CDF_PARTIDAPSVC = $datim
		CD_OPERADOR.CDF_PARTIDAPSVC = $item("CD_USUARIO", $$gParamGlb)
	endif

	validate/o "CDF_PARTIDASVC"
	if ($status &lt; 0)
		$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
		return(-1)
	endif

	if (!inValidarPartida())
		return(-1)
	endif

	setocc "CDF_PARTIDAISVC", -1
	setocc "CDF_PARTIDAISVC", 1
	vQtTotalItem = $totocc("CDF_PARTIDAISVC")

	while (!$empty("CDF_PARTIDAISVC"))
		$collhandle("CDF_PARTIDAISVC")-&gt;Remover()
		if ($procerror)
			$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status &lt; 0)
			return(-1)
		endif
	endwhile

	vDsLstItem = $item("DS_LSTITEM", vDsRegPartida)
	if (vQtTotalItem != $itemcount(vDsLstItem) &amp; TP_SITUACAO.CDF_PARTIDASVC != 0)
		$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG39787", "DESCRICAO=Situação da partida não permite alteração nos itens!", "ADICIONAL=Operação-&gt;CDFSVCO038.salvarPartida")
		return(-1)
	endif

	vQtPartida = ""
	vTpItemMaq = getMaqConfPar("TP_ITEM", CD_MAQUINA.CDF_PARTIDASVC)
	while (vDsLstItem != "")
		creocc "CDF_PARTIDAISVC"
		NR_SEQUENCIA.CDF_PARTIDAISVC = $item("NR_SEQUENCIA", $itemnr(1, vDsLstItem))
		retrieve/o "CDF_PARTIDAISVC"
		if ($status = -7)
			retrieve/x "CDF_PARTIDAISVC"
			vInExiste = &lt;TRUE&gt;
		elseif ($status = 4 | $status = 3)
			vInExiste = &lt;TRUE&gt;
		else
			vInExiste = &lt;FALSE&gt;
		endif

		getlistitems/occ $itemnr(1, vDsLstItem), "CDF_PARTIDAISVC"
		if (vTpItemMaq = 2 &amp; (NR_LOTE.CDF_PARTIDAISVC = "" | NR_ITEM.CDF_PARTIDAISVC = ""))
			$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG39788", "DESCRICAO=Tipo de item informado não corresponde ao tipo de item definido na máquina!", "ADICIONAL=Operação-&gt;CDFSVCO038.salvarPartida")
			return(-1)
		endif
		if (!vInExiste | !inRegBanco("CDF_PARTIDAISVC"))
			if (TP_SITUACAO.CDF_PARTIDASVC != 0)
				$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG39787", "DESCRICAO=Situação da partida não permite alteração nos itens!", "ADICIONAL=Operação-&gt;CDFSVCO038.salvarPartida")
				return(-1)
			endif

			DT_CADASTRO.CDF_PARTIDAISVC = $datim
			CD_OPERADOR.CDF_PARTIDAISVC = $item("CD_USUARIO", $$gParamGlb)
		endif

		putlistitems/occ viParams, "CDF_PARTIDAISVC"
		putitem/id viParams, "CD_MAQUINA", CD_MAQUINA.CDF_PARTIDASVC
		putitem/id viParams, "CD_PROCESSO", CD_PROCESSO.CDF_PARTIDAPSVC
		vQtPartida += converterQtProduto(viParams, QT_PARTIDA.CDF_PARTIDAISVC, "MUL")
		if ($status &lt; 0)
			return(-1)
		endif
		delitem vDsLstItem, 1
	endwhile

	if (vQtPartida &gt; getCapacidadeMaquina(CD_MAQUINA.CDF_PARTIDASVC, &lt;FALSE&gt;) &amp; (TP_TIPO.CDF_PARTIDASVC = 1 | TP_TIPO.CDF_PARTIDASVC = 4))
		$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG39789", "DESCRICAO=Quantidade da partida maior que a capacidade da máquina!", "ADICIONAL=Operação-&gt;CDFSVCO038.salvarPartida")
		return(-1)
	endif

	$collhandle("CDF_PARTIDASVC")-&gt;Salvar()
	if ($procerror)
		$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status &lt; 0)
		return(-1)
	endif

	return(0)
end ;salvarPartida

;-----------------------------
public operation getMaqConfPar
	;--------------------------
	params
		string piParams : IN
		string poParams : OUT
		string $xCdErro$ : OUT
		string $xCtxErro$ : OUT
	endparams

	if (!inValidarParametro("DS_CAMPO&uSEP;CD_MAQUINA", piParams, "getMaqConfPar"))
		return(-1)
	endif

	putitem/id poParams, "DS_INFO", getMaqConfPar($item("DS_CAMPO", piParams), $item("CD_MAQUINA", piParams))

	return(0)
end ;getMaqConfPar

;------------------------------
public operation removerPartida
	;---------------------------
	params
		string piParams : IN
		string poParams : OUT
		string $xCdErro$ : OUT
		string $xCtxErro$ : OUT
	endparams
	variables
		string vDsRegistro, viParams, voParams
		handle vHandleInstance
	endvariables

	if (!inValidarParametro("CD_EMPRESA&uSEP;NR_PARTIDA", piParams, "getMaqConfPar"))
		return(-1)
	endif

	clear/e "CDF_PARTIDASVC"
	CD_EMPRESA.CDF_PARTIDASVC = $item("CD_EMPRESA", piParams)
	NR_PARTIDA.CDF_PARTIDASVC = $item("NR_PARTIDA", piParams)
	retrieve/e "CDF_PARTIDASVC"
	if ($status &lt; 0)
		return(0)
	endif

	if (TP_TIPO.CDF_PARTIDASVC = 2)
		$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG1955", "DESCRICAO=Não é permitido remover partida de desativação de máquina!", "ADICIONAL=Operação-&gt;CDFSVCO038.removerPartida")
		return(-1)
	endif
	if (TP_SITUACAO.CDF_PARTIDASVC != 0)
		$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG39791", "DESCRICAO=Situação da partida não permite sua remoção!", "ADICIONAL=Operação-&gt;CDFSVCO038.removerPartida")
		return(-1)
	endif
	if (!$empty("CDF_PARTIDAISVC"))
		$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG2682", "DESCRICAO=Partida não pode ser removida pois existem itens vinculados!", "ADICIONAL=Operação-&gt;CDFSVCO038.removerPartida")
		return(-1)
	endif
	if (getFieldData("CD_EMPORI", "CDF_PARTIDARESVC", "CD_EMPORI=%%CD_EMPRESA.CDF_PARTIDASVC&uSEP;NR_PARTIDAORI=%%NR_PARTIDA.CDF_PARTIDASVC") != "")
		$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG39792", "DESCRICAO=Partida não pode ser removida pois existe relacionamento de reprocesso!", "ADICIONAL=Operação-&gt;CDFSVCO038.removerPartida")
		return(-1)
	endif
	if (getFieldData("CD_EMPORI", "CDF_PARTIDARESVC", "CD_EMPDEST=%%CD_EMPRESA.CDF_PARTIDASVC&uSEP;NR_PARTIDADEST=%%NR_PARTIDA.CDF_PARTIDASVC") != "")
		$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG39792", "DESCRICAO=Partida não pode ser removida pois existe relacionamento de reprocesso!", "ADICIONAL=Operação-&gt;CDFSVCO038.removerPartida")
		return(-1)
	endif

	putlistitems/occ vDsRegistro, "CDF_PARTIDASVC"

	$collhandle("CDF_PARTIDAPSVC")-&gt;Excluir()
	if ($procerror)
		$instancehandle-&gt;setStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status &lt; 0)
		return(-1)
	endif
	$collhandle("CDF_PARTIDASVC")-&gt;Excluir()
	if ($procerror)
		$instancehandle-&gt;setStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status &lt; 0)
		return(-1)
	endif

	newinstance "CDFSVCO038", vHandleInstance
	viParams = ""
	putitem/id viParams, "CD_EMPRESA", $item("CD_EMPRESA", vDsRegistro)
	putitem/id viParams, "CD_MAQUINA", $item("CD_MAQUINA", vDsRegistro)
	vHandleInstance-&gt;reordenarPartida(viParams, voParams, $xCdErro$, $xCtxErro$)
	if ($procerror)
		$instancehandle-&gt;setStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status &lt; 0)
		return(-1)
	endif

	return(0)
end ;removerPartida

;-------------------------------
public operation buscarQtPartida
	;----------------------------
	;&lt;-- LOMoreira Prj-&gt;217-218 23/03/2016 --&gt;
	params
		string piParams : IN
		string poParams : OUT
		string $xCdErro$ : OUT
		string $xCtxErro$ : OUT
	endparams
	variables
		string vDsRegistro, vDsConteudo
		numeric vTpItem, vQtAlocar, vQtAlocada
	endvariables

	if (!inValidarParametro("CD_EMPRESA&uSEP;NR_CICLO&uSEP;NR_OP&uSEP;CD_PRODUTO&uSEP;CD_PROCESSO&uSEP;CD_MAQUINA&uSEP;TP_ITEM", piParams, "buscarQtAlocar"))
		return(-1)
	endif

	;---- Buscar quantidade alocar
	vTpItem = $item("TP_ITEM", piParams)
	vDsRegistro = ""
	putitem/id vDsRegistro, "CD_EMPRESA", $item("CD_EMPRESA", piParams)
	putitem/id vDsRegistro, "NR_CICLO", $item("NR_CICLO", piParams)
	putitem/id vDsRegistro, "NR_OP", $item("NR_OP", piParams)
	putitem/id vDsRegistro, "CD_PRODUTO", $item("CD_PRODUTO", piParams)

	selectcase vTpItem
	case 1 ;- Item de O.P
		vQtAlocar = getQtAlocarItemOp(vDsRegistro, $item("CD_PROCESSO", piParams), $item("CD_MAQUINA", piParams), &lt;FALSE&gt;, "", "")
	case 2 ;- Item de lote
		if (!inValidarParametro("NR_LOTE&uSEP;NR_ITEM", piParams, "buscarQtAlocar"))
			return(-1)
		endif
		putitem/id vDsRegistro, "NR_LOTE", $item("NR_LOTE", piParams)
		putitem/id vDsRegistro, "NR_ITEM", $item("NR_ITEM", piParams)
		vQtAlocar = getQtAlocarItemLote(vDsRegistro, $item("CD_PROCESSO", piParams), $item("CD_MAQUINA", piParams), &lt;FALSE&gt;, "", "")
	endselectcase

	;----Buscar quantidade em outras partidas
	vDsRegistro = ""
	putitem/id vDsRegistro, "CD_EMPRESA", $item("CD_EMPRESA", piParams)
	putitem/id vDsRegistro, "NR_CICLO", $item("NR_CICLO", piParams)
	putitem/id vDsRegistro, "NR_OP", $item("NR_OP", piParams)
	putitem/id vDsRegistro, "TP_SITUACAO", "0&uSEP;1&uSEP;4" ;- Aguardando, Andamento e Encerrada
	if (vTpItem = 2)
		putitem/id vDsRegistro, "NR_LOTE", $item("NR_LOTE", piParams)
		putitem/id vDsRegistro, "NR_ITEM", $item("NR_ITEM", piParams)
		putitem/id vDsRegistro, "CD_PROCESSO", $item("CD_PROCESSO", piParams)
	endif

	vQtAlocada = getQtAlocadaPartida(vDsRegistro, 1)

	putitem/id poParams, "QT_ALOCAR", vQtAlocar
	putitem/id poParams, "QT_ALOCADA", vQtAlocada

	return(0)
end ;buscarQtPartida

;-----------------------------------
public operation gerarEmissaoPartida
	;--------------------------------
	params
		string piParams : IN
		string poParams : OUT
		string $xCdErro$ : OUT
		string $xCtxErro$ : OUT
	endparams
	variables
		handle vHandleInstance
		string viParams, voParams, vCdReceita, vDsRegistro, vDsLstOpi, vDsLstTpUtilizacao, vDsCondicao
		numeric vQtVolume, vQtPeso, vCdSeqMaq, vTpEmissao, vCdTipoUtilizacao, vQtPartida, vQtReferencia, vQtCone
	endvariables

	if (!inValidarParametro("CD_EMPRESA&uSEP;NR_PARTIDA", piParams, "gerarEmissaoPartida"))
		return(-1)
	endif

	viParams = piParams
	newinstance "CDFSVCO038", vHandleInstance
	vHandleInstance-&gt;buscarReceitaPartida(viParams, voParams, $xCdErro$, $xCtxErro$)
	if ($procerror)
		$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status &lt; 0)
		return(-1)
	endif
	if ($item("IN_RECEITAIGUAL", voParams) != &lt;TRUE&gt; | $item("CD_RECEITA", voParams) = "")
		if ($item("IN_NAO_VALIDAR_RECEITA", piParams) = &lt;TRUE&gt;)
			return(0)
		endif
		$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG39802", "DESCRICAO=Partida não possui receita para emissão!", "ADICIONAL=Operação-&gt;CDFSVCO038.gerarEmissaoPartida")
		return(-1)
	endif
	vCdReceita = $item("CD_RECEITA", voParams)
	vCdTipoUtilizacao = $item("CD_TPUTILIZACAO", voParams)
	vDsLstTpUtilizacao = $item("DS_LSTTPUTILIZACAO", voParams) ;--&gt; MNSANTOS - Prj 217/305 - 25/07/2016

	clear/e "CDF_PARTIDASVC"
	CD_EMPRESA.CDF_PARTIDASVC/init = $item("CD_EMPRESA", piParams)
	NR_PARTIDA.CDF_PARTIDASVC/init = $item("NR_PARTIDA", piParams)
	retrieve/e "CDF_PARTIDASVC"
	if ($status &lt; 0)
		return(0)
	endif
	vCdSeqMaq = getFieldData("CD_SEQMAQ", "CDF_MAQGMAQSVC", "CD_MAQUINA=%%CD_MAQUINA.CDF_PARTIDASVC")

	if (TP_TIPO.CDF_PARTIDASVC = 1)
		;- Partida descontínua
		viParams = ""
		putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.CDF_PARTIDASVC
		putitem/id viParams, "NR_PARTIDA", NR_PARTIDA.CDF_PARTIDASVC

		;&lt;-- DSantos Prj-&gt;217-511 30/05/2017
		;if (getQtRelBanhoReceita(vCdReceita) &gt; 0)
		;	vQtVolume = getQtAlocadaPartida(viParams, 4)
		;else
		;	vQtVolume = getFieldData("QT_VOLUMEIDEAL", "CDF_GMAQBENSVC", "CD_SEQMAQ=%%vCdSeqMaq")
		;	putitem/id poParams, "IN_VOLUMEIDEAL", &lt;TRUE&gt;
		;endif
		vQtPeso = getQtAlocadaPartidaCone(viParams, 3, vQtCone)
		viParams = ""
		putitem/id viParams, "CD_MAQUINA", CD_MAQUINA.CDF_PARTIDASVC
		putitem/id viParams, "CD_RECEITA", vCdReceita
		putitem/id viParams, "QT_CONE", vQtCone
		vQtVolume = converterQtProduto(viParams, vQtPeso, "VOLUME")
		if (vQtVolume = 0)
			putitem/id poParams, "IN_VOLUMEIDEAL", &lt;TRUE&gt;
			vQtVolume = getFieldData("QT_VOLUMEIDEAL", "CDF_GMAQBENSVC", "CD_SEQMAQ=%%vCdSeqMaq")
			if (vQtVolume &gt; 0)
				$instancehandle-&gt;armazenarLog(-5, CD_MAQUINA.CDF_PARTIDASVC, "", vQtVolume)
			;&lt;-- DSantos Prj-&gt;217-669 08/11/2017
			elseif ($empty("CDF_PARTIDAISVC"))
				vQtVolume = getFieldData("QT_PESOMAX", "CDF_GMAQBENSVC", "CD_SEQMAQ=%%vCdSeqMaq") * getFieldData("QT_RELBANHO", "CDF_GMAQBENSVC", "CD_SEQMAQ=%%vCdSeqMaq")
				$dsLstLogCalc$ = ""
				$instancehandle-&gt;armazenarLog(-6, CD_MAQUINA.CDF_PARTIDASVC, getFieldData("QT_PESOMAX", "CDF_GMAQBENSVC", "CD_SEQMAQ=%%vCdSeqMaq"), getFieldData("QT_RELBANHO", "CDF_GMAQBENSVC", "CD_SEQMAQ=%%vCdSeqMaq"))
			endif
		endif
		;&lt;-- DSantos Prj-&gt;217-669 08/11/2017
		if (vQtPeso = "" &amp; $empty("CDF_PARTIDAISVC"))
			vQtPeso = 0
		endif
		;DSantos --&gt;

	elseif (TP_TIPO.CDF_PARTIDASVC = 4)
		;- Partida contínua com quantidade
		vQtVolume = getQtAlocadaPartida(viParams, 4)
		if(vQtVolume = 0)
			vQtVolume = getFieldData("QT_VOLUMEIDEAL", "CDF_GMAQBENSVC", "CD_SEQMAQ=%%vCdSeqMaq")
			putitem/id poParams, "IN_VOLUMEIDEAL", &lt;TRUE&gt;
		else
			vQtVolume += getFieldData("QT_LASTRO", "CDF_GMAQBENSVC", "CD_SEQMAQ=%%vCdSeqMaq")
		endif
 		vQtPeso = getQtAlocadaPartida(viParams, 3)
	endif

	;&lt;-- LOMoreira Prj-&gt;217-583 25/07/2017 --&gt;
	if(!inValidarLocalizacaoItem())
		$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG41699", "DESCRICAO=Partida possui item sem localização para emissão!", "ADICIONAL=Operação-&gt;CDFSVCO038.gerarEmissaoPartida")
		return(-1)
	endif
	;&lt;-- LOMoreira Prj-&gt;217-583 25/07/2017 --&gt;

	if ($item("IN_GERAR_EMISSAO", piParams) = &lt;TRUE&gt;)
		;&lt;-- DSantos Prj-&gt;217-280 29/06/2016
		vQtPartida = ""
		if (vCdTipoUtilizacao != "" | vDsLstTpUtilizacao != "") ;--&gt; MNSANTOS - Prj 217/305 - 25/07/2016
			viParams = ""
			putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.CDF_PARTIDASVC
			putitem/id viParams, "NR_PARTIDA", NR_PARTIDA.CDF_PARTIDASVC
			vQtPartida = getQtAlocadaPartida(viParams, 1)
		endif
		; DSantos --&gt;

		if (!$empty("CDF_PARTIDAISVC"))
			;--&gt; MNSANTOS - Prj 217/311 - 01/08/2016
			vDsLstOpI = ""
			sort/e "CDF_PARTIDAISVC", "CD_EMPOP.CDF_PARTIDAISVC, NR_CICLO.CDF_PARTIDAISVC, NR_OP.CDF_PARTIDAISVC, CD_PRODUTO.CDF_PARTIDAISVC"
			vQtReferencia = ""
			setocc "CDF_PARTIDAISVC", 1
			while($status &gt;= 0)
				if(!inValidarLocalizacaoItem())	;&lt;-- LOMoreira Prj-&gt;217-583 25/07/2017 --&gt;
					$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MGS41699", "DESCRICAO=Partida possui item sem localização para emissão!", "ADICIONAL=Operação-&gt;CDFSVCO038.gerarEmissaoPartida")
					return(-1)
				endif
				if(inOpiPartidaDiferente())
					vDsRegistro = ""
					vQtReferencia += QT_REFERENCIA.CDF_PARTIDAISVC
					putlistitems/occ vDsRegistro, "CDF_PARTIDAISVC"
					putitem/id vDsRegistro, "QT_REFERENCIA", vQtReferencia
					putitem vDsLstOpI, -1, vDsRegistro
					vQtReferencia = ""
				else
					vQtReferencia += QT_REFERENCIA.CDF_PARTIDAISVC
				endif
				setocc "CDF_PARTIDAISVC", $curocc("CDF_PARTIDAISVC") + 1
			endwhile
			;--&lt; MNSANTOS
		endif

		viParams = ""
		putitem/id viParams, "CD_EMPPARTIDA", CD_EMPRESA.CDF_PARTIDASVC
		putitem/id viParams, "NR_PARTIDA", NR_PARTIDA.CDF_PARTIDASVC
		putitem/id viParams, "CD_PROCESSO", CD_PROCESSO.CDF_PARTIDAPSVC
		putitem/id viParams, "CD_CCUSTO", getFieldData("CD_CCUSTO", "CDF_GMAQSVC", "CD_SEQMAQ=%%vCdSeqMaq")
		putitem/id viParams, "CD_SEQMAQ", vCdSeqMaq
		putitem/id viParams, "CD_RECEITA", vCdReceita
		putitem/id viParams, "QT_VOLUME", vQtVolume
		putitem/id viParams, "QT_PESO", vQtPeso
		if($item("TP_VINCULO", piParams) &gt; 1)
			vTpEmissao = $item("TP_VINCULO", piParams) - 1
		else
			vTpEmissao = 1
		endif
		putitem/id viParams, "TP_EMISSAO", vTpEmissao
		putitem/id viParams, "CD_OPERACAO", $item("CD_OPERACAO", piParams)
		putitem/id viParams, "DS_LSTFOR", $item("DS_LSTFOR", piParams)
		putitem/id viParams, "IN_DESCONSIDERARLASTRO", $item("IN_DESCONSIDERARLASTRO", piParams)
		putitem/id viParams, "CD_TPUTILIZACAO", vCdTipoUtilizacao ;&lt;-- DSantos Prj-&gt;217-280 29/06/2016 --&gt;
		putitem/id viParams, "DS_LSTTPUTILIZACAO", vDsLstTpUtilizacao ;--&gt; MNSANTOS - Prj 217/305 - 25/07/2016
		putitem/id viParams, "QT_PRODUTO", vQtPartida ;&lt;-- DSantos Prj-&gt;217-280 29/06/2016 --&gt;
		putitem/id viParams, "DS_LSTOPI", vDsLstOpi
		putitem/id viParams, "IN_PARTIDASEMITEM", $empty("CDF_PARTIDAISVC") ;&lt;-- DSantos Prj-&gt;217-669 08/11/2017 --&gt;
		vHandleInstance-&gt;gerarEmissaoReceita(viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)
			$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status &lt; 0)
			return(-1)
		endif
		poParams = voParams
		if ($item("NR_EMISSAO", voParams) != "" &amp; $item("DS_LSTFOR", voParams) = "")
			viParams = ""
			putitem/id viParams, "CD_EMPPARTIDA", CD_EMPRESA.CDF_PARTIDASVC
			putitem/id viParams, "NR_PARTIDA", NR_PARTIDA.CDF_PARTIDASVC
			putitem/id viParams, "CD_EMPEMISSAO", $item("CD_EMPRESA", voParams)
			putitem/id viParams, "NR_EMISSAO", $item("NR_EMISSAO", voParams)
			putitem/id viParams, "TP_VINCULO", $item("TP_VINCULO", piParams)
			$instancehandle-&gt;relacionarEmissaoPartida(viParams, voParams, $xCdErro$, $xCtxErro$)
			if ($procerror)
				$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
				return(-1)
			elseif ($status &lt; 0)
				return(-1)
			endif
		endif
	else
		putitem/id poParams, "CD_RECEITA", vCdReceita
		putitem/id poParams, "QT_VOLUME", vQtVolume
		putitem/id poParams, "QT_PESO", vQtPeso
		putitem/id poParams, "CD_SEQMAQ", vCdSeqMaq
		putitem/id poParams, "CD_TPUTILIZACAO", vCdTipoUtilizacao
		putitem/id poParams, "DS_LSTTPUTILIZACAO", vDsLstTpUtilizacao ;--&gt; MNSANTOS - Prj 217/305 - 25/07/2016
	endif

	return(0)
end ;gerarEmissaoPartida

;-----------------------------------
public operation gerarEmissaoReceita
	;--------------------------------
	params
		string piParams : IN
		string poParams : OUT
		string $xCdErro$ : OUT
		string $xCtxErro$ : OUT
	endparams
	variables
		string vCdComponente, vDsRegistro, vDsLstPercPrd, vDsLstFor, viParams, vDsLstOpI, vDsReceita, vDsLstOper, vDsLstFase, vDsLstPrd, vDsLstCampo, voParams, vDsRegFase, vDsCondicao, vDsLstSaldoPrd
		numeric vQtPeso, vQtVolume, vPrCobertura, vQtPesoIn, vNrSeq, vNrAgrupador
		boolean vInRetornarFor
	endvariables

	if (!inValidarParametro("CD_RECEITA&uSEP;QT_PESO&uSEP;QT_VOLUME&uSEP;TP_EMISSAO", piParams, "gerarEmissaoReceita"))
		return(-1)
	endif

	vCdComponente = $item("CD_COMPONENTE", piParams)
	if (vCdComponente = "")
		vCdComponente = $componentname
	endif
	vQtPesoIn = $item("QT_PESO", piParams)
	vQtVolume = $item("QT_VOLUME", piParams)
	vDsLstPercPrd = $item("DS_LSTPERCPRD", piParams)
	vDsLstFor = $item("DS_LSTFOR", piParams)
	if(vDsLstFor = "")
		vInRetornarFor = &lt;TRUE&gt;
	else
		vInRetornarFor = &lt;FALSE&gt;
	endif

	if (!inValidarEmissao(vQtVolume, vQtPesoIn, $item("CD_SEQMAQ", piParams), $item("IN_PARTIDASEMITEM", piParams), $item("CD_RECEITA", piParams)))
		return(-1)
	endif

	vNrAgrupador = getFieldData("NR_AGRUPADOR", "TEX_RECEITASVC", "CD_RECEITA=%%$item("CD_RECEITA", piParams)")

	creocc "TEX_RECEMISSASVC", -1
	CD_EMPRESA.TEX_RECEMISSASVC = $item("CD_EMPRESA", $$gParamGlb)
	NR_EMISSAO.TEX_RECEMISSASVC = getNrEmissao()
	retrieve/o "TEX_RECEMISSASVC"
	if ($status = -7)
		retrieve/x "TEX_RECEMISSASVC"
	endif
	getlistitems/occ piParams, "TEX_RECEMISSASVC"
	;-&gt;HSGARCIA Proj 217/701 17/01/2018
	if($scan(CD_RECEITA.TEX_RECEMISSASVC, "RP") &gt; 0)
		CD_RECEITA.TEX_RECEMISSASVC = "RP"
	endif
	;&lt;-HSGARCIA
	TP_SITUACAO.TEX_RECEMISSASVC = "01" ;- Ativo
	CD_COMPONENTEINC.TEX_RECEMISSASVC	= vCdComponente
	;&lt;-- DSantos Prj-&gt;217-289 04/07/2016
	putitem/id DS_INFO.TEX_RECEMISSASVC, "QT_PRODUTO", $item("QT_PRODUTO", piParams)
	putitem/id DS_INFO.TEX_RECEMISSASVC, "CD_TPUTILIZACAO", $item("CD_TPUTILIZACAO", piParams)
	putitem/id DS_INFO.TEX_RECEMISSASVC, "IN_DESCONSIDERARLASTRO", $item("IN_DESCONSIDERARLASTRO", piParams)
	; DSantos --&gt;
	putitem/id DS_INFO.TEX_RECEMISSASVC, "DS_LSTTPUTILIZACAO", $item("DS_LSTTPUTILIZACAO", piParams);--&gt; MNSANTOS - Prj 217/305 - 27/07/2016
	CD_OPERADORINC.TEX_RECEMISSASVC	= $item("CD_USUARIO", $$gParamGlb)
	DT_INCLUSAO.TEX_RECEMISSASVC = $datim
	DT_EMISSAO.TEX_RECEMISSASVC = $datim
	CD_OPERADOR.TEX_RECEMISSASVC	= $item("CD_USUARIO", $$gParamGlb)
	DT_CADASTRO.TEX_RECEMISSASVC = $datim

	;--&gt; MNSANTOS - Prj 217/280 - 23/06/2016
	if($item("DS_LSTOPI", piParams) != "")
		vDsLstOpI = $item("DS_LSTOPI", piParams)
		while(vDsLstOpI != "")
			creocc "TEX_RECEMIOPSVC", -1
			getlistitems/occ $itemnr(1, vDsLstOpI), "TEX_RECEMIOPSVC"
			CD_OPERADOR.TEX_RECEMIOPSVC = $item("CD_USUARIO", $$gParamGlb)
			DT_CADASTRO.TEX_RECEMIOPSVC = $datim
			PR_RATEIO.TEX_RECEMIOPSVC = getRateioOpPartida(piParams, $itemnr(1, vDsLstOpI))
			delitem vDsLstOpI, 1
		endwhile
	endif
	;--&lt; MNSANTOS

	;--&gt; MNSANTOS - Prj 217/510 - 16/05/2017
	viParams = ""
	putitem/id viParams, "CD_RECEITA", $item("CD_RECEITA", piParams)
	putitem/id viParams, "IN_CAMPOCONF", &lt;TRUE&gt;
	activate "PCPSVCO043".buscarFaseReceita(viParams, voParams, $xCdErro$, $xCtxErro$)
	if($procerror)
		$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
		return(-1)
	elseif($status &lt; 0)
		return(-1)
	endif

	if($item("DS_RECEITA", voParams) != "")
		vDsReceita = $item("DS_RECEITA", voParams)
		vDsLstFase = $item("DS_LSTFASE", vDsReceita)
		while (vDsLstFase != "")
			vDsRegFase = $itemnr(1, vDsLstFase)
			creocc "TEX_RECEMIFASSVC", -1
			NR_FASE.TEX_RECEMIFASSVC = $item("NR_FASE", vDsRegFase)
			retrieve/o "TEX_RECEMIFASSVC"
			if ($status = -7)
				retrieve/x "TEX_RECEMIFASSVC"
			endif
			getlistitems/occ vDsRegFase, "TEX_RECEMIFASSVC"
			CD_OPERADOR.TEX_RECEMIFASSVC = $item("CD_USUARIO", $$gParamGlb)
			DT_CADASTRO.TEX_RECEMIFASSVC = $datim

			vQtPeso = vQtPesoIn
			if ($item(vNrAgrupador, $dsLstTpRecCampoConf$) != "" | $tpManutencaoFaseRec$ &gt; 0)
				vPrCobertura = getCampoConfReceita($item("CD_RECEITA", vDsRegFase), $item("NR_FASE", vDsRegFase), "", 3)
				if (vPrCobertura &gt; 0)
					vQtPeso = vQtPesoIn * (vPrCobertura / 100)
				endif

				if($item("DS_LSTCAMPO", vDsRegFase) != "")
					vDsLstCampo = $item("DS_LSTCAMPO", vDsRegFase)
					while (vDsLstCampo != "")
						creocc "CDF_CFGRECEMIFASESVC", -1
						getlistitems/occ $itemnr(1, vDsLstCampo), "CDF_CFGRECEMIFASESVC"
						CD_OPERADOR.CDF_CFGRECEMIFASESVC = $item("CD_USUARIO", $$gParamGlb)
						DT_CADASTRO.CDF_CFGRECEMIFASESVC = $datim
						delitem vDsLstCampo, 1
					endwhile
				endif

				$handleEntity$-&gt;consultar("PCP_CFGINFTECSVC", "CD_CONF=35&uSEP;TP_TIPOCAMPO=F")
				if($status &gt;= 0)
					$handleEntity$-&gt;getRegistro(vDsRegistro)
					if($item("CD_CAMPOADIC", vDsRegistro) != "")
						sort/e "CDF_CFGRECEMIFASESVC", "NR_SEQUENCIA.CDF_CFGRECEMIFASESVC"
						setocc "CDF_CFGRECEMIFASESVC", -1
						vNrSeq = NR_SEQUENCIA.CDF_CFGRECEMIFASESVC + 1
						creocc "CDF_CFGRECEMIFASESVC", -1
						NR_SEQUENCIA.CDF_CFGRECEMIFASESVC = vNrSeq
						retrieve/o "CDF_CFGRECEMIFASESVC"
						if($status = -7)
							retrieve/x "CDF_CFGRECEMIFASESVC"
						endif
						CD_TIPOCAMPO.CDF_CFGRECEMIFASESVC = $item("CD_CAMPOADIC", vDsRegistro)
						TP_TIPOCAMPO.CDF_CFGRECEMIFASESVC = $item("TP_TIPOCAMPO", vDsRegistro)
						if($item("IN_DESCONSIDERARLASTRO", piParams) = &lt;TRUE&gt;)
							NR_CAMPO.CDF_CFGRECEMIFASESVC = 0
						else
							NR_CAMPO.CDF_CFGRECEMIFASESVC = 1
						endif
						CD_OPERADOR.CDF_CFGRECEMIFASESVC = $item("CD_USUARIO", $$gParamGlb)
						DT_CADASTRO.CDF_CFGRECEMIFASESVC = $datim
					endif
				endif
			endif

			if (!inValidarRelBanhoFaseEmissao(CD_SEQMAQ.TEX_RECEMISSASVC, QT_RELBANHO.TEX_RECEMIFASSVC, NR_FASE.TEX_RECEMIFASSVC, vQtPeso))
				return(-1)
			endif

			vDsLstOper = $item("DS_LSTOPER", vDsRegFase)
			while(vDsLstOper != "")
				creocc "TEX_RECEMIOPESVC", -1
				NR_SEQOPER.TEX_RECEMIOPESVC = $item("NR_SEQOPER", $itemnr(1, vDsLstOper))
				retrieve/o "TEX_RECEMIOPESVC"
				if ($status = -7)
					retrieve/x "TEX_RECEMIOPESVC"
				endif
				getlistitems/occ $itemnr(1, vDsLstOper), "TEX_RECEMIOPESVC"
				CD_OPERADOR.TEX_RECEMIOPESVC = $item("CD_USUARIO", $$gParamGlb)
				DT_CADASTRO.TEX_RECEMIOPESVC = $datim

				if ($item(vNrAgrupador, $dsLstTpRecCampoConf$) != "" | $tpManutencaoFaseRec$ &gt; 0)
					if($item("DS_LSTCAMPO", $itemnr(1, vDsLstOper)) != "")
						vDsLstCampo = $item("DS_LSTCAMPO", $itemnr(1, vDsLstOper))
						while (vDsLstCampo != "")
							vDsRegistro = ""
							putlistitems/occ vDsRegistro, "CDF_CFGRECOPERSVC"
							creocc "CDF_CFGRECEMIOPERSVC", -1
							getlistitems/occ $itemnr(1, vDsLstCampo), "CDF_CFGRECEMIOPERSVC"
							CD_OPERADOR.CDF_CFGRECEMIOPERSVC = $item("CD_USUARIO", $$gParamGlb)
							DT_CADASTRO.CDF_CFGRECEMIOPERSVC = $datim
							delitem vDsLstCampo, 1
						endwhile
					endif
				endif

				vDsLstPrd = $item("DS_LSTPRD", $itemnr(1, vDsLstOper))
				while(vDsLstPrd != "")
					vDsRegistro = $itemnr(1, vDsLstPrd)
					creocc "TEX_RECEOPPRDSVC", -1
					NR_SEQPRD.TEX_RECEOPPRDSVC = $item("NR_SEQPRD", vDsRegistro);$curocc("TEX_RECEOPPRDSVC") ;--&gt;ROS--&gt;220/2199--&gt;03/08/2017
					retrieve/o "TEX_RECEOPPRDSVC"
					if ($status = -7)
						retrieve/x "TEX_RECEOPPRDSVC"
					endif
					delitem/id vDsRegistro, "NR_SEQPRD"
					getlistitems/occ vDsRegistro, "TEX_RECEOPPRDSVC"
					NR_ORDEM.TEX_RECEOPPRDSVC = $curocc("TEX_RECEOPPRDSVC")
					CD_OPERADOR.TEX_RECEOPPRDSVC = $item("CD_USUARIO", $$gParamGlb)
					DT_CADASTRO.TEX_RECEOPPRDSVC = $datim

					viParams = ""
					putitem/id viParams, "CD_RECEITA", $item("CD_RECEITA", vDsReceita)
					putitem/id viParams, "NR_FASE", $item("NR_FASE", vDsRegFase)
					putitem/id viParams, "NR_SEQOPER", $item("NR_SEQOPER", $itemnr(1, vDsLstOper))
					putitem/id viParams, "NR_SEQPRD", NR_SEQPRD.TEX_RECEOPPRDSVC
					putitem/id viParams, "CD_PRODUTO", $item("CD_PRODUTO", vDsRegistro)
					putitem/id viParams, "QT_PESO", vQtPeso
					putitem/id viParams, "QT_VOLUME", calcularVolumeEmissao(vQtVolume, vQtPeso, $item("CD_RECEITA", vDsReceita), NR_FASE.TEX_RECEMIFASSVC, QT_RELBANHO.TEX_RECEMIFASSVC, "", $item("IN_DESCONSIDERARLASTRO", piParams))
					putitem/id viParams, "TP_CONSUMO", $item("TP_CONSUMO", vDsRegistro)
					putitem/id viParams, "QT_CONSUMO", $item("QT_CONSUMO", vDsRegistro)
					putitem/id viParams, "PR_CONSUMO", $item($item("CD_PRODUTO", vDsRegistro), vDsLstPercPrd)
					;&lt;-- DSantos Prj-&gt;217-278 20/06/2016
					putitem/id viParams, "CD_TPUTILIZACAO", $item("CD_TPUTILIZACAO", piParams)
					putitem/id viParams, "DS_LSTTPUTILIZACAO", $item("DS_LSTTPUTILIZACAO", piParams) ;--&gt; MNSANTOS - Prj 217/305 - 27/07/2016
					putitem/id viParams, "QT_PRODUTO", $item("QT_PRODUTO", piParams)
					; DSantos --&gt;
					putitem/id viParams, "CD_MAQUINA", getMaquinaEmissao(piParams) ;&lt;-- DSantos Prj-&gt;217/06/2017 --&gt;
					putitem/id viParams, "IN_FASEPADRAO", $item("IN_FASEPADRAO", vDsReceita)
					;&lt;-- DSantos Prj-&gt;217-641 26/09/2017
					putitem/id viParams, "IN_RECEITAPARTIDA", $item("IN_RECEITAPARTIDA", vDsReceita)
					putitem/id viParams, "DS_LSTPRDCORANTE", $item("DS_LSTPRDCORANTE", vDsReceita)
					putitem/id viParams, "QT_REPETICAO", $item("QT_REPETICAO", vDsRegistro)
					; DSantos --&gt;
					QT_TOTAL.TEX_RECEOPPRDSVC = calcularConsumoProduto(viParams, vDsLstFor, poParams)
					if ($status &lt; 0)
						return(-1)
					endif
					if ($item("QT_CONSUMO", poParams) != "")
						QT_CONSUMO.TEX_RECEOPPRDSVC = $item("QT_CONSUMO", poParams)
					endif
					if ($item("TP_CONSUMO", poParams) != "")
						TP_CONSUMO.TEX_RECEOPPRDSVC = $item("TP_CONSUMO", poParams)
					endif

					if (TP_EMISSAO.TEX_RECEMISSASVC = 1)
						creocc "TEX_RECEMIMPSVC", -1
						CD_PRODUTO.TEX_RECEMIMPSVC = $item("CD_PRODUTO", vDsRegistro)
						retrieve/o "TEX_RECEMIMPSVC"
						if ($status = -7)
							retrieve/x "TEX_RECEMIMPSVC"
						endif
						QT_ESTIMADA.TEX_RECEMIMPSVC += QT_TOTAL.TEX_RECEOPPRDSVC
						QT_ESTIMADAORI.TEX_RECEMIMPSVC += QT_TOTAL.TEX_RECEOPPRDSVC
						IN_FECHAMENTO.TEX_RECEMIMPSVC = &lt;FALSE&gt;
						CD_OPERADOR.TEX_RECEMIMPSVC = $item("CD_USUARIO", $$gParamGlb)
						DT_CADASTRO.TEX_RECEMIMPSVC = $datim
					endif

					delitem vDsLstPrd, 1
				endwhile
				delitem vDsLstOper, 1
			endwhile
			delitem vDsLstFase, 1
		endwhile
	endif

	if (vDsLstFor = "" | !vInRetornarFor)
		;&lt;-- DSantos Prj-&gt;217-511 02/06/2017
		viParams = ""
		$instancehandle-&gt;contextualizarLog(viParams)
		putitem/id DS_INFO.TEX_RECEMISSASVC, "DS_DETALHE", viParams
		; DSantos --&gt;
		$collhandle("TEX_RECEMISSASVC")-&gt;Salvar()
		if ($procerror)
			$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status &lt; 0)
			return(-1)
		endif

		;==IES DVAIND-234 21/05/2018
		$instancehandle-&gt;atualizarDtUtilizacao(CD_RECEITA.TEX_RECEMISSASVC)
		if ($procerror)
			$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status &lt; 0)
			return(-1)
		endif
		;===IES

		if ($inValidarSaldoEmiRec$);&lt;-- LOMoreira Prj-&gt;217-708 22/01/2018 --&gt;
			$instancehandle-&gt;validarSaldoEmiRec(vDsLstSaldoPrd)
			if ($procerror)
				$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
				return(-1)
			elseif ($status &lt; 0)
				return(-1)
			endif
		endif
		putitem/id poParams, "DS_LSTSALDOPRD", vDsLstSaldoPrd
	else
		clear/e "TEX_RECEMISSASVC"
	endif

	putitem/id poParams, "CD_EMPRESA", CD_EMPRESA.TEX_RECEMISSASVC
	putitem/id poParams, "NR_EMISSAO", NR_EMISSAO.TEX_RECEMISSASVC
	if(vInRetornarFor)
		putitem/id poParams, "DS_LISTAFOR", vDsLstFor
	endif

	return(0)
end ;gerarEmissaoReceita

;--------------------------------------
public operation calcularPesoVolumeItem
;--------------------------------------
	params
		string piParams : IN
		string poParams : OUT
		string $xCdErro$ : OUT
		string $xCtxErro$ : OUT
	endparams
	variables
		boolean vInCompMaq
		string vDsLstLogCalc
	endvariables

	vInCompMaq = $inCompMaq$
 	vDsLstLogCalc = $dsLstLogCalc$

	if($item("TP_CALCULO", piParams) = 1)
		;Partida
		if(!inValidarParametro("CD_EMPRESA&uSEP;NR_PARTIDA&uSEP;NR_SEQUENCIA", piParams, "calcularPesoVolumeItem"))
			return(-1)
		endif
		delitem/id piParams, "TP_CALCULO"
		putitem/id poParams, "QT_VOLUME", getQtAlocadaPartida(piParams, 4)
		putitem/id poParams, "QT_PESO", getQtAlocadaPartida(piParams, 3)
	elseif($item("TP_CALCULO", piParams) = 2)
		;Item de O.P.
		if(!inValidarParametro("CD_EMPOP&uSEP;NR_CICLO&uSEP;NR_OP&uSEP;CD_PRODUTO&uSEP;CD_PROCESSO&uSEP;QT_PRODUTO", piParams, "calcularPesoVolumeItem"))
			return(-1)
		endif
		if($item("CD_SEQMAQ", piParams) != "")
			putitem/id piParams, "CD_MAQUINA", getFieldData("CD_MAQUINA", "CDF_MAQGMAQSVC", "CD_SEQMAQ=%%$item("CD_SEQMAQ", piParams)")
		elseif($item("CD_MAQUINA", piParams) = "")
			return(0)
		endif
		putitem/id poParams, "QT_VOLUME", converterQtProduto(piParams, $item("QT_PRODUTO", piParams), "MULV")
		putitem/id poParams, "QT_PESO", converterQtProduto(piParams, $item("QT_PRODUTO", piParams), "MULP")
	elseif ($item("TP_CALCULO", piParams) = 3)
		;- Produto
		if(!inValidarParametro("CD_PRODUTO&uSEP;QT_PRODUTO", piParams, "gerarEmissaoReceita"))
			return(-1)
		endif
		putitem/id poParams, "QT_PESO", converterQtProduto(piParams, $item("QT_PRODUTO", piParams), "MULP")
	endif

	putitem/id poParams, "IN_COMPMAQ", $inCompMaq$

	$inCompMaq$ = vInCompMaq
	$dsLstLogCalc$ = vDsLstLogCalc

	return(0)
end ;calcularPesoVolumeItem

;----------------------------------------
public operation relacionarEmissaoPartida
;----------------------------------------
	params
		string piParams : IN
		string poParams : OUT
		string $xCdErro$ : OUT
		string $xCtxErro$ : OUT
	endparams
	variables
		string viParams
	endvariables

	if(!inValidarParametro("CD_EMPPARTIDA&uSEP;NR_PARTIDA&uSEP;CD_EMPEMISSAO&uSEP;NR_EMISSAO&uSEP;TP_VINCULO", piParams, "relacionarEmissaoPartida"))
		return(-1)
	endif

	if(CD_EMPRESA.CDF_PARTIDASVC != $item("CD_EMPPARTIDA", piParams) | NR_PARTIDA.CDF_PARTIDASVC != $item("NR_PARTIDA", piParams))
		clear/e "CDF_PARTIDASVC"
		CD_EMPRESA.CDF_PARTIDASVC/init = $item("CD_EMPPARTIDA", piParams)
		NR_PARTIDA.CDF_PARTIDASVC/init = $item("NR_PARTIDA", piParams)
		retrieve/e "CDF_PARTIDASVC"
		if($status &lt; 0)
			return(0)
		endif
	endif

	if ($item("TP_VINCULO", piParams) = 1)
		;- Quando não for emissão complementar deve validar se a partida já possui emissão.
		clear/e "CDF_PARTIDAEMISSAOSVC"
		TP_EMISSAO.CDF_PARTIDAEMISSAOSVC = 1 ;- Normal
		TP_SITUACAO.CDF_PARTIDAEMISSAOSVC = 1 ;- Normal
		retrieve/e "CDF_PARTIDAEMISSAOSVC"
		if ($status &gt;= 0)
			$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG39820", "DESCRICAO=A partida @@1@@ já possui emissão de receita normal!&uSEP;PARAMETRO=%%NR_PARTIDA.CDF_PARTIDASVC", "ADICIONAL=Operação-&gt;CDFSVCO038.relacionarEmissaoPartida")
			return(-1)
		endif
		clear/e "CDF_PARTIDAEMISSAOSVC"
	endif

	creocc "CDF_PARTIDAEMISSAOSVC", -1
	CD_EMPEMISSAO.CDF_PARTIDAEMISSAOSVC = $item("CD_EMPEMISSAO", piParams)
	NR_EMISSAO.CDF_PARTIDAEMISSAOSVC = $item("NR_EMISSAO", piParams)
	retrieve/o "CDF_PARTIDAEMISSAOSVC"
	if ($status = -7)
		retrieve/x "CDF_PARTIDAEMISSAOSVC"
	endif
	TP_EMISSAO.CDF_PARTIDAEMISSAOSVC = $item("TP_VINCULO", piParams)
	TP_SITUACAO.CDF_PARTIDAEMISSAOSVC = 1 ;- Normal
	CD_OPERADOR.CDF_PARTIDAEMISSAOSVC = $item("CD_USUARIO", $$gParamGlb)
	DT_CADASTRO.CDF_PARTIDAEMISSAOSVC = $datim
	$collhandle("CDF_PARTIDAEMISSAOSVC")-&gt;Salvar()
	if ($procerror)
		$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status &lt; 0)
		return(-1)
	endif

	;-&gt;HSGARCIA Proj 217/610 10/08/2017
	if(TP_EMISSAO.CDF_PARTIDAEMISSAOSVC = 1 &amp; $tpIntAcabamentoTextil$ &gt; 0 &amp; getInfTecConf("", CD_MAQUINA.CDF_PARTIDASVC, "", "", 4, 42) != "");-&gt;HSGARCIA Proj 217/664 03/11/17 -- ;-&gt;HSGARCIA Proj 253/378 DVAIND-1940 05/12/2018
		viParams = ""
		putitem/id viParams, "CD_EMPRESA", CD_EMPPARTIDA.CDF_PARTIDAEMISSAOSVC
		putitem/id viParams, "NR_PARTIDA", NR_PARTIDA.CDF_PARTIDAEMISSAOSVC
		putitem/id viParams, "CD_EMPEMISSAO", CD_EMPEMISSAO.CDF_PARTIDAEMISSAOSVC
		putitem/id viParams, "NR_EMISSAO", NR_EMISSAO.CDF_PARTIDAEMISSAOSVC
		activate "CDFSVCO039".enviarEmissao(viParams, "", $xCdErro$, $xCtxerro$)
		if ($procerror)
			$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status &lt; 0)
			return(-1)
		endif
	endif
	;&lt;-

	return(0)
end ;relacionarEmissaoPartida

;--------------------------------------
public operation alterarSituacaoPartida
	;-----------------------------------
	;&lt;-- DSantos Prj-&gt;217-239 26/04/2016 --&gt;
	params
		string piParams : IN
		string poParams : OUT
		string $xCdErro$ : OUT
		string $xCtxErro$ : OUT
	endparams
	variables
		boolean vInApontarQt
		numeric vTpEmissaoMaq
		handle vHandleInstance
		string viParams, voParams
	endvariables

	if(!inValidarParametro("CD_EMPRESA&uSEP;NR_PARTIDA&uSEP;TP_SITUACAO", piParams, "alterarSituacaoPartida"))
		return(-1)
	endif

	clear/e "CDF_PARTIDASVC"
	CD_EMPRESA.CDF_PARTIDASVC/init = $item("CD_EMPRESA", piParams)
	NR_PARTIDA.CDF_PARTIDASVC/init = $item("NR_PARTIDA", piParams)
	retrieve/e "CDF_PARTIDASVC"
	if ($status &lt; 0)
		return(0)
	endif

	if ($item("TP_SITUACAO", piParams) = 1)
		if (NR_ORDEM.CDF_PARTIDASVC != "")
			if (!inVerificarOrdemAnterior(NR_ORDEM.CDF_PARTIDASVC, CD_MAQUINA.CDF_PARTIDASVC, &lt;TRUE&gt;, poParams))
				return(-1)
			endif
			vTpEmissaoMaq = getMaqConfPar("TP_EMISSAO", CD_MAQUINA.CDF_PARTIDASVC)
			if(vTpEmissaoMaq = 1)
				$handleEntity$-&gt;consultar("CDF_PARTIDAEMISSAOSVC", "CD_EMPPARTIDA=%%CD_EMPRESA.CDF_PARTIDASVC&uSEP;NR_PARTIDA=%%NR_PARTIDA.CDF_PARTIDASVC&uSEP;TP_SITUACAO=1")
				if ($status &lt; 0)
					$instancehandle-&gt;setStatus(&lt;STS_ERRO&gt;, "MSG30687", "DESCRICAO=Ainda não foi realizado a emissão de receita, a partida não pode ser iniciada.", "ADICIONAL=Operação-&gt;CDFSVCO038.alterarSituacaoPartida")
					return(-1)
				endif
			elseif(vTpEmissaoMaq = 2)
				viParams = ""
				putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.CDF_PARTIDASVC
				putitem/id viParams, "NR_PARTIDA", NR_PARTIDA.CDF_PARTIDASVC
				newinstance "CDFSVCO038", vHandleInstance
				vHandleInstance-&gt;buscarReceitaPartida(viParams, voParams, $xCdErro$, $xCtxErro$)
				if ($procerror)
					$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
					return(-1)
				elseif ($status &lt; 0)
					return(-1)
				endif
				if($item("CD_RECEITA", voParams) != "")
					$handleEntity$-&gt;consultar("CDF_PARTIDAEMISSAOSVC", "CD_EMPPARTIDA=%%CD_EMPRESA.CDF_PARTIDASVC&uSEP;NR_PARTIDA=%%NR_PARTIDA.CDF_PARTIDASVC&uSEP;TP_SITUACAO=1")
					if ($status &lt; 0)
						$instancehandle-&gt;setStatus(&lt;STS_ERRO&gt;, "MSG30687", "DESCRICAO=Ainda não foi realizado a emissão de receita, a partida não pode ser iniciada.", "ADICIONAL=Operação-&gt;CDFSVCO038.alterarSituacaoPartida")
						return(-1)
					endif
				endif
			endif
		endif
		;- Quando for para reabrir uma partida, abre último tempo e libera todos os itens.
		if (!$empty("CDF_PARTIDAPTSVC"))
			sort/e "CDF_PARTIDAPTSVC", "NR_SEQTEMPO.CDF_PARTIDAPTSVC"
			setocc "CDF_PARTIDAPTSVC", -1
			DT_FIM.CDF_PARTIDAPTSVC = ""
			CD_OPERFIM.CDF_PARTIDAPTSVC = ""
			DT_OPERFIM.CDF_PARTIDAPTSVC = ""
			CD_OPERADOR.CDF_PARTIDAPTSVC = $item("CD_USUARIO", $$gParamGlb)
			DT_CADASTRO.CDF_PARTIDAPTSVC = $datim
		endif
		if (!$empty("CDF_PARTIDAISVC"))
			setocc "CDF_PARTIDAISVC", 1
			while ($status &gt;= 0)
				IN_ENCERRADO.CDF_PARTIDAISVC = &lt;FALSE&gt;
				setocc "CDF_PARTIDAISVC", $curocc ("CDF_PARTIDAISVC") + 1
			endwhile
		endif
	elseif ($item("TP_SITUACAO", piParams) = 4)
		if (NR_ORDEM.CDF_PARTIDASVC != "")
			if (!inVerificarOrdemAnterior(NR_ORDEM.CDF_PARTIDASVC, CD_MAQUINA.CDF_PARTIDASVC, &lt;FALSE&gt;, poParams))
				return(-1)
			endif
			vInApontarQt = getMaqConfPar("IN_QTPRODUZIDAFIN", CD_MAQUINA.CDF_PARTIDASVC)
			if (vInApontarQt)
				$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG39985", "DESCRICAO=Configuração da máquina obriga apontar quantidade produzida, encerramento não permitido por este componente!", "ADICIONAL=Operação-&gt;CDFSVCO038.alterarSituacaoPartida")
				return(-1)
			endif
		endif

		;- Quando for encerrar a partida, fecha o último tempo e encerra todos os itens.
		if (!$empty("CDF_PARTIDAPTSVC"))
			sort/e "CDF_PARTIDAPTSVC", "NR_SEQTEMPO.CDF_PARTIDAPTSVC"
			setocc "CDF_PARTIDAPTSVC", -1
			if (DT_FIM.CDF_PARTIDAPTSVC = "")
				DT_FIM.CDF_PARTIDAPTSVC = $datim
				CD_OPERFIM.CDF_PARTIDAPTSVC = $item("CD_USUARIO", $$gParamGlb)
				DT_OPERFIM.CDF_PARTIDAPTSVC = $datim
				CD_OPERADOR.CDF_PARTIDAPTSVC = $item("CD_USUARIO", $$gParamGlb)
				DT_CADASTRO.CDF_PARTIDAPTSVC = $datim
			endif
		endif
		if (!$empty("CDF_PARTIDAISVC"))
			setocc "CDF_PARTIDAISVC", 1
			while ($status &gt;= 0)
				IN_ENCERRADO.CDF_PARTIDAISVC = &lt;TRUE&gt;
				setocc "CDF_PARTIDAISVC", $curocc ("CDF_PARTIDAISVC") + 1
			endwhile
		endif
	endif

	if ($item("TP_SITUACAO", piParams) &gt; 1)
		NR_ORDEM.CDF_PARTIDASVC = ""
	endif
	TP_SITUACAO.CDF_PARTIDASVC = $item("TP_SITUACAO", piParams)
	CD_OPERADOR.CDF_PARTIDASVC = $item("CD_USUARIO", $$gParamGlb)
	DT_CADASTRO.CDF_PARTIDASVC = $datim
	$collhandle("CDF_PARTIDASVC")-&gt;Salvar()
	if ($procerror)
		$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status &lt; 0)
		return(-1)
	endif

	if (TP_SITUACAO.CDF_PARTIDASVC &gt; 1 &amp; CD_MAQUINA.CDF_PARTIDASVC != "")
		viParams = ""
		putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.CDF_PARTIDASVC
		putitem/id viParams, "CD_MAQUINA", CD_MAQUINA.CDF_PARTIDASVC
		newinstance "CDFSVCO038", vHandleInstance
		vHandleInstance-&gt;reordenarPartida(viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)
			$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status &lt; 0)
			return(-1)
		endif
	endif

	if (!$empty("CDF_PARTIDAEMISSAOSVC"))
		setocc "CDF_PARTIDAEMISSAOSVC", 1
		while ($status &gt;= 0)
			viParams = ""
			putitem/id viParams, "CD_EMPRESA", CD_EMPEMISSAO.CDF_PARTIDAEMISSAOSVC
			putitem/id viParams, "NR_EMISSAO", NR_EMISSAO.CDF_PARTIDAEMISSAOSVC
			if ($item("TP_SITUACAO", piParams) = 6)
				putitem/id viParams, "TP_SITUACAO", "06" ;- Inativo
			else
				putitem/id viParams, "TP_SITUACAO", "01" ;- Ativo
			endif
			newinstance "CDFSVCO038", vHandleInstance
			vHandleInstance-&gt;alterarSituacaoEmissao(viParams, voParams, $xCdErro$, $xCtxErro$)
			if ($procerror)
				$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
				return(-1)
			elseif ($status &lt; 0)
				return(-1)
			endif
			setocc "CDF_PARTIDAEMISSAOSVC", $curocc("CDF_PARTIDAEMISSAOSVC") + 1
		endwhile
	endif

	;-&gt;HSGARCIA Proj 217/610 10/08/2017
	if($item("TP_SITUACAO", piParams) = 6 &amp; $tpIntAcabamentoTextil$ &gt; 0 &amp; getInfTecConf("", CD_MAQUINA.CDF_PARTIDASVC, "", "", 4, 42) != "");-&gt;HSGARCIA Proj 217/664 03/11/17 -- ;-&gt;HSGARCIA Proj 253/378 DVAIND-1940 05/12/2018
		viParams = ""
		putitem/id viParams, "CD_EMPRESA", $item("CD_EMPRESA", piParams)
		putitem/id viParams, "NR_PARTIDA", $item("NR_PARTIDA", piParams)
		activate "CDFSVCO039".cancelarPartida(viParams, voParams, $xCdErro$, $xCtxerro$)
		if ($procerror)
			$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status &lt; 0)
			$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $xCdErro$, $xCtxErro$, "")
			return(-1)
		endif
	endif
	;&lt;-

	return(0)
end ;alterarSituacaoPartida

;--------------------------------------
public operation alterarSituacaoEmissao
	;-----------------------------------
	;&lt;-- DSantos Prj-&gt;217-239 26/04/2016 --&gt;
	params
		string piParams : IN
		string poParams : OUT
		string $xCdErro$ : OUT
		string $xCtxErro$ : OUT
	endparams
	variables
		string vDsParams, vDsRegistro, viParams, vDsCondicao, vDsLstMov, vDsAux
	endvariables

	if(!inValidarParametro("CD_EMPRESA&uSEP;NR_EMISSAO&uSEP;TP_SITUACAO", piParams, "alterarSituacaoEmissao"))
		return(-1)
	endif

	clear/e "TEX_RECEMISSASVC"
	CD_EMPRESA.TEX_RECEMISSASVC/init = $item("CD_EMPRESA", piParams)
	NR_EMISSAO.TEX_RECEMISSASVC/init = $item("NR_EMISSAO", piParams)
	retrieve/e "TEX_RECEMISSASVC"
	if ($status &lt; 0)
		return(0)
	endif

	if (TP_SITUACAO.TEX_RECEMISSASVC = $item("TP_SITUACAO", piParams))
		return(0)
	endif
	clear/e "TMP_K06NRDTSVC"

	vDsParams = ""
	putitem/id vDsParams, "CD_EMPEMISSAO", CD_EMPRESA.TEX_RECEMISSASVC
	putitem/id vDsParams, "NR_EMISSAO", NR_EMISSAO.TEX_RECEMISSASVC
	$handleEntity$-&gt;consultar("CDF_PARTIDAEMISSAOSVC", vDsParams)
	if ($status &gt;= 0)
		$handleEntity$-&gt;getRegistro(vDsRegistro)
		clear/e "CDF_PARTIDASVC"
		CD_EMPRESA.CDF_PARTIDASVC/init = $item("CD_EMPPARTIDA", vDsRegistro)
		NR_PARTIDA.CDF_PARTIDASVC/init = $item("NR_PARTIDA", vDsRegistro)
		retrieve/e "CDF_PARTIDASVC"
		if ($status &gt;= 0)
			if ($item("TP_SITUACAO", piParams) != 6 &amp; TP_SITUACAO.CDF_PARTIDASVC = 6)
				;- Quando não for inativar a emissão, verifica se está relacionada a uma partida cancelada.
				$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG39987", "DESCRICAO=Alteração não permitda pois a emissão está vinculada a uma partida cancelada!", "ADICIONAL=Operação-&gt;CDFSVCO038.alterarSituacaoEmissao")
				return(-1)
			;--&lt; MNSANTOS - Prj 217/330 - 15/08/2016
			;elseif ($item("TP_SITUACAO", piParams) = 6 &amp; TP_SITUACAO.CDF_PARTIDASVC != 6)
			;	;- Quando for inativar a emissão, verifica se está relacionada a uma partida não cancelada
			;	$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG39988", "DESCRICAO=Alteração não permitda pois a emissão está vinculada a uma partida não cancelada!", "ADICIONAL=Operação-&gt;CDFSVCO038.alterarSituacaoEmissao")
			;	return(-1)
			;--&lt; MNSANTOS
			endif

			if ($item("TP_SITUACAO", piParams) = 6 | $item("TP_SITUACAO", piParams) = 1)
				clear/e "CDF_PARTIDAEMISSAOSVC"
				CD_EMPEMISSAO.CDF_PARTIDAEMISSAOSVC = CD_EMPRESA.TEX_RECEMISSASVC
				NR_EMISSAO.CDF_PARTIDAEMISSAOSVC = NR_EMISSAO.TEX_RECEMISSASVC
				retrieve/e "CDF_PARTIDAEMISSAOSVC"
				if ($status &gt;= 0)
					if ($item("TP_SITUACAO", piParams) = 6)
						TP_SITUACAO.CDF_PARTIDAEMISSAOSVC = 2 ;- Cancelado
					else
						TP_SITUACAO.CDF_PARTIDAEMISSAOSVC = 1 ;- Normal
					endif
					CD_OPERADOR.CDF_PARTIDAEMISSAOSVC = $item("CD_USUARIO", $$gParamGlb)
					DT_CADASTRO.CDF_PARTIDAEMISSAOSVC = $datim
					$collhandle("CDF_PARTIDAEMISSAOSVC")-&gt;Salvar()
					if ($procerror)
						$instancehandle-&gt;setStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
						return(-1)
					elseif ($status &lt; 0)
						return(-1)
					endif
				endif
			endif
			;--&gt; MNSANTOS - Prj 217/623 - 11/09/2017
			if($item("TP_SITUACAO", piParams) = 6 &amp; $dsLstLocalEmiRec$ != "" &amp; !$empty("CDF_PARTIDAISVC") &amp; $item("IN_NAOESTORNARMOVIMENTO", piParams) != &lt;TRUE&gt;) ;Inativo
				vDsLstMov = ""
				setocc "CDF_PARTIDAISVC", 1
				while($status &gt;= 0)
					vDsCondicao = ""
					putitem/id vDsCondicao, "CD_EMPRESA", CD_EMPOP.CDF_PARTIDAISVC
					putitem/id vDsCondicao, "NR_CICLO", NR_CICLO.CDF_PARTIDAISVC
					putitem/id vDsCondicao, "NR_OP", NR_OP.CDF_PARTIDAISVC
					putitem/id vDsCondicao, "CD_PRODUTO", CD_PRODUTO.CDF_PARTIDAISVC
					$handleConsulta$-&gt;consultar("V_CDF_LOCOPLOSVC", vDsCondicao)
					if($status &gt;= 0)
						$handleConsulta$-&gt;setEntityOcc(-1)
						$handleConsulta$-&gt;setEntityOcc(1)
						if(getTotOcc($handleConsulta$) &gt; 1)
							vDsLstMov = ""
							break
						endif
						$handleConsulta$-&gt;getRegistro(vDsRegistro)
						if($item("QT_LOTE", vDsRegistro) &gt; 0 &amp; $item("QT_SEMLOTE", vDsRegistro) &gt; 0)
							vDsLstMov = ""
							break
						endif

						$handleConsulta$-&gt;getPreviousReg(vDsAux)
						if($item("CD_EMPRESA", vDsRegistro) != $item("CD_EMPRESA", vDsAux) | $item("NR_CICLO", vDsRegistro) != $item("NR_CICLO", vDsAux) | $item("NR_OP", vDsRegistro) != $item("NR_OP", vDsAux))
							vDsCondicao = ""
							putitem/id vDsCondicao, "CD_EMPRESA", $item("CD_EMPRESA", vDsRegistro)
							putitem/id vDsCondicao, "NR_CICLO", $item("NR_CICLO", vDsRegistro)
							putitem/id vDsCondicao, "NR_OP", $item("NR_OP", vDsRegistro)
							;putitem/id vDsCondicao, "IN_ESTORNO", $concat(&lt;FALSE&gt;, "&uOR;&uEQ;");&lt;-- LOMoreira Prj-&gt;217-689 13/12/2017 --&gt;
							putitem/id vDsCondicao, "IN_ESTORNO", "&uNOT;&uEQ;T";&lt;-- LOMoreira Prj-&gt;217-689 13/12/2017 --&gt;
							$handleConsulta$-&gt;consultar("CDF_MOVOPCSVC", vDsCondicao)
							if($status &gt;= 0)
								$handleConsulta$-&gt;sortEntity("DT_MOVIMENTO.CDF_MOVOPCSVC, NR_SEQMOV.CDF_MOVOPCSVC")
								$handleConsulta$-&gt;setEntityOcc(-1)
								$handleConsulta$-&gt;getRegistro(vDsAux)
								if($item("CD_LOCALORIGEM", vDsAux) != "" &amp; $item($item("CD_LOCALORIGEM", vDsAux), $dsLstLocalEmiRec$) != "")
									;--&gt; MNSANTOS - Prj 217/763 - 21/03/2018
									creocc "TMP_K06NRDTSVC", -1
									NR_CHAVE01.TMP_K06NRDTSVC = $item("CD_EMPRESA", vDsAux)
									NR_CHAVE02.TMP_K06NRDTSVC = $item("NR_CICLO", vDsAux)
									NR_CHAVE03.TMP_K06NRDTSVC = $item("NR_OP", vDsAux)
									NR_CHAVE04.TMP_K06NRDTSVC = $item("NR_SEQMOV", vDsAux)
									NR_CHAVE05.TMP_K06NRDTSVC = 0
									DT_CHAVE06.TMP_K06NRDTSVC = $item("DT_MOVIMENTO", vDsAux)
									retrieve/o "TMP_K06NRDTSVC"
									;--&lt; MNSANTOS
									;putitem vDsLstMov, -1, vDsAux
								endif
							endif
						endif
					endif
					setocc "CDF_PARTIDAISVC", $curocc("CDF_PARTIDAISVC") + 1
				endwhile

				;--&gt; MNSANTOS - Prj 217/763 - 21/03/2018
				if(!$empty("TMP_K06NRDTSVC"))
					setocc "TMP_K06NRDTSVC", 1
					while($status &gt;= 0)
						viParams = ""
						putitem/id viParams, "CD_EMPRESA", NR_CHAVE01.TMP_K06NRDTSVC
						putitem/id viParams, "NR_CICLO", NR_CHAVE02.TMP_K06NRDTSVC
						putitem/id viParams, "NR_OP", NR_CHAVE03.TMP_K06NRDTSVC
						putitem/id viParams, "DT_MOVIMENTO", DT_CHAVE06.TMP_K06NRDTSVC
						putitem/id viParams, "NR_SEQMOV", NR_CHAVE04.TMP_K06NRDTSVC
						activate "CDFSVCO025".estornaMovimento($$gParamGlb, viParams, "", $xCdErro$, $xCtxerro$)
						if ($procerror)
							$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
							return(-1)
						elseif ($status &lt; 0)
							return(-1)
						endif
						setocc "TMP_K06NRDTSVC", $curocc("TMP_K06NRDTSVC") + 1
					endwhile
				endif
				;--&lt; MNSANTOS
			endif
			;--&lt; MNSANTOS
		endif
	endif

	if ($item("TP_SITUACAO", piParams) = 6)
		if (!$empty("TEX_RECEMIMPSVC"))
			setocc "TEX_RECEMIMPSVC", 1
			while ($status &gt;= 0)
				if (DT_FECHAMENTO.TEX_RECEMIMPSVC != "" | QT_RETIRADA.TEX_RECEMIMPSVC &gt; QT_RETORNADA.TEX_RECEMIMPSVC)
					$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG39989", "DESCRICAO=Não é permitido inativar a emissão pois possui M.P. baixada e/ou retirada!", "ADICIONAL=Operação-&gt;CDFSVCO038.alterarSituacaoEmissao")
					return(-1)
				endif
				setocc "TEX_RECEMIMPSVC", $curocc("TEX_RECEMIMPSVC") + 1
			endwhile
		endif
	endif

	TP_SITUACAO.TEX_RECEMISSASVC = $item("TP_SITUACAO", piParams)
	CD_OPERADOR.TEX_RECEMISSASVC = $item("CD_USUARIO", $$gParamGlb)
	DT_CADASTRO.TEX_RECEMISSASVC = $datim
	$collhandle("TEX_RECEMISSASVC")-&gt;Salvar()
	if ($procerror)
		$instancehandle-&gt;setStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status &lt; 0)
		return(-1)
	endif

	;-&gt;HSGARCIA Proj 217/610 10/08/2017
	if($item("TP_SITUACAO", piParams) = 6 &amp; $tpIntAcabamentoTextil$ &gt; 0 &amp; !$empty("CDF_PARTIDASVC") &amp; getInfTecConf("", CD_MAQUINA.CDF_PARTIDASVC, "", "", 4, 42) != "");-&gt;HSGARCIA Proj 217/664 03/11/17 -- ;-&gt;HSGARCIA Proj 253/378 DVAIND-1940 05/12/2018
		viParams = ""
		putitem/id viParams, "CD_EMPRESA", CD_EMPRESA.CDF_PARTIDASVC
		putitem/id viParams, "NR_PARTIDA", NR_PARTIDA.CDF_PARTIDASVC
		putitem/id viParams, "CD_EMPEMISSAO", CD_EMPRESA.TEX_RECEMISSASVC
		putitem/id viParams, "NR_EMISSAO", NR_EMISSAO.TEX_RECEMISSASVC
		activate "CDFSVCO039".cancelarEmissao(viParams, "", $xCdErro$, $xCtxerro$)
		if ($procerror)
			$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status &lt; 0)
			$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $xCdErro$, $xCtxErro$, "")
			return(-1)
		endif
	endif
	;&lt;-

	return(0)
end ;alterarSituacaoEmissao

;----------------------------------
public operation limparTempoPartida
	;-------------------------------
	params
		numeric piCdEmpresa : IN
		numeric piNrPartida : IN
	endparams

	delitem/id $dsTempoPartida$, "%%piCdEmpresa%%piNrPartida"

	return(0)
end ;retirarTempoPartida

;------------------------------------------
partner operation adicionarRegistroEntidade
	;---------------------------------------
	;&lt;-- DSantos Prj-&gt;217-245 18/05/2016 --&gt;
	params
		string piDsRegistro : IN
		string piDsEntity : IN
	endparams
	variables
		string vDsFields, vDsField
	endvariables

	vDsFields = getEntityFields(piDsEntity, 2)
	while (vDsFields != "")
		vDsField = "%%$itemnr(1, vDsFields).%%piDsEntity"
		@vDsField = $item($itemnr(1, vDsFields), piDsRegistro)
		delitem vDsFields, 1
	endwhile

	return(0)
end ;adicionarRegistroEntidade

;--------------------------------------
public operation calcularConsumoProduto
	;-----------------------------------
	;&lt;-- DSantos Prj-&gt;217-243 16/05/2016 --&gt;
	params
		string piParams : IN
		string poParams : OUT
		string $xCdErro$ : OUT
		string $xCtxErro$ : OUT
	endparams
	variables
		string vDsLstFor
		numeric vQtConsumo
		boolean vInRetornarFor
	endvariables

	if (!inValidarParametro("CD_RECEITA&uSEP;NR_FASE&uSEP;NR_SEQOPER&uSEP;NR_SEQPRD&uSEP;CD_PRODUTO&uSEP;QT_PESO&uSEP;QT_VOLUME&uSEP;TP_CONSUMO", piParams, "calcularConsumoProduto"))
		return(-1)
	endif

	vDsLstFor = $item("DS_LSTFOR", piParams)
	if(vDsLstFor = "")
		vInRetornarFor = &lt;TRUE&gt;
	else
		vInRetornarFor = &lt;FALSE&gt;
	endif

	putitem/id piParams, "QT_VOLUME", calcularVolumeEmissao($item("QT_VOLUME", piParams), $item("QT_PESO", piParams), $item("CD_RECEITA", piParams), $item("NR_FASE", piParams), $item("QT_RELBANHO", piParams), $item("QT_LASTRO", piParams), $item("IN_DESCONSIDERARLASTRO", piParams))
	vQtConsumo = calcularConsumoProduto(piParams, vDsLstFor, poParams)

	if(vInRetornarFor)
		putitem/id poParams, "DS_LISTAFOR", vDsLstFor
	endif
	putitem/id poParams, "QT_TOTAL", vQtConsumo

	return(0)
end ;calcularConsumoProduto

;----------------------------------------
public operation recalcularConsumoEmissao
	;-------------------------------------
	;&lt;-- DSantos Prj-&gt;217-243 18/05/2016 --&gt;
	params
		string piParams : IN
		string poParams : OUT
		string $xCdErro$ : OUT
		string $xCtxErro$ : OUT
	endparams
	variables
		boolean vInExiste, vInRetornarFor, vInDesconsiderarLastro
		string vDsRegistro, viParams, voParams, vDsLstFor, vDsRegEmissao
		numeric vQtPeso, vPrCobertura, vQtRetirada
	endvariables

	if (!inValidarParametro("CD_EMPRESA&uSEP;NR_EMISSAO", piParams, "recalcularConsumoEmissao"))
		return(-1)
	endif

	clear

	vDsLstFor = $item("DS_LSTFOR", piParams)
	if (vDsLstFor != "")
		vInRetornarFor = &lt;FALSE&gt;
	else
		vInRetornarFor = &lt;TRUE&gt;
	endif

	clear/e "TEX_RECEMISSASVC"
	CD_EMPRESA.TEX_RECEMISSASVC/init = $item("CD_EMPRESA", piParams)
	NR_EMISSAO.TEX_RECEMISSASVC/init = $item("NR_EMISSAO", piParams)
	retrieve/e "TEX_RECEMISSASVC"
	if ($status &lt; 0)
		return(0)
	endif
	putlistitems/occ vDsRegEmissao, "TEX_RECEMISSASVC"

	setocc "TEX_RECEMIFASSVC", 1
	while (!$empty("TEX_RECEMIFASSVC"))
		setocc "TEX_RECEMIOPESVC", 1
		while (!$empty("TEX_RECEMIOPESVC"))
			setocc "TEX_RECEOPPRDSVC", 1
			while (!$empty("TEX_RECEOPPRDSVC"))
				creocc "TEX_RECEMIMPSVC", -1
				CD_PRODUTO.TEX_RECEMIMPSVC = CD_PRODUTO.TEX_RECEOPPRDSVC
				retrieve/o "TEX_RECEMIMPSVC"
				if ($status = -7)
					retrieve/x "TEX_RECEMIMPSVC"
					QT_ESTIMADA.TEX_RECEMIMPSVC -= QT_TOTAL.TEX_RECEOPPRDSVC
				elseif($status = 0)
					discard "TEX_RECEMIMPSVC"
				else
					QT_ESTIMADA.TEX_RECEMIMPSVC -= QT_TOTAL.TEX_RECEOPPRDSVC
				endif
				$collhandle("TEX_RECEOPPRDSVC")-&gt;Remover()
				if ($procerror)
					$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
					return(-1)
				elseif ($status &lt; 0)
					return(-1)
				endif
			endwhile
			while(!$empty("CDF_CFGRECEMIOPERSVC"))
				$collhandle("CDF_CFGRECEMIOPERSVC")-&gt;Remover()
				if ($procerror)
					$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
					return(-1)
				elseif ($status &lt; 0)
					return(-1)
				endif
			endwhile
			$collhandle("TEX_RECEMIOPESVC")-&gt;Remover()
			if ($procerror)
				$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
				return(-1)
			elseif ($status &lt; 0)
				return(-1)
			endif
		endwhile
		while(!$empty("CDF_CFGRECEMIFASESVC") &amp; $status &gt;= 0)
			if(getFieldData("CD_CAMPOADIC", "PCP_CFGINFTECSVC", "CD_CONF=35") = CD_TIPOCAMPO.CDF_CFGRECEMIFASESVC)
				vInDesconsiderarLastro = NR_CAMPO.CDF_CFGRECEMIFASESVC
				setocc "CDF_CFGRECEMIFASESVC", $curocc("CDF_CFGRECEMIFASESVC") + 1
			else
				$collhandle("CDF_CFGRECEMIFASESVC")-&gt;Remover()
				if ($procerror)
					$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
					return(-1)
				elseif ($status &lt; 0)
					return(-1)
				endif
			endif
		endwhile
		$collhandle("TEX_RECEMIFASSVC")-&gt;Remover()
		if ($procerror)
			$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status &lt; 0)
			return(-1)
		endif
	endwhile

	clear/e "TEX_RECEITASVC"
	CD_RECEITA.TEX_RECEITASVC/init = CD_RECEITA.TEX_RECEMISSASVC
	retrieve/e "TEX_RECEITASVC"
	if ($status &lt; 0)
		return(0)
	endif
	;--&gt; MNSANTOS - Prj 217/436 - 17/02/2017
	putitem/id viParams, "CD_RECEITA", CD_RECEITA.TEX_RECEITASVC
	activate "PCPSVCO043".validarReceita(viParams, voParams, $xCdErro$, $xCtxerro$)
	if ($procerror)
		$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status &lt; 0)
		return(-1)
	endif
	if ($item("DS_ERRO", voParams) != "")
		poParams = voParams
		return(0)
	endif

	if (!$empty("TEX_RECFASESVC"))
		setocc "TEX_RECFASESVC", 1
		while ($status &gt;= 0)
			vDsRegistro = ""
			putlistitems/occ vDsRegistro, "TEX_RECFASESVC"

			creocc "TEX_RECEMIFASSVC", -1
			NR_FASE.TEX_RECEMIFASSVC = $item("NR_FASE", vDsRegistro)
			vInExiste = getStatusExiste("TEX_RECEMIFASSVC")
			$instancehandle-&gt;adicionarRegistroEntidade(vDsRegistro, "TEX_RECEMIFASSVC")
			if (!vInExiste | !inRegBanco("TEX_RECEMIFASSVC"))
				CD_OPERADOR.TEX_RECEMIFASSVC = $item("CD_USUARIO", $$gParamGlb)
				DT_CADASTRO.TEX_RECEMIFASSVC = $datim
			endif

			vQtPeso = QT_PESO.TEX_RECEMISSASVC
			if ($item(NR_AGRUPADOR.TEX_RECEITASVC, $dsLstTpRecCampoConf$) != "")
				vPrCobertura = getCampoConfReceita(CD_RECEITA.TEX_RECFASESVC, NR_FASE.TEX_RECFASESVC, "", 3)
				if (vPrCobertura &gt; 0)
					vQtPeso = vQtPeso * (vPrCobertura / 100)
				endif

				if (!$empty("CDF_CFGRECFASESVC"))
					setocc "CDF_CFGRECFASESVC", 1
					while ($status &gt;= 0)
						vDsRegistro = ""
						putlistitems/occ vDsRegistro, "CDF_CFGRECFASESVC"
						creocc "CDF_CFGRECEMIFASESVC", -1
						NR_SEQUENCIA.CDF_CFGRECEMIFASESVC = $item("NR_SEQUENCIA", vDsRegistro)
						vInExiste = getStatusExiste("CDF_CFGRECEMIFASESVC")
						$instancehandle-&gt;adicionarRegistroEntidade(vDsRegistro, "CDF_CFGRECEMIFASESVC")
						if (!vInExiste | !inRegBanco("CDF_CFGRECEMIFASESVC"))
							CD_OPERADOR.CDF_CFGRECEMIFASESVC = $item("CD_USUARIO", $$gParamGlb)
							DT_CADASTRO.CDF_CFGRECEMIFASESVC = $datim
						endif
						setocc "CDF_CFGRECFASESVC", $curocc("CDF_CFGRECFASESVC") + 1
					endwhile
				endif
			endif

			if (!$empty("TEX_RECOPERSVC"))
				setocc "TEX_RECOPERSVC", 1
				while ($status &gt;= 0)
					vDsRegistro = ""
					putlistitems/occ vDsRegistro, "TEX_RECOPERSVC"

					creocc "TEX_RECEMIOPESVC", 1
					NR_SEQOPER.TEX_RECEMIOPESVC = $item("NR_SEQOPER", vDsRegistro)
					vInExiste = getStatusExiste("TEX_RECEMIOPESVC")
					$instancehandle-&gt;adicionarRegistroEntidade(vDsRegistro, "TEX_RECEMIOPESVC")
					if (!vInExiste | !inRegBanco("TEX_RECEMIOPESVC"))
						CD_OPERADOR.TEX_RECEMIOPESVC = $item("CD_USUARIO", $$gParamGlb)
						DT_CADASTRO.TEX_RECEMIOPESVC = $datim
					endif

					if ($item(NR_AGRUPADOR.TEX_RECEITASVC, $dsLstTpRecCampoConf$) != "")
						if (!$empty("CDF_CFGRECOPERSVC"))
							setocc "CDF_CFGRECOPERSVC", 1
							while ($status &gt;= 0)
								vDsRegistro = ""
								putlistitems/occ vDsRegistro, "CDF_CFGRECOPERSVC"
								creocc "CDF_CFGRECEMIOPERSVC", -1
								NR_SEQUENCIA.CDF_CFGRECEMIOPERSVC = $item("NR_SEQUENCIA", vDsRegistro)
								vInExiste = getStatusExiste("CDF_CFGRECEMIOPERSVC")
								$instancehandle-&gt;adicionarRegistroEntidade(vDsRegistro, "CDF_CFGRECEMIOPERSVC")
								if (!vInExiste | !inRegBanco("CDF_CFGRECEMIOPERSVC"))
									CD_OPERADOR.CDF_CFGRECEMIOPERSVC = $item("CD_USUARIO", $$gParamGlb)
									DT_CADASTRO.CDF_CFGRECEMIOPERSVC = $datim
								endif
								setocc "CDF_CFGRECOPERSVC", $curocc("CDF_CFGRECOPERSVC") + 1
							endwhile
						endif
					endif

					if (!$empty("TEX_RECOPERPRSVC"))
						setocc "TEX_RECOPERPRSVC", 1
						while ($status &gt;= 0)
							vDsRegistro = ""
							putlistitems/occ vDsRegistro, "TEX_RECOPERPRSVC"

							creocc "TEX_RECEOPPRDSVC", -1
							NR_SEQPRD.TEX_RECEOPPRDSVC = $item("NR_SEQPRD", vDsRegistro)
							vInExiste = getStatusExiste("TEX_RECEOPPRDSVC")
							$instancehandle-&gt;adicionarRegistroEntidade(vDsRegistro, "TEX_RECEOPPRDSVC")

							viParams = ""
							putitem/id viParams, "CD_RECEITA", CD_RECEITA.TEX_RECOPERPRSVC
							putitem/id viParams, "NR_FASE", NR_FASE.TEX_RECOPERPRSVC
							putitem/id viParams, "NR_SEQOPER", NR_SEQOPER.TEX_RECOPERPRSVC
							putitem/id viParams, "NR_SEQPRD", NR_SEQPRD.TEX_RECOPERPRSVC
							putitem/id viParams, "CD_PRODUTO", CD_PRODUTO.TEX_RECOPERPRSVC
							putitem/id viParams, "QT_PESO", vQtPeso
							putitem/id viParams, "QT_VOLUME", calcularVolumeEmissao(QT_VOLUME.TEX_RECEMISSASVC, vQtPeso, CD_RECEITA.TEX_RECFASESVC, NR_FASE.TEX_RECFASESVC, QT_RELBANHO.TEX_RECFASESVC, "", vInDesconsiderarLastro)
							putitem/id viParams, "TP_CONSUMO", TP_CONSUMO.TEX_RECOPERPRSVC
							putitem/id viParams, "QT_CONSUMO", QT_CONSUMO.TEX_RECOPERPRSVC
							;&lt;-- DSantos Prj-&gt;217-289 04/07/2016
							putitem/id viParams, "QT_PRODUTO", $item("QT_PRODUTO", DS_INFO.TEX_RECEMISSASVC)
							putitem/id viParams, "CD_TPUTILIZACAO", $item("CD_TPUTILIZACAO", DS_INFO.TEX_RECEMISSASVC)
							putitem/id viParams, "DS_LSTTPUTILIZACAO", $item("DS_LSTTPUTILIZACAO", DS_INFO.TEX_RECEMISSASVC) ;--&gt; MNSANTOS - Prj 217/305 - 27/07/2016
							; DSantos --&gt;
							putitem/id viParams, "CD_MAQUINA", getMaquinaEmissao(vDsRegEmissao) ;&lt;-- DSantos Prj-&gt;217-511 02/06/2017 --&gt;
							QT_TOTAL.TEX_RECEOPPRDSVC = calcularConsumoProduto(viParams, vDsLstFor, poParams)
							if ($status &lt; 0)
								return(-1)
							endif

							if (!vInExiste | !inRegBanco("TEX_RECEOPPRDSVC"))
								CD_OPERADOR.TEX_RECEOPPRDSVC = $item("CD_USUARIO", $$gParamGlb)
								DT_CADASTRO.TEX_RECEOPPRDSVC = $datim
							endif

							if (TP_EMISSAO.TEX_RECEMISSASVC = 1)
								creocc "TEX_RECEMIMPSVC", -1
								CD_PRODUTO.TEX_RECEMIMPSVC = CD_PRODUTO.TEX_RECOPERPRSVC
								vInExiste = getStatusExiste("TEX_RECEMIMPSVC")
								if(!vInExiste)
									IN_FECHAMENTO.TEX_RECEMIMPSVC = &lt;FALSE&gt;
								endif
								QT_ESTIMADA.TEX_RECEMIMPSVC += QT_TOTAL.TEX_RECEOPPRDSVC
							endif

							setocc "TEX_RECOPERPRSVC", $curocc("TEX_RECOPERPRSVC") + 1
						endwhile
					endif

					setocc "TEX_RECOPERSVC", $curocc("TEX_RECOPERSVC") + 1
				endwhile
			endif

			setocc "TEX_RECFASESVC", $curocc("TEX_RECFASESVC") + 1
		endwhile
	endif

	setocc "TEX_RECEMIMPSVC", 1
	while ($status &gt;= 0)
		if (QT_ESTIMADA.TEX_RECEMIMPSVC &lt;= 0)
			if (IN_FECHAMENTO.TEX_RECEMIMPSVC)
				$instancehandle-&gt;setStatus(&lt;STS_ERRO&gt;, "MSG40050", "DESCRICAO=Matéria-prima @@1@@ da emissão @@2@@ está fechada, alteração não permitida!&uSEP;PARAMETRO=%%CD_PRODUTO.TEX_RECEMIMPSVC&uNOT;&uSEP;%%NR_EMISSAO.TEX_RECEMISSASVC", "ADICIONAL=Operação-&gt;CDFSVCO038.recalcularConsumoEmissao")
				return(-1)
			endif
 			vQtRetirada = QT_RETIRADA.TEX_RECEMIMPSVC - QT_RETORNADA.TEX_RECEMIMPSVC
			if (vQtRetirada &gt; 0)
				$instancehandle-&gt;setStatus(&lt;STS_ERRO&gt;, "MSG40052", "DESCRICAO=Matéria-prima @@1@@ da emissão @@2@@ foi removida e possui quantidade retirada sem retorno, alteração não permitida!&uSEP;PARAMETRO=%%CD_PRODUTO.TEX_RECEMIMPSVC&uNOT;&uSEP;%%NR_EMISSAO.TEX_RECEMISSASVC", "ADICIONAL=Operação-&gt;CDFSVCO038.recalcularConsumoEmissao")
				return(-1)
			endif
			$collhandle("TEX_RECEMIMPSVC")-&gt;Remover()
			if ($procerror)
				$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
				return(-1)
			elseif ($status &lt; 0)
				return(-1)
			endif
		else
			if (!inRegBanco("TEX_RECEMIMPSVC"))
				if (IN_FECHAMENTO.TEX_RECEMIMPSVC)
					$instancehandle-&gt;setStatus(&lt;STS_ERRO&gt;, "MSG40050", "DESCRICAO=Matéria-prima @@1@@ da emissão @@2@@ está fechada, alteração não permitida!&uSEP;PARAMETRO=%%CD_PRODUTO.TEX_RECEMIMPSVC&uNOT;&uSEP;%%NR_EMISSAO.TEX_RECEMISSASVC", "ADICIONAL=Operação-&gt;CDFSVCO038.recalcularConsumoEmissao")
					return(-1)
				endif
				CD_OPERADOR.TEX_RECEMIMPSVC = $item("CD_USUARIO", $$gParamGlb)
				DT_CADASTRO.TEX_RECEMIMPSVC = $datim
			endif
			setocc "TEX_RECEMIMPSVC", $curocc("TEX_RECEMIMPSVC") + 1
		endif
	endwhile

	$collhandle("TEX_RECEMISSASVC")-&gt;Salvar()
	if ($procerror)
		$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status &lt; 0)
		return(-1)
	endif

	if(vInRetornarFor)
		putitem/id poParams, "DS_LISTAFOR", vDsLstFor
	endif

	return(0)
end ;recalcularConsumoEmissao

;-------------------------------------
public operation getQtAlocarAgrupador
;-------------------------------------
	params
		string piParams : IN
		string poParams : OUT
		string $xCdErro$ : OUT
		string $xCtxErro$ : OUT
	endparams
	variables
		string vDsEntity
	endvariables

	if (!inValidarParametro("CD_EMPRESA&uSEP;NR_AGRUPADOR&uSEP;CD_PROCESSO&uSEP;CD_MAQUINA", piParams, "getQtAlocarAgrupador"))
		return(-1)
	endif

	if(getFieldData("TP_AGRUPAMENTO", "PCP_AGRUOPSVC", "CD_EMPRESA=%%$item("CD_EMPRESA", piParams)&uSEP;NR_AGRUPADOR=%%$item("NR_AGRUPADOR", piParams)") = 1)
		vDsEntity = "PCP_AGRUOPISVC"
	else
		vDsEntity = "PCP_AGRUOPILISVC"
	endif

	putitem/id poParams, "QT_ALOCAR", getQtAlocarAgrupador(piParams, $item("CD_PROCESSO", piParams), $item("CD_MAQUINA", piParams), vDsEntity, $item("IN_CONVERTER", piParams), "", "", "")

	return(0)
end ;getQtAlocarAgrupador

;-----------------------------------------
public operation validarProcessoDisponivel
;-----------------------------------------
	params
		string piParams : IN
		string poParams : OUT
		string $xCdErro$ : OUT
		string $xCtxErro$ : OUT
	endparams
	variables
		string viParams, vDsRegProcesso
	endvariables

	if (!inValidarParametro("CD_EMPRESA&uSEP;NR_CICLO&uSEP;NR_OP&uSEP;CD_PRODUTO&uSEP;CD_PROCESSO&uSEP;CD_MAQUINA", piParams, "validarProcessoDisponivel"))
		return(-1)
	endif

	viParams = ""
	putitem/id viParams, "CD_EMPRESA", $item("CD_EMPRESA", piParams)
	putitem/id viParams, "NR_CICLO", $item("NR_CICLO", piParams)
	putitem/id viParams, "NR_OP", $item("NR_OP", piParams)
	putitem/id viParams, "CD_PRODUTO", $item("CD_PRODUTO", piParams)
	vDsRegProcesso = getProcessoOp(viParams, $item("CD_PROCESSO", piParams), &lt;FALSE&gt;, &lt;TRUE&gt;)

	putitem/id viParams, "NR_LOTE", $item("NR_LOTE", piParams)
	putitem/id viParams, "NR_ITEM", $item("NR_ITEM", piParams)
	putitem/id viParams, "CD_PROCESSOANT", $item("CD_PROCESSO", vDsRegProcesso)
	putitem/id viParams, "CD_MAQUINA", $item("CD_MAQUINA", piParams)

	putitem/id poParams, "IN_DISPONIVEL", inProcessoDisponivel(viParams)

	return(0)
end ;validarProcessoDisponivel

;---------------------------------------------
public operation calcularConsumoReceitaProduto
	;------------------------------------------
	params
		string piParams : IN
		string poParams : OUT
		string $xCdErro$ : OUT
		string $xCtxErro$ : OUT
	endparams
	variables
		string viParams, voParams, vDsLstProc, vDsLstMp, vDsRegistro, vDsLstFase, vDsLstOper, vDsLstPrd, vDsRegReceita, vDsCondicao
		numeric vQtPeso, vQtVolume, vQtConsumo, vCdMaquina, vQtProduto, vPrCobertura, vQtPesoIn
	endvariables

	if (!inValidarParametro("CD_PRODUTO", piParams, "calcularConsumoReceitaProduto"))
		return(-1)
	endif

	viParams = ""
	putitem/id viParams, "CD_PRODUTO", $item("CD_PRODUTO", piParams)
	vDsLstProc = $item("DS_LSTSEQPROC", piParams) ;&lt;-- LOMoreira Prj-&gt;217-670 10/10/2017 --&gt;
	if (vDsLstProc = "")
		putitem/id viParams, "IN_PROCREC", &lt;TRUE&gt;
		activate "CDFSVCO030".buscarSeqProc(viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)
			$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status &lt; 0)
			return(-1)
		endif
		vDsLstProc = $item("DS_LSTSEQPROC",voParams)
	endif

	if(vDsLstProc = "")
		return(0)
	endif

	vQtProduto = $item("QT_PRODUTO", piParams) ;&lt;-- LOMoreira Prj-&gt;217-670 10/10/2017 --&gt;
	if (vQtProduto = 0)
		vQtProduto = 1
	endif

	vQtPesoIn = converterQtProduto(viParams, vQtProduto, "MULP")
	if ($status &lt; 0)
		return(-1)
	endif

	;&lt;-- LOMoreira Prj-&gt;217-670 13/11/2017 --&gt;
	vDsLstMp	= ""
	while (vDsLstProc != "")

		vDsCondicao = ""
		putitem/id vDsCondicao, "CD_SEQMAQ", $item("CD_SEQMAQ", $itemnr(1, vDsLstProc))
		vCdMaquina = getFieldData("CD_MAQUINA", "CDF_MAQGMAQSVC", vDsCondicao)

		viParams = ""
		putitem/id viParams, "CD_MAQUINA", vCdMaquina
		putitem/id viParams, "CD_RECEITA", $item("CD_RECEITA", $itemnr(1, vDsLstProc))
		vQtVolume = converterQtProduto(viParams, vQtPesoIn, "VOLUME")
		if (vQtVolume = 0)
			vQtVolume = getFieldData("QT_VOLUMEIDEAL", "CDF_GMAQBENSVC", vDsCondicao)
		endif

		viParams = ""
		putitem/id viParams, "CD_RECEITA", $item("CD_RECEITA", $itemnr(1, vDsLstProc))
		activate "PCPSVCO043".buscarFaseReceita(viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)
			$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status &lt; 0)
			return(-1)
		endif
		vDsRegReceita = $item("DS_RECEITA", voParams)
		vDsLstFase = $item("DS_LSTFASE", vDsRegReceita)
		while (vDsLstFase != "")

			vQtPeso = vQtPesoIn
			if ($item($item("NR_AGRUPADOR", vDsRegReceita), $dsLstTpRecCampoConf$) != "" | $tpManutencaoFaseRec$ &gt; 0)
				vPrCobertura = getCampoConfReceita($item("CD_RECEITA", vDsRegReceita), $item("NR_FASE", $itemnr(1, vDsLstFase)), "", 3)
				if (vPrCobertura &gt; 0)
					vQtPeso = vQtPesoIn * (vPrCobertura / 100)
				endif
			endif

			vDsLstOper = $item("DS_LSTOPER", $itemnr(1, vDsLstFase))
			while (vDsLstOper != "")

				vDsLstPrd = $item("DS_LSTPRD", $itemnr(1, vDsLstOper))
				while (vDsLstPrd != "")

					viParams = ""
					putitem/id viParams, "CD_RECEITA", $item("CD_RECEITA", vDsRegReceita)
					putitem/id viParams, "NR_FASE", $item("NR_FASE", $itemnr(1, vDsLstFase))
					putitem/id viParams, "NR_SEQOPER", $item("NR_SEQOPER", $itemnr(1, vDsLstOper))
					putitem/id viParams, "NR_SEQPRD", $item("NR_SEQPRD", $itemnr(1, vDsLstPrd))
					putitem/id viParams, "CD_PRODUTO", $item("CD_PRODUTO", $itemnr(1, vDsLstPrd))
					putitem/id viParams, "QT_PESO", vQtPeso
					putitem/id viParams, "QT_VOLUME", calcularVolumeEmissao(vQtVolume, vQtPeso, $item("CD_RECEITA", $itemnr(1, vDsLstProc)), $item("NR_FASE", $itemnr(1, vDsLstFase)), $item("QT_RELBANHO", $itemnr(1, vDsLstFase)), "", &lt;FALSE&gt;)
					putitem/id viParams, "TP_CONSUMO", $item("TP_CONSUMO", $itemnr(1, vDsLstPrd))
					putitem/id viParams, "QT_CONSUMO", $item("QT_CONSUMO", $itemnr(1, vDsLstPrd))
					putitem/id viParams, "CD_TPUTILIZACAO", $item("CD_TPUTILIZACAO", $itemnr(1, vDsLstProc))
					putitem/id viParams, "DS_LSTTPUTILIZACAO", getDsLstTipoUtilizacao($itemnr(1, vDsLstProc))
					putitem/id viParams, "QT_PRODUTO", vQtProduto
					putitem/id viParams, "CD_MAQUINA", vCdMaquina
					putitem/id viParams, "IN_FASEPADRAO", $item("IN_FASEPADRAO", vDsRegReceita)
					putitem/id viParams, "IN_RECEITAPARTIDA", &lt;FALSE&gt;
					putitem/id viParams, "DS_LSTPRDCORANTE", $item("DS_LSTPRDCORANTE", vDsRegReceita)
					putitem/id viParams, "QT_REPETICAO", $item("QT_REPETICAO", $itemnr(1, vDsLstPrd))

					vQtConsumo = calcularConsumoProduto(viParams, "", poParams)
					if ($status &lt; 0)
						return(-1)
					endif

					vQtConsumo += $item($item("CD_PRODUTO", $itemnr(1, vDsLstPrd)), vDsLstMp)
					putitem/id vDsLstMp, $item("CD_PRODUTO", $itemnr(1, vDsLstPrd)), vQtConsumo

					delitem vDsLstPrd, 1
				endwhile

				delitem vDsLstOper, 1
			endwhile

			delitem vDsLstFase, 1
		endwhile

		delitem vDsLstProc, 1
	endwhile
	;&lt;-- LOMoreira Prj-&gt;217-670 13/11/2017 --&gt;

	putitem/id poParams, "DS_LSTMP", vDsLstMp
	return(0)
end ;calcularConsumoReceitaProduto

;----------------------------------
public operation buscarConsumoFaixa
	;-------------------------------
	params
		string piParams : IN
		string poParams : OUT
		string $xCdErro$ : OUT
		string $xCtxErro$ : OUT
	endparams
	variables
		string vDsListaFor, vDsCondicao, vDsRegistro, vDsListaPrd, vDsLstCorante
		numeric vPrCorante, vCdCorantePrincipal, vQtRepeticao, vQtConsumo
	endvariables

	if (!inValidarParametro("CD_RECEITA&uSEP;NR_FASE&uSEP;CD_PRODUTO", piParams, "buscarConsumoFaixa"))
		return(-1)
	endif

	vDsListaFor = $item("DS_LSTFOR", piParams)
	while (vDsListaFor != "")
		creocc "TMP_K03NRSVC", -1
		NR_CHAVE01.TMP_K03NRSVC/init = $item("CD_RECEITA", $itemnr(1, vDsListaFor))
		NR_CHAVE02.TMP_K03NRSVC/init = $item("NR_FASE", $itemnr(1, vDsListaFor))
		NR_CHAVE03.TMP_K03NRSVC/init = $item("CD_PRODUTO", $itemnr(1, vDsListaFor))
		retrieve/o "TMP_K03NRSVC"
		if($status &lt; 0)
			discard "TMP_K03NRSVC"
		endif
		CD_FORNECEDOR.TMP_K03NRSVC/init = $item("CD_FORNECEDOR", $itemnr(1, vDsListaFor))
		delitem vDsListaFor, 1
	endwhile

	if ($item("IN_FASEPADRAO", piParams) = &lt;TRUE&gt; | $item("IN_RECEITAPARTIDA", piParams) = &lt;TRUE&gt;)
		;&lt;-- DSantos Prj-&gt;217-641 26/09/2017
		if ($item("IN_RECEITAPARTIDA", piParams) = &lt;TRUE&gt;)
			vQtRepeticao = $item("QT_REPETICAO", piParams)
			vDsLstCorante = $item("DS_LSTPRDCORANTE", piParams)
			while (vDsLstCorante != "")
				vQtConsumo = $item("QT_CONSUMO", $itemnr(1, vDsLstCorante))
				if ($item("TP_CONSUMO", $itemnr(1, vDsLstCorante)) = 1)
					vPrCorante += vQtConsumo / 10
				elseif ($item("TP_CONSUMO", $itemnr(1, vDsLstCorante)) = 3)
					vPrCorante += vQtConsumo
				endif
				if ($item("IN_PRINCIPAL", $itemnr(1, vDsLstCorante)) = &lt;TRUE&gt;)
					vCdCorantePrincipal = $item("CD_PRODUTO", $itemnr(1, vDsLstCorante))
				endif
				delitem vDsLstCorante, 1
			endwhile
		; DSantos --&gt;
		else
			vDsCondicao = ""
			putitem/id vDsCondicao, "NR_FASE", $item("NR_FASE", piParams)
			putitem/id vDsCondicao, "CD_PRODUTO", $item("CD_PRODUTO", piParams)
			$handleEntity$-&gt;consultar("TEX_FPADOPERPSVC", vDsCondicao)
			if ($status &gt;= 0)
				$handleEntity$-&gt;setEntityOcc(-1)
				vQtRepeticao = getTotOcc($handleEntity$)
			endif

			vDsCondicao = ""
			putitem/id vDsCondicao, "CD_RECEITA", $item("CD_RECEITA", piParams)
			$handleEntity$-&gt;consultar("TEX_RECEITAPRDSVC", vDsCondicao)
			if ($status &gt;= 0)
				$handleEntity$-&gt;setEntityOcc(1)
				while ($status &gt;= 0)
					$handleEntity$-&gt;getRegistro(vDsRegistro)
					vQtConsumo = calcularCompensacaoProduto($item("CD_PRODUTO", vDsRegistro), $item("CD_MAQUINA", piParams), $item("QT_PESO", piParams), $item("QT_VOLUME", piParams), $item("QT_CONSUMO", vDsRegistro), &lt;FALSE&gt;, $item("CD_RECEITA", piParams))
					if ($item("TP_CONSUMO", vDsRegistro) = 1)
						vPrCorante += vQtConsumo / 10
					elseif ($item("TP_CONSUMO", vDsRegistro) = 3)
						vPrCorante += vQtConsumo
					endif
					if ($item("IN_PRINCIPAL", vDsRegistro) = &lt;TRUE&gt;)
						vCdCorantePrincipal = $item("CD_PRODUTO", vDsRegistro)
					endif
					$handleEntity$-&gt;next()
				endwhile
			endif
		endif

		clear/e "CDF_PRDCLARECSVC"
		CD_PRODUTO.CDF_PRDCLARECSVC/init = $item("CD_PRODUTO", piParams)
		retrieve/e "CDF_PRDCLARECSVC"
		if ($status &gt;= 0)
			setocc "CDF_PRDCLARECSVC", 1
			while ($status &gt;= 0)
				if (inClassificacaoProduto(vCdCorantePrincipal, CD_TIPOCLAS.CDF_PRDCLARECSVC, CD_CLASSIFICACAO.CDF_PRDCLARECSVC))
					setocc "CDF_PRDCLAFORSVC", -1
					if ($totocc("CDF_PRDCLAFORSVC") &gt; 1)
						clear/e "CDF_PRDCLAFORSVC"
						CD_FORNECEDOR.CDF_PRDCLAFORSVC/init = getFornecedorPrincipal(vCdCorantePrincipal)
						retrieve/e "CDF_PRDCLAFORSVC"
						if ($status &gt;= 0)
							vDsRegistro = montarFaixaConsumoProduto($item("CD_PRODUTO", piParams), vPrCorante, vQtRepeticao)
							if (vDsRegistro != "")
								putitem vDsListaPrd, -1, vDsRegistro
							endif
						endif
					else
						vDsRegistro = montarFaixaConsumoProduto($item("CD_PRODUTO", piParams), vPrCorante, vQtRepeticao)
						if (vDsRegistro != "")
							putitem vDsListaPrd, -1, vDsRegistro
						endif
					endif
				endif
				setocc "CDF_PRDCLARECSVC", $curocc("CDF_PRDCLARECSVC") + 1
			endwhile
		endif
	else
		vQtRepeticao = ""
		clear/e "CDF_PRDCLARECSVC"
		CD_PRODUTO.CDF_PRDCLARECSVC/init = $item("CD_PRODUTO", piParams)
		IN_PRINCIPAL.CDF_PRDCLARECSVC/init = &lt;TRUE&gt;
		retrieve/e "CDF_PRDCLARECSVC"
		if ($status &gt;= 0)
			vDsCondicao = ""
			putitem/id vDsCondicao, "CD_RECEITA", $item("CD_RECEITA", piParams)
			putitem/id vDsCondicao, "NR_FASE", $item("NR_FASE", piParams)
			$handleEntity$-&gt;consultar("TEX_RECOPERPRSVC", vDsCondicao)
			if ($status &gt;= 0)
				$handleEntity$-&gt;setEntityOcc(1)
				while ($status &gt;= 0)
					$handleEntity$-&gt;getRegistro(vDsRegistro)
					if ($item("TP_CONSUMO", vDsRegistro) = 1 | $item("TP_CONSUMO", vDsRegistro) = 3)
						if (inClassificacaoProduto($item("CD_PRODUTO", vDsRegistro), CD_TIPOCLAS.CDF_PRDCLARECSVC, CD_CLASSIFICACAO.CDF_PRDCLARECSVC))
							vQtConsumo = calcularCompensacaoProduto($item("CD_PRODUTO", vDsRegistro), $item("CD_MAQUINA", piParams), $item("QT_PESO", piParams), $item("QT_VOLUME", piParams), $item("QT_CONSUMO", vDsRegistro), &lt;FALSE&gt;, $item("CD_RECEITA", piParams))
							if ($item("TP_CONSUMO", vDsRegistro) = 1)
								vPrCorante += vQtConsumo / 10
							elseif ($item("TP_CONSUMO", vDsRegistro) = 3)
								vPrCorante += vQtConsumo
							endif
						endif
					endif
					if ($item("CD_PRODUTO", vDsRegistro) = $item("CD_PRODUTO", piParams))
						vQtRepeticao += 1
					endif
					$handleEntity$-&gt;next()
				endwhile
			endif

			if (!$empty("CDF_PRDCLAFORSVC"))
				setocc "CDF_PRDCLAFORSVC", -1
				if ($totocc("CDF_PRDCLAFORSVC") &gt; 1)
					creocc "TMP_K03NRSVC", -1
					NR_CHAVE01.TMP_K03NRSVC/init = $item("CD_RECEITA", piParams)
					NR_CHAVE02.TMP_K03NRSVC/init = $item("NR_FASE", piParams)
					NR_CHAVE03.TMP_K03NRSVC/init = $item("CD_PRODUTO", piParams)
					retrieve/o "TMP_K03NRSVC"
					if ($status = 4)
						clear/e "CDF_PRDCLAFORSVC"
						CD_FORNECEDOR.CDF_PRDCLAFORSVC/init = CD_FORNECEDOR.TMP_K03NRSVC
						retrieve/e "CDF_PRDCLAFORSVC"
						if($status &lt; 0)
							clear/e "CDF_PRDCLAFORSVC"
							retrieve/e "CDF_PRDCLAFORSVC"
						else
							vDsRegistro = montarFaixaConsumoProduto($item("CD_PRODUTO", piParams), vPrCorante, vQtRepeticao)
							if (vDsRegistro != "")
								putitem vDsListaPrd, -1, vDsRegistro
							endif
						endif
					else
						discard "TMP_K03NRSVC", 1
						setocc "CDF_PRDCLAFORSVC", 1
						while ($status &gt;= 0)
							vDsRegistro = ""
							putitem/id vDsRegistro, "CD_RECEITA", $item("CD_RECEITA", piParams)
							putitem/id vDsRegistro, "NR_FASE", $item("NR_FASE", piParams)
							putitem/id vDsRegistro, "CD_PRODUTO", $item("CD_PRODUTO", piParams)
							putitem/id vDsRegistro, "CD_FORNECEDOR", CD_FORNECEDOR.CDF_PRDCLAFORSVC
							putitem/id vDsRegistro, "CD_TIPOCLAS", CD_TIPOCLAS.CDF_PRDCLARECSVC
							putitem/id vDsRegistro, "CD_CLASSIFICACAO", CD_CLASSIFICACAO.CDF_PRDCLARECSVC
							putitem/id vDsRegistro, "PR_TOTAL", vPrCorante
							putitem/id vDsRegistro, "QT_REPETICAO", vQtRepeticao
							putitem vDsListaFor, -1, vDsRegistro
							setocc "CDF_PRDCLAFORSVC", $curocc("CDF_PRDCLAFORSVC") + 1
						endwhile
					endif
				else
					vDsRegistro = montarFaixaConsumoProduto($item("CD_PRODUTO", piParams), vPrCorante, vQtRepeticao)
					if (vDsRegistro != "")
						putitem vDsListaPrd, -1, vDsRegistro
					endif
				endif
			endif
		endif
	endif

	putitem/id poParams, "DS_LISTAFOR", vDsListaFor
	putitem/id poParams, "DS_LSTPRODUTO", vDsListaPrd

	return(0)
end ;buscarConsumoFaixa

;-----------------------------
public operation armazenarLog
	;--------------------------
	;&lt;-- DSantos Prj-&gt;217-511 01/06/2017 --&gt;
	params
		numeric piNrMensagem : IN
		string piCdOrigem : IN
		numeric piNrIndice : IN
		numeric piNrResultado : IN
	endparams
	variables
		string vDsRegistro
	endvariables

	if ($item(piNrMensagem, $dsLstLogCalc$) != "")
		return(0)
	endif

	vDsRegistro = ""

	selectcase piNrMensagem
	case -1
		putitem/id vDsRegistro, "CD_RECEITA", piCdOrigem
		putitem/id vDsRegistro, "QT_RELBANHO", piNrResultado
	case -2, -6
		putitem/id vDsRegistro, "CD_MAQUINA", piCdOrigem
		putitem/id vDsRegistro, "QT_PESO", piNrIndice
		putitem/id vDsRegistro, "QT_RELBANHO", piNrResultado
	case -3
		putitem/id vDsRegistro, "CD_MAQUINA", piCdOrigem
		putitem/id vDsRegistro, "QT_CONE", piNrIndice
		putitem/id vDsRegistro, "QT_VOLUME", piNrResultado
	case -4
		putitem/id vDsRegistro, "CD_MAQUINA", piCdOrigem
		putitem/id vDsRegistro, "QT_RELBANHO", piNrResultado
	case -5
		putitem/id vDsRegistro, "QT_VOLUME", piNrResultado
	elsecase
		putitem/id vDsRegistro, "CD_PRODUTO", piNrMensagem
		putitem/id vDsRegistro, "CD_MAQUINA", piCdOrigem
		putitem/id vDsRegistro, "QT_RELBANHO", piNrIndice
		putitem/id vDsRegistro, "PR_VARIACAO", piNrResultado
	endselectcase

	if (vDsRegistro != "")
		putitem/id $dsLstLogCalc$, piNrMensagem, vDsRegistro
	endif

	return(0)
end ;armazenarLog

;---------------------------------
public operation contextualizarLog
	;------------------------------
	;&lt;-- DSantos Prj-&gt;217-511 01/06/2017 --&gt;
	params
		string poDsMensagem : OUT
	endparams
	variables
		string vDsLstLog, vDsRegistro, vDsMensagem
		numeric vNrMensagem
	endvariables

	vDsLstLog = $dsLstLogCalc$
	while (vDsLstLog != "")
		vNrMensagem = $idpart($itemnr(1, vDsLstLog))
		vDsRegistro = $valuepart($itemnr(1, vDsLstLog))

		selectcase vNrMensagem
		case -1
			vDsMensagem = " Volume calculado pela relação de banho da receita%%^"
			vDsMensagem = $concat(vDsMensagem, "	", "Receita...: ", $item("CD_RECEITA", vDsRegistro), "%%^")
			vDsMensagem = $concat(vDsMensagem, "	", "Rel. banho: ", formatarConteudo($item("QT_RELBANHO", vDsRegistro), "N=9;3"), "%%^")
		case -2
			vDsMensagem = " Volume calculado pela relação de banho em função do peso%%^"
			vDsMensagem = $concat(vDsMensagem, "	", "Máquina...: ", $item("CD_MAQUINA", vDsRegistro), "%%^")
			vDsMensagem = $concat(vDsMensagem, "	", "Peso......: ", formatarConteudo($item("QT_PESO", vDsRegistro), "N=9;3"), "%%^")
			vDsMensagem = $concat(vDsMensagem, "	", "Rel. banho: ", formatarConteudo($item("QT_RELBANHO", vDsRegistro), "N=9;3"), "%%^")
		case -3
			vDsMensagem = " Volume gerado em função da quantidade de cone%%^"
			vDsMensagem = $concat(vDsMensagem, "	", "Máquina: ", $item("CD_MAQUINA", vDsRegistro), "%%^")
			vDsMensagem = $concat(vDsMensagem, "	", "Cone...: ", formatarConteudo($item("QT_CONE", vDsRegistro), "N=9"), "%%^")
			vDsMensagem = $concat(vDsMensagem, "	", "Volume.: ", formatarConteudo($item("QT_VOLUME", vDsRegistro), "N=9;3"), "%%^")
		case -4
			vDsMensagem = " Volume calculado pela relação de banho ideal da máquina%%^"
			vDsMensagem = $concat(vDsMensagem, "	", "Máquina...: ", $item("CD_MAQUINA", vDsRegistro), "%%^")
			vDsMensagem = $concat(vDsMensagem, "	", "Rel. banho: ", formatarConteudo($item("QT_RELBANHO", vDsRegistro), "N=9;3"), "%%^")
		case -5
			vDsMensagem = " Volume sugerido de acordo com o volume ideal da máquina%%^"
			vDsMensagem = $concat(vDsMensagem, "	", "Volume: ", formatarConteudo($item("QT_VOLUME", vDsRegistro), "N=9;3"), "%%^")
		case -6
			vDsMensagem = " Volume sugerido de acordo com o peso máximo * relação de banho ideal da máquina%%^"
			vDsMensagem = $concat(vDsMensagem, "	", "Máquina...: ", $item("CD_MAQUINA", vDsRegistro), "%%^")
			vDsMensagem = $concat(vDsMensagem, "	", "Peso......: ", formatarConteudo($item("QT_PESO", vDsRegistro), "N=9;3"), "%%^")
			vDsMensagem = $concat(vDsMensagem, "	", "Rel. banho: ", formatarConteudo($item("QT_RELBANHO", vDsRegistro), "N=9;3"), "%%^")
		elsecase
			vDsMensagem = $concat(" Produto ", $item("CD_PRODUTO", vDsRegistro), "-", getFieldData("DS_PRODUTO", "PRD_PRODUTOSVC", "CD_PRODUTO=%%$item("CD_PRODUTO", vDsRegistro)"), "%%^")
			if ($item("PR_VARIACAO", vDsRegistro) &gt; 0)
				vDsMensagem = $concat(vDsMensagem, "	Aumento de ", formatarConteudo($item("PR_VARIACAO", vDsRegistro), "N=9;3"), "% ")
			else
 				vDsMensagem = $concat(vDsMensagem, "	Subtração de ", formatarConteudo($item("PR_VARIACAO", vDsRegistro), "N=9;3"), "% ")
			endif
			vDsMensagem = $concat(vDsMensagem, "em função da relação de banho", "%%^")
			vDsMensagem = $concat(vDsMensagem, "		Máquina...: ", $item("CD_MAQUINA", vDsRegistro), "%%^")
			vDsMensagem = $concat(vDsMensagem, "		Rel. banho: ", formatarConteudo($item("QT_RELBANHO", vDsRegistro), "N=9;3"), "%%^")
			vDsMensagem = $concat(vDsMensagem, "		Variação..: ", formatarConteudo($item("PR_VARIACAO", vDsRegistro), "N=9;3"), "%", "%%^")
		endselectcase

		delitem vDsLstLog, 1

		poDsMensagem = $concat(poDsMensagem, "%%^", vDsMensagem)
	endwhile

	return(0)
end ;contextualizarLog

;-----------------------------------
public operation buscarCapacidadeMaq
;-----------------------------------
	;HSGARCIA Proj 217/566 - 17/07/2017
	params
		string piParams : IN
		string poParams : OUT
		string $xCdErro$ : OUT
		string $xCtxErro$ : OUT
	endparams

	putitem/id poParams, "QT_CAPACIDADE", getCapacidadeMaquina($item("CD_MAQUINA", piParams), $item("IN_MINIMO", piParams))

	return(0)
End; operation buscarCapacidadeMaq

;--------------------------------------
public operation gerarReprocessoPartida
	;-----------------------------------
	;&lt;-- DSantos Prj-&gt;217-571 18/07/2017 --&gt;
	params
		string piParams : IN
		string poParams : OUT
		string $xCdErro$ : OUT
		string $xCtxErro$ : OUT
	endparams
	variables
		string vDsLstItem, viParams, voParams, vDsRegistro, vDsLstPartidaOri, vDsLstMovimento, vDsLstItemDest, vDsLstItemOri, vDsRegPartida, vDsCondicao
		numeric vCdEmpPartida, vNrPartida
		handle vHdInstance
	endvariables

	vDsLstItem = $item("DS_LSTITEM", piParams)

	if (inValidarParametro("CD_EMPRESA&uSEP;NR_PARTIDA", piParams, "gerarReprocessoPartida"))
		;- Ao gerar reprocesso de uma partida, gera uma nova partida com as mesmas informações
		clear/e "CDF_PARTIDASVC"
		CD_EMPRESA.CDF_PARTIDASVC/init = $item("CD_EMPRESA", piParams)
		NR_PARTIDA.CDF_PARTIDASVC/init = $item("NR_PARTIDA", piParams)
		retrieve/e "CDF_PARTIDASVC"
		if ($status &lt; 0)
			return(0)
		endif
		if (TP_SITUACAO.CDF_PARTIDASVC != 4)
			$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG2710", "DESCRICAO=Não é permitido realizar o reprocesso, pois a partida não foi encerrada!", "ADICIONAL=Operação-&gt;CDFSVCO038.gerarReprocessoPartida")
			return(-1)
		endif
		viParams = ""
		putitem/id viParams, "CD_EMPRESA", $item("CD_EMPRESA", piParams)
		putitem/id viParams, "CD_PROCESSO", CD_PROCESSO.CDF_PARTIDAPSVC
		putitem/id viParams, "CD_MAQUINA", CD_MAQUINA.CDF_PARTIDASVC
		putitem/id viParams, "CD_MOTIVO", CD_MOTIVO.CDF_PARTIDASVC
		putitem/id viParams, "TP_ALOCACAO", 1
		putitem/id viParams, "NR_PERIODO", $item("NR_PERIODO", piParams) ;&lt;-- LOMoreira Prj-&gt;253-48 15/04/2018 --&gt;
		putitem/id viParams, "DS_OBSERVACAO", $item("DS_OBSERVACAO", piParams) ;&lt;-- LOMoreira Prj-&gt;253-48 15/04/2018 --&gt;
		newinstance "CDFSVCO038", vHdInstance
		vHdInstance-&gt;gerarPartida(viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)
			$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status &lt; 0)
			return(-1)
		endif
		vCdEmpPartida = $item("CD_EMPRESA", voParams)
		vNrPartida = $item("NR_PARTIDA", voParams)
		if (vDsLstItem = "" &amp; !$empty("CDF_PARTIDAISVC"))
			;- Caso não receber lista de itens, repete os itens da partida origem
			setocc "CDF_PARTIDAISVC", 1
			while ($status &gt;= 0)
				vDsRegistro = ""
				putlistitems/occ vDsRegistro, "CDF_PARTIDAISVC"
				putitem/id vDsRegistro, "CD_EMPPARTIDA", vCdEmpPartida
				putitem/id vDsRegistro, "NR_PARTIDA", vNrPartida
				putitem/id vDsRegistro, "TP_ORIGEM", TP_ITEM.CDF_PARTIDAISVC
				putitem/id vDsRegistro, "IN_CONVERTER", &lt;FALSE&gt;
				putitem vDsLstItem, -1, vDsRegistro
				setocc "CDF_PARTIDAISVC", $curocc("CDF_PARTIDAISVC") + 1
			endwhile
		endif
		vDsRegistro = ""
		putitem/id vDsRegistro, "CD_EMPRESA", CD_EMPRESA.CDF_PARTIDASVC
		putitem/id vDsRegistro, "NR_PARTIDA", NR_PARTIDA.CDF_PARTIDASVC
		putitem vDsLstPartidaOri, -1, vDsRegistro
	elseif (inValidarParametro("DS_LSTITEM", piParams, "gerarReprocessoPartida"))
		if (!inValidarParametro("CD_PROCESSO", piParams, "gerarReprocessoPartida"))
			return(-1)
		endif
		viParams = piParams
		putitem/id viParams, "CD_EMPRESA", $item("CD_EMPRESA", $$gParamGlb)
		putitem/id viParams, "TP_ALOCACAO", 1
		putitem/id viParams, "TP_TIPO", 1 ;Descontinuo
		putitem/id viParams, "IN_NAO_VALIDAR_MAQUINA", $item("IN_NAO_VALIDAR_MAQUINA", piParams) ;--&gt; MNSANTOS - Prj 217/611 - 04/09/2017
		newinstance "CDFSVCO038", vHdInstance
		vHdInstance-&gt;gerarPartida(viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)
			$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status &lt; 0)
			return(-1)
		endif
		vCdEmpPartida = $item("CD_EMPRESA", voParams)
		vNrPartida = $item("NR_PARTIDA", voParams)
	else
		return(-1)
	endif

	vDsLstItemOri = $item("DS_LSTITEMORI", vDsLstItem)
	if (vDsLstItemOri != "")
		vDsLstMovimento = ""
		clear/e "TMP_K06NR10SVC"
		while (vDsLstItemOri != "")
			if ($item("NR_LOTE", $itemnr(1, vDsLstItemOri)) != "")
				;-- Caso seja item de lote, agrupa registro do mesmo item de O.P. e localização
				creocc "TMP_K06NR10SVC", -1
				NR_CHAVE01.TMP_K06NR10SVC = $item("CD_EMPRESA", $itemnr(1, vDsLstItemOri))
				NR_CHAVE02.TMP_K06NR10SVC = $item("NR_CICLO", $itemnr(1, vDsLstItemOri))
				NR_CHAVE03.TMP_K06NR10SVC = $item("NR_OP", $itemnr(1, vDsLstItemOri))
				NR_CHAVE04.TMP_K06NR10SVC = $item("CD_PRODUTO", $itemnr(1, vDsLstItemOri))
				NR_CHAVE05.TMP_K06NR10SVC = $item("CD_LOCAL", $itemnr(1, vDsLstItemOri))
				NR_CHAVE06.TMP_K06NR10SVC = $item("NR_SEQPROG", $itemnr(1, vDsLstItemOri))
				retrieve/o "TMP_K06NR10SVC"
				if ($status &lt; 0)
					discard "TMP_K06NR10SVC"
				endif
				vDsRegistro = ""
				putitem/id vDsRegistro, "NR_LOTE", $item("NR_LOTE", $itemnr(1, vDsLstItemOri))
				putitem/id vDsRegistro, "NR_ITEM", $item("NR_ITEM", $itemnr(1, vDsLstItemOri))
				;&lt;-- DSantos MVA-1221 220/2669 12/12/2017
				if ($item("QT_PRODUTOOP", $itemnr(1, vDsLstItemOri)) != "")
					putitem/id vDsRegistro, "QT_LOTE", $item("QT_PRODUTOOP", $itemnr(1, vDsLstItemOri))
				else
					putitem/id vDsRegistro, "QT_LOTE", $item("QT_PRODUTO", $itemnr(1, vDsLstItemOri))
				endif
				QT_MOVIMENTO.TMP_K06NR10SVC += $item("QT_LOTE", vDsRegistro)
				; DSantos --&gt;
				putitem DS_LSTLOTE.TMP_K06NR10SVC, -1, vDsRegistro
			elseif ($item("TP_REPROCESSO", piParams) != 3)
				;-- Caso seja item de O.P. e não for reprocesso por quantidade, monta lista para realizar movimento
				vDsRegistro = $itemnr(1, vDsLstItemOri)
				vDsCondicao = ""
				putitem/id vDsCondicao, "CD_PRODUTO", $item("CD_PRODUTO", vDsRegistro)
				putitem/id vDsRegistro, "CD_SEQGRUPO", getFieldData("CD_SEQGRUPO", "PRD_PRDGRADESVC", vDsCondicao)
				putitem/id vDsRegistro, "CD_LOCALORIGEM", $item("CD_LOCAL", vDsRegistro)
				putitem/id vDsRegistro, "NR_SEQPROGORIGEM", $item("NR_SEQPROG", vDsRegistro)
				putitem vDsLstMovimento, -1, vDsRegistro
			endif

			if ($item("NR_PARTIDA", $itemnr(1, vDsLstItemOri)) != "")
				vDsRegistro = ""
				putitem/id vDsRegistro, "CD_EMPRESA", $item("CD_EMPPARTIDA", $itemnr(1, vDsLstItemOri))
				putitem/id vDsRegistro, "NR_PARTIDA", $item("NR_PARTIDA", $itemnr(1, vDsLstItemOri))
				putitem vDsLstPartidaOri, -1, vDsRegistro
			endif

			delitem vDsLstItemOri, 1
		endwhile

		if (vDsLstMovimento = "" &amp; !$empty("TMP_K06NR10SVC"))
			setocc "TMP_K06NR10SVC", 1
			while ($status &gt;= 0)
				vDsRegistro = ""
				putitem/id vDsRegistro, "CD_EMPRESA", NR_CHAVE01.TMP_K06NR10SVC
				putitem/id vDsRegistro, "NR_CICLO", NR_CHAVE02.TMP_K06NR10SVC
				putitem/id vDsRegistro, "NR_OP", NR_CHAVE03.TMP_K06NR10SVC
				putitem/id vDsRegistro, "CD_PRODUTO", NR_CHAVE04.TMP_K06NR10SVC
				putitem/id vDsRegistro, "QT_PRODUTO", QT_MOVIMENTO.TMP_K06NR10SVC
				putitem/id vDsRegistro, "CD_SEQGRUPO", getFieldData("CD_SEQGRUPO", "PRD_PRDGRADESVC", "CD_PRODUTO=%%NR_CHAVE04.TMP_K06NR10SVC")
				putitem/id vDsRegistro, "CD_LOCALORIGEM", NR_CHAVE05.TMP_K06NR10SVC
				putitem/id vDsRegistro, "NR_SEQPROGORIGEM", NR_CHAVE06.TMP_K06NR10SVC
				putitem/id vDsRegistro, "DS_LSTLOTE", DS_LSTLOTE.TMP_K06NR10SVC
				putitem vDsLstMovimento, -1, vDsRegistro
				setocc "TMP_K06NR10SVC", $curocc("TMP_K06NR10SVC") + 1
			endwhile
		endif

		if (vDsLstMovimento != "")
			;- Realiza movimento de acerto para retirar quantidade dos itens origem.
			viParams = ""
			putitem/id viParams, "DS_LSTMOVIMENTO", vDsLstMovimento
			putitem/id viParams, "DT_MOVIMENTO", $datim
			putitem/id viParams, "TP_HISTORICOMOV", 55
			activate "CDFSVCO025".movimentarOP($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxerro$)
			if ($procerror)
				$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
				return(-1)
			elseif ($status &lt; 0)
				return(-1)
			endif
		endif
	endif

	vDsLstItemDest = $item("DS_LSTITEMDEST", vDsLstItem)
	if (vDsLstItemDest != "")
		vDsLstItem = ""
		vDsLstMovimento = ""
		clear/e "TMP_K06NR10SVC"
		while (vDsLstItemDest != "")
			if ($item("NR_LOTEORI", $itemnr(1, vDsLstItemDest)) != "")
				creocc "TMP_K06NR10SVC", -1
				NR_CHAVE01.TMP_K06NR10SVC = $item("CD_EMPRESA", $itemnr(1, vDsLstItemDest))
				NR_CHAVE02.TMP_K06NR10SVC = $item("NR_CICLO", $itemnr(1, vDsLstItemDest))
				NR_CHAVE03.TMP_K06NR10SVC = $item("NR_OP", $itemnr(1, vDsLstItemDest))
				NR_CHAVE04.TMP_K06NR10SVC = $item("CD_PRODUTO", $itemnr(1, vDsLstItemDest))
				NR_CHAVE05.TMP_K06NR10SVC = $item("CD_LOCAL", $itemnr(1, vDsLstItemDest))
				NR_CHAVE06.TMP_K06NR10SVC = $item("NR_SEQPROG", $itemnr(1, vDsLstItemDest))
				retrieve/o "TMP_K06NR10SVC"
				if ($status &lt; 0)
					discard "TMP_K06NR10SVC"
				endif
				vDsRegistro = ""
				if ($item("TP_REPROCESSO", piParams) = 3)
	 				putitem/id vDsRegistro, "NR_LOTE", $item("NR_LOTEORI", $itemnr(1, vDsLstItemDest))
				endif
				putitem/id vDsRegistro, "IN_CRIARLOTE", &lt;TRUE&gt;
 				putitem/id vDsRegistro, "NR_LOTEORI", $item("NR_LOTEORI", $itemnr(1, vDsLstItemDest))
				putitem/id vDsRegistro, "NR_ITEMORI", $item("NR_ITEMORI", $itemnr(1, vDsLstItemDest))
				;&lt;-- DSantos MVA-1221 220/2669 12/12/2017
				if ($item("QT_PRODUTOOP", $itemnr(1, vDsLstItemDest)) != "")
					putitem/id vDsRegistro, "QT_LOTE", $item("QT_PRODUTOOP", $itemnr(1, vDsLstItemDest))
				else
					putitem/id vDsRegistro, "QT_LOTE", $item("QT_PRODUTO", $itemnr(1, vDsLstItemDest))
				endif
				; DSantos --&gt;
				putitem/id vDsRegistro, "CD_COMPONENTE", $componentname
				putitem/id vDsRegistro, "CD_COMPONENTEINC", $componentname
				putitem/id vDsRegistro, "DT_INCLUSAO", $datim
				putitem/id vDsRegistro, "CD_OPERADORINC", $item("CD_USUARIO", $$gParamGlb)
				putitem/id vDsRegistro, "TP_SITUACAO", 1 ;- Em andamento
				putitem/id vDsRegistro, "IN_REPROCESSO", &lt;TRUE&gt;
				putitem/id vDsRegistro, "DS_ITEMCLI", getDsItemItemCliLoteOp($itemnr(1, vDsLstItemDest))
				;&lt;-- DSantos Prj-&gt;217-710 24/01/2018
				putitem/id vDsRegistro, "DS_OBSERVACAO", getObsItemLoteOp($itemnr(1, vDsLstItemDest))
				putitem/id vDsRegistro, "DS_LSTDEF", getLstDefeitoLoteOp($itemnr(1, vDsLstItemDest))
				; DSantos --&gt;
				QT_MOVIMENTO.TMP_K06NR10SVC += $item("QT_LOTE", vDsRegistro)
				putitem DS_LSTLOTE.TMP_K06NR10SVC, -1, vDsRegistro

				vDsRegPartida = ""
				putitem/id vDsRegPartida, "CD_EMPPARTIDA", vCdEmpPartida
				putitem/id vDsRegPartida, "NR_PARTIDA", vNrPartida
				putitem/id vDsRegPartida, "CD_EMPOP", NR_CHAVE01.TMP_K06NR10SVC
				putitem/id vDsRegPartida, "NR_CICLO", NR_CHAVE02.TMP_K06NR10SVC
				putitem/id vDsRegPartida, "NR_OP", NR_CHAVE03.TMP_K06NR10SVC
				putitem/id vDsRegPartida, "CD_PRODUTO", NR_CHAVE04.TMP_K06NR10SVC
				putitem/id vDsRegPartida, "NR_LOTEORI", $item("NR_LOTEORI", vDsRegistro)
				putitem/id vDsRegPartida, "NR_ITEMORI", $item("NR_ITEMORI", vDsRegistro)
				putitem/id vDsRegPartida, "QT_PARTIDA", $item("QT_PRODUTO", $itemnr(1, vDsLstItemDest))
				putitem/id vDsRegPartida, "TP_ORIGEM", 2 ;- Item lote O.P.
 				putitem/id vDsRegPartida, "IN_CONVERTER", &lt;FALSE&gt;
				putitem vDsLstItem, -1, vDsRegPartida
			else
				vDsRegistro = $itemnr(1, vDsLstItemDest)
				if ($item("TP_REPROCESSO", piParams) != 3)
					vDsCondicao = ""
					putitem/id vDsCondicao, "CD_PRODUTO", $item("CD_PRODUTO", vDsRegistro)
					putitem/id vDsRegistro, "CD_SEQGRUPO", getFieldData("CD_SEQGRUPO", "PRD_PRDGRADESVC", vDsCondicao)
					putitem/id vDsRegistro, "CD_LOCALDESTINO", $item("CD_LOCAL", vDsRegistro)
					putitem/id vDsRegistro, "NR_SEQPROGDESTINO", $item("NR_SEQPROG", vDsRegistro)
					putitem vDsLstMovimento, -1, vDsRegistro
					;- Caso o grupo do produto destino não existir na O.P. dever ser incluído, assim como sua programação.
					$instancehandle-&gt;adicionarGrupoOp(vDsRegistro)
					if ($procerror)
						$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
						return(-1)
					elseif ($status &lt; 0)
						return(-1)
					endif
				endif

				vDsRegPartida = ""
				putitem/id vDsRegPartida, "CD_EMPPARTIDA", vCdEmpPartida
				putitem/id vDsRegPartida, "NR_PARTIDA", vNrPartida
				putitem/id vDsRegPartida, "CD_EMPOP", $item("CD_EMPRESA", vDsRegistro)
				putitem/id vDsRegPartida, "NR_CICLO", $item("NR_CICLO", vDsRegistro)
				putitem/id vDsRegPartida, "NR_OP", $item("NR_OP", vDsRegistro)
				putitem/id vDsRegPartida, "CD_PRODUTO", $item("CD_PRODUTO", vDsRegistro)
				putitem/id vDsRegPartida, "QT_PARTIDA", $item("QT_PRODUTO", vDsRegistro)
				putitem/id vDsRegPartida, "TP_ORIGEM", 2 ;- Item O.P.
 				putitem/id vDsRegPartida, "IN_CONVERTER", &lt;FALSE&gt;
				putitem vDsLstItem, -1, vDsRegPartida
			endif

			delitem vDsLstItemDest, 1
		endwhile

		if (vDsLstMovimento = "" &amp; !$empty("TMP_K06NR10SVC"))
			setocc "TMP_K06NR10SVC", 1
			while ($status &gt;= 0)
				vDsRegistro = ""
				putitem/id vDsRegistro, "CD_EMPRESA", NR_CHAVE01.TMP_K06NR10SVC
				putitem/id vDsRegistro, "NR_CICLO", NR_CHAVE02.TMP_K06NR10SVC
				putitem/id vDsRegistro, "NR_OP", NR_CHAVE03.TMP_K06NR10SVC
				putitem/id vDsRegistro, "CD_PRODUTO", NR_CHAVE04.TMP_K06NR10SVC
				putitem/id vDsRegistro, "QT_PRODUTO", QT_MOVIMENTO.TMP_K06NR10SVC
				putitem/id vDsRegistro, "CD_SEQGRUPO", getFieldData("CD_SEQGRUPO", "PRD_PRDGRADESVC", "CD_PRODUTO=%%NR_CHAVE04.TMP_K06NR10SVC")
				putitem/id vDsRegistro, "CD_LOCALDESTINO", NR_CHAVE05.TMP_K06NR10SVC
				putitem/id vDsRegistro, "NR_SEQPROGDESTINO", NR_CHAVE06.TMP_K06NR10SVC
				putitem/id vDsRegistro, "DS_LSTLOTE", DS_LSTLOTE.TMP_K06NR10SVC
				putitem vDsLstMovimento, -1, vDsRegistro

				$instancehandle-&gt;adicionarGrupoOp(vDsRegistro)
				if ($procerror)
					$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
					return(-1)
				elseif ($status &lt; 0)
					return(-1)
				endif

				setocc "TMP_K06NR10SVC", $curocc("TMP_K06NR10SVC") + 1
			endwhile
		endif

		if (vDsLstMovimento != "")
			;- Realiza movimento de acerto para adicionar quantidade dos itens destino, e criar itens de lote.
			viParams = ""
			putitem/id viParams, "DS_LSTMOVIMENTO", vDsLstMovimento
			putitem/id viParams, "DT_MOVIMENTO", $datim
			putitem/id viParams, "TP_HISTORICOMOV", 55
			activate "CDFSVCO025".movimentarOP($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxerro$)
			if ($procerror)
				$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
				return(-1)
			elseif ($status &lt; 0)
				return(-1)
			endif

			vDsLstItem = associarItemLoteCriado($item("DS_LSTLOTECRIADO", voParams), vDsLstItem)
		endif
	endif

	if (vDsLstItem != "")
		viParams = ""
		putitem/id viParams, "DS_LSTITEM", vDsLstItem
		putitem/id viParams, "IN_VALIDARPROCESSO", &lt;FALSE&gt;
		vHdInstance-&gt;incluirItemPartida(viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)
			$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status &lt; 0)
			return(-1)
		endif
	endif

	if ($item("DS_RECEITA", piParams) != "")
		;- Gravar receita da partida
		vDsRegistro = ""
		vDsRegistro = $item("DS_RECEITA", piParams)

		viParams = ""
		putitem/id viParams, "CD_EMPRESA", vCdEmpPartida
		putitem/id viParams, "NR_PARTIDA", vNrPartida
		putitem/id viParams, "CD_COR", $item("CD_COR", vDsRegistro)
		putitem/id viParams, "CD_PROCORGATEX", $item("CD_PROCORGATEX", vDsRegistro)
		putitem/id viParams, "DS_ENTITY", "CDF_PARTIDARECSVC"
		putitem/id viParams, "DS_KEYS", "CD_EMPRESA&uSEP;NR_PARTIDA"
		activate "PCPSVCO043".salvarReceitaPartida(viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)
			$instancehandle-&gt;setStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
			return (-1)
		elseif ($status &lt; 0)
			return (-1)
		endif

		viParams = ""
		viParams = vDsRegistro
		viParams = $replace(viParams, 1, "-1", vCdEmpPartida, -1)
		viParams = $replace(viParams, 1, "-2", vNrPartida, -1)
		putitem/id viParams, "CD_EMPRESA", vCdEmpPartida
		putitem/id viParams, "NR_PARTIDA", vNrPartida
		activate "PCPSVCO043".salvarFaseReceita(viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)
			$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status &lt; 0)
			return(-1)
		endif
	endif

	while (vDsLstPartidaOri != "")
		viParams = ""
		putitem/id viParams, "CD_EMPORI", $item("CD_EMPRESA", $itemnr(1, vDsLstPartidaOri))
		putitem/id viParams, "NR_PARTIDAORI", $item("NR_PARTIDA", $itemnr(1, vDsLstPartidaOri))
		putitem/id viParams, "CD_EMPDEST", vCdEmpPartida
		putitem/id viParams, "NR_PARTIDADEST", vNrPartida
		putitem/id viParams, "TP_PARTIDAREL", 1 ;- Reprocesso
		putitem/id viParams, "DS_ENTITY", "CDF_PARTIDARESVC"
		$instancehandle-&gt;salvarEntidade(viParams, voParams, $xCdErro$, $xCtxErro$)
		if ($procerror)
			$instancehandle-&gt;setStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status &lt; 0)
			return(-1)
		endif
		delitem vDsLstPartidaOri, 1
	endwhile

	putitem/id poParams, "CD_EMPPARTIDA", vCdEmpPartida
	putitem/id poParams, "NR_PARTIDA", vNrPartida
	return(0)
end ;gerarReprocessoPartida

;---------------------------------
partner operation adicionarGrupoOp
	;------------------------------
	;&lt;-- DSantos Prj-&gt;217-571 20/07/2017 --&gt;
	params
		string piParams : IN
	endparams
	variables
		string viParams
	endvariables

	viParams = ""
	putitem/id viParams, "CD_EMPRESA", $item("CD_EMPRESA", piParams)
	putitem/id viParams, "NR_CICLO", $item("NR_CICLO", piParams)
	putitem/id viParams, "NR_OP", $item("NR_OP", piParams)
	putitem/id viParams, "CD_SEQGRUPO", $item("CD_SEQGRUPO", piParams)
	$handleEntity$-&gt;consultar("PCP_OPGSVC", viParams)
	if ($status &gt;= 0)
		return(0)
	endif

	activate "PCPSVCO031".gravaGrupoOp($$gParamGlb, viParams, "", $xCdErro$, $xCtxErro$)
	if ($procerror)
		$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status &lt; 0)
		return(-1)
	endif

	activate "CDFSVCO028".sugerirProgramacaoOp($$gParamGlb, viParams, "", $xCdErro$, $xCtxerro$)
	if ($procerror)
		$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status &lt; 0)
		return(-1)
	endif

	return(0)
end ;adicionarGrupoOp

;-------------------------------
public operation salvarEntidade
	;----------------------------
	;&lt;-- DSantos Prj-&gt;217-571 18/07/2017 --&gt;
	params
		string piParams : IN
		string poParams : OUT
		string $xCdErro$ : OUT
		string $xCtxErro$ : OUT
	endparams
	variables
		string vDsKeys, vDsEntity, vDsField
		boolean vInExiste
	endvariables

	if (!inValidarParametro("DS_ENTITY", piParams, "salvarEntidade"))
		return(-1)
	endif

	vDsEntity = $item("DS_ENTITY", piParams)
	vDsKeys = getEntityFields(vDsEntity, 1)

	if (!inValidarParametro(vDsKeys, piParams, "salvarEntidade"))
		return(-1)
	endif

	clear/e vDsEntity
	creocc vDsEntity, -1
	while (vDsKeys != "")
		vDsField = $concat($itemnr(1, vDsKeys), ".", vDsEntity)
		@vDsField = $item($itemnr(1, vDsKeys), piParams)
		delitem/id piParams, $itemnr(1, vDsKeys)
		delitem vDsKeys, 1
	endwhile

	vInExiste = getStatusExiste(vDsEntity)
	getlistitems/occ piParams, vDsEntity
	if (!vInExiste | !inRegBanco(vDsEntity))
		vDsField = $concat("CD_OPERADOR.", vDsEntity)
		@vDsField = $item("CD_USUARIO", $$gParamGlb)
		vDsField = $concat("DT_CADASTRO.", vDsEntity)
		@vDsField = $datim
	endif

	$collhandle(vDsEntity)-&gt;Salvar()
	if ($procerror)
		$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status &lt; 0)
		return(-1)
	endif

	return(0)
end ;salvarEntidade

;--&gt;ROS--&gt;220/2227--&gt;10/08/2017
public operation buscaProximaPartida
;-----------------------------------
	params
		string piParams : IN
		string poParams : OUT
		string $xCdErro$ : OUT
		string $xCtxErro$ : OUT
	endparams

	if($item("CD_EMPRESA", piParams) = 0)
		$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG6", "DESCRICAO=Empresa não informada!", "ADICIONAL=Operação-&gt;CDFSVCO038.buscaProximaPartida")
		return(-1)
	endif

	putitem/id poParams, "NR_PARTIDA", getNrNovaPartida($item("CD_EMPRESA", piParams))

	return(0)
End; operation buscaProximaPartida ;&lt;--ROS.

;----------------------------------
partner operation validarTipoSeguro
;----------------------------------
	;--&gt; MNSANTOS - Prj 217/602 - 30/08/2017
	params
		numeric piCdEmpresa : IN
		numeric piNrPartida : IN
		numeric piCdMaquina : IN
	endparams
	variables
		string vDsCondicao, vDsLstProduto
		numeric vCdProduto, vCdProcesso
	endvariables

	vDsCondicao = ""
	putitem/id vDsCondicao, "CD_EMPRESA", piCdEmpresa
	putitem/id vDsCondicao, "NR_PARTIDA", piNrPartida
	$handleConsulta$-&gt;consultar("CDF_PARTIDAISVC", vDsCondicao)
	if($status &gt;= 0)
		$handleConsulta$-&gt;getListItensField("CD_PRODUTO", vDsLstProduto)
		vCdProduto = getCdPrdSeguro(vDsLstProduto)
		if($status &lt; 0)
			return(-1)
		endif

		;HSGARCIA Proj 253/100 05/07/2018
		if(vCdProduto &gt; 0)
			delitem/id vDsCondicao, "CD_EMPRESA"
			putitem/id vDsCondicao, "CD_EMPPARTIDA", piCdEmpresa
			vCdProcesso = getFieldData("CD_PROCESSO", "CDF_PARTIDAPSVC", vDsCondicao)
			if($tpIntAcabamentoTextil$ &gt; 0 &amp; getInfTecConf("", piCdMaquina, "", "", 4, 42) != "" &amp; vCdProduto &gt; 0) ;-&gt;HSGARCIA Proj 253/378 DVAIND-1940 05/12/2018
				vDsCondicao = ""
				putitem/id vDsCondicao, "CD_SEQMAQ", getFieldData("CD_SEQMAQ", "CDF_MAQGMAQSVC", "CD_MAQUINA=%%piCdMaquina")
				putitem/id vDsCondicao, "NR_PARAMETRO", "&uGT;&uEQ;0"
				$handleConsulta$-&gt;consultar("CDF_CFGMAQCAMPOSVC", vDsCondicao)
				if($status &gt;= 0)
					$handleConsulta$-&gt;setEntityOcc(1)
					while($status &gt;= 0)
						if(dsBuscarPadraoTecnicoMaquina(vCdProduto, piCdMaquina, $item("CD_TIPOCAMPO", getRegistro($handleConsulta$)), vCdProcesso, piCdEmpresa, piNrPartida) = "")
							$instancehandle-&gt;setStatus(&lt;STS_ERRO&gt;, "MSG43119", "DESCRICAO=Produto de tipo seguro sem padrão técnico cadastrado!", "")
							return(-1)
						endif
						$handleConsulta$-&gt;next()
					endwhile
				endif
			endif
		endif
		;&lt;--
	endif

	return(0)
end ;validarTipoSeguro

;-----------------------------------
partner operation validarSaldoEmiRec
	;--------------------------------
	params
		string poDsLstSaldoPrd :OUT
	endparams
	variables
		string viParams, voParams, vDsCondicao
		numeric vQtSaldoPendenteEmissao, vQtSaldoEstoque, vQtSaldo
	endvariables

	if ($empty("TEX_RECEMIMPSVC"))
		return(0)
	endif

	newinstance "PRDSVCO057", $handleSaldo$, "TRANSACTION=TRUE"

	vDsCondicao = ""
	putitem/id vDsCondicao, "CD_OPERACAO", CD_OPERACAO.TEX_RECEMISSASVC
	putitem/id vDsCondicao, "IN_PADRAO", &lt;TRUE&gt;

	viParams = ""
	putitem/id viParams, "CD_SALDO", getFieldData("CD_SALDO", "GER_OPERSALDOSVC", vDsCondicao)
	$handleSaldo$-&gt;inicializar(viParams, voParams, $xCdErro$, $xCtxErro$)
	if($procerror)
		$instancehandle-&gt;setStatus(&lt;STS_ERRO&gt;, $procerror, $procreturncontext, "")
		return(-1)
	elseif($status &lt; 0)
		$instancehandle-&gt;setStatus(&lt;STS_ERRO&gt;, $xCdErro$, $xCtxErro$, "")
		return(-1)
	endif

	poDsLstSaldoPrd = ""
	setocc "TEX_RECEMIMPSVC", 1
	while ($status &gt;= 0)
		$handleSaldo$-&gt;getSaldoEstoque(CD_PRODUTO.TEX_RECEMIMPSVC, vQtSaldoEstoque)
		$handleSaldo$-&gt;getSaldoPendenteEmissao(CD_PRODUTO.TEX_RECEMIMPSVC, vQtSaldoPendenteEmissao)
		vQtSaldo =  vQtSaldoEstoque - vQtSaldoPendenteEmissao - QT_ESTIMADA.TEX_RECEMIMPSVC
		if (vQtSaldo &lt; 0)
			poDsLstSaldoPrd = $concat(poDsLstSaldoPrd, "Produto: ", "%%CD_PRODUTO.TEX_RECEMIMPSVC ", getFieldData("DS_PRODUTO", "PRD_PRODUTOSVC", "CD_PRODUTO=%%CD_PRODUTO.TEX_RECEMIMPSVC"), "%%^")
			poDsLstSaldoPrd = $concat(poDsLstSaldoPrd, "	- Estoque.........: ", formatarConteudo(vQtSaldoEstoque, "N=9;6"), "%%^")
			poDsLstSaldoPrd = $concat(poDsLstSaldoPrd, "	- Emissão atual...: ", formatarConteudo(QT_ESTIMADA.TEX_RECEMIMPSVC, "N=9;6"), "%%^")
			poDsLstSaldoPrd = $concat(poDsLstSaldoPrd, "	- Emissão pendente: ", formatarConteudo(vQtSaldoPendenteEmissao, "N=9;6"), "%%^")
			poDsLstSaldoPrd = $concat(poDsLstSaldoPrd, "	- Resultado.......: ", formatarConteudo(vQtSaldo, "N=9;6"), "%%^", "%%^")
		endif
		setocc "TEX_RECEMIMPSVC", $curocc("TEX_RECEMIMPSVC") + 1
	endwhile

	return(0)
end ;validarSaldoEmiRec

;-----------------------------------
partner operation baixarMpEmissaoAut
;-----------------------------------
	;--&gt; MNSANTOS - Prj 217/714 - 26/01/2018
	params
		numeric piCdEmpresa : IN
		numeric piNrPartida : IN
		string piDsLstPrd : IN
	endparams
	variables
		string vDsRegistro, vDsCondicao, vDsLstMp, vDsRegEmi, vDsRegEmiMp, viParams, voParams
		numeric vQtMovimento, vCdCampo
	endvariables

	if(piCdEmpresa = "" | piNrPartida = "")
		$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG14043", "DESCRICAO=Dados incorretos para o processo!", "ADICIONAL=Operação-&gt;CDFSVCO038.baixarMpEmissao")
		return(-1)
	endif

	$handleEntity$-&gt;consultar("PCP_CFGINFTECSVC", "CD_CONF=44")
	if($status &gt;= 0)
		vDsCondicao = ""
		putitem/id vDsCondicao, "CD_EMPPARTIDA", CD_EMPRESA.CDF_PARTIDASVC
		putitem/id vDsCondicao, "NR_PARTIDA", NR_PARTIDA.CDF_PARTIDASVC
		putitem/id vDsCondicao, "TP_SITUACAO", "&uNOT;&uEQ;06"
		putitem/id vDsCondicao, "CD_OPERACAO", "&uNOT;&uEQ;"
		$handleEntity$-&gt;consultar("TEX_RECEMISSASVC", vDsCondicao)
		if($status &gt;= 0)
			$handleEntity$-&gt;setEntityOcc(1)
			while($status &gt;= 0)
				$handleEntity$-&gt;getRegistro(vDsRegEmi)
				vDsLstMp = ""

				vDsCondicao = ""
				putitem/id vDsCondicao, "CD_EMPRESA", $item("CD_EMPRESA", vDsRegEmi)
				putitem/id vDsCondicao, "NR_EMISSAO", $item("NR_EMISSAO", vDsRegEmi)

				$handleConsulta$-&gt;consultar("TEX_RECEMIMPSVC", vDsCondicao)
				if($status &gt;= 0)
					$handleConsulta$-&gt;setEntityOcc(1)
					while($status &gt;= 0)
						vQtMovimento = 0
						$handleConsulta$-&gt;getRegistro(vDsRegEmiMp)
						vCdCampo = getInfTecConf($item("CD_PRODUTO", vDsRegEmiMp), "", "", "", 1, 44) ;-- Tipo de baixa na finalização da partida
						if(vCdCampo = 1)
							vQtMovimento = $item($item("CD_PRODUTO", vDsRegEmiMp), piDsLstPrd)
							;-&gt;HSGARCIA Proj 217/755 15/03/2018
							if(vQtMovimento = 0)
								vQtMovimento = $item("QT_ESTIMADA", vDsRegEmiMp)
							endif
							;&lt;-
						elseif(vCdCampo = 2)
							vQtMovimento = $item("QT_ESTIMADA", vDsRegEmiMp)
						endif

						if(vQtMovimento&gt; 0)
							vDsRegistro = ""
							putitem/id vDsRegistro, "CD_PRODUTO", $item("CD_PRODUTO", vDsRegEmiMp)
							putitem/id vDsRegistro, "QT_MOVIMENTO", vQtMovimento
							putitem/id vDsRegistro, "IN_FECHAMENTO", &lt;TRUE&gt;
							putitem vDsLstMp, -1, vDsRegistro
						endif

						$handleConsulta$-&gt;next()
					endwhile
				endif

				if (vDsLstMp != "")
					viParams = ""
					putitem/id viParams, "CD_EMPRESA", $item("CD_EMPRESA", vDsRegEmi)
					putitem/id viParams, "NR_EMISSAO", $item("NR_EMISSAO", vDsRegEmi)
					putitem/id viParams, "CD_OPERACAO", $item("CD_OPERACAO", vDsRegEmi)
					putitem/id viParams, "DS_LSTMP", vDsLstMp
					activate "PCPSVCO044".processarRecEmiMP($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
					if ($procerror)
						$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
						return(-1)
					elseif ($status &lt; 0)
						putitem/id $xCtxErro$, "DS_ERRO", $item("DS_ERRO", voParams)
						return(-1)
					endif
				endif

				$handleEntity$-&gt;next()
			endwhile
		endif
	endif

	return(0)
end ;baxarMpEmissaoAut

;-----------------------------------
public operation buscarPrdTipoSeguro
	;--------------------------------
	;&lt;-- DSantos Prj-&gt;217-730 20/02/2018 --&gt;
	params
		string piParams : IN
		string poParams : OUT
		string $xCdErro$ : OUT
		string $xCtxErro$ : OUT
	endparams

	if (!inValidarParametro("DS_LSTPRD", piParams, "buscarPrdTipoSeguro"))
		return(-1)
	endif

	putitem/id poParams, "CD_PRODUTO", getCdPrdSeguro($item("DS_LSTPRD", piParams))
	if ($status &lt; 0)
		return(-1)
	endif

	return(0)
end ;buscarPrdTipoSeguro

;---------------------------------------
partner operation gravarPadraoTecPartida
	;------------------------------------
	;&lt;-- DSantos Prj-&gt;217-730 20/02/2018 --&gt;
	params
		numeric piCdEmpresa : IN
		numeric piNrPartida : IN
		string piDsLstPadTec : IN
	endparams
	variables
		string vDsRegistro, vDsLstItem, viParams, voParams
	endvariables

	vDsLstItem = ""

	while (piDsLstPadTec != "")
		vDsRegistro = $itemnr(1, piDsLstPadTec)
		putitem/id vDsRegistro, "CD_EMPRESA", piCdEmpresa
		putitem/id vDsRegistro, "NR_PARTIDA", piNrPartida
		putitem vDsLstItem, -1, vDsRegistro
		delitem piDsLstPadTec, 1
	endwhile

	viParams = ""
	putitem/id viParams, "CD_EMPRESA", piCdEmpresa
	putitem/id viParams, "NR_PARTIDA", piNrPartida
	putitem/id viParams, "DS_LSTITEM", vDsLstItem
	activate "CDFSVCO029".salvarPadraoTecPartida(viParams, voParams, $xCdErro$, $xCtxErro$)
	if ($procerror)
		$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status &lt; 0)
		return(-1)
	endif

	clear/e "CDF_PARTIDACFGMAQSVC"
	retrieve/e "CDF_PARTIDACFGMAQSVC"

	return(0)
end ;gravarPadraoTecPartida

;----------------------------------
public operation gravarTempoPartida
	;-------------------------------
;-&gt;HSGARCIA Proj 253/31 25/04/2018
	params
		string piParams : IN
		string poParams : OUT
		string $xCdErro$ : OUT
		string $xCtxErro$ : OUT
	endparams
	variables
		string viParams, voParams, vDsAux, vDsCondicao, vDsRegistro
	endvariables

	if (!inValidarParametro("CD_EMPRESA&uSEP;NR_PARTIDA", piParams, "gravarTempoPartida"))
		return(-1)
	endif

	creocc "CDF_PARTIDASVC", -1
	CD_EMPRESA.CDF_PARTIDASVC/init = $item("CD_EMPRESA", piParams)
	NR_PARTIDA.CDF_PARTIDASVC/init = $item("NR_PARTIDA", piParams)
	retrieve/o "CDF_PARTIDASVC"
	if($status = 0)
		discard "CDF_PARTIDASVC"
		return(0)
	elseif($status = -7)
		retrieve/x "CDF_PARTIDASVC"
	endif

	;IAS - PRJ/TAR - 253/0028 - 23/04/2018
	if(getFieldData("IN_EFICIENCIA", "CDF_MAQCONFPARSVC", "CD_MAQUINA=%%CD_MAQUINA.CDF_PARTIDASVC") = "T")
		vDsCondicao = ""
		putitem/id vDsCondicao, "CD_EMPRESA", CD_EMPRESA.CDF_PARTIDASVC
		putitem/id vDsCondicao, "NR_PARTIDA", NR_PARTIDA.CDF_PARTIDASVC
		$handleEntity$-&gt;consultar("V_CDF_TEMPOPARTIDASVC", vDscondicao)
		if($status &gt;= 0)
			$handleEntity$-&gt;getRegistro(vDsRegistro)
			viParams = ""
			putitem/id viParams, "CD_MAQUINA", CD_MAQUINA.CDF_PARTIDASVC
			putitem/id viParams, "DT_INICIO", $item("DT_INICIO", vDsRegistro)
			putitem/id viParams, "DT_FIM", $item("DT_FIM", vDsRegistro)
			activate "PCPSVCO057".calcularTempoPeriodo(viParams, voParams, $xCdErro$, $xCtxerro$)
			if ($procerror)
				$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
				return(-1)
			elseif ($status &lt; 0)
				return(-1)
			endif

			;-&gt;HSGARCIA Proj 253/31 25/04/2018
			clear/e "CDF_PARTIDATEMPOSVC"
			retrieve/e "CDF_PARTIDATEMPOSVC"
			if($status &gt;= 0)
				if(!$empty("CDF_PARTIDATEMPOSVC"))
					$collhandle("CDF_PARTIDATEMPOSVC")-&gt;excluir()
					if ($procerror)
						$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
						return(-1)
					elseif ($status &lt; 0)
						return(-1)
					endif
				endif
			endif
			;&lt;-

			vDsAux = $item("DS_LSTPERIODO", voParams)
			vDsAux = $replace(vDsAux, 1, "DT_CALENDARIO", "DT_PERIODO", -1)
			while(vDsAux != "")

				creocc "CDF_PARTIDATEMPOSVC", -1
				getlistitems/occ $itemnr(1, vDsAux), "CDF_PARTIDATEMPOSVC"
			   CD_OPERADOR.CDF_PARTIDATEMPOSVC = $item("CD_USUARIO", $$gParamGlb)
			   DT_CADASTRO.CDF_PARTIDATEMPOSVC = $datim
				delitem vDsAux, 1
			endwhile
		endif
		;&lt;-

		$collhandle("CDF_PARTIDATEMPOSVC")-&gt;Salvar()
		if ($procerror)
			$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status &lt; 0)
			$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $xCdErro$, $xCtxErro$, "")
			return(-1)
		endif

	endif

	return(0)
end ;gravarTempoPartida

;---------------------------------------
public operation gravarEficienciaPartida
	;------------------------------------
	;-&gt;HSGARCIA Proj 253/31 25/04/2018
	params
		string piParams : IN
		string poParams : OUT
		string $xCdErro$ : OUT
		string $xCtxErro$ : OUT
	endparams

	if (!inValidarParametro("CD_EMPRESA&uSEP;NR_PARTIDA", piParams, "gravarEficienciaPartida"))
		return(-1)
	endif

	clear/e "CDF_PARTIDASVC"
	CD_EMPRESA.CDF_PARTIDASVC/init = $item("CD_EMPRESA", piParams)
	NR_PARTIDA.CDF_PARTIDASVC/init = $item("NR_PARTIDA", piParams)
	retrieve/e "CDF_PARTIDASVC"
	if($status &lt; 0)
		return(0)
	endif

	;IAS - PRJ/TAR - 253/0028 - 23/04/2018
	PR_EFICIENCIA.CDF_PARTIDASVC = prCalcularEficienciaPartida(CD_EMPRESA.CDF_PARTIDASVC, NR_PARTIDA.CDF_PARTIDASVC, CD_MAQUINA.CDF_PARTIDASVC)

	$collhandle("CDF_PARTIDASVC")-&gt;Salvar()
	if ($procerror)
		$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status &lt; 0)
		$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $xCdErro$, $xCtxErro$, "")
		return(-1)
	endif

	return(0)
end ;gravarEficienciaPartida

;------------------------------------------
public operation desalocarPartidaReprocesso
;------------------------------------------
	;-&gt;HSGARCIA Proj 253/49 15/05/2018
	params
		string piParams : IN
		string poParams : OUT
		string $xCdErro$ : OUT
		string $xCtxErro$ : OUT
	endparams
	variables
		string viParams, voParams
		numeric vCdMaquina
	endvariables

	if (!inValidarParametro("CD_EMPRESA&uSEP;NR_PARTIDA", piParams, "desalocarPartidaReprocesso"))
		return(-1)
	endif

	clear/e "CDF_PARTIDASVC"
	CD_EMPRESA.CDF_PARTIDASVC/init = $item("CD_EMPRESA", piParams)
	NR_PARTIDA.CDF_PARTIDASVC/init = $item("NR_PARTIDA", piParams)
	retrieve/e "CDF_PARTIDASVC"
	if ($status &lt; 0)
		return(0)
	endif

	vCdMaquina = CD_MAQUINA.CDF_PARTIDASVC
	CD_MAQUINA.CDF_PARTIDASVC = ""
	NR_ORDEM.CDF_PARTIDASVC = ""
	CD_OPERADOR.CDF_PARTIDASVC = $item("CD_USUARIO", $$gParamGlb)
	DT_CADASTRO.CDF_PARTIDASVC = $datim

	$collhandle("CDF_PARTIDASVC")-&gt;Salvar()
	if ($procerror)
		$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status &lt; 0)
		return(-1)
	endif

	viParams = ""
	putitem/id viParams, "CD_EMPRESA", $item("CD_EMPRESA", piParams)
	putitem/id viParams, "CD_MAQUINA", vCdMaquina
	$instancehandle-&gt;reordenarPartida(viParams, voParams, $xCdErro$, $xCtxErro$)
	if ($procerror)
		$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status &lt; 0)
		return(-1)
	endif

	if(getInfTecConf("", vCdMaquina, "", "", 4, 42) != "")
		putitem/id viParams, "NR_PARTIDA", $item("NR_PARTIDA", piParams)
		activate "CDFSVCO039".cancelarPartida(viParams, voParams, $xCdErro$, $xCtxerro$)
		if ($procerror)
			$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status &lt; 0)
			return(-1)
		endif
	endif

	return(0)
end; desalocarPartidaReprocesso

;---------------------------------------
partner operation atualizarDtUtilizacao
	;----------------------------------
	;===IES DVAIND-234 21/05/2018
	params
		string piCdReceita : IN
	endparams
	variables
		string vDsRegistro,voParams
	endvariables

	$handleEntity$-&gt;consultar("TEX_RECEITASVC", "CD_RECEITA=%%piCdReceita")
	if ($status &lt; 0)
		return(0)
	endif

	$handleEntity$-&gt;getRegistro(vDsRegistro)
	putitem/id vDsRegistro, "DT_ULTIMAUTILIZACAO", $datim
	activate "PCPSVCO043".gravaReceitaC($$gParamGlb, vDsRegistro, voParams, $xCdErro$, $xCtxErro$)
	if ($procerror)
		$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
		return(-1)
	elseif ($status &lt; 0)
		return(-1)
	endif

	return(0)

End ;atualizarDtUtilizacao

;IAS - PRJ/TAR - 253/0276 - 15/10/2018
;----------------------------------------
public operation substituirProdutoEmissao
;----------------------------------------
	params
		string piParams : IN
		string poParams : OUT
		string $xCdErro$ : OUT
		string $xCtxErro$ : OUT
	endparams
	variables
		string vDsLista, vDsRegistro, viParams, voParams
	endvariables

	if (!inValidarParametro("CD_EMPRESA&uSEP;NR_EMISSAO&uSEP;CD_PRODUTOORI&uSEP;CD_PRODUTODES&uSEP;DS_LSTFASEOPERACAO", piParams, "substituirProdutoEmissao"))
		return(-1)
	endif

	clear/e "TEX_RECEMISSASVC"
	CD_EMPRESA.TEX_RECEMISSASVC/init = $item("CD_EMPRESA", piParams)
	NR_EMISSAO.TEX_RECEMISSASVC/init = $item("NR_EMISSAO", piParams)
	retrieve/e "TEX_RECEMISSASVC"
	if($status &lt; 0)
		$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG36609", "DESCRICAO=Emissão não cadastrada!", "ADICIONAL=Operação-&gt;CDFSVCO038.substituirProdutoEmissao")
		return(-1)
	endif

	vDsLista = $item("DS_LSTFASEOPERACAO", piParams)
	while(vDsLista != "")
		clear/e "TEX_RECEMIFASSVC"
		NR_FASE.TEX_RECEMIFASSVC/init = $item("NR_FASE", $itemnr(1, vDsLista))
		retrieve/e "TEX_RECEMIFASSVC"
		if($status &lt; 0)
			$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG43607", "DESCRICAO=Fase informada não encontrada na emissão!", "ADICIONAL=Operação-&gt;CDFSVCO038.substituirProdutoEmissao")
			return(-1)
		endif

		clear/e "TEX_RECEMIOPESVC"
		NR_SEQOPER.TEX_RECEMIOPESVC/init = $item("NR_SEQOPER", $itemnr(1, vDsLista))
		retrieve/e "TEX_RECEMIOPESVC"
		if($status &lt; 0)
			$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG43608", "DESCRICAO=Operacão informada não encontrada na emissão!", "ADICIONAL=Operação-&gt;CDFSVCO038.substituirProdutoEmissao")
			return(-1)
		endif

		clear/e "TEX_RECEOPPRDSVC"
		CD_PRODUTO.TEX_RECEOPPRDSVC/init = $item("CD_PRODUTOORI", piParams)
		retrieve/e "TEX_RECEOPPRDSVC"
		if($status &lt; 0)
			$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, "MSG43609", "DESCRICAO=Produto origem não encontrado na fase/operação informada!", "ADICIONAL=Operação-&gt;CDFSVCO038.substituirProdutoEmissao")
			return(-1)
		endif
		while($status &gt;= 0)
			putlistitems/occ vDsRegistro, "TEX_RECEOPPRDSVC"
			CD_PRODUTO.TEX_RECEOPPRDSVC = $item("CD_PRODUTODES", piParams)
			QT_TOTAL.TEX_RECEOPPRDSVC = ""
			if(QT_CONSUMO.TEX_RECEOPPRDSVC &gt; 0 &amp; TP_CONSUMO.TEX_RECEOPPRDSVC != 4)
				QT_TOTAL.TEX_RECEOPPRDSVC = calcularConsumoProduto(dsMontarParamentroCalculo(), "", "")
			endif
			CD_OPERADOR.TEX_RECEOPPRDSVC = $item("CD_USUARIO", $$gParamGlb)
			DT_CADASTRO.TEX_RECEOPPRDSVC = $datim

			creocc "TEX_RELSUBPRDRECEMISVC", -1
			CD_EMPRESA.TEX_RELSUBPRDRECEMISVC   = CD_EMPRESA.TEX_RECEOPPRDSVC
			NR_EMISSAO.TEX_RELSUBPRDRECEMISVC   = NR_EMISSAO.TEX_RECEOPPRDSVC
			NR_FASE.TEX_RELSUBPRDRECEMISVC      = NR_FASE.TEX_RECEOPPRDSVC
			NR_SEQOPER.TEX_RELSUBPRDRECEMISVC   = NR_SEQOPER.TEX_RECEOPPRDSVC
			NR_SEQPRD.TEX_RELSUBPRDRECEMISVC    = NR_SEQPRD.TEX_RECEOPPRDSVC
			NR_SEQUENCIA.TEX_RELSUBPRDRECEMISVC = nrBuscarSeqRel(vDsRegistro)
			retrieve/o "TEX_RELSUBPRDRECEMISVC"

			CD_OPERADOR.TEX_RELSUBPRDRECEMISVC   = $item("CD_USUARIO", $$gParamGlb)
			DT_CADASTRO.TEX_RELSUBPRDRECEMISVC   = $datim
			CD_PRODUTOORI.TEX_RELSUBPRDRECEMISVC = $item("CD_PRODUTO", vDsRegistro)
			CD_PRODUTODES.TEX_RELSUBPRDRECEMISVC = $item("CD_PRODUTODES", piParams)
			QT_ORIGEM.TEX_RELSUBPRDRECEMISVC     = $item("QT_TOTAL", vDsRegistro)
			QT_DESTINO.TEX_RELSUBPRDRECEMISVC    = QT_TOTAL.TEX_RECEOPPRDSVC

			creocc "TEX_RECEMIMPSVC", -1
			CD_PRODUTO.TEX_RECEMIMPSVC = $item("CD_PRODUTO", vDsRegistro)
			retrieve/o "TEX_RECEMIMPSVC"
			if($status = 0)
				discard "TEX_RECEMIMPSVC"
			else
				if($status = -7)
					retrieve/x "TEX_RECEMIMPSVC"
				endif
				QT_ESTIMADA.TEX_RECEMIMPSVC -= $item("QT_TOTAL", vDsRegistro)
				if(QT_ESTIMADA.TEX_RECEMIMPSVC = 0)
					IN_FECHAMENTO.TEX_RECEMIMPSVC = &lt;TRUE&gt;
					DT_FECHAMENTO.TEX_RECEMIMPSVC = $datim
				endif
				CD_OPERADOR.TEX_RECEMIMPSVC = $item("CD_USUARIO", $$gParamGlb)
				DT_CADASTRO.TEX_RECEMIMPSVC = $datim
			endif

			creocc "TEX_RECEMIMPSVC", -1
			CD_PRODUTO.TEX_RECEMIMPSVC = CD_PRODUTO.TEX_RECEOPPRDSVC
			retrieve/o "TEX_RECEMIMPSVC"
			if($status = 0)
				IN_FECHAMENTO.TEX_RECEMIMPSVC = &lt;FALSE&gt;
			else
				if($status = -7)
					retrieve/x "TEX_RECEMIMPSVC"
				endif
				if(IN_FECHAMENTO.TEX_RECEMIMPSVC)
					IN_FECHAMENTO.TEX_RECEMIMPSVC = &lt;FALSE&gt;
					DT_FECHAMENTO.TEX_RECEMIMPSVC = ""
				endif
			endif
			QT_ESTIMADA.TEX_RECEMIMPSVC += $item("QT_TOTAL", vDsRegistro)
			CD_OPERADOR.TEX_RECEMIMPSVC = $item("CD_USUARIO", $$gParamGlb)
			DT_CADASTRO.TEX_RECEMIMPSVC = $datim

			setocc "TEX_RECEOPPRDSVC", $curocc("TEX_RECEOPPRDSVC") + 1
		endwhile

		$collhandle("TEX_RECEMISSASVC")-&gt;Salvar()
		if ($procerror)
			$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status &lt; 0)
			return(-1)
		endif

		$collhandle("TEX_RELSUBPRDRECEMISVC")-&gt;Salvar()
		if ($procerror)
			$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
			return(-1)
		elseif ($status &lt; 0)
			return(-1)
		endif

		delitem vDsLista, 1
	endwhile

	return(0)

End;substituirProdutoEmissao

;------------------------------------------
public operation buscarQtBaixadaMpPrincipal
;------------------------------------------
	;-&gt;HSGARCIA Proj 253/296 DVAIND-1145 24/10/2018
	params
		string piParams : IN
		string poParams : OUT
		string $xCdErro$ : OUT
		string $xCtxErro$ : OUT
	endparams

	if (!inValidarParametro("CD_EMPRESA&uSEP;NR_CICLO&uSEP;NR_OP&uSEP;CD_PRODUTO", piParams, "buscarQtBaixadaMpPrincipal"))
		return(-1)
	endif

	call getQtBaixadaMpPrincipal(piParams, poParams)

	return(0)
end; buscarQtBaixadaMpPrincipal

;----------------------------------------
public operation bloquearReceitaMovimento
	;------------------------------------
	;IES Proj/tar 253/349 21/11/2018 DVAIND-1254
	params
	string piParams : IN
	string poParams : OUT
	string $xCdErro$ : OUT
	string $xCtxErro$ : OUT
	endparams
	variables
		numeric vNrEmissao
		string  vDsLstReceita, vDsreceita, vDsLstProdutoOp, viParams, voParams
	endvariables

	if (!inValidarParametro("CD_EMPRESA&uSEP;NR_CICLO&uSEP;NR_OP&uSEP;DS_LSTPRODUTOS", piParams, "bloquearReceitaMovimento"))
		return(-1)
	endif

	vDsLstProdutoOp = $item("DS_LSTPRODUTOS", piParams)
	while(vDsLstProdutoOp != "")

		clear/e "PCP_OPISEQPROSVC"
		CD_EMPRESA.PCP_OPISEQPROSVC/init = $item("CD_EMPRESA", piParams)
		NR_CICLO.PCP_OPISEQPROSVC/init = $item("NR_CICLO", piParams)
		NR_OP.PCP_OPISEQPROSVC/init = $item("NR_OP", piParams)
		CD_PRODUTO.PCP_OPISEQPROSVC/init = $itemnr(1, vDsLstProdutoOp)
		retrieve/e "PCP_OPISEQPROSVC"
		if ($status &gt;= 0)
			setocc "PCP_OPISEQPROSVC", 1
			while($status &gt;= 0)
				vDsLstReceita = dsBuscarReceita($item("CD_EMPRESA", piParams), $item("NR_CICLO", piParams),  $item("NR_OP", piParams), CD_PROCESSO.PCP_OPISEQPROSVC)
				while (vDsLstReceita != "")
					clear/e "TEX_RECEITASVC"
					CD_RECEITA.TEX_RECEITASVC = $itemnr(1, vDsLstReceita)
					retrieve/e "TEX_RECEITASVC"
					if ($status &gt;= 0)
						TP_SITUACAO.TEX_RECEITASVC = 05

						viParams = ""
						putlistitems/occ viParams, "TEX_RECEITASVC"
						activate "PCPSVCO043".gravaReceitaC($$gParamGlb, viParams, voParams, $xCdErro$, $xCtxErro$)
						if ($procerror)
						$instancehandle-&gt;setStatus(&lt;STS_ERRO&gt;, $procerror, $procerrorcontext, "")
							return(-1)
						elseif ($status &lt; 0)
							return(-1)
						endif
						delitem vDsLstReceita, 1
					endif
				endwhile
				setocc "PCP_OPISEQPROSVC", $curocc("PCP_OPISEQPROSVC") + 1
			endwhile
		endif
		delitem vDsLstProdutoOp, 1
	endwhile

	return(0)
end ;bloquearReceitaMovimento

</DAT>
</OCC>
</TABLE>
<TABLE>
<DSC name="UXGROUP" model="DICT" system="S" pseudo ="73" level="1" noupdate="0"
 rbk="0" ffsql="0" transnr="0" segsize="0" ufocc="1000" charset=".U">
<FLD name="UTIMESTAMP" seqno="1" type="E" level="2" pack="0" scale="0" length="15"
 pointer="0" inum="0" ufocc="0" />
<FLD name="ULABEL" seqno="2" type="S" level="2" pack="0" scale="0" length="32"
 pointer="0" inum="1" ufocc="0" mandatory="yes" idxnum="1" idxsnr="101" />
<FLD name="UBASE" seqno="3" type="S" level="2" pack="0" scale="0" length="32"
 pointer="0" inum="1" ufocc="0" mandatory="yes" idxnum="1" idxsnr="102" />
<FLD name="UFORM" seqno="4" type="S" level="2" pack="0" scale="0" length="16"
 pointer="0" inum="2" ufocc="0" mandatory="yes" idxnum="1,2" idxsnr="103,1" />
<FLD name="UVERS" seqno="5" type="S" level="2" pack="0" scale="0" length="12"
 pointer="0" inum="0" ufocc="0" />
<FLD name="UDESCR" seqno="6" type="S" level="2" pack="0" scale="0" length="25"
 pointer="0" inum="0" ufocc="0" />
<FLD name="U_BORD" seqno="7" type="S" level="2" pack="0" scale="0" length="1"
 pointer="0" inum="0" ufocc="0" />
<FLD name="U_INDB" seqno="8" type="S" level="2" pack="0" scale="0" length="1"
 pointer="0" inum="0" ufocc="0" />
<FLD name="U_DBMS" seqno="9" type="S" level="2" pack="0" scale="0" length="3"
 pointer="0" inum="0" ufocc="0" />
<FLD name="U_UPD" seqno="10" type="S" level="2" pack="0" scale="0" length="1"
 pointer="0" inum="0" ufocc="0" />
<FLD name="U_MINL" seqno="11" type="N" level="2" pack="0" scale="0" length="6"
 pointer="0" inum="0" ufocc="0" />
<FLD name="U_MAXL" seqno="12" type="N" level="2" pack="0" scale="0" length="6"
 pointer="0" inum="0" ufocc="0" />
<FLD name="U_MINR" seqno="13" type="N" level="2" pack="0" scale="0" length="6"
 pointer="0" inum="0" ufocc="0" />
<FLD name="U_MAXR" seqno="14" type="N" level="2" pack="0" scale="0" length="6"
 pointer="0" inum="0" ufocc="0" />
<FLD name="TPLGINTF" seqno="15" type="S" level="2" pack="0" scale="0" length="32"
 pointer="0" inum="0" ufocc="0" />
<FLD name="U_INTF" seqno="16" type="S" level="2" pack="0" scale="0" length="64"
 pointer="0" inum="0" ufocc="0" />
<FLD name="TEMPLATENAME" seqno="17" type="S" level="2" pack="0" scale="0" length="32"
 pointer="0" inum="0" ufocc="0" />
<FLD name="UINHERIT" seqno="18" type="B" level="2" pack="0" scale="0" length="1"
 pointer="0" inum="0" ufocc="0" />
<FLD name="TPLACTUAL" seqno="19" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\E6,0,0,0,,0,0,0,," />
<FLD name="GETOCC" seqno="20" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\C1,0,0,0,,0,0,0,," />
<FLD name="PUTOCC" seqno="21" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\C2,0,0,0,,0,0,0,," />
<FLD name="DELOCC" seqno="22" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\C3,0,0,0,,0,0,0,," />
<FLD name="LCK" seqno="23" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\C4,0,0,0,,0,0,0,," />
<FLD name="UNLOCK" seqno="24" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\C5,0,0,0,,0,0,0,," />
<FLD name="GETSEGM" seqno="25" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\C6,0,0,0,,0,0,0,," />
<FLD name="ADDOCC" seqno="26" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\C7,0,0,0,,0,0,0,," />
<FLD name="DELOCCR" seqno="27" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\C8,0,0,0,,0,0,0,," />
<FLD name="ENDMOD" seqno="28" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\C9,0,0,0,,0,0,0,," />
<FLD name="DOC" seqno="29" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\CA,0,0,0,,0,0,0,," />
<FLD name="DETAIL" seqno="30" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\CB,0,0,0,,0,0,0,," />
<FLD name="CREOCC" seqno="31" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\CC,0,0,0,,0,0,0,," />
<FLD name="MENU" seqno="32" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\CD,0,0,0,,0,0,0,," />
<FLD name="FINDOCC" seqno="33" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\CE,0,0,0,,0,0,0,," />
<FLD name="ERROR" seqno="34" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\CF,0,0,0,,0,0,0,," />
<FLD name="GENERAL" seqno="35" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\D0,0,0,0,,0,0,0,," />
<FLD name="STARTMOD" seqno="36" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\D1,0,0,0,,0,0,0,," />
<FLD name="FLIST" seqno="37" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\E1,0,0,0,,0,0,0,," />
<FLD name="BREAK" seqno="38" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\E2,0,0,0,,0,0,0,," />
<FLD name="VLDE" seqno="39" type="S" level="2" pack="128" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\D2,0,0,0,,0,0,0,," />
<FLD name="VLDK" seqno="40" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\D3,0,0,0,,0,0,0,," />
<FLD name="UPOPUP" seqno="41" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\D4,0,0,0,,0,0,0,," />
<FLD name="UISBCLASS" seqno="42" type="B" level="2" pack="128" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\D5,0,0,0,,0,0,0,," />
<FLD name="UISASSOC" seqno="43" type="B" level="2" pack="128" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\D6,0,0,0,,0,0,0,," />
<FLD name="U_OBJSVC" seqno="44" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\DC,0,0,0,,0,0,0,," />
<FLD name="U_SVCUSE" seqno="45" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\DD,0,0,0,,0,0,0,," />
<FLD name="HTML_ENTPROP" seqno="46" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\D7,0,0,0,,0,0,0,," />
<FLD name="HTML_TABTYPE" seqno="47" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\D8,0,0,0,,0,0,0,," />
<FLD name="HTML_ENTHK_B" seqno="48" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\D9,0,0,0,,0,0,0,," />
<FLD name="HTML_ENTHK_E" seqno="49" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\DA,0,0,0,,0,0,0,," />
<FLD name="HTML_OCCHK_B" seqno="50" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\DB,0,0,0,,0,0,0,," />
<FLD name="HTML_OCCHK_E" seqno="51" type="S" level="2" pack="128" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\DE,0,0,0,,0,0,0,," />
<FLD name="HTML_ENTCLASS" seqno="52" type="S" level="2" pack="128" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\DF,0,0,0,,0,0,0,," />
<FLD name="U_GLAB" seqno="53" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\E0,0,0,0,,0,0,0,," />
<FLD name="UEOINTERFACE" seqno="54" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\E3,0,0,0,,0,0,0,," />
<FLD name="UECINTERFACE" seqno="55" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\E4,0,0,0,,0,0,0,," />
<FLD name="UEOOPERS" seqno="56" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\E5,0,0,0,,0,0,0,," />
<FLD name="UECOPERS" seqno="57" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\E7,0,0,0,,0,0,0,," />
<FLD name="UEOTRIGGERS" seqno="58" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\E8,0,0,0,,0,0,0,," />
<FLD name="UECTRIGGERS" seqno="59" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\E9,0,0,0,,0,0,0,," />
<FLD name="UGEOMETRY" seqno="60" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\EA,0,0,0,,0,0,0,," />
<FLD name="UWIDGETTYPE" seqno="61" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\EB,0,0,0,,0,0,0,," />
<FLD name="UWIDGETCREATE" seqno="62" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\EC,0,0,0,,0,0,0,," />
<FLD name="PRLO" seqno="63" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\ED,0,0,0,,0,0,0,," />
<FLD name="PSLO" seqno="64" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\EE,0,0,0,,0,0,0,," />
<FLD name="PRSO" seqno="65" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\EF,0,0,0,,0,0,0,," />
<FLD name="PSSO" seqno="66" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\F0,0,0,0,,0,0,0,," />
<FLD name="UPARENT" seqno="67" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\F1,0,0,0,,0,0,0,," />
</DSC>
<OCC>
<DAT name="UTIMESTAMP">2017-06-01T16:35:33.00</DAT>
<DAT name="ULABEL">CDF_CFGRECEMIFASESVC</DAT>
<DAT name="UBASE">CDF</DAT>
<DAT name="UFORM">CDFSVCO038</DAT>
<DAT name="UINHERIT">F</DAT>
<DAT name="FLIST">*</DAT>
<DAT name="UISBCLASS">F</DAT>
<DAT name="UISASSOC">F</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2017-06-01T16:35:33.00</DAT>
<DAT name="ULABEL">CDF_CFGRECEMIOPERSVC</DAT>
<DAT name="UBASE">CDF</DAT>
<DAT name="UFORM">CDFSVCO038</DAT>
<DAT name="UINHERIT">F</DAT>
<DAT name="FLIST">*</DAT>
<DAT name="UISBCLASS">F</DAT>
<DAT name="UISASSOC">F</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2017-06-01T16:35:33.00</DAT>
<DAT name="ULABEL">CDF_CFGRECFASESVC</DAT>
<DAT name="UBASE">CDF</DAT>
<DAT name="UFORM">CDFSVCO038</DAT>
<DAT name="UINHERIT">F</DAT>
<DAT name="FLIST">*</DAT>
<DAT name="UISBCLASS">F</DAT>
<DAT name="UISASSOC">F</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2017-06-01T16:35:33.00</DAT>
<DAT name="ULABEL">CDF_CFGRECOPERSVC</DAT>
<DAT name="UBASE">CDF</DAT>
<DAT name="UFORM">CDFSVCO038</DAT>
<DAT name="UINHERIT">F</DAT>
<DAT name="FLIST">*</DAT>
<DAT name="UISBCLASS">F</DAT>
<DAT name="UISASSOC">F</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2017-06-01T16:35:33.00</DAT>
<DAT name="ULABEL">CDF_MAQSVC</DAT>
<DAT name="UBASE">CDF</DAT>
<DAT name="UFORM">CDFSVCO038</DAT>
<DAT name="UINHERIT">F</DAT>
<DAT name="LCK" xml:space='preserve'>;#include &lt;LIB_PADRAO&gt;:DEF_LOCK
lock
if ($status = -10)
	reload
else
	return($status)
endif
return(0)</DAT>
<DAT name="FLIST">*</DAT>
<DAT name="UISBCLASS">F</DAT>
<DAT name="UISASSOC">F</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2017-06-01T16:35:33.00</DAT>
<DAT name="ULABEL">CDF_MOVOPCSVC</DAT>
<DAT name="UBASE">CDF</DAT>
<DAT name="UFORM">CDFSVCO038</DAT>
<DAT name="UINHERIT">F</DAT>
<DAT name="FLIST">*</DAT>
<DAT name="UISBCLASS">F</DAT>
<DAT name="UISASSOC">F</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2018-02-20T14:48:00.00</DAT>
<DAT name="ULABEL">CDF_PARTIDACFGMAQSVC</DAT>
<DAT name="UBASE">CDF</DAT>
<DAT name="UFORM">CDFSVCO038</DAT>
<DAT name="UINHERIT">F</DAT>
<DAT name="FLIST">*</DAT>
<DAT name="UISBCLASS">F</DAT>
<DAT name="UISASSOC">F</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2017-06-01T16:35:33.00</DAT>
<DAT name="ULABEL">CDF_PARTIDAEMISSAOSVC</DAT>
<DAT name="UBASE">CDF</DAT>
<DAT name="UFORM">CDFSVCO038</DAT>
<DAT name="UINHERIT">F</DAT>
<DAT name="FLIST">*</DAT>
<DAT name="UISBCLASS">F</DAT>
<DAT name="UISASSOC">F</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2017-06-01T16:35:33.00</DAT>
<DAT name="ULABEL">CDF_PARTIDAFISVC</DAT>
<DAT name="UBASE">CDF</DAT>
<DAT name="UFORM">CDFSVCO038</DAT>
<DAT name="UINHERIT">F</DAT>
<DAT name="FLIST">*</DAT>
<DAT name="UISBCLASS">F</DAT>
<DAT name="UISASSOC">F</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2019-02-18T10:58:03.00</DAT>
<DAT name="ULABEL">CDF_PARTIDAISVC</DAT>
<DAT name="UBASE">CDF</DAT>
<DAT name="UFORM">CDFSVCO038</DAT>
<DAT name="UINHERIT">F</DAT>
<DAT name="PUTOCC" xml:space='preserve'>;#include &lt;LIB_PADRAO&gt;:DEF_WRITE
$occhandle("&lt;$entname&gt;")-&gt;PreWRITE()
if($status &lt; 0)
	return(-1)
endif
#include LIB_LOG:ESCREVER
write
if ($status &lt; 0)
	#include &lt;LIB_PADRAO&gt;:ZSET_CTXERRO
else
	$occhandle("&lt;$entname&gt;")-&gt;PosWRITE()
endif
</DAT>
<DAT name="DELOCC" xml:space='preserve'>;#include &lt;LIB_PADRAO&gt;:DEF_DELETE
delete
if ($status &lt; 0)
	#include &lt;LIB_PADRAO&gt;:ZSET_CTXERRO
else
	#include LIB_LOG:DELETAR
endif
</DAT>
<DAT name="FLIST">*</DAT>
<DAT name="UISBCLASS">F</DAT>
<DAT name="UISASSOC">F</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2017-06-01T16:35:33.00</DAT>
<DAT name="ULABEL">CDF_PARTIDAMOVSVC</DAT>
<DAT name="UBASE">CDF</DAT>
<DAT name="UFORM">CDFSVCO038</DAT>
<DAT name="UINHERIT">F</DAT>
<DAT name="FLIST">*</DAT>
<DAT name="UISBCLASS">F</DAT>
<DAT name="UISASSOC">F</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2017-06-01T16:35:33.00</DAT>
<DAT name="ULABEL">CDF_PARTIDAPSVC</DAT>
<DAT name="UBASE">CDF</DAT>
<DAT name="UFORM">CDFSVCO038</DAT>
<DAT name="UINHERIT">F</DAT>
<DAT name="FLIST">*</DAT>
<DAT name="UISBCLASS">F</DAT>
<DAT name="UISASSOC">F</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2017-06-01T16:35:33.00</DAT>
<DAT name="ULABEL">CDF_PARTIDAPTSVC</DAT>
<DAT name="UBASE">CDF</DAT>
<DAT name="UFORM">CDFSVCO038</DAT>
<DAT name="UINHERIT">F</DAT>
<DAT name="FLIST">*</DAT>
<DAT name="UISBCLASS">F</DAT>
<DAT name="UISASSOC">F</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2017-06-27T09:05:35.00</DAT>
<DAT name="ULABEL">CDF_PARTIDAREALOCSVC</DAT>
<DAT name="UBASE">CDF</DAT>
<DAT name="UFORM">CDFSVCO038</DAT>
<DAT name="UINHERIT">F</DAT>
<DAT name="FLIST">*</DAT>
<DAT name="UISBCLASS">F</DAT>
<DAT name="UISASSOC">F</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2018-10-08T14:59:06.00</DAT>
<DAT name="ULABEL">CDF_PARTIDARESVC</DAT>
<DAT name="UBASE">CDF</DAT>
<DAT name="UFORM">CDFSVCO038</DAT>
<DAT name="UINHERIT">F</DAT>
<DAT name="FLIST">*</DAT>
<DAT name="UISBCLASS">F</DAT>
<DAT name="UISASSOC">F</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2017-06-01T16:35:33.00</DAT>
<DAT name="ULABEL">CDF_PARTIDASVC</DAT>
<DAT name="UBASE">CDF</DAT>
<DAT name="UFORM">CDFSVCO038</DAT>
<DAT name="U_BORD">N</DAT>
<DAT name="U_INDB">Y</DAT>
<DAT name="U_DBMS">DEF</DAT>
<DAT name="U_UPD">Y</DAT>
<DAT name="U_INTF">C*</DAT>
<DAT name="TEMPLATENAME">GENERICA</DAT>
<DAT name="UINHERIT">F</DAT>
<DAT name="FLIST">*</DAT>
<DAT name="UISBCLASS">F</DAT>
<DAT name="UISASSOC">F</DAT>
<DAT name="U_SVCUSE">N</DAT>
<DAT name="HTML_ENTPROP" xml:space='preserve'>U_ATLEASTONE=1&uSEP;U_STARTOCC=1</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2018-04-25T09:33:02.00</DAT>
<DAT name="ULABEL">CDF_PARTIDATEMPOSVC</DAT>
<DAT name="UBASE">CDF</DAT>
<DAT name="UFORM">CDFSVCO038</DAT>
<DAT name="UINHERIT">F</DAT>
<DAT name="FLIST">*</DAT>
<DAT name="UISBCLASS">F</DAT>
<DAT name="UISASSOC">F</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2017-06-01T16:35:33.00</DAT>
<DAT name="ULABEL">CDF_PRDCLAFORSVC</DAT>
<DAT name="UBASE">CDF</DAT>
<DAT name="UFORM">CDFSVCO038</DAT>
<DAT name="UINHERIT">F</DAT>
<DAT name="FLIST">*</DAT>
<DAT name="UISBCLASS">F</DAT>
<DAT name="UISASSOC">F</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2018-04-26T10:20:31.00</DAT>
<DAT name="ULABEL">CDF_PRDCLARECSVC</DAT>
<DAT name="UBASE">CDF</DAT>
<DAT name="UFORM">CDFSVCO038</DAT>
<DAT name="UINHERIT">F</DAT>
<DAT name="FLIST">*</DAT>
<DAT name="UISBCLASS">F</DAT>
<DAT name="UISASSOC">F</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2017-06-01T16:35:33.00</DAT>
<DAT name="ULABEL">CDF_PRDFORPERSVC</DAT>
<DAT name="UBASE">CDF</DAT>
<DAT name="UFORM">CDFSVCO038</DAT>
<DAT name="UINHERIT">F</DAT>
<DAT name="FLIST">*</DAT>
<DAT name="UISBCLASS">F</DAT>
<DAT name="UISASSOC">F</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2017-06-01T16:35:33.00</DAT>
<DAT name="ULABEL">F_CDF_PARTIDASVC</DAT>
<DAT name="UBASE">CDF</DAT>
<DAT name="UFORM">CDFSVCO038</DAT>
<DAT name="UINHERIT">F</DAT>
<DAT name="FLIST">*</DAT>
<DAT name="UISBCLASS">F</DAT>
<DAT name="UISASSOC">F</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2017-06-01T16:35:33.00</DAT>
<DAT name="ULABEL">F_CDF_PARTIISVC</DAT>
<DAT name="UBASE">CDF</DAT>
<DAT name="UFORM">CDFSVCO038</DAT>
<DAT name="UINHERIT">F</DAT>
<DAT name="FLIST">*</DAT>
<DAT name="UISBCLASS">F</DAT>
<DAT name="UISASSOC">F</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2017-06-01T16:35:33.00</DAT>
<DAT name="ULABEL">F_CDF_PARTIPTSVC</DAT>
<DAT name="UBASE">CDF</DAT>
<DAT name="UFORM">CDFSVCO038</DAT>
<DAT name="UINHERIT">F</DAT>
<DAT name="FLIST">*</DAT>
<DAT name="UISBCLASS">F</DAT>
<DAT name="UISASSOC">F</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2017-06-01T16:35:33.00</DAT>
<DAT name="ULABEL">PCP_AGRUOPILISVC</DAT>
<DAT name="UBASE">PCP</DAT>
<DAT name="UFORM">CDFSVCO038</DAT>
<DAT name="UINHERIT">F</DAT>
<DAT name="FLIST">*</DAT>
<DAT name="UISBCLASS">F</DAT>
<DAT name="UISASSOC">F</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2017-06-01T16:35:33.00</DAT>
<DAT name="ULABEL">PCP_AGRUOPISVC</DAT>
<DAT name="UBASE">PCP</DAT>
<DAT name="UFORM">CDFSVCO038</DAT>
<DAT name="UINHERIT">F</DAT>
<DAT name="FLIST">*</DAT>
<DAT name="UISBCLASS">F</DAT>
<DAT name="UISASSOC">F</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2017-06-01T16:35:33.00</DAT>
<DAT name="ULABEL">PCP_OPILOTECSVC</DAT>
<DAT name="UBASE">PCP</DAT>
<DAT name="UFORM">CDFSVCO038</DAT>
<DAT name="UINHERIT">F</DAT>
<DAT name="FLIST">*</DAT>
<DAT name="UISBCLASS">F</DAT>
<DAT name="UISASSOC">F</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2017-06-01T16:35:33.00</DAT>
<DAT name="ULABEL">PCP_OPILOTEISVC</DAT>
<DAT name="UBASE">PCP</DAT>
<DAT name="UFORM">CDFSVCO038</DAT>
<DAT name="UINHERIT">F</DAT>
<DAT name="FLIST">*</DAT>
<DAT name="UISBCLASS">F</DAT>
<DAT name="UISASSOC">F</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2017-06-01T16:35:33.00</DAT>
<DAT name="ULABEL">PCP_OPISEQPROSVC</DAT>
<DAT name="UBASE">PCP</DAT>
<DAT name="UFORM">CDFSVCO038</DAT>
<DAT name="UINHERIT">F</DAT>
<DAT name="FLIST">*</DAT>
<DAT name="UISBCLASS">F</DAT>
<DAT name="UISASSOC">F</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2017-06-01T16:35:33.00</DAT>
<DAT name="ULABEL">PCP_OPISVC</DAT>
<DAT name="UBASE">PCP</DAT>
<DAT name="UFORM">CDFSVCO038</DAT>
<DAT name="UINHERIT">F</DAT>
<DAT name="FLIST">*</DAT>
<DAT name="UISBCLASS">F</DAT>
<DAT name="UISASSOC">F</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2017-06-01T16:35:33.00</DAT>
<DAT name="ULABEL">TEX_RECEITAFASESVC</DAT>
<DAT name="UBASE">TEX</DAT>
<DAT name="UFORM">CDFSVCO038</DAT>
<DAT name="UINHERIT">F</DAT>
<DAT name="FLIST">*</DAT>
<DAT name="UISBCLASS">F</DAT>
<DAT name="UISASSOC">F</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2017-06-01T16:35:33.00</DAT>
<DAT name="ULABEL">TEX_RECEITASVC</DAT>
<DAT name="UBASE">TEX</DAT>
<DAT name="UFORM">CDFSVCO038</DAT>
<DAT name="UINHERIT">F</DAT>
<DAT name="FLIST">*</DAT>
<DAT name="UISBCLASS">F</DAT>
<DAT name="UISASSOC">F</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2017-06-01T16:35:33.00</DAT>
<DAT name="ULABEL">TEX_RECEMIFASSVC</DAT>
<DAT name="UBASE">TEX</DAT>
<DAT name="UFORM">CDFSVCO038</DAT>
<DAT name="UINHERIT">F</DAT>
<DAT name="FLIST">*</DAT>
<DAT name="UISBCLASS">F</DAT>
<DAT name="UISASSOC">F</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2017-06-01T16:35:33.00</DAT>
<DAT name="ULABEL">TEX_RECEMIMPSVC</DAT>
<DAT name="UBASE">TEX</DAT>
<DAT name="UFORM">CDFSVCO038</DAT>
<DAT name="UINHERIT">F</DAT>
<DAT name="FLIST">*</DAT>
<DAT name="UISBCLASS">F</DAT>
<DAT name="UISASSOC">F</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2017-06-01T16:35:33.00</DAT>
<DAT name="ULABEL">TEX_RECEMIOPESVC</DAT>
<DAT name="UBASE">TEX</DAT>
<DAT name="UFORM">CDFSVCO038</DAT>
<DAT name="UINHERIT">F</DAT>
<DAT name="FLIST">*</DAT>
<DAT name="UISBCLASS">F</DAT>
<DAT name="UISASSOC">F</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2017-06-01T16:35:33.00</DAT>
<DAT name="ULABEL">TEX_RECEMIOPSVC</DAT>
<DAT name="UBASE">TEX</DAT>
<DAT name="UFORM">CDFSVCO038</DAT>
<DAT name="UINHERIT">F</DAT>
<DAT name="FLIST">*</DAT>
<DAT name="UISBCLASS">F</DAT>
<DAT name="UISASSOC">F</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2017-06-01T16:35:33.00</DAT>
<DAT name="ULABEL">TEX_RECEMISSASVC</DAT>
<DAT name="UBASE">TEX</DAT>
<DAT name="UFORM">CDFSVCO038</DAT>
<DAT name="UINHERIT">F</DAT>
<DAT name="FLIST">*</DAT>
<DAT name="UISBCLASS">F</DAT>
<DAT name="UISASSOC">F</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2017-06-01T16:35:33.00</DAT>
<DAT name="ULABEL">TEX_RECEOPPRDSVC</DAT>
<DAT name="UBASE">TEX</DAT>
<DAT name="UFORM">CDFSVCO038</DAT>
<DAT name="UINHERIT">F</DAT>
<DAT name="FLIST">*</DAT>
<DAT name="UISBCLASS">F</DAT>
<DAT name="UISASSOC">F</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2017-06-01T16:35:33.00</DAT>
<DAT name="ULABEL">TEX_RECFASESVC</DAT>
<DAT name="UBASE">TEX</DAT>
<DAT name="UFORM">CDFSVCO038</DAT>
<DAT name="UINHERIT">F</DAT>
<DAT name="FLIST">*</DAT>
<DAT name="UISBCLASS">F</DAT>
<DAT name="UISASSOC">F</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2017-06-01T16:35:33.00</DAT>
<DAT name="ULABEL">TEX_RECOPERPRSVC</DAT>
<DAT name="UBASE">TEX</DAT>
<DAT name="UFORM">CDFSVCO038</DAT>
<DAT name="UINHERIT">F</DAT>
<DAT name="FLIST">*</DAT>
<DAT name="UISBCLASS">F</DAT>
<DAT name="UISASSOC">F</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2017-06-01T16:35:33.00</DAT>
<DAT name="ULABEL">TEX_RECOPERSVC</DAT>
<DAT name="UBASE">TEX</DAT>
<DAT name="UFORM">CDFSVCO038</DAT>
<DAT name="UINHERIT">F</DAT>
<DAT name="FLIST">*</DAT>
<DAT name="UISBCLASS">F</DAT>
<DAT name="UISASSOC">F</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2018-10-17T09:27:11.00</DAT>
<DAT name="ULABEL">TEX_RELSUBPRDRECEMISVC</DAT>
<DAT name="UBASE">TEX</DAT>
<DAT name="UFORM">CDFSVCO038</DAT>
<DAT name="UINHERIT">F</DAT>
<DAT name="FLIST">*</DAT>
<DAT name="UISBCLASS">F</DAT>
<DAT name="UISASSOC">F</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2017-06-01T16:35:33.00</DAT>
<DAT name="ULABEL">TMP_K03NRSVC</DAT>
<DAT name="UBASE">TMP</DAT>
<DAT name="UFORM">CDFSVCO038</DAT>
<DAT name="UINHERIT">F</DAT>
<DAT name="FLIST">*</DAT>
<DAT name="UISBCLASS">F</DAT>
<DAT name="UISASSOC">F</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2018-03-21T14:34:53.00</DAT>
<DAT name="ULABEL">TMP_K06NRDTSVC</DAT>
<DAT name="UBASE">TMP</DAT>
<DAT name="UFORM">CDFSVCO038</DAT>
<DAT name="UINHERIT">F</DAT>
<DAT name="FLIST">*</DAT>
<DAT name="UISBCLASS">F</DAT>
<DAT name="UISASSOC">F</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2017-07-19T15:15:36.00</DAT>
<DAT name="ULABEL">TMP_K06NR10SVC</DAT>
<DAT name="UBASE">TMP</DAT>
<DAT name="UFORM">CDFSVCO038</DAT>
<DAT name="UINHERIT">F</DAT>
<DAT name="FLIST">*</DAT>
<DAT name="UISBCLASS">F</DAT>
<DAT name="UISASSOC">F</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2017-06-01T16:35:33.00</DAT>
<DAT name="ULABEL">V_CDF_PARTIDASVC</DAT>
<DAT name="UBASE">CDF</DAT>
<DAT name="UFORM">CDFSVCO038</DAT>
<DAT name="U_UPD">N</DAT>
<DAT name="UINHERIT">F</DAT>
<DAT name="FLIST">*</DAT>
<DAT name="VLDE" xml:space='preserve'>;#include &lt;LIB_PADRAO&gt;:DEF_VLDO</DAT>
<DAT name="UISBCLASS">F</DAT>
<DAT name="UISASSOC">F</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2017-06-01T16:35:33.00</DAT>
<DAT name="ULABEL">V_CDF_REC_PARTISVC</DAT>
<DAT name="UBASE">CDF</DAT>
<DAT name="UFORM">CDFSVCO038</DAT>
<DAT name="UINHERIT">F</DAT>
<DAT name="FLIST">*</DAT>
<DAT name="UISBCLASS">F</DAT>
<DAT name="UISASSOC">F</DAT>
</OCC>
</TABLE>
<TABLE>
<DSC name="UXFIELD" model="DICT" system="S" pseudo ="73" level="1" noupdate="0"
 rbk="0" ffsql="0" transnr="0" segsize="0" ufocc="1000" charset=".U">
<FLD name="UTIMESTAMP" seqno="1" type="E" level="2" pack="0" scale="0" length="15"
 pointer="0" inum="0" ufocc="0" />
<FLD name="ULABEL" seqno="2" type="S" level="2" pack="0" scale="0" length="32"
 pointer="0" inum="1" ufocc="0" mandatory="yes" idxnum="1" idxsnr="101" />
<FLD name="GRP" seqno="3" type="S" level="2" pack="0" scale="0" length="32"
 pointer="0" inum="2" ufocc="0" mandatory="yes" idxnum="1,2" idxsnr="102,1" />
<FLD name="UBASE" seqno="4" type="S" level="2" pack="0" scale="0" length="32"
 pointer="0" inum="2" ufocc="0" mandatory="yes" idxnum="1,2" idxsnr="103,2" />
<FLD name="UFORM" seqno="5" type="S" level="2" pack="0" scale="0" length="16"
 pointer="0" inum="3" ufocc="0" mandatory="yes" idxnum="1,2,3" idxsnr="104,3,1" />
<FLD name="U_TLAB" seqno="6" type="S" level="2" pack="0" scale="0" length="32"
 pointer="0" inum="0" ufocc="0" />
<FLD name="UVERS" seqno="7" type="S" level="2" pack="0" scale="0" length="12"
 pointer="0" inum="0" ufocc="0" />
<FLD name="UDESCR" seqno="8" type="S" level="2" pack="0" scale="0" length="25"
 pointer="0" inum="0" ufocc="0" />
<FLD name="U_DTYP" seqno="9" type="S" level="2" pack="0" scale="0" length="2"
 pointer="0" inum="0" ufocc="0" />
<FLD name="U_INDB" seqno="10" type="S" level="2" pack="0" scale="0" length="1"
 pointer="0" inum="0" ufocc="0" />
<FLD name="TPLLAY" seqno="11" type="S" level="2" pack="0" scale="0" length="32"
 pointer="0" inum="0" ufocc="0" />
<FLD name="LAYOUTMOD" seqno="12" type="S" level="2" pack="0" scale="0" length="128"
 pointer="0" inum="0" ufocc="0" />
<FLD name="TPLSYN" seqno="13" type="S" level="2" pack="0" scale="0" length="32"
 pointer="0" inum="0" ufocc="0" />
<FLD name="SYNTAXMOD" seqno="14" type="S" level="2" pack="0" scale="0" length="192"
 pointer="0" inum="0" ufocc="0" />
<FLD name="TPLINTF" seqno="15" type="S" level="2" pack="0" scale="0" length="32"
 pointer="0" inum="0" ufocc="0" />
<FLD name="INTERFACEMOD" seqno="16" type="S" level="2" pack="0" scale="0" length="64"
 pointer="0" inum="0" ufocc="0" />
<FLD name="TABSTOP" seqno="17" type="N" level="2" pack="10" scale="0" length="2"
 pointer="0" inum="0" ufocc="0" />
<FLD name="WIDGETTYPE" seqno="18" type="S" level="2" pack="0" scale="0" length="16"
 pointer="0" inum="0" ufocc="0" />
<FLD name="TEMPLATENAME" seqno="19" type="S" level="2" pack="0" scale="0" length="32"
 pointer="0" inum="0" ufocc="0" />
<FLD name="UINHERIT" seqno="20" type="B" level="2" pack="0" scale="0" length="1"
 pointer="0" inum="0" ufocc="0" />
<FLD name="STARTMOD" seqno="21" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\C1,0,0,0,,0,0,0,," />
<FLD name="ENDMOD" seqno="22" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\C2,0,0,0,,0,0,0,," />
<FLD name="NEXTFLD" seqno="23" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\C3,0,0,0,,0,0,0,," />
<FLD name="PREVFLD" seqno="24" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\C4,0,0,0,,0,0,0,," />
<FLD name="ENCRYPT" seqno="25" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\C5,0,0,0,,0,0,0,," />
<FLD name="DECRYPT" seqno="26" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\C6,0,0,0,,0,0,0,," />
<FLD name="DOC" seqno="27" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\C7,0,0,0,,0,0,0,," />
<FLD name="DETAIL" seqno="28" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\C8,0,0,0,,0,0,0,," />
<FLD name="MENU" seqno="29" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\C9,0,0,0,,0,0,0,," />
<FLD name="ERROR" seqno="30" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\CA,0,0,0,,0,0,0,," />
<FLD name="UFORMAT" seqno="31" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\CB,0,0,0,,0,0,0,," />
<FLD name="DEFORMAT" seqno="32" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\CC,0,0,0,,0,0,0,," />
<FLD name="GENERAL" seqno="33" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\CD,0,0,0,,0,0,0,," />
<FLD name="GETFOCUS" seqno="34" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\CE,0,0,0,,0,0,0,," />
<FLD name="VCHANGED" seqno="35" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\CF,0,0,0,,0,0,0,," />
<FLD name="WIDGETCREATE" seqno="36" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\DD,0,0,0,,0,0,0,," />
<FLD name="VALLAB" seqno="37" type="S" level="2" pack="128" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\DE,0,0,0,,0,0,0,," />
<FLD name="INITVALUE" seqno="38" type="S" level="2" pack="128" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\DF,0,0,0,,0,0,0,," />
<FLD name="TPLACTUAL" seqno="39" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\E6,0,0,0,,0,0,0,," />
<FLD name="VLDF" seqno="40" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\D0,0,0,0,,0,0,0,," />
<FLD name="UPOPUP" seqno="41" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\D1,0,0,0,,0,0,0,," />
<FLD name="UISOBJID" seqno="42" type="B" level="2" pack="128" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\D2,0,0,0,,0,0,0,," />
<FLD name="HTML_FLDPROP" seqno="43" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\D3,0,0,0,,0,0,0,," />
<FLD name="HTML_CTRLTYPE" seqno="44" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\D4,0,0,0,,0,0,0,," />
<FLD name="HTML_HOOK_B" seqno="45" type="S" level="2" pack="128" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\D5,0,0,0,,0,0,0,," />
<FLD name="HTML_HOOK_M" seqno="46" type="S" level="2" pack="128" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\D6,0,0,0,,0,0,0,," />
<FLD name="HTML_HOOK_E" seqno="47" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\D7,0,0,0,,0,0,0,," />
<FLD name="HTML_LBLHK_B" seqno="48" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\D8,0,0,0,,0,0,0,," />
<FLD name="HTML_LBLHK_E" seqno="49" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\D9,0,0,0,,0,0,0,," />
<FLD name="HTML_FLDCLASS" seqno="50" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\DA,0,0,0,,0,0,0,," />
<FLD name="HTML_LBLCLASS" seqno="51" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\DB,0,0,0,,0,0,0,," />
<FLD name="UFOPERS" seqno="52" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\DC,0,0,0,,0,0,0,," />
<FLD name="UFTRIGGERS" seqno="53" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\E0,0,0,0,,0,0,0,," />
<FLD name="UGEOMETRY" seqno="54" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\E1,0,0,0,,0,0,0,," />
<FLD name="USCOPE" seqno="55" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\E2,0,0,0,,0,0,0,," />
<FLD name="UFORMATS" seqno="56" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\E3,0,0,0,,0,0,0,," />
<FLD name="UHINTERFACE" seqno="57" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\E4,0,0,0,,0,0,0,," />
</DSC>
<OCC>
<DAT name="UTIMESTAMP">2017-06-01T16:35:33.00</DAT>
<DAT name="ULABEL">CD_FORNECEDOR</DAT>
<DAT name="GRP">TMP_K03NRSVC</DAT>
<DAT name="UBASE">TMP</DAT>
<DAT name="UFORM">CDFSVCO038</DAT>
<DAT name="UDESCR">Nr.</DAT>
<DAT name="U_DTYP">N</DAT>
<DAT name="U_INDB">N</DAT>
<DAT name="TPLLAY">NR_09</DAT>
<DAT name="TPLINTF">NR_09</DAT>
<DAT name="WIDGETTYPE">EDITBOX</DAT>
<DAT name="UINHERIT">F</DAT>
<DAT name="DETAIL" xml:space='preserve'>return (-1)</DAT>
<DAT name="ERROR">$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;,$error,$dataerrorcontext,"")</DAT>
<DAT name="UISOBJID">F</DAT>
<DAT name="HTML_FLDPROP">SYNC=1</DAT>
<DAT name="HTML_CTRLTYPE">U_INPUT</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2017-07-19T15:17:53.00</DAT>
<DAT name="ULABEL">DS_LSTLOTE</DAT>
<DAT name="GRP">TMP_K06NR10SVC</DAT>
<DAT name="UBASE">TMP</DAT>
<DAT name="UFORM">CDFSVCO038</DAT>
<DAT name="UDESCR" xml:space='preserve'>Texto geral</DAT>
<DAT name="U_DTYP">S</DAT>
<DAT name="U_INDB">N</DAT>
<DAT name="TPLINTF">DS_GERAL</DAT>
<DAT name="WIDGETTYPE">EDITBOX</DAT>
<DAT name="UINHERIT">F</DAT>
<DAT name="ERROR" xml:space='preserve'>; Include an "else" block like the one shown below at the end of any
; Proc written in this trigger.
; . . .
; else
;    message $text("%%$error")
;    return (-1)
; endif
</DAT>
<DAT name="WIDGETCREATE">MULTILINE=T</DAT>
<DAT name="UISOBJID">F</DAT>
<DAT name="HTML_FLDPROP">SYNC=1</DAT>
<DAT name="HTML_CTRLTYPE">U_INPUT</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2017-07-19T15:17:38.00</DAT>
<DAT name="ULABEL">QT_MOVIMENTO</DAT>
<DAT name="GRP">TMP_K06NR10SVC</DAT>
<DAT name="UBASE">TMP</DAT>
<DAT name="UFORM">CDFSVCO038</DAT>
<DAT name="UDESCR">Qtde.</DAT>
<DAT name="U_DTYP">N</DAT>
<DAT name="U_INDB">N</DAT>
<DAT name="TPLLAY">QT_09D3</DAT>
<DAT name="TPLINTF">QT_09D3</DAT>
<DAT name="WIDGETTYPE">EDITBOX</DAT>
<DAT name="UINHERIT">F</DAT>
<DAT name="DETAIL" xml:space='preserve'>return (-1)</DAT>
<DAT name="ERROR">$instancehandle-&gt;SetStatus(&lt;STS_ERRO&gt;,$error,$dataerrorcontext,"")</DAT>
<DAT name="UISOBJID">F</DAT>
<DAT name="HTML_FLDPROP">SYNC=1</DAT>
<DAT name="HTML_CTRLTYPE">U_INPUT</DAT>
</OCC>
</TABLE>
<TABLE>
<DSC name="UXREGS" model="DICT" system="S" pseudo ="73" level="1" noupdate="0"
 rbk="0" ffsql="0" transnr="0" segsize="0" ufocc="0" charset=".U">
<FLD name="UTIMESTAMP" seqno="1" type="E" level="2" pack="0" scale="0" length="15"
 pointer="0" inum="0" ufocc="0" />
<FLD name="U_STAT" seqno="2" type="S" level="2" pack="0" scale="0" length="4"
 pointer="0" inum="0" ufocc="0" />
<FLD name="U_TYPE" seqno="3" type="S" level="2" pack="0" scale="0" length="2"
 pointer="0" inum="0" ufocc="0" />
<FLD name="U_FORMLIB" seqno="4" type="S" level="2" pack="0" scale="0" length="16"
 pointer="0" inum="2" ufocc="0" mandatory="yes" idxnum="1,3" idxsnr="101,1" />
<FLD name="U_NAME" seqno="5" type="S" level="2" pack="0" scale="0" length="32"
 pointer="0" inum="2" ufocc="0" mandatory="yes" idxnum="1,2" idxsnr="102,1" />
<FLD name="UVERS" seqno="6" type="S" level="2" pack="0" scale="0" length="12"
 pointer="0" inum="0" ufocc="0" />
<FLD name="UDESCR" seqno="7" type="S" level="2" pack="0" scale="0" length="25"
 pointer="0" inum="0" ufocc="0" />
<FLD name="U_DTYP" seqno="8" type="S" level="2" pack="0" scale="0" length="2"
 pointer="0" inum="0" ufocc="0" />
<FLD name="U_LAYOUT" seqno="9" type="S" level="2" pack="0" scale="0" length="46"
 pointer="0" inum="0" ufocc="0" />
<FLD name="U_DOC" seqno="10" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\C1,0,0,0,,0,0,0,," />
<FLD name="USCOPE" seqno="11" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\C2,0,0,0,,0,0,0,," />
<FLD name="UHINTERFACE" seqno="12" type="S" level="2" pack="141" scale="0" length="0"
 pointer="0" inum="0" ufocc="0" varinfo=",1,0,2,\1F\C3,0,0,0,,0,0,0,," />
</DSC>
<OCC>
<DAT name="UTIMESTAMP">2018-10-08T14:56:33.00</DAT>
<DAT name="U_FORMLIB">CDFSVCO038</DAT>
<DAT name="U_NAME">CDCLASPERMITEPARTIDA</DAT>
<DAT name="U_DTYP">S</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2017-08-10T16:58:01.00</DAT>
<DAT name="U_FORMLIB">CDFSVCO038</DAT>
<DAT name="U_NAME">CDEMPRESA</DAT>
<DAT name="U_DTYP">N</DAT>
<DAT name="U_LAYOUT">DIS(9999)</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2017-06-01T16:35:33.00</DAT>
<DAT name="U_FORMLIB">CDFSVCO038</DAT>
<DAT name="U_NAME">CDESPECIEKG</DAT>
<DAT name="U_DTYP">S</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2017-08-30T14:23:27.00</DAT>
<DAT name="U_FORMLIB">CDFSVCO038</DAT>
<DAT name="U_NAME">CDTIPOCLASPADRAOTEC</DAT>
<DAT name="U_DTYP">N</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2017-06-01T16:35:33.00</DAT>
<DAT name="U_FORMLIB">CDFSVCO038</DAT>
<DAT name="U_NAME">DATAHORA</DAT>
<DAT name="U_DTYP">E</DAT>
<DAT name="U_LAYOUT">@DT_DATAHORA</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2017-07-25T08:35:27.00</DAT>
<DAT name="U_FORMLIB">CDFSVCO038</DAT>
<DAT name="U_NAME">DSLSTLOCALEMIREC</DAT>
<DAT name="U_DTYP">S</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2017-06-01T16:35:33.00</DAT>
<DAT name="U_FORMLIB">CDFSVCO038</DAT>
<DAT name="U_NAME">DSLSTLOGCALC</DAT>
<DAT name="U_DTYP">S</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2017-06-02T11:19:32.00</DAT>
<DAT name="U_FORMLIB">CDFSVCO038</DAT>
<DAT name="U_NAME">DSLSTMAQCOMP</DAT>
<DAT name="U_DTYP">S</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2017-06-01T16:35:33.00</DAT>
<DAT name="U_FORMLIB">CDFSVCO038</DAT>
<DAT name="U_NAME">DSLSTPROCMAQ</DAT>
<DAT name="U_DTYP">S</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2018-04-03T17:46:06.00</DAT>
<DAT name="U_FORMLIB">CDFSVCO038</DAT>
<DAT name="U_NAME">DSLSTTPCLARECPARTIDA</DAT>
<DAT name="U_DTYP">S</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2017-06-01T16:35:33.00</DAT>
<DAT name="U_FORMLIB">CDFSVCO038</DAT>
<DAT name="U_NAME">DSLSTTPRECCAMPOCONF</DAT>
<DAT name="U_DTYP">S</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2018-02-22T08:57:55.00</DAT>
<DAT name="U_FORMLIB">CDFSVCO038</DAT>
<DAT name="U_NAME">DSPARTIDAPADRAOTEC</DAT>
<DAT name="U_DTYP">S</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2017-06-01T16:35:33.00</DAT>
<DAT name="U_FORMLIB">CDFSVCO038</DAT>
<DAT name="U_NAME">DSTEMPOPARTIDA</DAT>
<DAT name="U_DTYP">S</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2017-06-01T16:35:33.00</DAT>
<DAT name="U_FORMLIB">CDFSVCO038</DAT>
<DAT name="U_NAME">DTDATE</DAT>
<DAT name="U_DTYP">D</DAT>
<DAT name="U_LAYOUT">@DT_DDMMYYYY</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2017-06-01T16:35:33.00</DAT>
<DAT name="U_FORMLIB">CDFSVCO038</DAT>
<DAT name="U_NAME">HANDLECONSULTA</DAT>
<DAT name="U_DTYP">H</DAT>
<DAT name="USCOPE">PUB</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2017-06-01T16:35:33.00</DAT>
<DAT name="U_FORMLIB">CDFSVCO038</DAT>
<DAT name="U_NAME">HANDLEENTITY</DAT>
<DAT name="U_DTYP">H</DAT>
<DAT name="USCOPE">PUB</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2018-04-05T16:17:15.00</DAT>
<DAT name="U_FORMLIB">CDFSVCO038</DAT>
<DAT name="U_NAME">HANDLERECCLAS</DAT>
<DAT name="U_DTYP">H</DAT>
<DAT name="USCOPE">PUB</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2017-07-31T17:20:18.00</DAT>
<DAT name="U_FORMLIB">CDFSVCO038</DAT>
<DAT name="U_NAME">HANDLERECEITAPRD</DAT>
<DAT name="U_DTYP">H</DAT>
<DAT name="USCOPE">PUB</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2018-01-23T08:58:19.00</DAT>
<DAT name="U_FORMLIB">CDFSVCO038</DAT>
<DAT name="U_NAME">HANDLESALDO</DAT>
<DAT name="U_DTYP">H</DAT>
<DAT name="USCOPE">PUB</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2017-06-01T16:35:33.00</DAT>
<DAT name="U_FORMLIB">CDFSVCO038</DAT>
<DAT name="U_NAME">INCOMPMAQ</DAT>
<DAT name="U_DTYP">B</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2018-02-21T15:18:08.00</DAT>
<DAT name="U_FORMLIB">CDFSVCO038</DAT>
<DAT name="U_NAME">INCONEPARTIDAALOCADA</DAT>
<DAT name="U_DTYP">B</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2017-08-10T08:58:11.00</DAT>
<DAT name="U_FORMLIB">CDFSVCO038</DAT>
<DAT name="U_NAME">ININTEGRACAOORGATEX</DAT>
<DAT name="U_DTYP">B</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2017-06-01T16:35:33.00</DAT>
<DAT name="U_FORMLIB">CDFSVCO038</DAT>
<DAT name="U_NAME">INSTANCE</DAT>
<DAT name="U_DTYP">H</DAT>
<DAT name="USCOPE">PUB</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2018-01-22T16:54:15.00</DAT>
<DAT name="U_FORMLIB">CDFSVCO038</DAT>
<DAT name="U_NAME">INVALIDARSALDOEMIREC</DAT>
<DAT name="U_DTYP">B</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2017-06-01T16:35:33.00</DAT>
<DAT name="U_FORMLIB">CDFSVCO038</DAT>
<DAT name="U_NAME">LSTITENSDESCARTADOS</DAT>
<DAT name="U_DTYP">S</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2017-06-01T16:35:33.00</DAT>
<DAT name="U_FORMLIB">CDFSVCO038</DAT>
<DAT name="U_NAME">NREMISSAO</DAT>
<DAT name="U_DTYP">N</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2018-02-21T15:18:08.00</DAT>
<DAT name="U_FORMLIB">CDFSVCO038</DAT>
<DAT name="U_NAME">QTCONEPARTIDAALOCADA</DAT>
<DAT name="U_DTYP">N</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2017-06-01T16:35:33.00</DAT>
<DAT name="U_FORMLIB">CDFSVCO038</DAT>
<DAT name="U_NAME">TPALOCACAOPARTIDA</DAT>
<DAT name="U_DTYP">N</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2018-12-05T10:15:12.00</DAT>
<DAT name="U_FORMLIB">CDFSVCO038</DAT>
<DAT name="U_NAME">TPINTACABAMENTOTEXTIL</DAT>
<DAT name="U_DTYP">N</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2017-06-01T16:35:33.00</DAT>
<DAT name="U_FORMLIB">CDFSVCO038</DAT>
<DAT name="U_NAME">TPMANUTENCAOFASEREC</DAT>
<DAT name="U_DTYP">N</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2017-06-01T16:35:33.00</DAT>
<DAT name="U_FORMLIB">CDFSVCO038</DAT>
<DAT name="U_NAME">VL12D2</DAT>
<DAT name="U_DTYP">N</DAT>
<DAT name="U_LAYOUT">@VL_12D2</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2017-06-01T16:35:33.00</DAT>
<DAT name="U_FORMLIB">CDFSVCO038</DAT>
<DAT name="U_NAME">XCDERRO</DAT>
<DAT name="UDESCR" xml:space='preserve'>Identificador do erro</DAT>
<DAT name="U_DTYP">S</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2017-06-01T16:35:33.00</DAT>
<DAT name="U_FORMLIB">CDFSVCO038</DAT>
<DAT name="U_NAME">XCDNIVEL</DAT>
<DAT name="UDESCR" xml:space='preserve'>Nivel de acesso  usuário</DAT>
<DAT name="U_DTYP">S</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2017-06-01T16:35:33.00</DAT>
<DAT name="U_FORMLIB">CDFSVCO038</DAT>
<DAT name="U_NAME">XCP</DAT>
<DAT name="UDESCR" xml:space='preserve'>Código do processo local</DAT>
<DAT name="U_DTYP">S</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2017-06-01T16:35:33.00</DAT>
<DAT name="U_FORMLIB">CDFSVCO038</DAT>
<DAT name="U_NAME">XCS</DAT>
<DAT name="UDESCR" xml:space='preserve'>Código status</DAT>
<DAT name="U_DTYP">S</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2017-06-01T16:35:33.00</DAT>
<DAT name="U_FORMLIB">CDFSVCO038</DAT>
<DAT name="U_NAME">XCTXERRO</DAT>
<DAT name="UDESCR" xml:space='preserve'>Contexto do erro</DAT>
<DAT name="U_DTYP">S</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2017-06-01T16:35:33.00</DAT>
<DAT name="U_FORMLIB">CDFSVCO038</DAT>
<DAT name="U_NAME">XLCS</DAT>
<DAT name="UDESCR" xml:space='preserve'>Lista contexto status</DAT>
<DAT name="U_DTYP">S</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2017-06-01T16:35:33.00</DAT>
<DAT name="U_FORMLIB">CDFSVCO038</DAT>
<DAT name="U_NAME">XLPG</DAT>
<DAT name="UDESCR" xml:space='preserve'>Lista parâmetro global</DAT>
<DAT name="U_DTYP">S</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2017-06-01T16:35:33.00</DAT>
<DAT name="U_FORMLIB">CDFSVCO038</DAT>
<DAT name="U_NAME">XLPI</DAT>
<DAT name="UDESCR" xml:space='preserve'>Lista parâmetro input</DAT>
<DAT name="U_DTYP">S</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2017-06-01T16:35:33.00</DAT>
<DAT name="U_FORMLIB">CDFSVCO038</DAT>
<DAT name="U_NAME">XLPL</DAT>
<DAT name="UDESCR" xml:space='preserve'>Lista parâmetro local</DAT>
<DAT name="U_DTYP">S</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2017-06-01T16:35:33.00</DAT>
<DAT name="U_FORMLIB">CDFSVCO038</DAT>
<DAT name="U_NAME">XLPLEMP</DAT>
<DAT name="UDESCR" xml:space='preserve'>Lista parametro local emp</DAT>
<DAT name="U_DTYP">S</DAT>
</OCC>
<OCC>
<DAT name="UTIMESTAMP">2017-06-01T16:35:33.00</DAT>
<DAT name="U_FORMLIB">CDFSVCO038</DAT>
<DAT name="U_NAME">XLPO</DAT>
<DAT name="UDESCR" xml:space='preserve'>Lista parâmetro output</DAT>
<DAT name="U_DTYP">S</DAT>
</OCC>
</TABLE>
</UNIFACE>
